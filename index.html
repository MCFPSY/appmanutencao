<!DOCTYPE html>
<!-- 
    ğŸ­ APP MANUTENÃ‡ÃƒO MCF + PSY
    ğŸ“¦ VersÃ£o: v3.8.3.10.27.54 (Worker: v3.8.3.10.27.10)
    ğŸ“… Data: 2026-02-11
    
    ğŸ¯ v3.8.3.10.27.54: FIX CRÃTICO - RevisÃµes + Multiselect INLINE (mesmo fix do Filtro Excel) âœ…
    ğŸ¯ v3.8.3.10.27.53: FIX - Campos de RevisÃ£o aparecem corretamente (Tipo IntervenÃ§Ã£o oculto) âœ…
    ğŸ¯ v3.8.3.10.27.52: FIX - Campo Tipo de RevisÃ£o nÃ£o Ã© mais obrigatÃ³rio quando nÃ£o Ã© RevisÃ£o âœ…
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âœ… DESCOBERTA: Estrutura DOM estÃ¡ PERFEITA (thead primeiro, tbody segundo)
    âœ… PROBLEMA: Motor de impressÃ£o do browser REORGANIZA durante renderizaÃ§Ã£o
    âœ… SOLUÃ‡ÃƒO RADICAL: REMOVER <thead> completamente!
    âœ… CONVERTER: Linha de cabeÃ§alho (<thead><tr>) vira primeira linha de <tbody>
    âœ… RESULTADO: Tabela com APENAS <tbody> - browser nÃ£o pode reorganizar!
    âœ… CSS: Estilizar .header-row para parecer cabeÃ§alho (fundo azul, texto branco)
    âœ… EVITA: Browser reorganizar estrutura durante cloneNode
    âœ… MANTÃ‰M: Todas as correÃ§Ãµes anteriores (CSS especÃ­fico, reflow, delay)
    âœ… REVERTIDA v3.8.3.10.27.27: LÃ³gica body:not(.printing-planning) RESTAURADA
    âœ… SOLUÃ‡ÃƒO CIRÃšRGICA: Regra ESPECÃFICA para .planning-grid th > div
    âœ… FORÃ‡AR visibilidade APENAS dos <div> dentro de <th> da tabela planeamento
    âœ… MANTÃ‰M relatÃ³rio funcionando (body:not(.printing-planning) preservado)
    âœ… REFLOW FORÃ‡ADO: void offsetHeight para forÃ§ar recÃ¡lculo antes de imprimir
    âœ… DELAY AUMENTADO: 300msâ†’800ms para dar tempo ao CSS ser aplicado
    âœ… COMBINAÃ‡ÃƒO PERFEITA: CabeÃ§alhos visÃ­veis + Tabela estruturada
    âœ… FIX v3.8.3.10.27.25: ConteÃºdo <th> visÃ­vel (mas quebrou tabela com display:block)
    âœ… FIX v3.8.3.10.27.26: Removido display:block â†’ mantÃ©m estrutura natural
    âœ… SOLUÃ‡ÃƒO FINAL: ForÃ§ar visibility/max-height/overflow SEM alterar display
    âœ… RESULTADO: CabeÃ§alho azul completo NO TOPO + Tabela formatada correctamente
    âœ… CABEÃ‡ALHOS CORRETOS: cloneNode() em vez de outerHTML â†’ estrutura DOM preservada
    âœ… FIX THEAD: CabeÃ§alho agora aparece SEMPRE no topo (nÃ£o mais no meio!)
    âœ… ESTRUTURA GARANTIDA: <thead> â†’ <tbody> ordem correta
    âœ… PARSING CORRETO: Browser nÃ£o separa mais o cabeÃ§alho do corpo da tabela
    âœ… COLUNA TAREFA: Mantida em 35% largura â†’ texto completo visÃ­vel
    âœ… CABEÃ‡ALHO: Mantido com borda inferior, fontes maiores, formataÃ§Ã£o profissional
    âœ… BADGES: Mantidos maiores (3px/8px padding, 7.5pt) e mais legÃ­veis
    
    ğŸ”’ v3.8.3.10.27.17: FIX PERMISSÃ•ES PLANEAMENTO + FIX CONTAGEM! âœ…
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âœ… PERMISSÃ•ES PLANEAMENTO: Bloqueio real em updateTaskHours, updateTaskResponsible, savePlanning
    âœ… BLOQUEIO BD: Utilizadores sem podeEditarPlaneamento NÃƒO conseguem gravar
    âœ… FEEDBACK: Toast "ğŸ”’ Sem permissÃ£o para editar o planeamento"
    âœ… CONTAGEM CORRIGIDA: Respeita filtros de Estado (Novo, Em curso, Resolvido)
    âœ… SINCRONIZAÃ‡ÃƒO: NÃºmero de OTs no dropdown = nÃºmero de OTs na lista
    âœ… ATUALIZAÃ‡ÃƒO DINÃ‚MICA: Contagem atualiza quando filtros mudam
    
    ğŸ‰ v3.8.3.10.27.16: 23 PÃGINAS â†’ 9 PÃGINAS! âœ…
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âœ… FIX PÃGINAS 10-23 BRANCAS: max-height: 0 em elementos escondidos
    âœ… 14 PÃGINAS ELIMINADAS: De 23 pÃ¡ginas â†’ 9 pÃ¡ginas (61% menos!)
    âœ… SOLUÃ‡ÃƒO DEFINITIVA: Elementos com visibility:hidden nÃ£o ocupam espaÃ§o
    âœ… MANTÃ‰M TUDO PERFEITO: Landscape, descriÃ§Ã£o visÃ­vel, cabeÃ§alhos, grupos
    
    ğŸ“ v3.8.3.10.27.15: LANDSCAPE + SEM PÃGINAS BRANCAS! âœ…
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âœ… LANDSCAPE (HORIZONTAL): A4 landscape para descriÃ§Ã£o visÃ­vel completa
    âœ… SEM PÃGINAS BRANCAS: Margens e espaÃ§amentos otimizados (10mm)
    âœ… DESCRIÃ‡ÃƒO VISÃVEL: Mais espaÃ§o horizontal = descriÃ§Ãµes completas
    âœ… MARGENS REDUZIDAS: 12mm â†’ 10mm (mais espaÃ§o Ãºtil)
    âœ… PADDING REDUZIDO: CabeÃ§alhos e cÃ©lulas com menos espaÃ§amento
    
    ğŸš¨ v3.8.3.10.27.14: FIX CRÃTICO - PÃGINA BRANCA CORRIGIDA! âœ…
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âœ… PÃGINA BRANCA CORRIGIDA: visibility: hidden + visible (em vez de display: none)
    âœ… CONTEÃšDO VISÃVEL: RelatÃ³rio agora aparece na prÃ©-visualizaÃ§Ã£o de impressÃ£o
    âœ… CABEÃ‡ALHO REPETIDO: Mantido em TODAS as pÃ¡ginas (display: table-header-group)
    âœ… GRUPOS INTACTOS: NÃ£o quebram entre pÃ¡ginas (page-break-after: avoid)
    âœ… POSICIONAMENTO: position: absolute + z-index: 9999 (garante visibilidade)
    
    ğŸ–¨ï¸ v3.8.3.10.27.13: FIX IMPRESSÃƒO FINAL - CABEÃ‡ALHOS REPETIDOS! âœ…
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âœ… CABEÃ‡ALHO REPETIDO: Agora aparece em TODAS as pÃ¡ginas (display: table-header-group)
    âœ… GRUPOS INTACTOS: NÃ£o quebram entre pÃ¡ginas (page-break-after: avoid)
    âœ… SEM Ã“RFÃƒS: MÃ­nimo 2 linhas juntas (orphans: 2, widows: 2)
    âœ… LAYOUT PERFEITO: 100% IGUAL ao PDF fornecido
    
    âœ¨ v3.8.3.10.27.11: DETECÃ‡ÃƒO HÃBRIDA + RELATÃ“RIO IMPRIMÃVEL DE OTs (2026-02-02) ğŸ–¨ï¸
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âœ… FIX FOTO FECHO: Pasta separada (ot-fecho/) para evitar substituiÃ§Ã£o
    âœ… FIX DASHBOARD: Card 'Abertas Esta Semana' agora conta TODAS (nÃ£o sÃ³ nÃ£o resolvidas)
    âœ… LIMPEZA: Removidos 40 ficheiros debug/temp + 7 console.logs
    âœ… STORAGE PDF: DocumentaÃ§Ã£o completa para corrigir upload de PDFs
    âœ… DETECÃ‡ÃƒO ÃNDICES: GPT-4 Vision detecta Ã­ndices por LAYOUT (tipo: "indice")
    âœ… THRESHOLDS REDUZIDOS: tableScore 18â†’12, diagramScore 15â†’10 (detecta mais esquemas)
    âœ… RAIO ADJACÃŠNCIA: 3.0Ã—â†’5.0Ã— (125px, evita fragmentaÃ§Ã£o de esquemas)
    âœ… TAMANHO MÃNIMO: 80Ã—80â†’50Ã—50px (captura esquemas/Ã­ndices menores)
    âœ… ASPECT RATIO: 0.5-2.0â†’0.3-3.5 (aceita esquemas mais alongados)
    âœ… METADATA SEM NÃšMERO: Ãndices/esquemas sem nÃºmero agora enviados ao Gemini
    âœ… DEBUG LOGS: Logs detalhados para diagnÃ³stico de GPT-4 Vision
    
    ğŸ”§ v3.8.2.16: FIX FILTRO - Filtro desativado temporariamente! ğŸ›
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âœ… PROBLEMA: Filtro inteligente estava MUITO AGRESSIVO
    âœ… EXEMPLO: Manual L04 tinha 4 secÃ§Ãµes, filtro sÃ³ enviava 3 ao Gemini
    âœ… CAUSA: SecÃ§Ãµes sem palavra "manutenÃ§Ã£o" eram excluÃ­das
    âœ… SOLUÃ‡ÃƒO: Desativar filtro TEMPORARIAMENTE (enviar todas as secÃ§Ãµes)
    âœ… RESULTADO: Gemini recebe TODO o conteÃºdo do manual (filtra ele mesmo)
    
    âœ¨ v3.8.2.15: SIMPLIFICAÃ‡ÃƒO - Remover TODOS os emojis! ğŸ§¹
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âœ… MUDANÃ‡A: Emojis sÃ£o desnecessÃ¡rios e causam problemas
    âœ… REMOVIDO: ğŸ“Š/ğŸ–¼ï¸ do tÃ­tulo das imagens
    âœ… SIMPLIFICADO: Regex apenas detecta [TABLE/DIAGRAM] (sem emojis)
    âœ… RESULTADO: TÃ­tulo limpo "Table" em vez de "ğŸ“Š Table"
    âœ… BENEFÃCIO: CÃ³digo mais simples, sem problemas de encoding!
    
    ğŸ› v3.8.2.13: FIX CLEAN HTML - Remover quebras de linha! ğŸ§¹
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âœ… SOLUÃ‡ÃƒO: HTML numa Ãºnica linha (sem \n) â†’ <img> nÃ£o Ã© quebrada
    
    ğŸ¯ v3.8.2.12: FIX FINAL - IMAGENS INLINE! ğŸ–¼ï¸âœ¨
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âœ… SOLUÃ‡ÃƒO: Substituir URLs por <img> INLINE antes de converter markdown
    âœ… RESULTADO: Imagens aparecem EXATAMENTE onde Gemini as menciona
    
    ğŸ› v3.8.2.11-WORKER: FIX CRÃTICO - Try-catch em JSON.stringify! ğŸ”§
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âœ… PROBLEMA: Worker retornava 500 sem detalhes
    âœ… SOLUÃ‡ÃƒO: Try-catch em 2 locais crÃ­ticos do Worker
    
    ğŸ¯ v3.8.2.10: CÃ“DIGO MÃNIMO - SEM ALTERAÃ‡Ã•ES PÃ“S-WORKER! ğŸ§¹
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âœ… REMOVIDAS: TODAS as "correÃ§Ãµes" frontend que adicionei hoje
    âœ… CÃ“DIGO: Processamento mÃ­nimo - Worker retorna, frontend renderiza
    âœ… SEM: VerificaÃ§Ãµes de URLs, sem failsafes, sem regex no contexto
    
    ğŸ¯ v3.8.2.7: FIX VERDADEIRO - GEMINI INSERE URLS INLINE ğŸ›ğŸ–¼ï¸
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âœ… DESCOBERTA: Problema era PROMPT do Gemini (URLs todas no final!)
    âœ… CORREÃ‡ÃƒO: InstruÃ§Ãµes novas - Gemini INSERE URLs inline apÃ³s cada menÃ§Ã£o
    âœ… Frontend simplificado: Gemini jÃ¡ organiza, frontend sÃ³ renderiza
    âœ… Exemplo: "Tabela 6:\n\nğŸ“Š [TABLE]: https://..." (inline!)
    âœ… NÃ£o agrupa URLs no final da resposta
    âœ… Remove caracteres ï¿½ isolados
    
    ğŸ¯ v3.8.2.6: ANÃLISE PROFUNDA (mas estava errado!)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âš ï¸ Sistema de marcadores complexo, mas o problema era outro!
    âš ï¸ Gemini estava colocando URLs todas no final (nÃ£o inline)
    
    ğŸ¯ v3.7.2.1: CORREÃ‡Ã•ES DE UX ğŸ¨
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âœ… BotÃ£o de alertas otimizado (apenas Ã­cone ğŸš¨, mostra alertas ao clicar)
    âœ… Filtro de equipamentos por empresa (MCF vs PSY)
    âœ… Dropdown desabilitado atÃ© empresa ser selecionada
    âœ… Componentes filtram por empresa E Ã¡rea
    
    ğŸ¯ v3.7.2.0: ALERTAS DE PRODUTIVIDADE ğŸš¨
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âœ… Banner de alerta para Marco e GonÃ§alo se tÃ©cnicos nÃ£o fecharem OTs
    âœ… VerificaÃ§Ã£o automÃ¡tica no Ãºltimo dia Ãºtil (Segunda-SÃ¡bado)
    âœ… LÃ³gica: Segundaâ†’SÃ¡bado, TerÃ§a-SÃ¡badoâ†’dia anterior, Domingoâ†’sem verificaÃ§Ã£o
    âœ… Alerta aparece 1x por dia, visual vermelho com botÃ£o "Entendido"
    âœ… Logs detalhados no Console (F12) para debug
    
    ğŸ¯ v3.7.1.4: FIX CRÃTICO - ERRO renderMovimentos() BLOQUEAVA ANÃLISES ğŸ›
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âœ… Removida referÃªncia a renderMovimentos() (funÃ§Ã£o obsoleta)
    âœ… Erro "renderMovimentos is not defined" estava a parar TODO o JavaScript
    âœ… window.atualizarAnalises agora Ã© definida corretamente
    âœ… AnÃ¡lises funcionam!
    
    ğŸ¯ v3.7.1.3: FIX CRÃTICO - ANÃLISES CARREGAM DADOS DO SUPABASE ğŸ›
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âœ… SincronizaÃ§Ã£o do Supabase ANTES de restaurar aba ativa
    âœ… Timeout aumentado (300msâ†’500ms) para garantir dados carregados
    âœ… Logs para debug na chamada de atualizarAnalises()
    âœ… Await explÃ­cito na sincronizaÃ§Ã£o para garantir ordem
    
    ğŸ¯ v3.7.1.2: CORREÃ‡Ã•ES CRÃTICAS - ANÃLISES & CHATBOT ğŸ›
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âœ… Removida declaraÃ§Ã£o window.atualizarAnalises = null (bug crÃ­tico)
    âœ… Try/catch em todas as funÃ§Ãµes de renderizaÃ§Ã£o de grÃ¡ficos
    âœ… ValidaÃ§Ã£o de Chart.js carregado
    âœ… Mensagens de erro mais claras no chatbot
    
    ğŸ¯ v3.7.1.1: PERMISSÃ•ES SIMPLIFICADAS ğŸ”
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âœ… Sistema de permissÃµes clarificado (Admin vs User)
    âœ… User pode ver mas nÃ£o editar Planeamento
    âœ… Utilizador registado automaticamente em movimentos
    âœ… Removido role "visualizador" (nÃ£o usado)
    
    ğŸ¯ v3.7.1.0: ASSOCIAÃ‡ÃƒO DE STOCKS A ORDENS DE TRABALHO ğŸ’°
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âœ… Modal de Baixa MÃºltipla de Stock (vÃ¡rios artigos de uma vez)
    âœ… AssociaÃ§Ã£o opcional de movimentos a OTs (campo pedidoId)
    âœ… BotÃ£o "Dar Baixa de Stock" no modal de detalhes da OT
    âœ… SecÃ§Ã£o "Materiais Usados" mostrando custos por OT
    âœ… Rastreabilidade completa: artigo, qtd, responsÃ¡vel, data, custo
    âœ… CÃ¡lculo automÃ¡tico de custo total da OT
    âœ… Suporta baixas sem OT (consumÃ­veis gerais)
    
    ğŸ¯ v3.7.0.11: HistÃ³rico de Movimentos reformulado
    ğŸ¯ v3.7.0.10: Badges melhorados + Prioridade opcional
    
    ğŸ¯ v3.7.0.8: PREVENTIVAS COMPLETAS + CHATBOT IA (GEMINI 2.5 FLASH)
    ğŸ§¹ v3.6.7: Limpeza profunda (â†“25% ficheiros, â†“30% tamanho, zero 404)
-->
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="ManutenÃ§Ã£o MCF+PSY">
    <title>GestÃ£o de manutenÃ§Ã£o MCF + PSY</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/appmanutencao/manifest.json">
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/appmanutencao/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/appmanutencao/icons/favicon-16x16.png">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/appmanutencao/icons/apple-touch-icon-180x180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/appmanutencao/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/appmanutencao/icons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/appmanutencao/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/appmanutencao/icons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/appmanutencao/icons/apple-touch-icon-60x60.png">
    
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileColor" content="#000000">
    
    <!-- Preload logo for faster loading -->
    <link rel="preload" href="./icons/android-chrome-192x192.png" as="image" type="image/png">
    <style>
        /* ===================================
           App de ManutenÃ§Ã£o - Estilo Apple (INLINE)
           =================================== */
        
        /* Reset e VariÃ¡veis */
        :root {
            /* Cores Apple */
            --color-white: #FFFFFF;
            --color-background: #F5F5F7;
            --color-text-primary: #1D1D1F;
            --color-text-secondary: #86868B;
            --color-blue: #007AFF;
            --color-blue-dark: #0051D5;
            --color-border: #D2D2D7;
            --color-shadow: rgba(0, 0, 0, 0.1);
            
            /* Cores de Prioridade */
            --color-alta: #FF3B30;
            --color-media: #FF9500;
            --color-baixa: #34C759;
            
            /* Cores de Estado */
            --color-novo: #007AFF;
            --color-emcurso: #FF9500;
            --color-resolvido: #34C759;
            
            /* Tipografia - System Fonts */
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-weight-regular: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            
            /* EspaÃ§amento */
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-full: 999px;
            
            /* Sombras */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            
            /* TransiÃ§Ãµes */
            --transition-fast: 0.15s ease;
            --transition-base: 0.3s ease;
            --transition-slow: 0.5s ease;
        }
        
        /* Reset Global */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            max-width: 100%;
        }
        
        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            max-width: 100vw;
            overflow-x: hidden;
        }
        
        body {
            font-family: var(--font-family);
            font-weight: var(--font-weight-regular);
            color: var(--color-text-primary);
            background-color: var(--color-background);
            line-height: 1.5;
            min-height: 100vh;
            overflow-x: hidden;
            width: 100%;
        }
        
        /* Header */
        .app-header {
            background: var(--color-white);
            border-bottom: 1px solid var(--color-border);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.8);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-header h1 {
            font-size: 1.5rem;
            font-weight: var(--font-weight-semibold);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .header-icon {
            width: 28px;
            height: 28px;
            color: var(--color-blue);
            flex-shrink: 0;
            /* Remover fundo branco */
            border-radius: 50%;
            background: transparent;
        }
        
        /* EspecÃ­fico para IMG (nÃ£o SVG) */
        img.header-icon {
            width: 32px !important;
            height: 32px !important;
            object-fit: contain;
        }
        
        @media (max-width: 768px) {
            .header-icon {
                width: 20px !important;
                height: 20px !important;
            }
            
            img.header-icon {
                width: 24px !important;
                height: 24px !important;
            }
        }
        
        /* Main Content */
        .app-main {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-lg);
            width: 100%;
            overflow-x: hidden;
        }
        
        .container {
            width: 100%;
        }
        
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            background: var(--color-white);
            padding: 4px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
        }
        
        .tab-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            background: transparent;
            color: var(--color-text-secondary);
            font-size: 0.9375rem;
            font-weight: var(--font-weight-medium);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .tab-btn svg {
            width: 20px;
            height: 20px;
        }
        
        .tab-btn.active {
            background: var(--color-blue);
            color: var(--color-white);
        }
        
        .tab-btn:hover:not(.active) {
            background: var(--color-background);
        }
        
        /* âœ… NOVO: Badge de alertas no botÃ£o tab */
        .alert-badge {
            background: #d32f2f;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.7rem;
            margin-left: 6px;
            font-weight: var(--font-weight-semibold);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* âœ… NOVO: Badges de status de stock */
        .badge-critico {
            background: #d32f2f;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: var(--font-weight-semibold);
        }
        
        .badge-alerta {
            background: #f57c00;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: var(--font-weight-semibold);
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* âœ… CORREÃ‡ÃƒO v3.6.22: Esconder tabs durante carregamento (evita flash) */
        body.app-loading .tab-content {
            visibility: hidden !important;
        }
        
        body.app-loading .tabs {
            visibility: hidden !important;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Card */
        .card {
            background: var(--color-white);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-lg);
        }
        
        .card-title {
            font-size: 1.5rem;
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-lg);
            color: var(--color-text-primary);
        }
        
        /* Form */
        .maintenance-form {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }
        
        .form-label {
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
        }
        
        .form-input {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-family: var(--font-family);
            color: var(--color-text-primary);
            background: var(--color-white);
            transition: all var(--transition-fast);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--color-blue);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }
        
        textarea.form-input {
            resize: vertical;
            min-height: 100px;
        }
        
        select.form-input {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2386868B' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }
        
        /* Priority Selector */
        .priority-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
        }
        
        .priority-option {
            position: relative;
            cursor: pointer;
        }
        
        .priority-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }
        
        .priority-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-md);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
            transition: all var(--transition-fast);
        }
        
        .priority-label svg {
            width: 24px;
            height: 24px;
        }
        
        .priority-alta .priority-label {
            color: var(--color-alta);
        }
        
        .priority-media .priority-label {
            color: var(--color-media);
        }
        
        .priority-baixa .priority-label {
            color: var(--color-baixa);
        }
        
        .priority-option input[type="radio"]:checked + .priority-label {
            border-width: 2px;
        }
        
        .priority-alta input[type="radio"]:checked + .priority-label {
            border-color: var(--color-alta);
            background: rgba(255, 59, 48, 0.05);
        }
        
        .priority-media input[type="radio"]:checked + .priority-label {
            border-color: var(--color-media);
            background: rgba(255, 149, 0, 0.05);
        }
        
        .priority-baixa input[type="radio"]:checked + .priority-label {
            border-color: var(--color-baixa);
            background: rgba(52, 199, 89, 0.05);
        }
        
        /* âœ… Priority Selector Inline (Modal) */
        .detail-priority-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .priority-option-inline {
            cursor: pointer;
            position: relative;
        }
        
        .priority-option-inline input[type="radio"] {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }
        
        .priority-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .priority-badge svg {
            width: 14px;
            height: 14px;
        }
        
        .priority-alta {
            color: #ff3b30;
            background: rgba(255, 59, 48, 0.1);
        }
        
        .priority-option-inline.active .priority-alta,
        .priority-option-inline:hover .priority-alta {
            border-color: #ff3b30;
            background: rgba(255, 59, 48, 0.2);
        }
        
        .priority-media {
            color: #ff9500;
            background: rgba(255, 149, 0, 0.1);
        }
        
        .priority-option-inline.active .priority-media,
        .priority-option-inline:hover .priority-media {
            border-color: #ff9500;
            background: rgba(255, 149, 0, 0.2);
        }
        
        .priority-baixa {
            color: #34c759;
            background: rgba(52, 199, 89, 0.1);
        }
        
        .priority-option-inline.active .priority-baixa,
        .priority-option-inline:hover .priority-baixa {
            border-color: #34c759;
            background: rgba(52, 199, 89, 0.2);
        }
        
        /* File Upload */
        .file-upload {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--color-text-secondary);
            font-size: 0.9375rem;
        }
        
        .file-label svg {
            width: 24px;
            height: 24px;
            color: var(--color-blue);
        }
        
        .file-label:hover {
            border-color: var(--color-blue);
            background: rgba(0, 122, 255, 0.03);
        }
        
        .image-preview {
            display: none;
            position: relative;
        }
        
        .image-preview.active {
            display: block;
        }
        
        .image-preview img {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: var(--radius-md);
        }
        
        .image-preview .remove-image {
            position: absolute;
            top: var(--spacing-sm);
            right: var(--spacing-sm);
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            background: rgba(0, 0, 0, 0.6);
            border: none;
            color: var(--color-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            backdrop-filter: blur(10px);
        }
        
        .image-preview .remove-image svg {
            width: 16px;
            height: 16px;
        }
        
        .image-preview .remove-image:hover {
            background: rgba(0, 0, 0, 0.8);
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-full);
            font-size: 1rem;
            font-weight: var(--font-weight-medium);
            font-family: var(--font-family);
            cursor: pointer;
            transition: all var(--transition-fast);
            text-decoration: none;
        }
        
        .btn svg {
            width: 20px;
            height: 20px;
        }
        
        .btn-primary {
            background: var(--color-blue);
            color: var(--color-white);
        }
        
        .btn-primary:hover {
            background: var(--color-blue-dark);
        }
        
        .btn-primary:active {
            transform: scale(0.98);
        }
        
        .btn-secondary {
            background: var(--color-background);
            color: var(--color-text-primary);
        }
        
        .btn-secondary:hover {
            background: var(--color-border);
        }
        
        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            border-radius: var(--radius-full);
            background: transparent;
            color: var(--color-blue);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .btn-icon svg {
            width: 24px;
            height: 24px;
            stroke: currentColor;
        }
        
        .btn-icon:hover {
            background: var(--color-background);
        }
        
        /* ğŸ†• v3.8.3.10.27.11: BotÃ£o de imprimir relatÃ³rio com hover */
        #btnImprimirRelatorio:hover {
            background: #2563EB !important;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-text {
            padding: var(--spacing-xs) var(--spacing-md);
            border: none;
            background: transparent;
            color: var(--color-blue);
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .btn-text:hover {
            opacity: 0.7;
        }
        
        .form-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
            margin-top: var(--spacing-md);
        }
        
        /* Filters */
        .filters-card {
            margin-bottom: var(--spacing-lg);
        }
        
        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }
        
        .filters-header h3 {
            font-size: 1.125rem;
            font-weight: var(--font-weight-semibold);
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-lg);
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        
        .filter-label {
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            cursor: pointer;
            font-size: 0.9375rem;
            color: var(--color-text-primary);
        }
        
        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--color-blue);
        }
        
        /* List Header */
        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }
        
        .list-info {
            font-size: 0.9375rem;
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
        }
        
        /* Requests List */
        .requests-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        .request-card {
            background: var(--color-white);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
            border: 1px solid transparent;
        }
        
        .request-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--color-border);
            transform: translateY(-2px);
        }
        
        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-sm);
        }
        
        .request-badges {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .badge {
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: var(--font-weight-medium);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-tipo {
            background: var(--color-background);
            color: var(--color-text-primary);
        }
        
        .badge-prioridade {
            color: var(--color-white);
        }
        
        .badge-prioridade.alta {
            background: var(--color-alta);
        }
        
        .badge-prioridade.media {
            background: var(--color-media);
        }
        
        .badge-prioridade.baixa {
            background: var(--color-baixa);
        }
        
        .badge-estado {
            color: var(--color-white);
        }
        
        .badge-estado.novo {
            background: var(--color-novo);
        }
        
        .badge-estado.emcurso {
            background: var(--color-emcurso);
        }
        
        .badge-estado.resolvido {
            background: var(--color-resolvido);
        }
        
        .request-date {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
        }
        
        .request-body {
            margin-bottom: var(--spacing-sm);
        }
        
        .request-body h4 {
            font-size: 1rem;
            font-weight: var(--font-weight-semibold);
            margin-bottom: 4px;
        }
        
        .request-body p {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .request-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: var(--spacing-sm);
            border-top: 1px solid var(--color-background);
        }
        
        .request-meta {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            font-size: 0.875rem;
            color: var(--color-text-secondary);
        }
        
        .request-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .request-meta svg {
            width: 16px;
            height: 16px;
        }
        
        .request-actions {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .request-actions .btn-icon {
            width: 32px;
            height: 32px;
        }
        
        .request-actions .btn-icon svg {
            width: 18px;
            height: 18px;
        }
        
        /* Empty State */
        .empty-state {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-xl);
            text-align: center;
        }
        
        .empty-state.active {
            display: flex;
        }
        
        .empty-state svg {
            width: 64px;
            height: 64px;
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-md);
        }
        
        .empty-state h3 {
            font-size: 1.25rem;
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-xs);
        }
        
        .empty-state p {
            font-size: 0.9375rem;
            color: var(--color-text-secondary);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-lg);
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            animation: fadeIn var(--transition-base);
        }
        
        .modal-content {
            position: relative;
            background: var(--color-white);
            border-radius: var(--radius-lg);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            animation: slideUp var(--transition-base);
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--color-background);
        }
        
        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: var(--font-weight-semibold);
        }
        
        .btn-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--color-background);
            border-radius: var(--radius-full);
            color: var(--color-text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }
        
        .btn-close svg {
            width: 16px;
            height: 16px;
        }
        
        .btn-close:hover {
            background: var(--color-border);
        }
        
        .modal-body {
            padding: var(--spacing-lg);
            overflow-y: auto;
        }
        
        .detail-group {
            margin-bottom: var(--spacing-lg);
        }
        
        .detail-label {
            font-size: 0.75rem;
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .detail-value {
            font-size: 1rem;
            color: var(--color-text-primary);
        }
        
        .detail-badges {
            display: flex;
            gap: var(--spacing-xs);
            flex-wrap: wrap;
        }
        
        .detail-image {
            width: 100%;
            border-radius: var(--radius-md);
            margin-top: var(--spacing-xs);
        }
        
        .modal-actions {
            display: flex;
            gap: var(--spacing-sm);
            padding: var(--spacing-lg);
            border-top: 1px solid var(--color-background);
            background: var(--color-background);
        }
        
        .modal-actions .btn {
            flex: 1;
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            pointer-events: none;
        }
        
        .toast {
            background: var(--color-white);
            color: var(--color-text-primary);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            min-width: 300px;
            pointer-events: auto;
            animation: slideInRight var(--transition-base);
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .toast.success {
            border-left: 4px solid var(--color-resolvido);
        }
        
        .toast.error {
            border-left: 4px solid var(--color-alta);
        }
        
        .toast.info {
            border-left: 4px solid var(--color-blue);
        }
        
        .toast svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        
        .toast.success svg {
            color: var(--color-resolvido);
        }
        
        .toast.error svg {
            color: var(--color-alta);
        }
        
        .toast.info svg {
            color: var(--color-blue);
        }
        
        .toast-message {
            flex: 1;
            font-size: 0.9375rem;
        }
        
        /* Loading State */
        .btn.loading {
            pointer-events: none;
            opacity: 0.7;
            position: relative;
        }
        
        .btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* ===================================
           ManutenÃ§Ãµes AutÃ³nomas Tab
           =================================== */
        
        .card-description {
            color: var(--color-text-secondary);
            font-size: 0.9375rem;
            line-height: 1.6;
            margin-bottom: var(--spacing-lg);
        }
        
        /* PDF Actions */
        .pdf-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-lg);
            flex-wrap: wrap;
        }
        
        .pdf-actions .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .pdf-actions .btn svg {
            width: 18px;
            height: 18px;
        }
        
        /* PDF Viewer Container */
        .pdf-viewer-container {
            margin-top: var(--spacing-lg);
            padding: 0;
            overflow: hidden;
        }
        
        .pdf-viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--color-border);
            background-color: var(--color-background);
        }
        
        .pdf-viewer-header h3 {
            font-size: 1.125rem;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin: 0;
        }
        
        .pdf-viewer {
            width: 100%;
            height: 80vh;
            min-height: 600px;
            background-color: #525659;
            position: relative;
        }
        
        .pdf-viewer iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* Loading State for PDF */
        .pdf-viewer.loading::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 3px solid var(--color-border);
            border-top-color: var(--color-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .pdf-viewer.loading::after {
            content: 'Carregando PDF...';
            position: absolute;
            top: calc(50% + 40px);
            left: 50%;
            transform: translateX(-50%);
            color: var(--color-white);
            font-size: 0.875rem;
            white-space: nowrap;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            html {
                font-size: 14px;
            }
            
            body {
                overflow-x: hidden;
            }
            
            .app-main {
                padding: 12px;
            }
            
            .header-content {
                padding: 10px 12px;
            }
            
            .app-header h1 {
                font-size: 1rem !important;
                gap: 6px !important;
            }
            
            .app-header h1 svg,
            .header-icon {
                width: 18px !important;
                height: 18px !important;
            }
            
            img.header-icon {
                width: 20px !important;
                height: 20px !important;
            }
            
            .btn-icon {
                width: 32px !important;
                height: 32px !important;
                padding: 6px !important;
            }
            
            .btn-icon svg {
                width: 18px !important;
                height: 18px !important;
            }
            
            .tab-nav {
                padding: 4px;
                gap: 4px;
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab-btn {
                flex: 0 0 auto !important;
                font-size: 0.7rem !important;
                padding: 8px 12px !important;
                min-width: 80px;
                flex-direction: column !important;
                gap: 4px !important;
            }
            
            .tab-btn svg {
                width: 20px !important;
                height: 20px !important;
                margin: 0 !important;
            }
            
            .card {
                padding: var(--spacing-md);
            }
            
            .card-title {
                font-size: 1.25rem;
            }
            
            .priority-selector {
                grid-template-columns: 1fr;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .form-actions .btn {
                width: 100%;
            }
            
            .modal {
                padding: 0;
            }
            
            .modal-content {
                max-height: 100vh;
                border-radius: 0;
            }
            
            .toast-container {
                left: var(--spacing-sm);
                right: var(--spacing-sm);
                top: var(--spacing-sm);
            }
            
            .toast {
                min-width: auto;
            }
        }
        
        /* Planeamento / Planning Grid */
        .planning-controls {
            margin-bottom: var(--spacing-lg);
        }
        
        .planning-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }
        
        .planning-header h2 {
            margin: 0;
        }
        
        .planning-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .planning-range {
            font-size: 0.9375rem;
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            padding: 0 var(--spacing-sm);
        }
        
        .planning-filters {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }
        
        .planning-grid-container {
            overflow-x: auto;
            padding: 0;
            -webkit-overflow-scrolling: touch;
            width: 100%;
        }
        
        .planning-scroll {
            overflow-x: auto;
            overflow-y: visible;
            -webkit-overflow-scrolling: touch;
            width: 100%;
        }
        
        .planning-grid {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .planning-grid th,
        .planning-grid td {
            padding: var(--spacing-sm);
            text-align: center;
            border: 1px solid var(--color-border);
        }
        
        .planning-grid th {
            background: var(--color-background);
            font-weight: var(--font-weight-semibold);
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.875rem;
        }
        
        .planning-grid th.task-header {
            text-align: left;
            min-width: 250px;
            max-width: 350px;
        }
        
        .planning-grid th.responsible-header {
            text-align: left;
            min-width: 120px;
            width: 150px;
        }
        
        .planning-grid th.hours-header {
            text-align: center;
            min-width: 80px;
            width: 80px;
        }
        
        .planning-grid th.date-header {
            min-width: 70px;
            writing-mode: horizontal-tb;
        }
        
        .planning-grid th.weekend {
            background: #f0f0f0;
            color: var(--color-text-secondary);
        }
        
        .planning-grid td.task-cell {
            text-align: left;
            font-size: 0.875rem;
            background: var(--color-white);
        }
        
        .planning-grid td.responsible-cell {
            text-align: left;
            font-size: 0.875rem;
            background: var(--color-white);
            color: var(--color-text-primary);
            font-weight: var(--font-weight-medium);
            padding: var(--spacing-xs);
        }
        
        /* âœ… NOVO: Estilo para select de responsÃ¡vel */
        .planning-grid .responsible-select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-size: 0.875rem;
            background-color: var(--color-white);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: border-color 0.2s ease;
        }
        
        .planning-grid .responsible-select:hover {
            border-color: var(--color-primary);
        }
        
        .planning-grid .responsible-select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        .planning-grid td.hours-cell {
            text-align: center;
            background: var(--color-white);
            padding: var(--spacing-xs);
        }
        
        .hours-input {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            text-align: center;
            font-family: var(--font-family);
            transition: all var(--transition-fast);
        }
        
        .hours-input:focus {
            outline: none;
            border-color: var(--color-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .hours-input::-webkit-inner-spin-button,
        .hours-input::-webkit-outer-spin-button {
            opacity: 1;
        }
        
        .planning-grid td.date-cell {
            cursor: pointer;
            transition: all var(--transition-fast);
            background: var(--color-white);
            position: relative;
        }
        
        .planning-grid td.date-cell:hover {
            background: var(--color-background);
        }
        
        .planning-grid td.date-cell.allocated {
            background: var(--color-blue);
            color: var(--color-white);
            font-weight: var(--font-weight-bold);
        }
        
        .planning-grid td.date-cell.allocated::after {
            content: 'X';
            font-size: 1.125rem;
        }
        
        /* ğŸ†• v3.8.3.10.23: Preventivas = VERDE */
        .planning-grid td.date-cell.allocated.preventiva {
            background: #34C759;  /* Verde */
        }
        
        .planning-grid td.date-cell.weekend.allocated.preventiva {
            background: #34C759;  /* Verde */
            opacity: 0.8;
        }
        
        .planning-grid td.date-cell.weekend {
            background: #f9f9f9;
        }
        
        .planning-grid td.date-cell.weekend:hover {
            background: #f0f0f0;
        }
        
        .planning-grid td.date-cell.weekend.allocated {
            background: var(--color-blue);
            opacity: 0.8;
        }
        
        .task-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .task-title {
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .task-meta {
            display: flex;
            gap: var(--spacing-xs);
            flex-wrap: wrap;
        }
        
        .task-responsible {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .task-responsible svg {
            width: 12px;
            height: 12px;
        }
        
        .planning-legend {
            margin-top: var(--spacing-lg);
        }
        
        .planning-legend h3 {
            font-size: 1rem;
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-md);
        }
        
        .legend-items {
            display: flex;
            gap: var(--spacing-lg);
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.875rem;
        }
        
        .legend-box {
            width: 40px;
            height: 30px;
            border: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-weight: var(--font-weight-bold);
        }
        
        .legend-box.allocated {
            background: var(--color-blue);
            color: var(--color-white);
        }
        
        .legend-box.weekend {
            background: #f9f9f9;
        }
        
        /* Responsivo - Planeamento */
        @media (max-width: 768px) {
            .planning-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .planning-actions {
                justify-content: space-between;
            }
            
            .planning-filters {
                flex-direction: column;
            }
            
            .planning-filters .btn {
                width: 100%;
            }
            
            .planning-grid {
                min-width: 600px;
            }
            
            .planning-grid th.task-header {
                min-width: 150px;
                max-width: 150px;
                font-size: 0.75rem;
            }
            
            .planning-grid th.responsible-header {
                min-width: 80px;
                font-size: 0.7rem;
            }
            
            .planning-grid th.hours-header {
                min-width: 50px;
                font-size: 0.7rem;
            }
            
            .planning-grid th.date-header {
                min-width: 50px;
                font-size: 0.7rem;
                padding: 4px;
            }
            
            .planning-grid td {
                padding: 6px;
                font-size: 0.75rem;
            }
            
            .hours-input {
                width: 45px;
                font-size: 0.75rem;
                padding: 2px 4px;
            }
            
            .legend-items {
                flex-direction: column;
            }
            
            /* PDF Viewer Mobile */
            .pdf-actions {
                flex-direction: column;
                gap: var(--spacing-xs);
            }
            
            .pdf-actions .btn {
                width: 100%;
                justify-content: center;
            }
            
            .pdf-viewer {
                height: 70vh;
                min-height: 400px;
            }
            
            .pdf-viewer-header {
                padding: var(--spacing-sm) var(--spacing-md);
            }
            
            .pdf-viewer-header h3 {
                font-size: 1rem;
            }
        }
        
        /* Mobile Pequeno (iPhone SE, etc) */
        @media (max-width: 480px) {
            .app-header h1 {
                font-size: 0.9rem !important;
            }
            
            .tab-btn {
                font-size: 0.65rem !important;
                padding: 6px 10px !important;
                min-width: 70px;
            }
            
            .tab-btn svg {
                width: 18px !important;
                height: 18px !important;
            }
            
            .app-main {
                padding: var(--spacing-sm);
            }
            
            .card {
                padding: var(--spacing-sm);
            }
            
            .card-title {
                font-size: 1.1rem;
            }
            
            .form-group label {
                font-size: 0.875rem;
            }
            
            .form-input,
            .form-select,
            .form-textarea {
                font-size: 0.875rem;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 0.875rem;
            }
            
            .planning-grid {
                min-width: 500px;
            }
            
            .planning-grid th.task-header {
                min-width: 120px;
                max-width: 120px;
            }
            
            .planning-grid th.responsible-header {
                min-width: 70px;
            }
            
            .planning-grid th.hours-header {
                min-width: 45px;
            }
            
            .planning-grid th.date-header {
                min-width: 45px;
                font-size: 0.65rem;
                padding: 2px;
            }
            
            .hours-input {
                width: 40px;
                font-size: 0.7rem;
            }
            
            .request-card {
                padding: var(--spacing-sm);
            }
            
            .request-header h3 {
                font-size: 1rem;
            }
            
            .badge {
                font-size: 0.7rem;
                padding: 2px 8px;
            }
            
            .pdf-viewer {
                height: 60vh;
                min-height: 300px;
            }
        }
        
        /* Mobile Extra Pequeno (iPhone 12/13/14 width) */
        @media (max-width: 400px) {
            .app-header h1 {
                font-size: 0.85rem !important;
            }
            
            .tab-btn {
                font-size: 0.6rem !important;
                padding: 6px 8px !important;
                min-width: 65px;
            }
            
            .tab-btn svg {
                width: 16px !important;
                height: 16px !important;
            }
        }
        
        /* Fix especÃ­fico Chrome iOS */
        @supports (-webkit-touch-callout: none) {
            @media (max-width: 768px) {
                .tab-btn {
                    -webkit-tap-highlight-color: transparent;
                    touch-action: manipulation;
                }
                
                .app-main {
                    padding: 10px !important;
                }
            }
        }
        
        /* Print Styles */
        /* ğŸ†• v3.8.3.10.27.10: Estilos do RelatÃ³rio de OTs */
        .relatorio-tabela {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .relatorio-tabela thead {
            background: #1E3A8A;
            color: white;
            font-weight: 600;
        }

        .relatorio-tabela thead th {
            padding: 12px 8px;
            text-align: center; /* ğŸ¯ Centralizado */
            border-right: 1px solid rgba(255,255,255,0.2);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* ğŸ¯ DESCRIÃ‡ÃƒO alinhada Ã  esquerda */
        .relatorio-tabela thead th:last-child {
            text-align: left;
        }

        .relatorio-tabela thead th:last-child {
            border-right: none;
        }

        .relatorio-tabela tbody tr {
            border-bottom: 1px solid #E5E7EB;
        }

        .relatorio-tabela tbody tr:nth-child(even) {
            background: #F9FAFB;
        }

        .relatorio-tabela tbody tr:hover {
            background: #EFF6FF;
        }

        .relatorio-tabela tbody td {
            padding: 10px 8px;
            vertical-align: top;
            border-right: 1px solid #E5E7EB;
            font-size: 11px;
        }

        .relatorio-tabela tbody td:last-child {
            border-right: none;
        }

        .relatorio-grupo-header {
            background: #F3F4F6;
            font-weight: 600;
            color: #1F2937;
            padding: 12px 8px;
            border-top: 2px solid #9CA3AF;
            border-bottom: 2px solid #9CA3AF;
        }

        .relatorio-subgrupo-header {
            background: #F9FAFB;
            font-weight: 600;
            color: #4B5563;
            padding: 10px 8px 10px 24px;
            border-bottom: 1px solid #D1D5DB;
            font-size: 12px;
        }

        .relatorio-item-row td {
            padding-left: 40px !important;
        }

        .badge-prioridade {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-prioridade.alta {
            background: #FEE2E2;
            color: #991B1B;
        }

        .badge-prioridade.media {
            background: #FEF3C7;
            color: #92400E;
        }

        .badge-prioridade.baixa {
            background: #DBEAFE;
            color: #1E40AF;
        }
        
        /* ğŸ†• v3.8.3.10.27.11: Badge para texto genÃ©rico (frequÃªncias, etc.) */
        .badge-prioridade:not(.alta):not(.media):not(.baixa) {
            background: #E0E7FF;
            color: #3730A3;
        }

        /* ğŸ–¨ï¸ REGRAS DE IMPRESSÃƒO - VERSÃƒO FINAL v3.8.3.10.27.15 */
        /* ğŸ†• v3.8.3.10.27.20: CSS de impressÃ£o do PLANEAMENTO */
        @media print {
            /* âœ… ConfiguraÃ§Ã£o de pÃ¡gina padrÃ£o */
            @page {
                size: A4 landscape;
                margin: 10mm;
            }
            
            body {
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* ğŸ¯ PLANEAMENTO: Quando body tem classe .printing-planning */
            body.printing-planning * {
                visibility: hidden !important;
                max-height: 0 !important;
                overflow: hidden !important;
            }
            
            body.printing-planning #planningPrintContainer,
            body.printing-planning #planningPrintContainer * {
                visibility: visible !important;
                max-height: none !important;
                overflow: visible !important;
            }
            
            /* ğŸ¯ v3.8.3.10.27.26: FORÃ‡AR visibilidade SEM quebrar display da tabela */
            body.printing-planning #planningPrintContainer table,
            body.printing-planning #planningPrintContainer table *,
            body.printing-planning #planningPrintContainer thead,
            body.printing-planning #planningPrintContainer thead *,
            body.printing-planning #planningPrintContainer tbody,
            body.printing-planning #planningPrintContainer tbody *,
            body.printing-planning #planningPrintContainer tr,
            body.printing-planning #planningPrintContainer tr *,
            body.printing-planning #planningPrintContainer th,
            body.printing-planning #planningPrintContainer th *,
            body.printing-planning #planningPrintContainer td,
            body.printing-planning #planningPrintContainer td *,
            body.printing-planning #planningPrintContainer th div,
            body.printing-planning #planningPrintContainer td div {
                visibility: visible !important;
                max-height: none !important;
                overflow: visible !important;
                /* âŒ NÃƒO FORÃ‡AR display: block - mantÃ©m display natural da tabela! */
            }
            
            body.printing-planning #planningPrintContainer {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                display: block !important;
            }
            
            /* ğŸ¨ Estilos especÃ­ficos para tabela de planeamento */
            body.printing-planning .planning-grid {
                width: 100% !important;
                border-collapse: collapse !important;
                font-size: 8pt !important;
                table-layout: auto !important;
            }
            
            body.printing-planning .planning-grid th,
            body.printing-planning .planning-grid td {
                border: 1px solid #D1D5DB !important;
                padding: 4px 6px !important;
                text-align: left !important;
                vertical-align: top !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
            }
            
            body.printing-planning .planning-grid thead {
                display: table-header-group !important;
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
            }
            
            body.printing-planning .planning-grid tbody {
                display: table-row-group !important;
            }
            
            body.printing-planning .planning-grid th {
                background-color: #1E3A8A !important;
                color: #FFFFFF !important;
                font-weight: bold !important;
                font-size: 8pt !important;
                padding: 6px 8px !important;
                text-align: center !important;
                vertical-align: middle !important;
                line-height: 1.3 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            /* ğŸ¯ v3.8.3.10.27.33: Estilizar linha de cabeÃ§alho dentro do tbody */
            body.printing-planning .planning-grid .header-row th {
                background-color: #1E3A8A !important;
                color: #FFFFFF !important;
                font-weight: bold !important;
                font-size: 8pt !important;
                padding: 6px 8px !important;
                text-align: center !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            body.printing-planning .planning-grid .header-row th > div {
                visibility: visible !important;
                display: block !important;
                max-height: none !important;
                overflow: visible !important;
            }
            
            /* ğŸ¯ v3.8.3.10.27.28: FORÃ‡AR visibilidade dos <div> dentro dos <th> */
            body.printing-planning .planning-grid th > div {
                visibility: visible !important;
                display: block !important;
                max-height: none !important;
                overflow: visible !important;
            }
            
            /* âœ… CabeÃ§alhos especÃ­ficos com alinhamento */
            body.printing-planning .task-header {
                text-align: left !important; /* Tarefa Ã  esquerda */
            }
            
            body.printing-planning .responsible-header {
                text-align: left !important; /* ResponsÃ¡vel Ã  esquerda */
            }
            
            body.printing-planning .task-cell {
                width: 35% !important; /* âœ… 35% da largura total para tarefa */
                min-width: 200px !important;
            }
            
            /* âœ… Estilo para nÃºmero da OT (nÃ£o quebrar) */
            body.printing-planning .task-cell span[style*="color: #3B82F6"] {
                white-space: nowrap !important;
                display: inline !important;
                font-weight: 700 !important;
                font-size: 8.5pt !important;
            }
            
            /* âœ… Estilo para task-info */
            body.printing-planning .task-info {
                display: block !important;
            }
            
            body.printing-planning .task-title {
                display: block !important;
                margin-bottom: 4px !important;
                line-height: 1.3 !important;
            }
            
            body.printing-planning .responsible-cell {
                width: 15% !important; /* âœ… 15% para responsÃ¡vel */
                min-width: 80px !important;
            }
            
            body.printing-planning .hours-cell {
                width: 5% !important; /* âœ… 5% para horas */
                min-width: 40px !important;
                text-align: center !important;
            }
            
            body.printing-planning .date-cell {
                width: 3% !important; /* âœ… 3% por dia (14 dias Ã— 3% = 42%) */
                min-width: 35px !important;
                text-align: center !important;
                font-size: 7pt !important; /* âœ… Fonte menor para caber melhor */
            }
            
            body.printing-planning .date-cell.allocated {
                background-color: #93C5FD !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            body.printing-planning .badge {
                padding: 3px 8px !important; /* âœ… Maior: 2pxâ†’3px, 6pxâ†’8px */
                border-radius: 4px !important;
                font-size: 7.5pt !important; /* âœ… Maior: 7ptâ†’7.5pt */
                font-weight: 700 !important; /* âœ… Mais negrito: 600â†’700 */
                white-space: nowrap !important;
                display: inline-block !important;
                margin-right: 5px !important;
                margin-bottom: 2px !important; /* âœ… EspaÃ§amento vertical */
                line-height: 1.2 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            body.printing-planning .badge-tipo {
                background-color: #DBEAFE !important;
                color: #1E40AF !important;
            }
            
            body.printing-planning .badge-prioridade {
                border: 1px solid !important;
            }
            
            body.printing-planning .badge-prioridade.alta {
                background-color: #FCA5A5 !important;
                color: #7F1D1D !important;
                border-color: #DC2626 !important;
            }
            
            body.printing-planning .badge-prioridade.media,
            body.printing-planning .badge-prioridade.mÃ©dia {
                background-color: #FCD34D !important;
                color: #78350F !important;
                border-color: #F59E0B !important;
            }
            
            body.printing-planning .badge-prioridade.baixa {
                background-color: #93C5FD !important;
                color: #1E3A8A !important;
                border-color: #3B82F6 !important;
            }
            
            /* ğŸ¯ RELATÃ“RIO: Quando NÃƒO tem classe .printing-planning (comportamento padrÃ£o) */
            body:not(.printing-planning) * {
                visibility: hidden !important;
                max-height: 0 !important;
                overflow: hidden !important;
            }
            
            body:not(.printing-planning) #modalRelatorio,
            body:not(.printing-planning) #modalRelatorio * {
                visibility: visible !important;
                max-height: none !important;
                overflow: visible !important;
            }
            
            /* Esconder elementos desnecessÃ¡rios dentro do modal do RELATÃ“RIO */
            body:not(.printing-planning) #modalRelatorio .modal-header,
            body:not(.printing-planning) #modalRelatorio .modal-footer,
            body:not(.printing-planning) #modalRelatorio .btn,
            body:not(.printing-planning) #modalRelatorio button {
                visibility: hidden !important;
                display: none !important;
            }

            /* âœ… Garantir que o relatÃ³rio seja visÃ­vel */
            body:not(.printing-planning) #modalRelatorio {
                visibility: visible !important;
                display: block !important;
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                background: white !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
                z-index: 9999 !important;
                page-break-after: auto !important; /* âœ… Evitar pÃ¡ginas em branco */
            }

            /* Ajustar modal-content */
            body:not(.printing-planning) #modalRelatorio .modal-content {
                visibility: visible !important;
                max-width: 100% !important;
                width: 100% !important;
                max-height: none !important;
                height: auto !important;
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 0 !important;
                transform: none !important;
                page-break-after: avoid !important;
            }

            /* Esconder header e footer do modal */
            body:not(.printing-planning) #modalRelatorio .modal-header,
            body:not(.printing-planning) #modalRelatorio .modal-footer {
                display: none !important;
                height: 0 !important;
            }

            /* Ajustar modal-body */
            body:not(.printing-planning) #modalRelatorio .modal-body {
                visibility: visible !important;
                display: block !important;
                padding: 0 !important;
                margin: 0 !important; /* âœ… Sem margens */
                overflow: visible !important;
                background: white !important;
                page-break-before: avoid !important; /* âœ… Evitar pÃ¡gina em branco antes */
            }

            /* Esconder resumo de filtros (caixa cinzenta) */
            body:not(.printing-planning) #modalRelatorio .modal-body > div:first-child {
                visibility: hidden !important;
                display: none !important;
            }

            /* CabeÃ§alho do relatÃ³rio */
            body:not(.printing-planning) #relatorioHeader {
                visibility: visible !important;
                display: block !important;
                text-align: center;
                margin-bottom: 10px; /* âœ… Reduzido: 15px â†’ 10px */
                page-break-after: avoid !important;
                page-break-inside: avoid !important;
            }
            
            body:not(.printing-planning) #relatorioHeader h1 {
                visibility: visible !important;
                font-size: 14pt;
                color: #1E3A8A !important;
                margin: 0 0 5px 0; /* âœ… Reduzido: 8px â†’ 5px */
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            body:not(.printing-planning) #relatorioHeader p {
                visibility: visible !important;
                font-size: 8pt; /* âœ… Reduzido: 9pt â†’ 8pt */
                color: #4B5563 !important;
                margin: 2px 0; /* âœ… Reduzido: 3px â†’ 2px */
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* Container do relatÃ³rio */
            body:not(.printing-planning) #relatorioContainer {
                visibility: visible !important;
                display: block !important;
                width: 100%;
                page-break-before: avoid !important; /* âœ… Evitar pÃ¡gina em branco antes */
            }

            /* Tabela */
            body:not(.printing-planning) .relatorio-tabela {
                visibility: visible !important;
                width: 100%;
                border-collapse: collapse;
                font-size: 8pt;
                page-break-after: auto;
                page-break-before: avoid !important; /* âœ… Evitar pÃ¡gina em branco antes da tabela */
            }

            body:not(.printing-planning) .relatorio-tabela thead {
                visibility: visible !important;
                display: table-header-group;
                page-break-after: avoid !important; /* âœ… Evitar quebra apÃ³s cabeÃ§alho */
            }
            
            body:not(.printing-planning) .relatorio-tabela tbody {
                visibility: visible !important;
                page-break-before: avoid !important; /* âœ… Evitar pÃ¡gina em branco antes do corpo */
            }
            
            body:not(.printing-planning) .relatorio-tabela tr,
            body:not(.printing-planning) .relatorio-tabela th,
            body:not(.printing-planning) .relatorio-tabela td {
                visibility: visible !important;
            }
            
            /* âœ… FORÃ‡AR repetiÃ§Ã£o do cabeÃ§alho em TODAS as pÃ¡ginas */
            body:not(.printing-planning) .relatorio-tabela thead tr {
                page-break-after: avoid !important;
                page-break-inside: avoid !important;
            }

            body:not(.printing-planning) .relatorio-tabela th {
                border: 1px solid #1E3A8A;
                padding: 4px 6px;
                text-align: left;
                font-size: 8pt;
                background-color: #1E3A8A !important;
                color: #FFFFFF !important;
                font-weight: bold;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            body:not(.printing-planning) .relatorio-tabela td {
                border: 1px solid #D1D5DB;
                padding: 4px 6px;
                font-size: 8pt;
                vertical-align: top;
                word-wrap: break-word;
            }

            /* CabeÃ§alhos de grupo (Empresa) */
            body:not(.printing-planning) .relatorio-grupo-header {
                page-break-after: avoid !important;
                page-break-inside: avoid !important;
                page-break-before: auto;
            }
            
            .relatorio-grupo-header td {
                background-color: #E5E7EB !important;
                font-weight: bold;
                font-size: 9pt !important;
                padding: 4px 8px !important; /* âœ… Reduzido: 6px â†’ 4px */
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* CabeÃ§alhos de Ã¡rea */
            body:not(.printing-planning) .relatorio-area-header {
                page-break-after: avoid !important;
                page-break-inside: avoid !important;
                page-break-before: auto;
            }
            
            body:not(.printing-planning) .relatorio-area-header td {
                background-color: #F3F4F6 !important;
                font-weight: 600;
                font-size: 8.5pt !important;
                padding: 3px 8px !important; /* âœ… Reduzido: 5px â†’ 3px */
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* Linhas de OT */
            body:not(.printing-planning) .relatorio-item-row {
                page-break-inside: avoid !important;
                page-break-before: auto;
            }

            /* Evitar quebra apÃ³s cabeÃ§alhos */
            body:not(.printing-planning) .relatorio-grupo-header + tr,
            body:not(.printing-planning) .relatorio-area-header + tr {
                page-break-before: avoid !important;
            }
            
            /* âœ… NOVO: Evitar Ã³rfÃ£s - manter pelo menos 2 linhas juntas */
            body:not(.printing-planning) .relatorio-item-row {
                orphans: 2;
                widows: 2;
            }

            body:not(.printing-planning) .relatorio-item-row td {
                vertical-align: top;
            }

            /* Manter cores dos badges de prioridade */
            body:not(.printing-planning) .badge-prioridade {
                padding: 2px 6px;
                border-radius: 3px;
                font-size: 7pt;
                font-weight: 600;
                white-space: nowrap;
                display: inline-block;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            body:not(.printing-planning) .badge-prioridade {
                padding: 0px 3px;
                border-radius: 2px;
                font-size: 5.5pt;
                font-weight: 600;
                white-space: nowrap;
                display: inline-block;
                line-height: 1.3;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            body:not(.printing-planning) .badge-prioridade.alta {
                background-color: #FCA5A5 !important;
                color: #7F1D1D !important;
                border: 1px solid #DC2626 !important;
            }

            body:not(.printing-planning) .badge-prioridade.media,
            body:not(.printing-planning) .badge-prioridade.mÃ©dia {
                background-color: #FCD34D !important;
                color: #78350F !important;
                border: 1px solid #F59E0B !important;
            }

            body:not(.printing-planning) .badge-prioridade.baixa {
                background-color: #93C5FD !important;
                color: #1E3A8A !important;
                border: 1px solid #3B82F6 !important;
            }

            /* CENÃRIO 2: ImpressÃ£o de OT individual */
            body:not(.printing-planning) #printContainer,
            body:not(.printing-planning) #printContainer * {
                visibility: visible !important;
            }
            
            /* Mostrar apenas o container de impressÃ£o */
            body:not(.printing-planning) #printContainer {
                display: block !important;
                width: 100%;
                max-width: 186mm;
                margin: 0;
                padding: 0;
                font-family: Arial, sans-serif;
                font-size: 9pt;
                line-height: 1.3;
                color: #000;
            }
            
            body:not(.printing-planning) #printContainer h1 {
                text-align: center;
                color: #667eea;
                border-bottom: 2px solid #667eea;
                padding-bottom: 6px;
                margin: 0 0 10px 0;
                font-size: 16pt;
            }
            
            body:not(.printing-planning) #printContainer .print-header {
                text-align: center;
                margin-bottom: 12px;
                font-size: 9pt;
            }
            
            body:not(.printing-planning) #printContainer .print-header p {
                margin: 2px 0;
            }
            
            body:not(.printing-planning) #printContainer .print-section {
                margin-bottom: 10px;
                page-break-inside: avoid;
            }
            
            body:not(.printing-planning) #printContainer .print-section h2 {
                color: #667eea;
                border-bottom: 1px solid #667eea;
                padding-bottom: 3px;
                margin: 0 0 6px 0;
                font-size: 12pt;
            }
            
            body:not(.printing-planning) #printContainer table {
                width: 100%;
                border-collapse: collapse;
            }
            
            body:not(.printing-planning) #printContainer td {
                padding: 3px 6px;
                border-bottom: 1px solid #ddd;
                vertical-align: top;
                font-size: 9pt;
            }
            
            #printContainer td:first-child {
                font-weight: bold;
                width: 38%;
            }
            
            #printContainer .description {
                white-space: pre-wrap;
                word-wrap: break-word;
                font-size: 9pt;
                line-height: 1.4;
            }
            
            #printContainer .photo-section {
                page-break-before: always;
                text-align: center;
            }
            
            #printContainer .photo-section img {
                max-width: 100%;
                max-height: 250mm;
                height: auto;
                display: block;
                margin: 8px auto;
            }
            
            #printContainer .print-footer {
                margin-top: 15px;
                padding-top: 8px;
                border-top: 1px solid #999;
                text-align: center;
                color: #666;
                font-size: 8pt;
            }
            
            #printContainer .print-footer p {
                margin: 2px 0;
            }
        }
        
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        /* ===================================
           STOCK MODULE - ESTILOS
           =================================== */
        
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }
        
        .stock-search {
            flex: 1;
            min-width: 250px;
            max-width: 500px;
        }
        
        .stock-filters {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }
        
        .familia-selector {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            background: var(--color-white);
            font-family: var(--font-family);
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .familia-selector:focus {
            outline: none;
            border-color: var(--color-blue);
        }
        
        .stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }
        
        .stock-card {
            background: var(--color-white);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-fast);
            border: 1px solid var(--color-border);
        }
        
        .stock-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .stock-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-sm);
        }
        
        .stock-familia-badge {
            font-size: 0.75rem;
            font-weight: var(--font-weight-semibold);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            background: rgba(0, 122, 255, 0.1);
            color: var(--color-blue);
            white-space: nowrap;
        }
        
        .stock-card-title {
            font-size: 1rem;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin: var(--spacing-xs) 0;
            line-height: 1.3;
        }
        
        .stock-card-ref {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            font-family: 'Courier New', monospace;
        }
        
        .stock-info {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            margin: var(--spacing-md) 0;
            padding: var(--spacing-sm);
            background: var(--color-background);
            border-radius: var(--radius-sm);
        }
        
        .stock-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
        }
        
        .stock-info-label {
            color: var(--color-text-secondary);
            font-weight: var(--font-weight-medium);
        }
        
        .stock-info-value {
            color: var(--color-text-primary);
            font-weight: var(--font-weight-semibold);
        }
        
        .stock-level {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .stock-level.baixo {
            color: var(--color-alta);
        }
        
        .stock-level.ok {
            color: var(--color-baixa);
        }
        
        .stock-level-icon {
            font-size: 1.2rem;
        }
        
        .stock-card-actions {
            display: flex;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-md);
        }
        
        .stock-btn {
            flex: 1;
            padding: var(--spacing-sm);
            border: none;
            border-radius: var(--radius-sm);
            font-family: var(--font-family);
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
        }
        
        .stock-btn-primary {
            background: var(--color-blue);
            color: var(--color-white);
        }
        
        .stock-btn-primary:hover {
            background: var(--color-blue-dark);
        }
        
        .stock-btn-secondary {
            background: var(--color-background);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
        }
        
        .stock-btn-secondary:hover {
            background: var(--color-border);
        }
        
        .stock-alerts {
            margin-bottom: var(--spacing-lg);
        }
        
        .alert-card {
            background: #FFF3CD;
            border: 1px solid #FFC107;
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .alert-card.critical {
            background: #F8D7DA;
            border-color: #F5C6CB;
        }
        
        .alert-title {
            font-size: 1rem;
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .alert-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }
        
        .alert-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-xs);
            background: rgba(255, 255, 255, 0.5);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
        }
        
        .movimento-form {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        .artigo-selected-info {
            background: var(--color-background);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
        }
        
        .artigo-selected-info h4 {
            margin-bottom: var(--spacing-xs);
            color: var(--color-text-primary);
        }
        
        .artigo-selected-info p {
            color: var(--color-text-secondary);
            font-size: 0.875rem;
            margin: 4px 0;
        }
        
        .quantidade-input-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .quantidade-btn {
            width: 40px;
            height: 40px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            background: var(--color-white);
            color: var(--color-text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }
        
        .quantidade-btn:hover {
            background: var(--color-background);
            border-color: var(--color-blue);
        }
        
        .quantidade-input {
            flex: 1;
            text-align: center;
            font-size: 1.2rem;
            font-weight: var(--font-weight-semibold);
        }
        
        .artigos-list {
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            background: var(--color-background);
            margin-top: var(--spacing-md);
        }
        
        .artigos-list-title {
            font-size: 0.875rem;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-sm);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .artigo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm);
            background: var(--color-white);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-xs);
        }
        
        .artigo-item-info {
            flex: 1;
        }
        
        .artigo-item-name {
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            font-size: 0.875rem;
        }
        
        .artigo-item-details {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            margin-top: 2px;
        }
        
        .artigo-item-remove {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--color-alta);
            color: var(--color-alta);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.75rem;
            transition: all var(--transition-fast);
        }
        
        .artigo-item-remove:hover {
            background: var(--color-alta);
            color: var(--color-white);
        }
        
        .artigos-total {
            margin-top: var(--spacing-sm);
            padding-top: var(--spacing-sm);
            border-top: 2px solid var(--color-border);
            font-weight: var(--font-weight-semibold);
            text-align: right;
            color: var(--color-text-primary);
        }
        
        @media (max-width: 768px) {
            .stock-grid {
                grid-template-columns: 1fr;
            }
            
            .stock-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stock-search {
                max-width: none;
            }
        }
        
        /* ===================================
           STOCK MODULE - NOVOS ESTILOS
           =================================== */
        
        .card-header-flex {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }
        
        .stock-table-container {
            overflow-x: auto;
            margin-top: var(--spacing-md);
        }
        
        .stock-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--color-white);
            font-size: 0.875rem;
        }
        
        .stock-table thead {
            background: var(--color-background);
            position: sticky;
            top: 0;
        }
        
        .stock-table th {
            padding: var(--spacing-sm) var(--spacing-md);
            text-align: left;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-secondary);
            border-bottom: 2px solid var(--color-border);
            white-space: nowrap;
        }
        
        .stock-table td {
            padding: var(--spacing-sm) var(--spacing-md);
            border-bottom: 1px solid var(--color-border);
            vertical-align: middle;
        }
        
        .stock-table tbody tr:hover {
            background: var(--color-background);
        }
        
        .stock-value {
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
        }
        
        .stock-value.baixo {
            color: var(--color-alta);
        }
        
        .stock-value.ok {
            color: var(--color-baixa);
        }
        
        .stock-actions {
            display: flex;
            gap: var(--spacing-xs);
            flex-wrap: nowrap;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.75rem;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: var(--font-weight-semibold);
            white-space: nowrap;
        }
        
        .badge-entrada {
            background: rgba(52, 199, 89, 0.1);
            color: var(--color-baixa);
        }
        
        .badge-saida {
            background: rgba(255, 59, 48, 0.1);
            color: var(--color-alta);
        }
        
        .badge-ajuste {
            background: rgba(255, 149, 0, 0.1);
            color: var(--color-media);
        }
        
        .empty-state-small {
            text-align: center;
            padding: var(--spacing-lg);
            color: var(--color-text-secondary);
            font-size: 0.875rem;
        }
        
        /* ğŸ“š ESTILOS DE MANUAIS */
        .manual-card {
            background: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            transition: all 0.3s ease;
        }
        
        .manual-card:hover {
            box-shadow: 0 4px 12px var(--color-shadow);
            border-color: var(--color-blue);
        }
        
        .manual-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-sm);
        }
        
        .manual-card-title {
            font-size: 1rem;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin: 0 0 4px 0;
        }
        
        .manual-card-equipment {
            font-size: 0.875rem;
            color: var(--color-blue);
            font-weight: var(--font-weight-medium);
        }
        
        .manual-card-description {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            margin: var(--spacing-sm) 0;
            line-height: 1.5;
        }
        
        .manual-card-meta {
            display: flex;
            gap: var(--spacing-md);
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            margin: var(--spacing-sm) 0;
        }
        
        .manual-card-actions {
            display: flex;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-sm);
        }
        
        .manual-status-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: var(--font-weight-medium);
        }
        
        .manual-status-processado {
            background: rgba(52, 199, 89, 0.1);
            color: var(--color-baixa);
        }
        
        .manual-status-pendente {
            background: rgba(255, 159, 10, 0.1);
            color: var(--color-media);
        }
        
        .stock-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: var(--spacing-md) 0 var(--spacing-sm) 0;
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--color-border);
        }
        
        .movimento-filters {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
            flex-wrap: wrap;
        }
        
        .movimento-filters .form-input {
            flex: 1;
            min-width: 150px;
        }
        
        .quantidade-badge {
            font-weight: var(--font-weight-bold);
            color: var(--color-text-primary);
        }
        
        .quantidade-badge.negativo {
            color: var(--color-alta);
        }
        
        .quantidade-badge.positivo {
            color: var(--color-baixa);
        }
        
        .badge-entrada {
            background: rgba(52, 199, 89, 0.1);
            color: var(--color-baixa);
        }
        
        .badge-saida {
            background: rgba(255, 59, 48, 0.1);
            color: var(--color-alta);
        }
        
        .badge-ajuste {
            background: rgba(255, 149, 0, 0.1);
            color: var(--color-media);
        }
        
        .stock-actions {
            display: flex;
            gap: var(--spacing-xs);
            flex-wrap: wrap;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 0.75rem;
        }
        
        .stock-value {
            font-weight: var(--font-weight-semibold);
        }
        
        .stock-value.baixo {
            color: var(--color-alta);
        }
        
        .stock-value.ok {
            color: var(--color-baixa);
        }
        
        .artigo-selected-info {
            padding: var(--spacing-md);
            background: var(--color-background);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
        }
        
        .artigo-selected-info h4 {
            margin-bottom: var(--spacing-xs);
            color: var(--color-text-primary);
        }
        
        .artigo-selected-info p {
            margin: var(--spacing-xs) 0;
            font-size: 0.875rem;
            color: var(--color-text-secondary);
        }
        
        /* SecÃ§Ã£o de Novo Movimento - Destacada */
        .card .btn-primary svg {
            display: inline-block;
            vertical-align: middle;
        }
        
        /* Stock Cards Grid */
        .stock-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }
        
        .stock-card {
            background: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }
        
        .stock-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .stock-card-header {
            margin-bottom: var(--spacing-sm);
        }
        
        .stock-card-title {
            font-size: 1rem;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin-bottom: var(--spacing-xs);
        }
        
        .stock-card-ref {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            font-family: 'Courier New', monospace;
        }
        
        .stock-card-body {
            margin-bottom: var(--spacing-md);
        }
        
        .stock-card-info {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            font-size: 0.875rem;
        }
        
        .stock-card-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stock-card-info-label {
            color: var(--color-text-secondary);
        }
        
        .stock-card-info-value {
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
        }
        
        .stock-card-stock {
            background: var(--color-background);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm);
            margin: var(--spacing-sm) 0;
            text-align: center;
        }
        
        .stock-card-stock-label {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .stock-card-stock-value {
            font-size: 1.5rem;
            font-weight: var(--font-weight-bold);
        }
        
        .stock-card-stock-value.baixo {
            color: var(--color-alta);
        }
        
        .stock-card-stock-value.ok {
            color: var(--color-baixa);
        }
        
        .stock-card-footer {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .stock-card-footer .btn {
            flex: 1;
        }
        
        @media (max-width: 768px) {
            .stock-cards-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .stock-table {
                font-size: 0.75rem;
            }
            
            .stock-table th,
            .stock-table td {
                padding: var(--spacing-xs) var(--spacing-sm);
            }
            
            .stock-actions {
                flex-direction: column;
            }
            
            .card-header-flex {
                flex-direction: column;
                align-items: stretch;
            }
        }
        
        /* ===================================
           TOAST NOTIFICATIONS
           =================================== */
        
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            pointer-events: none;
        }
        
        .toast {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background: var(--color-white);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 300px;
            max-width: 400px;
            pointer-events: auto;
            animation: slideInRight 0.3s ease;
        }
        
        .toast svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        
        .toast.success {
            border-left: 4px solid var(--color-baixa);
        }
        
        .toast.success svg {
            color: var(--color-baixa);
        }
        
        .toast.error {
            border-left: 4px solid var(--color-alta);
        }
        
        .toast.error svg {
            color: var(--color-alta);
        }
        
        .toast.info {
            border-left: 4px solid var(--color-blue);
        }
        
        .toast.info svg {
            color: var(--color-blue);
        }
        
        .toast-message {
            flex: 1;
            font-size: 0.875rem;
            color: var(--color-text-primary);
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        @media (max-width: 768px) {
            .toast-container {
                top: 60px;
                right: 10px;
                left: 10px;
            }
            
            .toast {
                min-width: auto;
                max-width: none;
            }
        }
        
        /* ============================================
           LOADING SPINNER - Feedback visual durante carregamento
           ============================================ */
        
        .loading-spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .loading-spinner-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-spinner-content {
            background: white;
            padding: 40px 60px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .spinner-circle {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner-message {
            margin: 0;
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }
        
        @media (max-width: 768px) {
            .loading-spinner-content {
                padding: 30px 40px;
            }
            
            .spinner-circle {
                width: 50px;
                height: 50px;
                border-width: 4px;
            }
            
            .spinner-message {
                font-size: 14px;
            }
        }
        
        /* ============================================
           LOGIN SCREEN - APPLE CLEAN STYLE
           ============================================ */
        
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #FFFFFF;
            display: none; /* Escondido por padrÃ£o - JS mostra se necessÃ¡rio */
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .login-screen.show {
            display: flex; /* Mostrar quando JS adicionar classe .show */
        }
        
        .login-card-wrapper {
            width: 100%;
            max-width: 420px;
            padding: 20px;
        }
        
        .login-card-apple {
            background: #FFFFFF;
            border-radius: 20px;
            padding: 48px 40px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
            border: 1px solid #E5E5E7;
            text-align: center;
            animation: fadeInUp 0.4s ease;
        }
        
        .login-logo-container {
            margin-bottom: 32px;
        }
        
        .login-logo {
            width: 120px;
            height: 120px;
            margin: 0 auto;
            display: block;
            /* Remover fundo branco da imagem */
            border-radius: 50%;
            padding: 10px;
            background: transparent;
            /* Adicionar sombra suave para destacar */
            filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.1));
        }
        
        img.login-logo {
            width: 140px !important;
            height: 140px !important;
            object-fit: contain;
            border-radius: 0;
            padding: 0;
        }
        
        .login-title-apple {
            font-size: 28px;
            font-weight: 600;
            color: #1D1D1F;
            margin: 0 0 8px 0;
            letter-spacing: -0.5px;
        }
        
        .login-subtitle-apple {
            font-size: 15px;
            color: #86868B;
            margin: 0 0 32px 0;
            font-weight: 400;
        }
        
        .login-form-apple {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .login-input-wrapper {
            position: relative;
        }
        
        .login-input-apple {
            width: 100%;
            padding: 16px 20px;
            border: 1px solid #D2D2D7;
            border-radius: 12px;
            font-size: 17px;
            font-family: var(--font-family);
            background: #FAFAFA;
            color: #1D1D1F;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }
        
        .login-input-apple::placeholder {
            color: #86868B;
        }
        
        .login-input-apple:focus {
            outline: none;
            border-color: #1D1D1F;
            background: #FFFFFF;
            box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.03);
        }
        
        .login-button-apple {
            width: 100%;
            padding: 16px 24px;
            background: #1D1D1F;
            color: #FFFFFF;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.2s ease;
            font-family: var(--font-family);
        }
        
        .login-button-apple:hover {
            background: #000000;
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }
        
        .login-button-apple:active {
            transform: translateY(0);
        }
        
        .login-button-apple:disabled {
            background: #D2D2D7;
            cursor: not-allowed;
            transform: none;
        }
        
        .login-error-apple {
            background: #FFEBEE;
            border: 1px solid #FFCDD2;
            color: #C62828;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 14px;
            text-align: center;
            margin: 8px 0;
            animation: shake 0.3s;
        }
        
        .login-hint-apple {
            margin-top: 24px;
            padding: 16px;
            background: #F5F5F7;
            border-radius: 12px;
            text-align: left;
        }
        
        .hint-title {
            font-size: 13px;
            font-weight: 600;
            color: #1D1D1F;
            margin-bottom: 8px;
        }
        
        .hint-credentials {
            font-size: 13px;
            color: #86868B;
            line-height: 1.6;
        }
        
        .hint-label {
            color: #1D1D1F;
            font-weight: 500;
        }
        
        .hint-credentials code {
            background: #FFFFFF;
            padding: 3px 8px;
            border-radius: 6px;
            color: #1D1D1F;
            font-size: 13px;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            border: 1px solid #E5E5E7;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        @media (max-width: 768px) {
            .login-card-apple {
                padding: 36px 28px;
            }
            
            .login-title-apple {
                font-size: 24px;
            }
            
            .login-logo {
                width: 80px;
                height: 80px;
            }
            
            img.login-logo {
                width: 100px !important;
                height: 100px !important;
                object-fit: contain;
            }
        }
        
        /* Estilos antigos mantidos para compatibilidade */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #FFFFFF;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .login-overlay.hidden { display: none; }
        
        .login-btn {
            background: #1D1D1F;
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s;
        }
        
        .login-btn:hover { transform: translateY(-2px); }
        .login-btn:active { transform: translateY(0); }
        .login-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .login-error {
            background: #ffebee;
            border: 1px solid #ef5350;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            animation: shake 0.3s;
        }
        
        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
            margin-right: 12px;
        }
        
        .user-info .user-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text-primary);
        }
        
        .user-info .user-dept {
            font-size: 12px;
            color: var(--color-text-secondary);
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 14px;
        }
        
        .logout-btn {
            background: transparent !important;
            border: 1px solid var(--color-border) !important;
            color: var(--color-text-primary) !important;
            width: 40px !important;
            height: 40px !important;
            padding: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .logout-btn:hover {
            background: var(--color-background);
            border-color: var(--color-blue);
            color: var(--color-blue);
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        /* ===================================
           TAB ANÃLISE - GrÃ¡ficos e Chatbot
           =================================== */
        
        /* Analytics Cards */
        .analytics-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }
        
        .analytics-card {
            background: var(--color-white);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            border: 1px solid var(--color-border);
            transition: all var(--transition-base);
        }
        
        .analytics-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .analytics-card-icon {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .analytics-card-icon svg {
            width: 28px;
            height: 28px;
        }
        
        .analytics-card-content {
            flex: 1;
        }
        
        .analytics-card-label {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-xs);
        }
        
        .analytics-card-value {
            font-size: 2rem;
            font-weight: var(--font-weight-bold);
            color: var(--color-text-primary);
        }
        
        .analytics-card-trend {
            font-size: 0.875rem;
            margin-top: var(--spacing-xs);
        }
        
        .analytics-card-trend.up {
            color: #f44336;
        }
        
        .analytics-card-trend.down {
            color: #4CAF50;
        }
        
        /* Analytics Filters */
        .analytics-filters {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
            flex-wrap: wrap;
        }
        
        .analytics-filters .form-input {
            flex: 1;
            min-width: 200px;
        }
        
        .analytics-filters .btn {
            white-space: nowrap;
        }
        
        /* Analytics Charts */
        .analytics-chart-container {
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-lg);
            background: var(--color-white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
        }
        
        .analytics-chart-title {
            font-size: 1.125rem;
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-lg);
            color: var(--color-text-primary);
        }
        
        .analytics-chart-container canvas {
            max-height: 400px;
        }
        
        /* Filtros de AnÃ¡lise */
        .filter-btn {
            padding: 6px 12px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            background: var(--color-white);
            color: var(--color-text-primary);
            cursor: pointer;
            font-size: 13px;
            font-family: var(--font-family);
            transition: all 0.2s ease;
        }
        
        .filter-btn:hover {
            background: var(--color-background);
        }
        
        .filter-btn.active {
            background: var(--color-blue);
            color: var(--color-white);
            border-color: var(--color-blue);
        }
        
        /* Chatbot */
        .chatbot-history {
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-md);
            background: var(--color-background);
            border-radius: var(--radius-md);
        }
        
        .chatbot-message {
            margin-bottom: var(--spacing-md);
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .chatbot-message-user {
            justify-content: flex-end;
        }
        
        .chatbot-message-content {
            max-width: 80%;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            line-height: 1.5;
        }
        
        .chatbot-message-assistant .chatbot-message-content {
            background: var(--color-white);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
        }
        
        .chatbot-message-user .chatbot-message-content {
            background: var(--color-blue);
            color: white;
        }
        
        .chatbot-input-container {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .chatbot-input {
            flex: 1;
            padding: var(--spacing-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-family: var(--font-family);
            font-size: 0.9375rem;
            resize: vertical;
            min-height: 60px;
        }
        
        .chatbot-input:focus {
            outline: none;
            border-color: var(--color-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .chatbot-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            color: var(--color-text-secondary);
            font-size: 0.875rem;
            padding: var(--spacing-md);
            background: var(--color-background);
            border-radius: var(--radius-md);
        }
        
        .chatbot-loading {
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* ===================================
           ğŸ†• v3.8.3.10.27.41: Choices.js Multiselect Custom Styles
           =================================== */
        
        /* Container principal */
        .choices {
            margin-bottom: 0;
            font-size: 0.9375rem;
        }
        
        .choices__inner {
            background: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: 8px 12px;
            min-height: 44px;
            font-family: var(--font-family);
        }
        
        .choices__inner:focus,
        .choices[data-type*="select-multiple"] .choices__inner:focus {
            border-color: var(--color-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        /* Items selecionados */
        .choices__list--multiple .choices__item {
            background-color: var(--color-blue);
            border: none;
            border-radius: 16px;
            padding: 4px 12px;
            margin: 2px 4px 2px 0;
            font-size: 0.875rem;
            color: white;
            display: inline-flex;
            align-items: center;
        }
        
        .choices__list--multiple .choices__item.is-highlighted {
            background-color: var(--color-blue-dark);
        }
        
        /* BotÃ£o remover item */
        .choices__button {
            border-left: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0 0 0 8px;
            margin-left: 8px;
            background: none;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .choices__button:hover {
            opacity: 1;
        }
        
        /* Dropdown */
        .choices__list--dropdown {
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            margin-top: 4px;
            box-shadow: var(--shadow-md);
            z-index: 100;
        }
        
        .choices__list--dropdown .choices__item {
            padding: 10px 12px;
            font-size: 0.9375rem;
            transition: background 0.2s;
        }
        
        .choices__list--dropdown .choices__item--selectable {
            padding-right: 40px;
        }
        
        .choices__list--dropdown .choices__item--selectable.is-highlighted {
            background-color: var(--color-background);
        }
        
        .choices__list--dropdown .choices__item--selectable:hover {
            background-color: #F0F0F0;
        }
        
        /* Placeholder */
        .choices__placeholder {
            opacity: 0.5;
        }
        
        /* Input de pesquisa */
        .choices__input {
            background-color: transparent;
            border: none;
            padding: 4px;
            font-size: 0.9375rem;
            font-family: var(--font-family);
        }
        
        .choices__input:focus {
            outline: none;
        }
        
        /* Estado disabled */
        .choices.is-disabled .choices__inner {
            background-color: var(--color-background);
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .choices__list--multiple .choices__item {
                font-size: 0.8125rem;
                padding: 3px 10px;
            }
        }
    </style>
    
    <!-- PDF.js para processar manuais -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script>
        // Configurar worker do PDF.js
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
            // PDF.js carregado
        }
    </script>
    
    <!-- Tesseract.js para OCR (reconhecimento de texto em imagens) -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.4/dist/tesseract.min.js"></script>
    <script>
        // Verificar se Tesseract.js carregou
        if (typeof Tesseract !== 'undefined') {
            // Tesseract.js carregado
        } else {
            console.warn('âš ï¸ Tesseract.js nÃ£o carregou (OCR desabilitado)');
        }
    </script>
    
    <!-- ğŸ†• v3.8.3.10.27.41: Choices.js para multiselect -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js@10.2.0/public/assets/styles/choices.min.css">
    <script src="https://cdn.jsdelivr.net/npm/choices.js@10.2.0/public/assets/scripts/choices.min.js"></script>
    
    <!-- ğŸ†• v3.8.3.10.27.51: Filtro Excel (INLINE para garantir carregamento) -->
    <style>
        /* ================================================================
           FILTRO EXCEL - Estilos
           v3.8.3.10.27.51 (INLINE)
           ================================================================ */

        /* Modal Overlay */
        .filtro-excel-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        /* Modal Content */
        .filtro-excel-content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        /* Header (Pesquisa) */
        .filtro-excel-header {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .filtro-excel-search {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }

        .filtro-excel-search:focus {
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Body (Lista de checkboxes) */
        .filtro-excel-body {
            padding: 12px 16px;
            max-height: 400px;
            overflow-y: auto;
        }

        .filtro-excel-option {
            display: flex;
            align-items: center;
            padding: 8px 0;
            cursor: pointer;
            user-select: none;
            font-size: 14px;
            color: #374151;
        }

        .filtro-excel-option:hover {
            background: #f9fafb;
            border-radius: 4px;
            padding-left: 8px;
            padding-right: 8px;
        }

        .filtro-excel-option input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        /* Footer (BotÃµes) */
        .filtro-excel-footer {
            padding: 12px 16px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .filtro-excel-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .filtro-excel-btn-cancel {
            background: #f3f4f6;
            color: #374151;
        }

        .filtro-excel-btn-cancel:hover {
            background: #e5e7eb;
        }

        .filtro-excel-btn-ok {
            background: #3B82F6;
            color: white;
        }

        .filtro-excel-btn-ok:hover {
            background: #2563eb;
        }

        /* BotÃ£o de acionamento do filtro */
        .filtro-excel-trigger {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .filtro-excel-trigger:hover {
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .filtro-excel-trigger::after {
            content: 'â–¼';
            font-size: 10px;
            color: #9ca3af;
        }

        /* Scrollbar personalizada */
        .filtro-excel-body::-webkit-scrollbar {
            width: 8px;
        }

        .filtro-excel-body::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        .filtro-excel-body::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .filtro-excel-body::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
    
    <script>
    // ================================================================
    // FILTRO EXCEL - Multiselect com Checkboxes + Pesquisa
    // v3.8.3.10.27.51 (INLINE)
    // ================================================================

    /**
     * Classe para criar filtros estilo Excel com checkboxes + pesquisa
     */
    class FiltroExcel {
        constructor(config) {
            this.id = config.id;
            this.targetInputId = config.targetInputId;
            this.options = config.options || [];
            this.selectedOptions = config.selectedOptions || [];
            this.placeholder = config.placeholder || 'Selecione...';
            this.onApply = config.onApply || (() => {});
            this.modalId = `filtro-excel-modal-${this.id}`;
            
            this.init();
        }
        
        init() {
            this.createModal();
            this.attachEventListeners();
            this.updateButtonText();
        }
        
        createModal() {
            const modal = document.createElement('div');
            modal.id = this.modalId;
            modal.className = 'filtro-excel-modal';
            modal.style.display = 'none';
            
            modal.innerHTML = `
                <div class="filtro-excel-content">
                    <div class="filtro-excel-header">
                        <input 
                            type="text" 
                            class="filtro-excel-search" 
                            placeholder="ğŸ” Procurar..."
                        >
                    </div>
                    <div class="filtro-excel-body">
                        <label class="filtro-excel-option">
                            <input type="checkbox" class="filtro-excel-select-all"> 
                            <strong>(Selecionar Tudo)</strong>
                        </label>
                        <div class="filtro-excel-list"></div>
                    </div>
                    <div class="filtro-excel-footer">
                        <button class="filtro-excel-btn filtro-excel-btn-cancel">Cancelar</button>
                        <button class="filtro-excel-btn filtro-excel-btn-ok">OK</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            this.renderOptions();
        }
        
        renderOptions(filter = '') {
            const list = document.querySelector(`#${this.modalId} .filtro-excel-list`);
            if (!list) return;
            
            list.innerHTML = '';
            
            const filteredOptions = this.options.filter(opt => 
                opt.toLowerCase().includes(filter.toLowerCase())
            );
            
            filteredOptions.forEach(option => {
                const label = document.createElement('label');
                label.className = 'filtro-excel-option';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = option;
                checkbox.checked = this.selectedOptions.includes(option);
                
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(option));
                
                list.appendChild(label);
            });
            
            this.updateSelectAllState();
        }
        
        updateSelectAllState() {
            const selectAllCheckbox = document.querySelector(`#${this.modalId} .filtro-excel-select-all`);
            if (!selectAllCheckbox) return;
            
            const allCheckboxes = document.querySelectorAll(`#${this.modalId} .filtro-excel-list input[type="checkbox"]`);
            const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
            
            selectAllCheckbox.checked = allChecked && allCheckboxes.length > 0;
        }
        
        attachEventListeners() {
            const modal = document.getElementById(this.modalId);
            const targetButton = document.getElementById(this.targetInputId);
            
            console.log(`ğŸ”§ Anexando listeners para ${this.id}:`, {
                modalId: this.modalId,
                targetInputId: this.targetInputId,
                modal: !!modal,
                targetButton: !!targetButton
            });
            
            if (targetButton) {
                targetButton.addEventListener('click', (e) => {
                    console.log(`ğŸ–±ï¸ BotÃ£o ${this.targetInputId} clicado!`);
                    e.stopPropagation();
                    this.openModal();
                });
            } else {
                console.error(`âŒ BotÃ£o ${this.targetInputId} nÃ£o encontrado!`);
            }
            
            const searchInput = modal.querySelector('.filtro-excel-search');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    this.renderOptions(e.target.value);
                });
            }
            
            const selectAllCheckbox = modal.querySelector('.filtro-excel-select-all');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', (e) => {
                    const list = modal.querySelector('.filtro-excel-list');
                    const checkboxes = list.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(cb => cb.checked = e.target.checked);
                });
            }
            
            modal.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox' && !e.target.classList.contains('filtro-excel-select-all')) {
                    this.updateSelectAllState();
                }
            });
            
            const btnOk = modal.querySelector('.filtro-excel-btn-ok');
            if (btnOk) {
                btnOk.addEventListener('click', () => {
                    this.apply();
                });
            }
            
            const btnCancel = modal.querySelector('.filtro-excel-btn-cancel');
            if (btnCancel) {
                btnCancel.addEventListener('click', () => {
                    this.closeModal();
                });
            }
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    this.closeModal();
                }
            });
        }
        
        openModal() {
            const modal = document.getElementById(this.modalId);
            if (modal) {
                modal.style.display = 'flex';
                
                const searchInput = modal.querySelector('.filtro-excel-search');
                if (searchInput) {
                    searchInput.value = '';
                }
                
                this.renderOptions();
            }
        }
        
        closeModal() {
            const modal = document.getElementById(this.modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        apply() {
            const modal = document.getElementById(this.modalId);
            const checkboxes = modal.querySelectorAll('.filtro-excel-list input[type="checkbox"]:checked');
            
            this.selectedOptions = Array.from(checkboxes).map(cb => cb.value);
            
            this.updateButtonText();
            this.closeModal();
            
            this.onApply(this.selectedOptions);
        }
        
        updateButtonText() {
            const button = document.getElementById(this.targetInputId);
            if (!button) return;
            
            if (this.selectedOptions.length === 0) {
                button.textContent = `ğŸ“‹ ${this.placeholder}`;
            } else if (this.selectedOptions.length === this.options.length) {
                button.textContent = `ğŸ“‹ Todos (${this.options.length})`;
            } else {
                button.textContent = `ğŸ“‹ ${this.selectedOptions.length} selecionados`;
            }
        }
        
        updateOptions(newOptions) {
            this.options = newOptions;
            this.renderOptions();
        }
        
        reset() {
            this.selectedOptions = [];
            this.updateButtonText();
            this.renderOptions();
        }
        
        selectAll() {
            this.selectedOptions = [...this.options];
            this.updateButtonText();
            this.renderOptions();
        }
    }

    console.log('ğŸ“¦ FiltroExcel (INLINE) carregado');
    </script>
    
    <!-- ğŸ†• v3.8.3.10.27.54: RevisÃµes + Multiselect (INLINE para garantir carregamento) -->
    <script>
    // ================================================================
    // ğŸš€ REVISÃ•ES + MULTISELECT (INLINE)
    // v3.8.3.10.27.54
    // ================================================================
    
    // ================================================================
    // CONFIGURAÃ‡ÃƒO
    // ================================================================
    
    const EQUIPAMENTOS_REVISAO = {
        'MCF': ['Empilhadores', 'High-Lifts', 'PÃ¡s Carregadoras'],
        'PSY': ['Empilhadores']
    };
    
    const CHOICES_CONFIG = {
        removeItemButton: true,
        searchEnabled: true,
        searchPlaceholderValue: 'Pesquisar...',
        noResultsText: 'Nenhum resultado',
        noChoicesText: 'Sem opÃ§Ãµes',
        itemSelectText: '',
        loadingText: 'A carregar...',
        maxItemCount: -1,
        placeholder: true,
        shouldSort: false,
        silent: true
    };
    
    // ================================================================
    // GLOBAL: InstÃ¢ncias Choices.js
    // ================================================================
    
    window.choicesInstances = {};
    
    // ================================================================
    // INICIALIZAR MULTISELECT
    // ================================================================
    
    function initializeMultiselect() {
        console.log('ğŸ¯ Inicializando multiselect...');
        
        try {
            // Tab OT's - Filtros
            initMultiselectOTs();
            
            // Tab Planeamento - Filtros
            initMultiselectPlaneamento();
            
            console.log('âœ… Multiselect inicializado');
        } catch (error) {
            console.error('âŒ Erro ao inicializar multiselect:', error);
        }
    }
    
    function initMultiselectOTs() {
        // Filtro Empresa
        const filterEmpresa = document.querySelector('.filter-empresa');
        if (filterEmpresa && typeof Choices !== 'undefined') {
            window.choicesInstances.filterEmpresa = new Choices(filterEmpresa, {
                ...CHOICES_CONFIG,
                placeholderValue: 'Todas as empresas'
            });
            
            filterEmpresa.addEventListener('change', () => {
                updateFiltersFromChoices();
                renderRequestsList();
            });
        }
        
        // Filtro Tipo
        const filterTipo = document.querySelector('.filter-tipo');
        if (filterTipo && typeof Choices !== 'undefined') {
            window.choicesInstances.filterTipo = new Choices(filterTipo, {
                ...CHOICES_CONFIG,
                placeholderValue: 'Todos os tipos'
            });
            
            filterTipo.addEventListener('change', () => {
                updateFiltersFromChoices();
                renderRequestsList();
            });
        }
        
        // Filtro Estado
        const filterEstado = document.querySelector('.filter-estado');
        if (filterEstado && typeof Choices !== 'undefined') {
            window.choicesInstances.filterEstado = new Choices(filterEstado, {
                ...CHOICES_CONFIG,
                placeholderValue: 'Todos os estados'
            });
            
            filterEstado.addEventListener('change', () => {
                updateFiltersFromChoices();
                renderRequestsList();
            });
        }
        
        // Filtro ResponsÃ¡vel
        const filterResponsavel = document.getElementById('filterResponsavel');
        if (filterResponsavel && typeof Choices !== 'undefined') {
            window.choicesInstances.filterResponsavel = new Choices(filterResponsavel, {
                ...CHOICES_CONFIG,
                placeholderValue: 'Todos os responsÃ¡veis'
            });
            
            filterResponsavel.addEventListener('change', () => {
                updateFiltersFromChoices();
                renderRequestsList();
            });
        }
    }
    
    function initMultiselectPlaneamento() {
        // Filtro Estado (Planeamento)
        const planningFilterEstado = document.querySelectorAll('.planning-filter-estado');
        planningFilterEstado.forEach((el, index) => {
            if (el && typeof Choices !== 'undefined') {
                window.choicesInstances[`planningEstado${index}`] = new Choices(el, {
                    ...CHOICES_CONFIG,
                    placeholderValue: 'Todos os estados'
                });
                
                el.addEventListener('change', () => {
                    renderPlanningGrid();
                });
            }
        });
    }
    
    function updateFiltersFromChoices() {
        // Atualizar AppState.currentFilters com valores dos multiselect
        
        // Empresa
        if (window.choicesInstances.filterEmpresa) {
            const values = window.choicesInstances.filterEmpresa.getValue(true);
            AppState.currentFilters.empresa = Array.isArray(values) ? values : (values ? [values] : []);
        }
        
        // Tipo
        if (window.choicesInstances.filterTipo) {
            const values = window.choicesInstances.filterTipo.getValue(true);
            AppState.currentFilters.tipo = Array.isArray(values) ? values : (values ? [values] : []);
        }
        
        // Estado
        if (window.choicesInstances.filterEstado) {
            const values = window.choicesInstances.filterEstado.getValue(true);
            AppState.currentFilters.estado = Array.isArray(values) ? values : (values ? [values] : []);
        }
        
        // ResponsÃ¡vel
        if (window.choicesInstances.filterResponsavel) {
            const values = window.choicesInstances.filterResponsavel.getValue(true);
            AppState.currentFilters.responsavel = Array.isArray(values) ? values : (values ? [values] : []);
        }
        
        console.log('ğŸ”„ Filtros atualizados:', AppState.currentFilters);
    }
    
    // ================================================================
    // REVISÃ•ES: Inicializar campos
    // ================================================================
    
    function initializeRevisao() {
        console.log('ğŸ”§ Inicializando campos de RevisÃ£o...');
        
        const tipoSelect = document.getElementById('tipo');
        const empresaSelect = document.getElementById('empresa');
        const camposRevisao = document.getElementById('camposRevisao');
        const camposPreventiva = document.getElementById('camposPreventiva');
        
        if (!tipoSelect) {
            console.warn('âš ï¸ Elemento #tipo nÃ£o encontrado');
            return;
        }
        
        // Event listener: Tipo mudou
        tipoSelect.addEventListener('change', function() {
            const tipo = this.value;
            const empresa = empresaSelect ? empresaSelect.value : '';
            
            console.log('ğŸ”„ Tipo mudou:', tipo);
            
            // ReferÃªncias adicionais
            const componenteGroup = document.getElementById('componenteGroup');
            const tipoIntervencaoGroup = document.getElementById('tipoIntervencaoGroup');
            const checkboxesGroup = document.getElementById('checkboxesGroup');
            
            if (tipo === 'RevisÃ£o') {
                console.log('âœ… Modo RevisÃ£o ATIVADO - ocultando campos de Corretiva/Melhoria');
                
                // Mostrar campos de revisÃ£o
                if (camposRevisao) {
                    camposRevisao.style.display = 'block';
                    console.log('  âœ… camposRevisao: visÃ­vel');
                }
                if (camposPreventiva) {
                    camposPreventiva.style.display = 'none';
                    console.log('  âœ… camposPreventiva: oculto');
                }
                
                // Componente VISÃVEL para RevisÃµes
                if (componenteGroup) {
                    componenteGroup.style.display = 'block';
                    document.getElementById('componente').required = true;
                    console.log('  âœ… componenteGroup: visÃ­vel');
                }
                
                // Esconder Tipo de IntervenÃ§Ã£o para RevisÃµes
                if (tipoIntervencaoGroup) {
                    tipoIntervencaoGroup.style.display = 'none';
                    document.getElementById('tipoIntervencao').required = false;
                    console.log('  âœ… tipoIntervencaoGroup: OCULTO');
                }
                
                // Esconder checkboxes (Urgente, Paragem, Exige Compra)
                if (checkboxesGroup) {
                    checkboxesGroup.style.display = 'none';
                    console.log('  âœ… checkboxesGroup: OCULTO');
                }
                
                // Filtrar equipamentos
                filterEquipamentosRevisao(empresa);
                
            } else if (tipo === 'Preventiva') {
                // Mostrar campos de preventiva
                if (camposPreventiva) {
                    camposPreventiva.style.display = 'block';
                }
                if (camposRevisao) {
                    camposRevisao.style.display = 'none';
                }
                
                // Restaurar Componente
                if (componenteGroup) {
                    componenteGroup.style.display = 'block';
                    document.getElementById('componente').required = true;
                }
                
                // Restaurar Tipo de IntervenÃ§Ã£o
                if (tipoIntervencaoGroup) {
                    tipoIntervencaoGroup.style.display = 'block';
                    document.getElementById('tipoIntervencao').required = true;
                }
                
                // Restaurar checkboxes
                if (checkboxesGroup) {
                    checkboxesGroup.style.display = 'block';
                }
                
            } else {
                // Esconder ambos
                if (camposRevisao) {
                    camposRevisao.style.display = 'none';
                    
                    // Limpar campos de RevisÃ£o quando nÃ£o Ã© RevisÃ£o
                    const tipoRevisaoSelect = document.getElementById('tipoRevisao');
                    const numeroHorasInput = document.getElementById('numeroHoras');
                    if (tipoRevisaoSelect) tipoRevisaoSelect.value = '';
                    if (numeroHorasInput) numeroHorasInput.value = '';
                }
                if (camposPreventiva) {
                    camposPreventiva.style.display = 'none';
                }
                
                // Restaurar Componente
                if (componenteGroup) {
                    componenteGroup.style.display = 'block';
                    document.getElementById('componente').required = true;
                }
                
                // Restaurar Tipo de IntervenÃ§Ã£o
                if (tipoIntervencaoGroup) {
                    tipoIntervencaoGroup.style.display = 'block';
                    document.getElementById('tipoIntervencao').required = true;
                }
                
                // Restaurar checkboxes
                if (checkboxesGroup) {
                    checkboxesGroup.style.display = 'block';
                }
            }
        });
        
        // Event listener: Empresa mudou (se Tipo=RevisÃ£o)
        if (empresaSelect) {
            empresaSelect.addEventListener('change', function() {
                const tipo = tipoSelect.value;
                const empresa = this.value;
                
                if (tipo === 'RevisÃ£o') {
                    filterEquipamentosRevisao(empresa);
                }
            });
        }
        
        // ğŸ†• v3.8.3.10.27.54: Aplicar lÃ³gica inicial ao carregar a pÃ¡gina
        // Se "RevisÃ£o" jÃ¡ estiver selecionada ao carregar, ocultar campos corretos
        const tipoInicial = tipoSelect.value;
        if (tipoInicial === 'RevisÃ£o') {
            console.log('ğŸ”„ Aplicando lÃ³gica inicial para RevisÃ£o');
            
            if (camposRevisao) camposRevisao.style.display = 'block';
            if (camposPreventiva) camposPreventiva.style.display = 'none';
            
            const componenteGroup = document.getElementById('componenteGroup');
            const tipoIntervencaoGroup = document.getElementById('tipoIntervencaoGroup');
            const checkboxesGroup = document.getElementById('checkboxesGroup');
            
            if (componenteGroup) {
                componenteGroup.style.display = 'block';
                const componenteField = document.getElementById('componente');
                if (componenteField) componenteField.required = true;
            }
            
            if (tipoIntervencaoGroup) {
                tipoIntervencaoGroup.style.display = 'none';
                const tipoIntervencaoField = document.getElementById('tipoIntervencao');
                if (tipoIntervencaoField) tipoIntervencaoField.required = false;
                console.log('  âœ… tipoIntervencaoGroup: OCULTO (inicial)');
            }
            
            if (checkboxesGroup) {
                checkboxesGroup.style.display = 'none';
                console.log('  âœ… checkboxesGroup: OCULTO (inicial)');
            }
            
            const empresa = empresaSelect ? empresaSelect.value : '';
            if (empresa) {
                filterEquipamentosRevisao(empresa);
            }
        }
        
        console.log('âœ… RevisÃ£o inicializada');
    }
    
    function filterEquipamentosRevisao(empresa) {
        const areaSelect = document.getElementById('areaEquipamento');
        
        if (!areaSelect || !empresa) {
            console.warn('âš ï¸ Empresa ou Ã¡rea nÃ£o encontrada');
            return;
        }
        
        const equipamentosPermitidos = EQUIPAMENTOS_REVISAO[empresa] || [];
        
        console.log(`ğŸ”§ Filtrando equipamentos para ${empresa}:`, equipamentosPermitidos);
        
        // Limpar opÃ§Ãµes existentes
        areaSelect.innerHTML = '<option value="">Selecione o equipamento</option>';
        
        // Adicionar apenas equipamentos permitidos
        equipamentosPermitidos.forEach(equip => {
            const option = document.createElement('option');
            option.value = equip;
            option.textContent = equip;
            areaSelect.appendChild(option);
        });
        
        // Habilitar dropdown
        areaSelect.disabled = false;
    }
    
    // ================================================================
    // REVISÃ•ES: Validar formulÃ¡rio
    // ================================================================
    
    function validateRevisao(data) {
        const { tipo, empresa, areaEquipamento, dataPrimeiraIntervencao, frequencia, tiposRevisao } = data;
        
        if (tipo !== 'RevisÃ£o') {
            return true; // NÃ£o Ã© revisÃ£o, skip validaÃ§Ã£o
        }
        
        // 1. Empresa obrigatÃ³ria
        if (!empresa) {
            showToast('âŒ Empresa Ã© obrigatÃ³ria para revisÃµes', 'error');
            return false;
        }
        
        // 2. Equipamento deve ser permitido
        const equipamentosPermitidos = EQUIPAMENTOS_REVISAO[empresa] || [];
        if (!equipamentosPermitidos.includes(areaEquipamento)) {
            showToast(`âŒ Equipamento "${areaEquipamento}" nÃ£o permitido para revisÃµes ${empresa}`, 'error');
            return false;
        }
        
        // 3. Data 1Âª IntervenÃ§Ã£o obrigatÃ³ria
        if (!dataPrimeiraIntervencao) {
            showToast('âŒ Data 1Âª IntervenÃ§Ã£o Ã© obrigatÃ³ria para revisÃµes', 'error');
            return false;
        }
        
        // 4. FrequÃªncia obrigatÃ³ria
        if (!frequencia) {
            showToast('âŒ FrequÃªncia Ã© obrigatÃ³ria para revisÃµes', 'error');
            return false;
        }
        
        // 5. Tipo de RevisÃ£o obrigatÃ³rio
        if (!tiposRevisao || tiposRevisao.length === 0 || !tiposRevisao[0]) {
            showToast('âŒ Selecione o tipo de revisÃ£o', 'error');
            return false;
        }
        
        console.log('âœ… RevisÃ£o validada com sucesso');
        return true;
    }
    
    // ================================================================
    // REVISÃ•ES: Coletar dados do formulÃ¡rio
    // ================================================================
    
    function getRevisaoData() {
        const numeroHoras = document.getElementById('numeroHoras')?.value || null;
        const dataPrimeiraIntervencao = document.getElementById('dataPrimeiraIntervencaoRevisao')?.value || null;
        const frequencia = document.getElementById('frequenciaRevisao')?.value || null;
        
        // Tipo de RevisÃ£o (dropdown simples)
        const tipoRevisaoSelect = document.getElementById('tipoRevisao');
        const tipoRevisao = tipoRevisaoSelect?.value || null;
        const tiposRevisao = tipoRevisao ? [tipoRevisao] : []; // Converter para array (BD espera array)
        
        return {
            numeroHoras: numeroHoras ? parseInt(numeroHoras) : null,
            dataPrimeiraIntervencao,
            frequencia: frequencia || null,  // String (Semanal, Mensal, etc.)
            tiposRevisao
        };
    }
    
    // ================================================================
    // EXPORT FUNCTIONS (para uso global)
    // ================================================================
    
    window.initializeMultiselect = initializeMultiselect;
    window.initializeRevisao = initializeRevisao;
    window.validateRevisao = validateRevisao;
    window.getRevisaoData = getRevisaoData;
    window.filterEquipamentosRevisao = filterEquipamentosRevisao;
    window.EQUIPAMENTOS_REVISAO = EQUIPAMENTOS_REVISAO;
    
    console.log('ğŸ“¦ RevisÃµes + Multiselect (INLINE) carregado v3.8.3.10.27.54');
    </script>
</head>
<body class="app-loading">
    <!-- Header -->
    <header class="app-header">
        <div class="header-content">
            <h1>
                <img src="/appmanutencao/icons/android-chrome-192x192.png" alt="Logo" class="header-icon" id="headerLogo">
                ManutenÃ§Ã£o
            </h1>
            <div class="header-actions">
                <!-- ğŸ“š BOTÃƒO DE TESTE REMOVIDO - Usava funÃ§Ã£o antiga -->
                
                <!-- ğŸš¨ BOTÃƒO DE ALERTAS (SÃ“ ÃCONE) -->
                <button 
                    id="testarAlertasBtn" 
                    onclick="mostrarAlertasPendentes()" 
                    style="
                        width: 40px;
                        height: 40px;
                        background: #ff6b6b;
                        color: white;
                        border: none;
                        border-radius: 50%;
                        cursor: pointer;
                        font-size: 20px;
                        display: none;
                        align-items: center;
                        justify-content: center;
                        margin-right: 12px;
                        transition: all 0.2s;
                        box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
                    "
                    onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(255, 107, 107, 0.5)';"
                    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(255, 107, 107, 0.3)';"
                    title="Ver alertas de produtividade"
                >
                    ğŸš¨
                </button>
                
                <div id="userInfo" class="user-info" style="display: none;">
                    <span class="user-name"></span>
                    <span class="user-dept"></span>
                </div>

                <button class="btn-icon logout-btn" id="logoutBtn" title="Terminar SessÃ£o" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="app-main">
        
        <!-- Tab Navigation -->
        <nav class="tab-nav">
            <button class="tab-btn active" data-tab="novo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
                Nova OT
            </button>
            <button class="tab-btn" data-tab="lista">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/>
                </svg>
                Lista de OTs
            </button>
            <button class="tab-btn" data-tab="stock">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                    <line x1="12" y1="22.08" x2="12" y2="12"/>
                </svg>
                Stock
                <span class="alert-badge" id="stockAlertBadge" style="display: none;">0</span>
            </button>
            <button class="tab-btn" data-tab="planeamento">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                Planeamento
            </button>
            <button class="tab-btn" data-tab="analise">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 3v18h18"/>
                    <path d="M18 17V9"/>
                    <path d="M13 17V5"/>
                    <path d="M8 17v-3"/>
                </svg>
                AnÃ¡lise
            </button>
            <button class="tab-btn" data-tab="documentos">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10 9 9 9 8 9"/>
                </svg>
                Documentos
            </button>
        </nav>

        <!-- Nova Ordem de Trabalho Tab -->
        <section class="tab-content active" id="tab-novo">
            <div class="container">
                <div class="card form-card">
                    <h2 class="card-title">Criar Nova Ordem de Trabalho</h2>
                    
                    <form id="maintenanceForm" class="maintenance-form">
                        <!-- 1. Empresa -->
                        <div class="form-group">
                            <label class="form-label" for="empresa">Empresa *</label>
                            <select class="form-input" id="empresa" name="empresa" required>
                                <option value="">Selecione a empresa</option>
                                <option value="MCF">MCF</option>
                                <option value="PSY">PSY</option>
                            </select>
                        </div>

                        <!-- 2. Tipo de ManutenÃ§Ã£o -->
                        <div class="form-group">
                            <label class="form-label" for="tipo">Tipo de ManutenÃ§Ã£o *</label>
                            <select class="form-input" id="tipo" name="tipo" required>
                                <option value="">Selecione o tipo</option>
                                <option value="Preventiva">Preventiva</option>
                                <option value="Corretiva">Corretiva</option>
                                <option value="Melhoria">Melhoria</option>
                                <option value="RevisÃ£o">RevisÃ£o</option>
                            </select>
                        </div>

                        <!-- FrequÃªncia (apenas para Preventivas) -->
                        <div class="form-group" id="frequenciaGroup" style="display: none;">
                            <label class="form-label" for="frequencia">FrequÃªncia *</label>
                            <select class="form-input" id="frequencia" name="frequencia">
                                <option value="">Selecione a frequÃªncia</option>
                                <option value="Semanal">Semanal</option>
                                <option value="Quinzenal">Quinzenal</option>
                                <option value="Mensal">Mensal</option>
                                <option value="Trimestral">Trimestral</option>
                                <option value="Semestral">Semestral</option>
                                <option value="Anual">Anual</option>
                                <option value="2 anos">2 anos</option>
                            </select>
                        </div>

                        <!-- âœ… NOVO v3.7.0.8: Data 1Âª IntervenÃ§Ã£o (apenas para Preventivas) -->
                        <div class="form-group" id="dataPrimeiraIntervencaoGroup" style="display: none;">
                            <label class="form-label" for="dataPrimeiraIntervencao">Data 1Âª IntervenÃ§Ã£o *</label>
                            <input 
                                type="date" 
                                class="form-input" 
                                id="dataPrimeiraIntervencao" 
                                name="dataPrimeiraIntervencao"
                            >
                            <small class="form-hint">Data da primeira intervenÃ§Ã£o programada</small>
                        </div>

                        <!-- ğŸ†• v3.8.3.10.27.42: CAMPOS DE REVISÃƒO (apenas para RevisÃµes) -->
                        <div id="camposRevisao" style="display: none;">
                            <!-- Data 1Âª IntervenÃ§Ã£o -->
                            <div class="form-group">
                                <label class="form-label" for="dataPrimeiraIntervencaoRevisao">Data 1Âª IntervenÃ§Ã£o *</label>
                                <input 
                                    type="date" 
                                    class="form-input" 
                                    id="dataPrimeiraIntervencaoRevisao" 
                                    name="dataPrimeiraIntervencaoRevisao"
                                >
                                <small class="form-hint">Data da primeira intervenÃ§Ã£o programada</small>
                            </div>

                            <!-- FrequÃªncia -->
                            <div class="form-group">
                                <label class="form-label" for="frequenciaRevisao">FrequÃªncia *</label>
                                <select class="form-input" id="frequenciaRevisao" name="frequenciaRevisao">
                                    <option value="">Selecione a frequÃªncia</option>
                                    <option value="Semanal">Semanal</option>
                                    <option value="Quinzenal">Quinzenal</option>
                                    <option value="Mensal">Mensal</option>
                                    <option value="Trimestral">Trimestral</option>
                                    <option value="Semestral">Semestral</option>
                                    <option value="Anual">Anual</option>
                                    <option value="2 anos">2 anos</option>
                                </select>
                            </div>

                            <!-- NÃºmero de Horas -->
                            <div class="form-group">
                                <label class="form-label" for="numeroHoras">NÃºmero de Horas</label>
                                <input 
                                    type="number" 
                                    class="form-input" 
                                    id="numeroHoras" 
                                    name="numeroHoras"
                                    min="0"
                                    step="1"
                                    placeholder="Ex: 500"
                                >
                                <small class="form-hint">NÃºmero de horas de funcionamento do equipamento (opcional)</small>
                            </div>

                            <!-- Tipo de RevisÃ£o -->
                            <div class="form-group">
                                <label class="form-label" for="tipoRevisao">Tipo de RevisÃ£o *</label>
                                <select class="form-input" id="tipoRevisao" name="tipoRevisao">
                                    <option value="">Selecione o tipo</option>
                                    <option value="geral">RevisÃ£o Geral</option>
                                    <option value="filtros_oleos">RevisÃ£o Filtros + Ã“leos</option>
                                    <option value="oleo_caixa">RevisÃ£o Ã“leo Caixa</option>
                                </select>
                            </div>
                        </div>

                        <!-- 3. Tipo de IntervenÃ§Ã£o -->
                        <div class="form-group" id="tipoIntervencaoGroup">
                            <label class="form-label" for="tipoIntervencao">Tipo de IntervenÃ§Ã£o *</label>
                            <select class="form-input" id="tipoIntervencao" name="tipoIntervencao" required>
                                <option value="">Selecione o tipo *</option>
                                <option value="Eletricidade">Eletricidade</option>
                                <option value="MecÃ¢nica">MecÃ¢nica</option>
                                <option value="HidrÃ¡ulica / PneumÃ¡tica">HidrÃ¡ulica / PneumÃ¡tica</option>
                                <option value="Serralharia">Serralharia</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>

                        <!-- 4. Checkboxes: Urgente, Paragem ProduÃ§Ã£o e Exige Compra -->
                        <div class="form-group" id="checkboxesGroup">
                            <div class="checkbox-group" style="display: flex; flex-direction: column; gap: 12px;">
                                <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="urgente" name="urgente" value="true" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-size: 14px; color: #333;">ğŸ”´ Urgente (risco paragem / seguranÃ§a)</span>
                                </label>
                                <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="paragemProducao" name="paragemProducao" value="true" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-size: 14px; color: #333;">âš ï¸ Implica paragem de produÃ§Ã£o</span>
                                </label>
                                <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="exigeCompra" name="exigeCompra" value="true" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-size: 14px; color: #333;">ğŸ›’ Exige compra de material especÃ­fico</span>
                                </label>
                            </div>
                        </div>

                        <!-- 5. Prioridade (oculta em Preventivas) -->
                        <div class="form-group" id="prioridadeGroup">
                            <label class="form-label">Prioridade *</label>
                            <div class="priority-selector">
                                <label class="priority-option priority-alta">
                                    <input type="radio" name="prioridade" value="Alta" id="prioridadeAlta">
                                    <span class="priority-label">
                                        <svg viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12 2L2 12h3v8h14v-8h3L12 2z"/>
                                        </svg>
                                        Alta
                                    </span>
                                </label>
                                <label class="priority-option priority-media">
                                    <input type="radio" name="prioridade" value="MÃ©dia" id="prioridadeMedia">
                                    <span class="priority-label">
                                        <svg viewBox="0 0 24 24" fill="currentColor">
                                            <circle cx="12" cy="12" r="10"/>
                                        </svg>
                                        MÃ©dia
                                    </span>
                                </label>
                                <label class="priority-option priority-baixa">
                                    <input type="radio" name="prioridade" value="Baixa" id="prioridadeBaixa">
                                    <span class="priority-label">
                                        <svg viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12 22L22 12h-3V4H5v8H2l10 10z"/>
                                        </svg>
                                        Baixa
                                    </span>
                                </label>
                            </div>
                        </div>

                        <!-- 6. Ãrea/Equipamento -->
                        <div class="form-group">
                            <label class="form-label" for="areaEquipamento">Ãrea/Equipamento *</label>
                            <select class="form-input" id="areaEquipamento" name="areaEquipamento" required>
                                <option value="">Selecione a Ã¡rea/equipamento</option>
                                <!-- Preenchido dinamicamente via JavaScript -->
                            </select>
                        </div>

                        <!-- 7. Componente (desabilitado atÃ© escolher Ãrea) -->
                        <div class="form-group" id="componenteGroup">
                            <label class="form-label" for="componente">Componente *</label>
                            <select class="form-input" id="componente" name="componente" required disabled>
                                <option value="">Escolha primeiro a Ã¡rea/equipamento</option>
                                <!-- Preenchido dinamicamente via JavaScript -->
                            </select>
                        </div>

                        <!-- Departamento -->
                        <div class="form-group">
                            <label class="form-label" for="departamento">Departamento</label>
                            <input type="text" class="form-input" id="departamento" name="departamento" placeholder="Ex: ProduÃ§Ã£o, LogÃ­stica...">
                        </div>

                        <!-- DescriÃ§Ã£o -->
                        <div class="form-group">
                            <label class="form-label" for="descricao">DescriÃ§Ã£o *</label>
                            <textarea class="form-input" id="descricao" name="descricao" rows="4" placeholder="Descreva o problema ou melhoria necessÃ¡ria..." required></textarea>
                        </div>

                        <!-- Upload de Foto/PDF -->
                        <div class="form-group">
                            <label class="form-label" for="foto">Anexo (opcional, mÃ¡x. 5MB) - Imagem ou PDF</label>
                            <div class="file-upload">
                                <input type="file" id="foto" name="foto" accept="image/*,.pdf,application/pdf" class="file-input">
                                <label for="foto" class="file-label">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <path d="M21 15l-5-5L5 21"/>
                                    </svg>
                                    <span id="fileName">Escolher imagem ou PDF</span>
                                </label>
                                <div id="imagePreview" class="image-preview"></div>
                            </div>
                        </div>

                        <!-- Nome -->
                        <div class="form-group">
                            <label class="form-label" for="nome">Nome de quem regista *</label>
                            <input type="text" class="form-input" id="nome" name="nome" placeholder="Seu nome completo" required>
                        </div>

                        <!-- BotÃµes -->
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="clearBtn">Limpar</button>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                                    <polyline points="17 21 17 13 7 13 7 21"/>
                                    <polyline points="7 3 7 8 15 8"/>
                                </svg>
                                Criar Ordem
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- Lista de Ordens de Trabalho Tab -->
        <section class="tab-content" id="tab-lista">
            <div class="container">
                <!-- Filtros -->
                <div class="card filters-card">
                    <div class="filters-header">
                        <h3>Filtros</h3>
                        <button class="btn-text" id="clearFilters">Limpar</button>
                    </div>
                    
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">Tipo</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Preventiva" class="filter-tipo">
                                    <span>Preventiva</span>
                                </label>
                                <!-- ğŸ†• v3.8.3.10.25: Filtros de preventivas (todas, para breve, atrasadas) -->
                                <label class="checkbox-label" style="margin-left: 20px;">
                                    <input type="checkbox" id="filterPreventivaTodas" class="filter-preventiva-todas">
                                    <span style="color: #666; font-size: 0.9em;">Todas</span>
                                </label>
                                <label class="checkbox-label" style="margin-left: 20px;">
                                    <input type="checkbox" id="filterPreventivaBreve" class="filter-preventiva-breve" checked>
                                    <span style="color: #FF9500; font-weight: 600;">âš¡ Para breve</span>
                                </label>
                                <label class="checkbox-label" style="margin-left: 20px;">
                                    <input type="checkbox" id="filterPreventivaAtrasadas" class="filter-preventiva-atrasadas" checked>
                                    <span style="color: #e74c3c; font-weight: 600;">âš ï¸ Atrasadas</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Corretiva" class="filter-tipo" checked>
                                    <span>Corretiva</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Melhoria" class="filter-tipo" checked>
                                    <span>Melhoria</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="RevisÃ£o" class="filter-tipo" checked>
                                    <span>RevisÃ£o</span>
                                </label>
                            </div>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Prioridade</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Alta" class="filter-prioridade">
                                    <span>Alta</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="MÃ©dia" class="filter-prioridade">
                                    <span>MÃ©dia</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Baixa" class="filter-prioridade">
                                    <span>Baixa</span>
                                </label>
                            </div>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Estado</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Novo" class="filter-estado" checked>
                                    <span>Novo</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Em curso" class="filter-estado" checked>
                                    <span>Em curso</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Resolvido" class="filter-estado">
                                    <span>Resolvido</span>
                                </label>
                            </div>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Empresa</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="MCF" class="filter-empresa">
                                    <span>MCF</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="PSY" class="filter-empresa">
                                    <span>PSY</span>
                                </label>
                            </div>
                        </div>

                        <!-- âš¡ NOVO: Filtro de Equipamento (Excel Style) -->
                        <div class="filter-group">
                            <label class="filter-label">ğŸ”§ Ãrea/Equipamento</label>
                            <button id="filterEquipamentoBtn" class="filtro-excel-trigger" type="button" style="margin-top: 8px;">
                                ğŸ“‹ Todos os equipamentos
                            </button>
                        </div>
                        
                        <!-- âœ… v3.7.0.9: NOVO Filtro de ResponsÃ¡vel -->
                        <div class="filter-group">
                            <label class="filter-label">ğŸ‘¤ ResponsÃ¡vel</label>
                            <select id="filterResponsavel" class="form-input" style="width: 100%; margin-top: 8px;">
                                <option value="">Todos os responsÃ¡veis</option>
                                <!-- Populado dinamicamente via JavaScript -->
                            </select>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Tipo de IntervenÃ§Ã£o</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Eletricidade" class="filter-tipoIntervencao">
                                    <span>Eletricidade</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="MecÃ¢nica" class="filter-tipoIntervencao">
                                    <span>MecÃ¢nica</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="HidrÃ¡ulica / PneumÃ¡tica" class="filter-tipoIntervencao">
                                    <span>HidrÃ¡ulica / PneumÃ¡tica</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Serralharia" class="filter-tipoIntervencao">
                                    <span>Serralharia</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Outros" class="filter-tipoIntervencao">
                                    <span>Outros</span>
                                </label>
                            </div>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Especiais</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="true" class="filter-urgente">
                                    <span>ğŸ”´ Urgente</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="true" class="filter-paragemProducao">
                                    <span>âš ï¸ Paragem ProduÃ§Ã£o</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="true" class="filter-exigeCompra">
                                    <span>ğŸ›’ Exige compra material</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lista Header -->
                <div class="list-header">
                    <div class="list-info">
                        <span id="listCount">0 pedidos</span>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button class="btn-icon" id="btnImprimirRelatorio" title="Imprimir RelatÃ³rio" style="background: #3B82F6; color: white; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 20px; border: none; cursor: pointer; transition: all 0.2s;">
                            ğŸ–¨ï¸
                        </button>
                        <button class="btn-icon" id="sortBtn" title="Ordenar por data">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 5h10M11 9h7M11 13h4M3 17l3 3 3-3M6 18V4"/>
                            </svg>
                        </button>
                        <button class="btn-icon" id="groupBtn" title="Agrupar por Hierarquia (Empresa â†’ Ãrea â†’ Componente)" style="background: #10B981;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Lista de Ordens de Trabalho -->
                <div id="requestsList" class="requests-list">
                    <!-- Pedidos serÃ£o inseridos aqui dinamicamente -->
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"/>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                    </svg>
                    <h3>Nenhuma ordem de trabalho encontrada</h3>
                    <p>Crie o primeiro pedido ou ajuste os filtros</p>
                </div>
            </div>
        </section>

        <!-- ğŸ†• v3.8.3.10.27.10: Modal de RelatÃ³rio de OTs -->
        <div id="modalRelatorio" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 95%; width: 1400px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
                <div class="modal-header" style="flex-shrink: 0;">
                    <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">ğŸ–¨ï¸</span>
                        <span>RelatÃ³rio de Ordens de Trabalho</span>
                    </h2>
                    <button class="modal-close" id="closeModalRelatorio">&times;</button>
                </div>
                
                <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
                    <!-- Resumo de Filtros -->
                    <div style="background: #F3F4F6; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 14px;">
                            <div>
                                <strong>ğŸ“Š Filtros aplicados:</strong>
                                <span id="relatorioFiltrosTexto" style="color: #6B7280;"></span>
                            </div>
                            <div>
                                <strong>ğŸ“… Data:</strong>
                                <span id="relatorioData" style="color: #6B7280;"></span>
                            </div>
                            <div>
                                <strong>ğŸ“‹ Total de OTs:</strong>
                                <span id="relatorioTotal" style="color: #6B7280; font-weight: 600;"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Container para impressÃ£o/exportaÃ§Ã£o -->
                    <div id="relatorioContainer">
                        <!-- ConteÃºdo do relatÃ³rio serÃ¡ inserido aqui dinamicamente -->
                    </div>
                </div>

                <div class="modal-footer" style="flex-shrink: 0; display: flex; gap: 10px; justify-content: flex-end; padding: 20px; border-top: 1px solid #E5E7EB;">
                    <button class="btn" id="btnCopiarTabela" style="background: #6B7280; color: white; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 18px;">ğŸ“‹</span>
                        <span>Copiar Tabela</span>
                    </button>
                    <button class="btn" id="btnExportarCSV" style="background: #10B981; color: white; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 18px;">ğŸ’¾</span>
                        <span>Exportar CSV</span>
                    </button>
                    <button class="btn" id="btnExportarImagem" style="background: #8B5CF6; color: white; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 18px;">ğŸ–¼ï¸</span>
                        <span>Exportar como Imagem</span>
                    </button>
                    <button class="btn" id="btnImprimirPDF" style="background: #3B82F6; color: white; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 18px;">ğŸ–¨ï¸</span>
                        <span>Imprimir</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Planeamento Tab -->
        <section class="tab-content" id="tab-planeamento">
            <div class="container">
                
                <!-- âœ… NOVO: Resumo de ManutenÃ§Ãµes Preventivas -->
                <div class="card" style="margin-bottom: 20px;">
                    <h2 class="card-title">ğŸ“‹ Resumo de ManutenÃ§Ãµes Preventivas</h2>
                    
                    <!-- Filtros -->
                    <div class="filters-grid" style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label class="form-label">PerÃ­odo</label>
                            <select class="form-input" id="preventivaPeriodoFilter">
                                <option value="mes">PrÃ³ximo MÃªs</option>
                                <option value="3meses" selected>PrÃ³ximos 3 Meses</option>
                                <option value="6meses">PrÃ³ximos 6 Meses</option>
                                <option value="ano">PrÃ³ximo Ano</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Empresa</label>
                            <select class="form-input" id="preventivaEmpresaFilter">
                                <option value="todas">Todas</option>
                                <option value="MCF">MCF</option>
                                <option value="PSY">PSY</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">FrequÃªncia</label>
                            <select class="form-input" id="preventivaFrequenciaFilter">
                                <option value="todas">Todas</option>
                                <option value="Semanal">Semanal</option>
                                <option value="Quinzenal">Quinzenal</option>
                                <option value="Mensal">Mensal</option>
                                <option value="Trimestral">Trimestral</option>
                                <option value="Semestral">Semestral</option>
                                <option value="Anual">Anual</option>
                                <option value="2 anos">2 anos</option>
                            </select>
                        </div>
                        <div class="form-group" style="display: flex; align-items: flex-end;">
                            <button class="btn btn-primary" id="atualizarPreventivasBtn" style="width: 100%;">
                                Atualizar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lista de Preventivas -->
                    <div id="preventivasList" class="requests-list">
                        <p style="text-align: center; color: #666; padding: 20px;">
                            Selecione os filtros e clique em "Atualizar" para ver as manutenÃ§Ãµes preventivas.
                        </p>
                    </div>
                </div>
                
                <!-- Controlos do Planeamento -->
                <div class="card planning-controls">
                    <div class="planning-header">
                        <h2 class="card-title">Planeamento de ManutenÃ§Ã£o Quinzenal</h2>
                        <div class="planning-actions">
                            <button class="btn-icon" id="prevWeekBtn" title="Semana anterior">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M15 18l-6-6 6-6"/>
                                </svg>
                            </button>
                            <span class="planning-range" id="planningRange">Carregando...</span>
                            <button class="btn-icon" id="nextWeekBtn" title="PrÃ³xima semana">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 18l6-6-6-6"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- âœ… v3.7.0.9: NOVO - Filtros de Planeamento -->
                    <div class="filters-header" style="margin-top: 20px;">
                        <h3>Filtros</h3>
                        <button class="btn-text" id="clearPlanningFilters">Limpar</button>
                    </div>
                    
                    <div class="filters-grid" style="margin-top: 12px;">
                        <div class="filter-group">
                            <label class="filter-label">Tipo</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Preventiva" class="planning-filter-tipo" checked>
                                    <span>Preventiva</span>
                                </label>
                                <!-- ğŸ†• v3.8.3.10.25: Filtros de preventivas (todas, para breve, atrasadas) -->
                                <label class="checkbox-label" style="margin-left: 20px;">
                                    <input type="checkbox" id="planningFilterPreventivaTodas" class="planning-filter-preventiva-todas">
                                    <span style="color: #666; font-size: 0.9em;">Todas</span>
                                </label>
                                <label class="checkbox-label" style="margin-left: 20px;">
                                    <input type="checkbox" id="planningFilterPreventivaBreve" class="planning-filter-preventiva-breve" checked>
                                    <span style="color: #FF9500; font-weight: 600;">âš¡ Para breve</span>
                                </label>
                                <label class="checkbox-label" style="margin-left: 20px;">
                                    <input type="checkbox" id="planningFilterPreventivaAtrasadas" class="planning-filter-preventiva-atrasadas" checked>
                                    <span style="color: #e74c3c; font-weight: 600;">âš ï¸ Atrasadas</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Corretiva" class="planning-filter-tipo" checked>
                                    <span>Corretiva</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Melhoria" class="planning-filter-tipo" checked>
                                    <span>Melhoria</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="RevisÃ£o" class="planning-filter-tipo" checked>
                                    <span>RevisÃ£o</span>
                                </label>
                            </div>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Prioridade</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Alta" class="planning-filter-prioridade" checked>
                                    <span>Alta</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="MÃ©dia" class="planning-filter-prioridade" checked>
                                    <span>MÃ©dia</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Baixa" class="planning-filter-prioridade" checked>
                                    <span>Baixa</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="-" class="planning-filter-prioridade" checked>
                                    <span>Sem Prioridade</span>
                                </label>
                            </div>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Estado</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Novo" class="planning-filter-estado" checked>
                                    <span>Novo</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Em curso" class="planning-filter-estado" checked>
                                    <span>Em curso</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Resolvido" class="planning-filter-estado">
                                    <span>Resolvido</span>
                                </label>
                            </div>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Empresa</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="MCF" class="planning-filter-empresa" checked>
                                    <span>MCF</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="PSY" class="planning-filter-empresa" checked>
                                    <span>PSY</span>
                                </label>
                            </div>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">ğŸ”§ Ãrea/Equipamento</label>
                            <button id="planningFilterEquipamentoBtn" class="filtro-excel-trigger" type="button" style="margin-top: 8px;">
                                ğŸ“‹ Todos os equipamentos
                            </button>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">ğŸ‘¤ ResponsÃ¡vel</label>
                            <select id="planningFilterResponsavel" class="form-input" style="width: 100%; margin-top: 8px;">
                                <option value="">Todos os responsÃ¡veis</option>
                                <!-- Populado dinamicamente -->
                            </select>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Tipo de IntervenÃ§Ã£o</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Eletricidade" class="planning-filter-tipoIntervencao" checked>
                                    <span>Eletricidade</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="MecÃ¢nica" class="planning-filter-tipoIntervencao" checked>
                                    <span>MecÃ¢nica</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="HidrÃ¡ulica / PneumÃ¡tica" class="planning-filter-tipoIntervencao" checked>
                                    <span>HidrÃ¡ulica / PneumÃ¡tica</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Serralharia" class="planning-filter-tipoIntervencao" checked>
                                    <span>Serralharia</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Outros" class="planning-filter-tipoIntervencao" checked>
                                    <span>Outros</span>
                                </label>
                            </div>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Especiais</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="true" class="planning-filter-urgente">
                                    <span>ğŸ”´ Urgente</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="true" class="planning-filter-paragemProducao">
                                    <span>âš ï¸ Paragem ProduÃ§Ã£o</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="true" class="planning-filter-exigeCompra">
                                    <span>ğŸ›’ Exige compra material</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="planning-filters">
                        <button class="btn btn-secondary" id="todayBtn">Hoje</button>
                        <button class="btn btn-secondary" id="togglePlaneadasBtn" onclick="toggleApenasPlanadas()" title="Mostrar apenas OTs com dias alocados">
                            <span id="togglePlaneadasIcon">ğŸ‘ï¸</span> <span id="togglePlaneadasText">Apenas Planeadas</span>
                        </button>
                        <button class="btn btn-secondary" id="savePlanningBtn">Salvar Planeamento</button>
                        <button class="btn btn-primary" id="printPlanningBtn" onclick="imprimirPlaneamento()" title="Imprimir planeamento em PDF">
                            ğŸ–¨ï¸ Imprimir PDF
                        </button>
                    </div>
                </div>

                <!-- Grid de Planeamento -->
                <div class="card planning-grid-container">
                    <div class="planning-scroll">
                        <table class="planning-grid" id="planningGrid">
                            <!-- SerÃ¡ preenchido dinamicamente -->
                        </table>
                    </div>
                </div>

                <!-- Legenda -->
                <div class="card planning-legend">
                    <h3>Legenda</h3>
                    <div class="legend-items">
                        <div class="legend-item">
                            <span class="legend-box allocated">X</span>
                            <span>Dia alocado</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-box weekend"></span>
                            <span>Fim de semana</span>
                        </div>
                        <div class="legend-item">
                            <span class="badge badge-prioridade alta">Alta</span>
                            <span class="badge badge-prioridade media">MÃ©dia</span>
                            <span class="badge badge-prioridade baixa">Baixa</span>
                            <span>Prioridades</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ğŸ“š TAB MANUAIS -->
        <!-- âŒ TAB MANUAIS REMOVIDA (merged para tab-documentos) v3.8.3.10.27.38 -->
        <!-- ğŸ“š DOCUMENTOS Tab (merge de AutÃ³nomas + Manuais) v3.8.3.10.27.38 -->
        <section class="tab-content" id="tab-documentos">
            <div class="container">
                <div class="card">
                    <h2 class="card-title">ğŸ”§ ManutenÃ§Ãµes AutÃ³nomas MCF</h2>
                    <p class="card-description">Selecione uma mÃ¡quina para visualizar os procedimentos de manutenÃ§Ã£o.</p>
                    
                    <!-- Seletor de MÃ¡quina -->
                    <div class="form-group">
                        <label class="form-label" for="machineSelect">MÃ¡quina</label>
                        <select class="form-input" id="machineSelect">
                            <option value="">Selecione uma mÃ¡quina</option>
                            <option value="crivo">Crivo de excÃªntrico</option>
                            <option value="destrocador">DestroÃ§ador</option>
                            <option value="l01-dupla">L01 - Dupla</option>
                            <option value="l01-multiserra">L01 - Multiserra</option>
                            <option value="l01-paletizadora">L01 - Paletizadora</option>
                            <option value="l01-retestadeira">L01 - Retestadeira</option>
                            <option value="l01-tracador">L01 - TraÃ§ador</option>
                            <option value="l02-charriot">L02 - Charriot</option>
                            <option value="l02-retestadeira">L02 - Retestadeira</option>
                            <option value="l03-alinhadeira">L03 - Alinhadeira</option>
                            <option value="l03-paletizadora">L03 - Paletizadora</option>
                            <option value="l03-retestadeira">L03 - Retestadeira</option>
                            <option value="tinas">Tinas impregnante</option>
                        </select>
                    </div>

                    <!-- AÃ§Ãµes PDF -->
                    <div class="pdf-actions" id="pdfActions" style="display: none;">
                        <button class="btn btn-secondary" id="downloadPdfBtn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                            </svg>
                            Download
                        </button>
                        <button class="btn btn-secondary" id="printPdfBtn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 9V2h12v7M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                                <rect x="6" y="14" width="12" height="8"/>
                            </svg>
                            Imprimir
                        </button>
                        <!-- âŒ v3.8.3.10.27.38: BotÃ£o "Abrir no Google Drive" REMOVIDO (migraÃ§Ã£o para Supabase) -->
                    </div>
                </div>

                <!-- Visualizador PDF -->
                <div class="card pdf-viewer-container" id="pdfViewerContainer" style="display: none;">
                    <div class="pdf-viewer-header">
                        <h3 id="pdfTitle">Procedimento de ManutenÃ§Ã£o</h3>
                        <button class="btn-icon" id="closePdfBtn" title="Fechar">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                    <div class="pdf-viewer">
                        <iframe id="pdfIframe" frameborder="0" allowfullscreen></iframe>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="pdfEmptyState" class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                    </svg>
                    <h3>Selecione uma MÃ¡quina</h3>
                    <p>Escolha uma mÃ¡quina acima para visualizar os standards de manutenÃ§Ã£o MCF</p>
                </div>
                
                <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                <!-- SECÃ‡ÃƒO 2: MANUAIS DISPONÃVEIS -->
                <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                
                <div class="card" style="margin-top: var(--spacing-xl);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                        <div>
                            <h2 class="card-title" style="margin: 0;">ğŸ“– Manuais DisponÃ­veis</h2>
                            <p class="card-description" style="margin-top: 8px;">Consulte os manuais de instruÃ§Ã£o dos equipamentos</p>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="carregarManuais()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" 
                                 style="width: 16px; height: 16px; margin-right: 4px;">
                                <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                            </svg>
                            Atualizar
                        </button>
                    </div>
                    
                    <!-- Lista de Manuais -->
                    <div id="manuaisLista">
                        <div class="loading-spinner">A carregar manuais...</div>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="manuaisEmptyState" class="empty-state-small" style="display: none;">
                        <p>ğŸ“š Nenhum manual carregado ainda. FaÃ§a upload do primeiro manual abaixo!</p>
                    </div>
                </div>
                
                <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                <!-- SECÃ‡ÃƒO 3: UPLOAD DE NOVO MANUAL -->
                <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                
                <div class="card" style="margin-top: var(--spacing-xl);">
                    <h2 class="card-title">ğŸ“¤ Upload de Novo Manual</h2>
                    <p class="card-description">Adicione novos manuais de instruÃ§Ã£o para consulta pelo Chatbot IA</p>
                    
                    <form id="uploadManualForm" class="maintenance-form">
                        <!-- Equipamento -->
                        <div class="form-group">
                            <label class="form-label" for="manualEquipamento">Equipamento *</label>
                            <input type="text" class="form-input" id="manualEquipamento" 
                                   placeholder="ex: Alinhadeira L03" required>
                        </div>
                        
                        <!-- TÃ­tulo -->
                        <div class="form-group">
                            <label class="form-label" for="manualTitulo">TÃ­tulo do Manual *</label>
                            <input type="text" class="form-input" id="manualTitulo" 
                                   placeholder="ex: Manual de OperaÃ§Ã£o e ManutenÃ§Ã£o" required>
                        </div>
                        
                        <!-- DescriÃ§Ã£o -->
                        <div class="form-group">
                            <label class="form-label" for="manualDescricao">DescriÃ§Ã£o</label>
                            <textarea class="form-input" id="manualDescricao" rows="3"
                                      placeholder="Breve descriÃ§Ã£o do conteÃºdo do manual..."></textarea>
                        </div>
                        
                        <!-- Upload PDF -->
                        <div class="form-group">
                            <label class="form-label" for="manualPDF">Ficheiro PDF *</label>
                            <input type="file" class="form-input" id="manualPDF" 
                                   accept=".pdf" required>
                            <small style="color: var(--color-text-secondary); margin-top: 8px; display: block;">
                                Tamanho mÃ¡ximo: 50MB
                            </small>
                        </div>
                        
                        <!-- BotÃµes -->
                        <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-lg);">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" 
                                     style="width: 20px; height: 20px; margin-right: 8px;">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-15M12 17V3M7 8l5-5 5 5"/>
                                </svg>
                                Upload e Processar
                            </button>
                            <button type="button" class="btn btn-secondary" 
                                    onclick="document.getElementById('uploadManualForm').reset()">
                                Limpar
                            </button>
                        </div>
                    </form>
                    
                    <!-- Progress Bar -->
                    <div id="uploadProgress" style="display: none; margin-top: var(--spacing-lg);">
                        <div style="margin-bottom: 8px;">
                            <strong id="uploadProgressLabel">A processar...</strong>
                            <span id="uploadProgressPercent" style="float: right; color: var(--color-blue);">0%</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: var(--color-border); border-radius: 4px; overflow: hidden;">
                            <div id="uploadProgressBar" style="width: 0%; height: 100%; background: var(--color-blue); transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tab Stock -->
        <section class="tab-content" id="tab-stock">
            <div class="container">
                
                <!-- SECÃ‡ÃƒO 1: CONSULTA E BAIXA RÃPIDA -->
                <div class="card">
                    <h2 class="card-title">ğŸ“¦ Consulta de Stock e Baixas</h2>
                    
                    <!-- Pesquisa de Artigo -->
                    <div class="form-group">
                        <label class="form-label">Procurar Artigo</label>
                        <input type="text" 
                               class="form-input" 
                               id="stockSearchInput" 
                               placeholder="Digite nome, famÃ­lia, referÃªncia, fornecedor ou cÃ³digo...">
                    </div>
                    
                    <!-- Resultados da Pesquisa em CARDS -->
                    <div id="stockSearchResults" style="display: none;">
                        <div class="stock-results-header">
                            <strong>Resultados:</strong>
                            <button class="btn btn-secondary btn-sm" onclick="clearStockSearch()">âœ• Limpar</button>
                        </div>
                        <div class="stock-cards-grid" id="stockSearchResultsBody">
                            <!-- Preenchido dinamicamente com cards -->
                        </div>
                    </div>
                    
                    <!-- Estado Vazio -->
                    <div id="stockEmptySearch" class="empty-state-small">
                        <p>ğŸ” Digite acima para procurar artigos</p>
                    </div>
                </div>
                
                <!-- SECÃ‡ÃƒO 2: REGISTAR NOVO MOVIMENTO -->
                <div class="card" style="margin-top: var(--spacing-lg);">
                    <h2 class="card-title">â• Registar Novo Movimento</h2>
                    <p class="card-description">Criar entrada, saÃ­da ou ajuste de stock (Ãºnico ou mÃºltiplo)</p>
                    
                    <button class="btn btn-primary" onclick="openBaixaMultiplaModal()" style="width: 100%; padding: var(--spacing-md);">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; margin-right: 8px;">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        Movimento Stock
                    </button>
                </div>
                
                <!-- SECÃ‡ÃƒO 3: âš ï¸ ALERTAS DE STOCK MÃNIMO -->
                <div class="card" style="margin-top: var(--spacing-lg);">
                    <h2 class="card-title">âš ï¸ Alertas de Stock MÃ­nimo</h2>
                    <p class="card-description">Artigos com stock abaixo do mÃ­nimo definido</p>
                    
                    <div id="stockMinimoContent">
                        <!-- Preenchido dinamicamente -->
                    </div>
                </div>
                
                <!-- SECÃ‡ÃƒO 4: HISTÃ“RICO DE MOVIMENTOS -->
                <div class="card" style="margin-top: var(--spacing-lg);">
                    <h2 class="card-title">ğŸ“‹ HistÃ³rico de Movimentos</h2>
                    
                    <!-- Pesquisa de Artigo -->
                    <div class="form-group">
                        <label class="form-label">Procurar Artigo</label>
                        <input type="text" 
                               class="form-input" 
                               id="historicoSearchInput" 
                               placeholder="Digite nome, famÃ­lia, referÃªncia, fornecedor ou cÃ³digo...">
                    </div>
                    
                    <!-- Filtros de Movimentos (aparecem apÃ³s selecionar artigo) -->
                    <div id="historicoFilters" style="display: none; margin-top: var(--spacing-md);">
                        <div class="movimento-filters">
                            <select class="form-input" id="movimentoTipoFilter" onchange="renderMovimentosByArtigo()">
                                <option value="TODOS">Todos os Tipos</option>
                                <option value="Entrada">ğŸ“¥ Entradas</option>
                                <option value="SaÃ­da">ğŸ“¤ SaÃ­das</option>
                                <option value="Ajuste">âš™ï¸ Ajustes</option>
                            </select>
                            <input type="number" 
                                   class="form-input" 
                                   id="movimentoLimitFilter" 
                                   value="20" 
                                   min="10" 
                                   max="100" 
                                   step="10"
                                   onchange="renderMovimentosByArtigo()"
                                   placeholder="Limite">
                            <button class="btn btn-secondary btn-sm" onclick="clearHistoricoSearch()">âœ• Limpar</button>
                        </div>
                    </div>
                    
                    <!-- Tabela de Movimentos (aparece apÃ³s selecionar artigo) -->
                    <div id="historicoTableContainer" style="display: none; margin-top: var(--spacing-md);">
                        <div class="stock-table-container">
                            <table class="stock-table">
                                <thead>
                                    <tr>
                                        <th>Data/Hora</th>
                                        <th>Tipo</th>
                                        <th>Quantidade</th>
                                        <th>ResponsÃ¡vel</th>
                                        <th>ObservaÃ§Ãµes</th>
                                        <th>AÃ§Ãµes</th>
                                    </tr>
                                </thead>
                                <tbody id="movimentosTableBody">
                                    <!-- Preenchido dinamicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Estado Vazio -->
                    <div id="historicoEmptyState" class="empty-state-small">
                        <p>ğŸ” Digite acima para procurar um artigo e ver seu histÃ³rico</p>
                    </div>
                    
                    <div id="historicoNoMovimentos" class="empty-state-small" style="display: none;">
                        <p>ğŸ“­ Nenhum movimento registado para este artigo</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal de Detalhes -->
    <div class="modal" id="detailsModal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Detalhes da Ordem de Trabalho</h2>
                <button class="btn-close" id="closeModal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- ConteÃºdo serÃ¡ inserido dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Container de ImpressÃ£o (oculto) -->
    <div id="printContainer" style="display: none;"></div>

    <!-- Modal: Movimento de Stock -->
    <div class="modal" id="movimentoModal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="movimentoModalTitle">Movimento de Stock</h2>
                <button class="btn-close" onclick="closeMovimentoModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="movimentoForm" class="movimento-form">
                    <!-- Filtro de FamÃ­lia -->
                    <div class="form-group">
                        <label class="form-label">ğŸ“¦ FamÃ­lia</label>
                        <select class="form-input" id="movimentoFamiliaSelect" onchange="filtrarArtigosPorFamilia()">
                            <option value="">Todas as famÃ­lias</option>
                        </select>
                    </div>
                    
                    <!-- SeleÃ§Ã£o de Artigo -->
                    <div class="form-group" id="artigoSelectGroup">
                        <label class="form-label">Artigo *</label>
                        <select class="form-input" id="movimentoArtigoSelect" required onchange="updateArtigoInfo()">
                            <option value="">Selecione um artigo...</option>
                        </select>
                    </div>
                    
                    <!-- Info do Artigo Selecionado -->
                    <div class="artigo-selected-info" id="artigoSelectedInfo" style="display: none;"></div>
                    
                    <div class="form-group">
                        <label class="form-label">Tipo de Movimento *</label>
                        <select class="form-input" id="movimentoTipo" required>
                            <option value="Entrada">ğŸ“¥ Entrada (Compra/DevoluÃ§Ã£o)</option>
                            <option value="SaÃ­da">ğŸ“¤ SaÃ­da (Consumo)</option>
                            <option value="Ajuste">âš™ï¸ Ajuste (CorreÃ§Ã£o)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Quantidade *</label>
                        <div class="quantidade-input-group">
                            <button type="button" class="quantidade-btn" onclick="adjustQuantidade(-1)">âˆ’</button>
                            <input type="number" 
                                   class="form-input quantidade-input" 
                                   id="movimentoQuantidade" 
                                   min="1" 
                                   value="1" 
                                   required>
                            <button type="button" class="quantidade-btn" onclick="adjustQuantidade(1)">+</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Empresa *</label>
                        <select class="form-input" id="movimentoEmpresa" required>
                            <option value="">Selecione a empresa</option>
                            <option value="MCF" selected>MCF</option>
                            <option value="PSY">PSY</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ResponsÃ¡vel</label>
                        <input type="text" 
                               class="form-input" 
                               id="movimentoResponsavel" 
                               list="responsaveisList">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ObservaÃ§Ãµes</label>
                        <textarea class="form-input" 
                                  id="movimentoObservacoes" 
                                  rows="3" 
                                  placeholder="Motivo do movimento, notas adicionais..."></textarea>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeMovimentoModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">ğŸ’¾ Registar Movimento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ğŸ†• Modal: Baixa MÃºltipla de Stock -->
    <div class="modal" id="baixaMultiplaModal">
        <div class="modal-overlay"></div>
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="baixaMultiplaModalTitle">ğŸ’° Baixa de Stock</h2>
                <button class="btn-close" onclick="closeBaixaMultiplaModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Associar a OT (opcional) -->
                <div class="form-group" style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <label class="form-label">ğŸ”— Associar a Ordem de Trabalho (opcional)</label>
                    <input type="text" 
                           class="form-input" 
                           id="baixaMultiplaOTSearch" 
                           placeholder="Digite ID da OT (ex: OT_00067) ou deixe vazio..."
                           style="margin-bottom: 8px;">
                    <div id="baixaMultiplaOTInfo" style="display: none; padding: 12px; background: white; border-radius: 8px; border: 1px solid #dee2e6;">
                        <!-- Info da OT selecionada -->
                    </div>
                </div>

                <!-- Lista de Artigos para Baixa -->
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <label class="form-label" style="margin: 0;">ğŸ“¦ Artigos para Baixa</label>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="adicionarLinhaBaixa()">
                            â• Adicionar Artigo
                        </button>
                    </div>
                    
                    <div id="baixaMultiplaLinhas" style="display: flex; flex-direction: column; gap: 12px;">
                        <!-- Linhas de artigos adicionadas dinamicamente -->
                    </div>
                </div>

                <!-- Resumo e Total -->
                <div id="baixaMultiplaResumo" style="display: none; padding: 16px; background: #e8f5e9; border-radius: 8px; margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">ğŸ“Š Resumo da Baixa:</div>
                    <div id="baixaMultiplaResumoConteudo"></div>
                </div>

                <!-- Campos Comuns -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">Empresa *</label>
                        <select class="form-input" id="baixaMultiplaEmpresa" required>
                            <option value="MCF" selected>MCF</option>
                            <option value="PSY">PSY</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">ResponsÃ¡vel *</label>
                        <input type="text" 
                               class="form-input" 
                               id="baixaMultiplaResponsavel" 
                               placeholder="Nome do responsÃ¡vel"
                               required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">ObservaÃ§Ãµes</label>
                    <textarea class="form-input" 
                              id="baixaMultiplaObservacoes" 
                              rows="2" 
                              placeholder="ObservaÃ§Ãµes gerais sobre esta baixa..."></textarea>
                </div>

                <!-- AÃ§Ãµes -->
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeBaixaMultiplaModal()">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="confirmarBaixaMultipla()">
                        âœ… Confirmar Baixa
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Login - Apple Style Clean -->
    <div class="login-screen" id="loginModal" style="display: none;">
        <div class="login-card-wrapper">
            <div class="login-card-apple">
                <!-- Logo -->
                <div class="login-logo-container">
                    <img src="/appmanutencao/icons/android-chrome-192x192.png" alt="Logo ManutenÃ§Ã£o" class="login-logo" id="loginLogo">
                </div>
                
                <!-- TÃ­tulo -->
                <h1 class="login-title-apple">GestÃ£o de manutenÃ§Ã£o MCF + PSY</h1>
                <p class="login-subtitle-apple">FaÃ§a login para continuar</p>
                
                <!-- FormulÃ¡rio -->
                <form id="loginForm" class="login-form-apple">
                    <div class="login-input-wrapper">
                        <input type="text" 
                               class="login-input-apple" 
                               id="loginUsername" 
                               placeholder="Username"
                               required 
                               autocomplete="username">
                    </div>
                    
                    <div class="login-input-wrapper">
                        <input type="password" 
                               class="login-input-apple" 
                               id="loginPassword" 
                               placeholder="Password"
                               required 
                               autocomplete="current-password">
                    </div>
                    
                    <div id="loginError" class="login-error-apple" style="display: none;"></div>
                    
                    <button type="submit" class="login-button-apple">
                        Entrar
                    </button>
                    

                </form>
            </div>
        </div>
    </div>

    <!-- Tab AnÃ¡lise -->
    <section class="tab-content" id="tab-analise">
        <div class="container">
            <!-- TÃ­tulo -->
            <div class="card">
                <h2 class="card-title">ğŸ“Š AnÃ¡lise de Pedidos</h2>
                
                <!-- Cards de MÃ©tricas -->
                <div class="analytics-cards">
                    <div class="analytics-card">
                        <div class="analytics-card-icon" style="background: #4CAF50;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14"/>
                            </svg>
                        </div>
                        <div class="analytics-card-content">
                            <div class="analytics-card-label">Ordens Abertas Esta Semana</div>
                            <div class="analytics-card-value" id="abertosEstaSemana">-</div>
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="analytics-card-icon" style="background: #2196F3;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 11 12 14 22 4"/>
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                            </svg>
                        </div>
                        <div class="analytics-card-content">
                            <div class="analytics-card-label">Ordens Fechadas Esta Semana</div>
                            <div class="analytics-card-value" id="fechadosEstaSemana">-</div>
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="analytics-card-icon" style="background: #FF9800;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/>
                            </svg>
                        </div>
                        <div class="analytics-card-content">
                            <div class="analytics-card-label">Backlog Total</div>
                            <div class="analytics-card-value" id="backlogTotal">-</div>
                            <div class="analytics-card-trend" id="backlogTrend"></div>
                        </div>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="analytics-filters">
                    <select id="analiseEmpresaFilter" class="form-input">
                        <option value="">Todas as Empresas</option>
                        <option value="MCF">MCF</option>
                        <option value="PSY">PSY</option>
                    </select>
                    
                    <button class="btn btn-primary" onclick="atualizarAnalises()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                            <polyline points="23 4 23 10 17 10"/>
                            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                        </svg>
                        Atualizar
                    </button>
                </div>

                <!-- âœ… GrÃ¡fico 1: Pedidos Fechados por Utilizador -->
                <div class="analytics-chart-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
                        <div>
                            <h3 class="analytics-chart-title" style="margin: 0;">ğŸ“Š Pedidos Fechados por Utilizador</h3>
                            <p style="font-size: 12px; color: #666; margin-top: 4px; margin-bottom: 0;">
                                â„¹ï¸ OTs antigas mostram quem iniciou/foi alocado | OTs novas (apÃ³s 14/01/2026) mostram quem fechou
                            </p>
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="filter-btn" data-period="1" onclick="filtrarPorUtilizadorPeriodo(1)">Ãšltimo Dia</button>
                            <button class="filter-btn active" data-period="7" onclick="filtrarPorUtilizadorPeriodo(7)">Ãšltima Semana</button>
                            <button class="filter-btn" data-period="30" onclick="filtrarPorUtilizadorPeriodo(30)">Ãšltimo MÃªs</button>
                            <button class="filter-btn" data-period="180" onclick="filtrarPorUtilizadorPeriodo(180)">6 Meses</button>
                            <button class="filter-btn" data-period="365" onclick="filtrarPorUtilizadorPeriodo(365)">Ãšltimo Ano</button>
                        </div>
                    </div>
                    <canvas id="chartPedidosPorUtilizador"></canvas>
                </div>

                <!-- ğŸ†• v3.7.6.9: GrÃ¡fico Pie Chart - Tipos de IntervenÃ§Ã£o -->
                <div class="analytics-chart-container">
                    <h3 class="analytics-chart-title">ğŸ”§ Tipos de IntervenÃ§Ã£o (Todos os Pedidos)</h3>
                    <div style="max-width: 500px; margin: 0 auto;">
                        <canvas id="chartTiposIntervencao"></canvas>
                    </div>
                </div>

                <!-- GrÃ¡fico 2: Ordens de Trabalho por Semana -->
                <div class="analytics-chart-container">
                    <h3 class="analytics-chart-title">Ordens de Trabalho por Semana</h3>
                    <canvas id="chartPedidosPorSemana"></canvas>
                </div>

                <!-- GrÃ¡fico 3: EvoluÃ§Ã£o do Backlog -->
                <div class="analytics-chart-container">
                    <h3 class="analytics-chart-title">EvoluÃ§Ã£o do Backlog</h3>
                    <canvas id="chartEvolucaoBacklog"></canvas>
                </div>
            </div>

            <!-- Chatbot -->
            <div class="card" style="margin-top: var(--spacing-lg);">
                <h2 class="card-title">ğŸ¤– Assistente de AnÃ¡lise</h2>
                <p style="color: var(--color-text-secondary); margin-bottom: var(--spacing-lg);">
                    FaÃ§a perguntas sobre tendÃªncias, padrÃµes de avarias, anÃ¡lises de mÃ¡quinas e muito mais.
                </p>
                
                <!-- HistÃ³rico de Chat -->
                <div class="chatbot-history" id="chatbotHistory">
                    <div class="chatbot-message chatbot-message-assistant">
                        <div class="chatbot-message-content">
                            OlÃ¡! Sou o teu assistente de anÃ¡lise. Podes perguntar-me sobre:<br>
                            â€¢ TendÃªncias de manutenÃ§Ãµes<br>
                            â€¢ MÃ¡quinas com mais avarias<br>
                            â€¢ ComparaÃ§Ãµes entre MCF e PSY<br>
                            â€¢ PadrÃµes temporais<br>
                            â€¢ PrevisÃµes de manutenÃ§Ã£o
                        </div>
                    </div>
                </div>
                
                <!-- Input do Chat -->
                <div class="chatbot-input-container">
                    <textarea 
                        id="chatbotInput" 
                        class="chatbot-input" 
                        placeholder="Pergunta algo sobre os dados de manutenÃ§Ã£o..."
                        rows="2"></textarea>
                    <button id="chatbotSendBtn" class="btn btn-primary" onclick="enviarPerguntaChatbot()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"/>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                        </svg>
                        Enviar
                    </button>
                </div>
                
                <div class="chatbot-status" id="chatbotStatus" style="display: none;">
                    <svg class="chatbot-loading" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="2" x2="12" y2="6"/>
                        <line x1="12" y1="18" x2="12" y2="22"/>
                        <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/>
                        <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/>
                        <line x1="2" y1="12" x2="6" y2="12"/>
                        <line x1="18" y1="12" x2="22" y2="12"/>
                        <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/>
                        <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/>
                    </svg>
                    A pensar...
                </div>
            </div>
        </div>
    </section>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    
    <!-- ğŸ”¥ Supabase Client INLINE v3.6.8 -->
    <script>
// ================================================
// ğŸ”¥ SUPABASE CLIENT - INLINE
// ================================================

// CONFIGURAÃ‡ÃƒO SUPABASE
const SUPABASE_CONFIG = {
    URL: 'https://wegftalccimrnnlmoiyn.supabase.co',
    ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlZ2Z0YWxjY2ltcm5ubG1vaXluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MDY0MzIsImV4cCI6MjA4MjM4MjQzMn0.0TqEtQnJC7kVQO284C0xvaE_xi2e0zuXpsF1M4ZEw4w'
};

// HELPER: Fetch genÃ©rico para Supabase REST API
async function supabaseFetch(endpoint, options = {}) {
    const url = `${SUPABASE_CONFIG.URL}/rest/v1/${endpoint}`;
    const headers = {
        'apikey': SUPABASE_CONFIG.ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_CONFIG.ANON_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation',
        ...options.headers
    };

    const response = await fetch(url, {
        ...options,
        headers
    });

    if (!response.ok) {
        const error = await response.json();
        console.error('âŒ Supabase Error:', error);
        throw new Error(error.message || 'Erro na API Supabase');
    }

    return response.json();
}

// ================================================
// API FUNCTIONS
// ================================================

// Artigos
async function getArtigos() {
    // âœ… v3.7.0.9: Filtrar apenas artigos visÃ­veis (VisÃ­vel = true)
    return await supabaseFetch('artigos?select=*&VisÃ­vel=eq.true&order=ID.asc');
}

// Utilizadores
async function getUtilizadores() {
    try {
        const result = await supabaseFetch('utilizadores?select=Username,Nome Completo,Departamento,Role,Ativo&order=Nome Completo.asc');
        
        // Mapear para formato esperado
        const mapped = result.map(u => ({
            username: u.Username,
            nomeCompleto: u['Nome Completo'],
            departamento: u.Departamento,
            role: u.Role,
            ativo: u.Ativo
        }));
        
        return mapped;
    } catch (error) {
        console.error('âŒ [getUtilizadores] ERRO ao ler tabela:', error);
        console.error('âŒ [getUtilizadores] Detalhes:', error.message);
        throw error;
    }
}

async function loginUtilizador(username, password) {
    const users = await supabaseFetch(`utilizadores?Username=eq.${encodeURIComponent(username)}&Password=eq.${encodeURIComponent(password)}`);
    
    if (users.length === 0) {
        throw new Error('Utilizador ou password incorretos');
    }
    
    return users[0];
}

// Pedidos
async function getPedidos() {
    // âœ… Corrigido: Remover order porque "Data/hora" tem barra
    return await supabaseFetch('pedidos?select=*');
}

async function addPedido(pedido) {
    return await supabaseFetch('pedidos', {
        method: 'POST',
        body: JSON.stringify(pedido)
    });
}

async function updatePedido(id, pedido) {
    return await supabaseFetch(`pedidos?ID=eq.${id}`, {
        method: 'PATCH',
        body: JSON.stringify(pedido)
    });
}

async function deletePedido(id) {
    return await supabaseFetch(`pedidos?ID=eq.${id}`, {
        method: 'DELETE'
    });
}

// Movimentos
async function getMovimentos() {
    // âœ… Corrigido: Remover order porque "Data/Hora" tem barra
    return await supabaseFetch('movimentos?select=*');
}

async function addMovimento(movimento) {
    return await supabaseFetch('movimentos', {
        method: 'POST',
        body: JSON.stringify(movimento)
    });
}

// Planeamento
async function getPlaneamento() {
    return await supabaseFetch('planeamento?select=*');
}

async function addPlaneamento(planeamento) {
    return await supabaseFetch('planeamento', {
        method: 'POST',
        body: JSON.stringify(planeamento)
    });
}

async function updatePlaneamento(id, planeamento) {
    return await supabaseFetch(`planeamento?ID=eq.${id}`, {
        method: 'PATCH',
        body: JSON.stringify(planeamento)
    });
}

async function deletePlaneamento(id) {
    return await supabaseFetch(`planeamento?ID=eq.${id}`, {
        method: 'DELETE'
    });
}

// ğŸ“¸ v3.6.18: Storage para Fotos
async function uploadFoto(pedidoId, file) {
    try {
        console.log('ğŸ“¸ [FOTO-INICIAL] Iniciando upload...', file.name, (file.size / 1024 / 1024).toFixed(2) + ' MB');
        
        // Nome do ficheiro = ID da ordem + extensÃ£o
        const ext = file.type.split('/')[1] || 'jpg';
        const fileName = `${pedidoId}.${ext}`;
        
        // Upload via REST API do Supabase Storage
        const url = `${SUPABASE_CONFIG.URL}/storage/v1/object/pedidos-fotos/${fileName}`;
        

        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_CONFIG.ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_CONFIG.ANON_KEY}`,
                'Content-Type': file.type,
                'x-upsert': 'true'  // Substituir se jÃ¡ existir
            },
            body: file  // Enviar File diretamente
        });
        

        
        if (!response.ok) {
            const error = await response.text();
            console.error('âŒ [FOTO-INICIAL] Erro upload Storage:', error);
            throw new Error('Erro ao fazer upload da foto');
        }
        
        // Retornar URL pÃºblica
        const publicUrl = `${SUPABASE_CONFIG.URL}/storage/v1/object/public/pedidos-fotos/${fileName}`;
        console.log('âœ… [FOTO-INICIAL] Foto enviada:', publicUrl);
        return publicUrl;
        
    } catch (error) {
        console.error('âŒ Erro ao fazer upload:', error);
        return null;  // Retornar null em vez de falhar
    }
}

async function deleteFoto(pedidoId) {
    try {
        // Tentar deletar jpg, jpeg, png, webp (nÃ£o sabemos a extensÃ£o)
        const extensions = ['jpg', 'jpeg', 'png', 'webp'];
        
        for (const ext of extensions) {
            const fileName = `${pedidoId}.${ext}`;
            const url = `${SUPABASE_CONFIG.URL}/storage/v1/object/pedidos-fotos/${fileName}`;
            
            await fetch(url, {
                method: 'DELETE',
                headers: {
                    'apikey': SUPABASE_CONFIG.ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_CONFIG.ANON_KEY}`
                }
            });
        }
        
        console.log('âœ… Foto eliminada (tentado todas extensÃµes)');
        
    } catch (error) {
        console.error('âš ï¸ Erro ao eliminar foto:', error);
        // NÃ£o falhar se nÃ£o conseguir deletar
    }
}

function getFotoUrl(pedidoId, extensao = 'jpg') {
    if (!pedidoId) return null;
    return `${SUPABASE_CONFIG.URL}/storage/v1/object/public/pedidos-fotos/${pedidoId}.${extensao}`;
}

// âœ… v3.7.0.9: Buscar equipamentos do Supabase
async function getEquipamentos() {
    try {
        const result = await supabaseFetch('lista_equipamentos?select=*&order=area.asc,ordem.asc');
        if (!result || result.length === 0) {
            console.warn('âš ï¸ Nenhum equipamento encontrado');
        }
        return result || [];
    } catch (error) {
        console.error('âŒ Erro ao buscar equipamentos:', error);
        return [];
    }
}

// ğŸ“š MANUAIS
async function getManuais() {
    try {
        return await supabaseFetch('manuais?select=*&ativo=eq.true&order=created_at.desc');
    } catch (error) {
        console.error('âŒ Erro ao buscar manuais:', error);
        return [];
    }
}

async function addManual(manual) {
    return await supabaseFetch('manuais', {
        method: 'POST',
        body: JSON.stringify(manual)
    });
}

async function updateManual(id, manual) {
    return await supabaseFetch(`manuais?id=eq.${id}`, {
        method: 'PATCH',
        body: JSON.stringify(manual)
    });
}

async function deleteManual(id) {
    return await supabaseFetch(`manuais?id=eq.${id}`, {
        method: 'PATCH',
        body: JSON.stringify({ ativo: false })
    });
}

async function addConteudoManual(conteudo) {
    return await supabaseFetch('manuais_conteudo', {
        method: 'POST',
        body: JSON.stringify(conteudo)
    });
}

async function getConteudoManual(manualId) {
    try {
        return await supabaseFetch(`manuais_conteudo?manual_id=eq.${manualId}&order=pagina_inicio.asc`);
    } catch (error) {
        console.error('âŒ Erro ao buscar conteÃºdo do manual:', error);
        return [];
    }
}

async function uploadManualPDF(manualId, file) {
    try {
        console.log('ğŸ“„ Iniciando upload do PDF...', file.name, (file.size / 1024 / 1024).toFixed(2) + ' MB');
        
        const fileName = `${manualId}.pdf`;
        
        // ğŸ”§ CORREÃ‡ÃƒO v3.7.3.2: Usar FormData para upload correto
        const formData = new FormData();
        formData.append('file', file);
        
        // URL correto do Supabase Storage
        const url = `${SUPABASE_CONFIG.URL}/storage/v1/object/manuais/${fileName}`;
        

        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_CONFIG.ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_CONFIG.ANON_KEY}`,
                // âŒ NÃƒO definir Content-Type - deixar o browser definir para FormData
            },
            body: formData  // ğŸ”§ Usar FormData em vez de file direto
        });
        

        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('âŒ Erro upload Storage:', response.status, errorText);
            
            // Tentar parsear como JSON para melhor diagnÃ³stico
            try {
                const errorJson = JSON.parse(errorText);
                console.error('âŒ Detalhes do erro:', errorJson);
                throw new Error(errorJson.message || errorJson.error || 'Erro ao fazer upload do PDF');
            } catch (parseError) {
                throw new Error(`Erro ao fazer upload do PDF: ${response.status} - ${errorText}`);
            }
        }
        
        // Construir URL pÃºblico
        const publicUrl = `${SUPABASE_CONFIG.URL}/storage/v1/object/public/manuais/${fileName}`;
        console.log('âœ… PDF enviado com sucesso!');
        console.log('âœ… URL pÃºblica:', publicUrl);
        return publicUrl;
        
    } catch (error) {
        console.error('âŒ Erro ao fazer upload do PDF:', error);
        throw error;
    }
}

// ğŸš€ v3.8.3.10.27.38: Upload de PDF de AutÃ³noma para Supabase Storage
async function uploadAutonomaPDF(filePath, file) {
    try {
        console.log('ğŸ“„ Upload autÃ³noma:', file.name, (file.size / 1024 / 1024).toFixed(2) + ' MB');
        
        // ğŸ”§ Normalizar nome do ficheiro (remover acentos, espaÃ§os, caracteres especiais)
        const normalizedPath = filePath
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '') // Remove acentos
            .replace(/\s+/g, '-')             // Substitui espaÃ§os por hÃ­fens
            .toLowerCase();                   // MinÃºsculas
        
        console.log('ğŸ“ Path normalizado:', normalizedPath);
        
        const formData = new FormData();
        formData.append('file', file);
        
        // URL do Supabase Storage (bucket: manuais, path: autonomas/nome.pdf)
        const url = `${SUPABASE_CONFIG.URL}/storage/v1/object/manuais/${normalizedPath}`;
        
        console.log('ğŸ”— URL de upload:', url);
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_CONFIG.ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_CONFIG.ANON_KEY}`,
            },
            body: formData
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('âŒ Erro upload:', response.status, errorText);
            console.error('âŒ URL tentada:', url);
            
            // Tentar parsear erro JSON
            try {
                const errorJson = JSON.parse(errorText);
                console.error('âŒ Detalhes:', errorJson);
                throw new Error(errorJson.message || `Erro ${response.status}: ${errorText}`);
            } catch (parseError) {
                throw new Error(`Erro ${response.status}: ${errorText}`);
            }
        }
        
        // URL pÃºblico
        const publicUrl = `${SUPABASE_CONFIG.URL}/storage/v1/object/public/manuais/${normalizedPath}`;
        console.log('âœ… PDF autÃ³noma enviado:', publicUrl);
        return publicUrl;
        
    } catch (error) {
        console.error('âŒ Erro ao fazer upload de autÃ³noma:', error);
        throw error;
    }
}

// ğŸ†• v3.8.3.10.27: HISTÃ“RICO DE EXECUÃ‡Ã•ES PREVENTIVAS
// ============================================

// Adicionar execuÃ§Ã£o de preventiva
async function addExecucaoPreventiva(pedidoId, dadosExecucao) {
    try {
        console.log('ğŸ“ Registrando execuÃ§Ã£o preventiva...', pedidoId);
        
        const execucao = {
            pedido_id: pedidoId,
            data_execucao: dadosExecucao.dataExecucao || new Date().toISOString(),
            responsavel: dadosExecucao.responsavel || '',
            observacoes: dadosExecucao.observacoes || '',
            foto_url: dadosExecucao.fotoUrl || '',
            horas_gastas: dadosExecucao.horasGastas || 0,
            custo_materiais: dadosExecucao.custoMateriais || 0
        };
        
        const response = await fetch(`${SUPABASE_CONFIG.URL}/rest/v1/execucoes_preventivas`, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_CONFIG.ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_CONFIG.ANON_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
            },
            body: JSON.stringify(execucao)
        });
        
        if (!response.ok) {
            throw new Error(`Erro ao registrar execuÃ§Ã£o: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('âœ… ExecuÃ§Ã£o registrada:', data[0]);
        return data[0];
        
    } catch (error) {
        console.error('âŒ Erro ao registrar execuÃ§Ã£o:', error);
        throw error;
    }
}

// Buscar histÃ³rico de execuÃ§Ãµes de uma preventiva
async function getExecucoesPreventiva(pedidoId) {
    try {
        console.log('ğŸ“‹ Buscando histÃ³rico de execuÃ§Ãµes...', pedidoId);
        
        const response = await fetch(
            `${SUPABASE_CONFIG.URL}/rest/v1/execucoes_preventivas?pedido_id=eq.${pedidoId}&order=data_execucao.desc`,
            {
                headers: {
                    'apikey': SUPABASE_CONFIG.ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_CONFIG.ANON_KEY}`
                }
            }
        );
        
        if (!response.ok) {
            throw new Error(`Erro ao buscar execuÃ§Ãµes: ${response.status}`);
        }
        
        const data = await response.json();
        console.log(`âœ… ${data.length} execuÃ§Ãµes encontradas`);
        return data;
        
    } catch (error) {
        console.error('âŒ Erro ao buscar execuÃ§Ãµes:', error);
        return [];
    }
}

// Calcular e atualizar prÃ³xima execuÃ§Ã£o
async function atualizarProximaExecucao(pedidoId, frequencia, dataBase) {
    try {
        console.log('ğŸ“… Calculando prÃ³xima execuÃ§Ã£o...', pedidoId);
        
        // Buscar dados do pedido
        const response = await fetch(
            `${SUPABASE_CONFIG.URL}/rest/v1/pedidos?ID=eq.${pedidoId}&select=data_primeira_intervencao,frequencia,total_execucoes`,
            {
                headers: {
                    'apikey': SUPABASE_CONFIG.ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_CONFIG.ANON_KEY}`
                }
            }
        );
        
        if (!response.ok) {
            throw new Error(`Erro ao buscar pedido: ${response.status}`);
        }
        
        const pedidos = await response.json();
        if (pedidos.length === 0) {
            throw new Error('Pedido nÃ£o encontrado');
        }
        
        const pedido = pedidos[0];
        const dataInicial = dataBase || pedido.data_primeira_intervencao;
        const freq = frequencia || pedido.frequencia;
        
        if (!dataInicial || !freq) {
            console.warn('âš ï¸ Sem data inicial ou frequÃªncia');
            return null;
        }
        
        // Calcular prÃ³xima data usando a funÃ§Ã£o existente
        const proximaData = calcularProximaIntervencao(dataInicial, freq);
        
        if (!proximaData) {
            console.warn('âš ï¸ NÃ£o foi possÃ­vel calcular prÃ³xima data');
            return null;
        }
        
        // Formatar data para SQL (YYYY-MM-DD)
        const proximaDataSQL = proximaData.toISOString().split('T')[0];
        
        // Atualizar pedido
        const updateResponse = await fetch(
            `${SUPABASE_CONFIG.URL}/rest/v1/pedidos?ID=eq.${pedidoId}`,
            {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_CONFIG.ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_CONFIG.ANON_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify({
                    proxima_execucao: proximaDataSQL,
                    ultima_execucao: new Date().toISOString(),
                    total_execucoes: (pedido.total_execucoes || 0) + 1
                })
            }
        );
        
        if (!updateResponse.ok) {
            throw new Error(`Erro ao atualizar prÃ³xima execuÃ§Ã£o: ${updateResponse.status}`);
        }
        
        console.log('âœ… PrÃ³xima execuÃ§Ã£o calculada:', proximaDataSQL);
        return proximaDataSQL;
        
    } catch (error) {
        console.error('âŒ Erro ao atualizar prÃ³xima execuÃ§Ã£o:', error);
        throw error;
    }
}

// Exportar para uso global
window.SupabaseAPI = {
    getArtigos,
    getUtilizadores,
    loginUtilizador,
    getPedidos,
    addPedido,
    updatePedido,
    deletePedido,
    getMovimentos,
    addMovimento,
    getPlaneamento,
    addPlaneamento,
    updatePlaneamento,
    deletePlaneamento,
    uploadFoto,
    deleteFoto,
    getFotoUrl,
    getEquipamentos,
    // Manuais
    getManuais,
    addManual,
    updateManual,
    deleteManual,
    addConteudoManual,
    getConteudoManual,
    uploadManualPDF,
    uploadAutonomaPDF,  // ğŸš€ v3.8.3.10.27.38: Upload de autÃ³nomas
    // ğŸ†• v3.8.3.10.27: ExecuÃ§Ãµes preventivas
    addExecucaoPreventiva,
    getExecucoesPreventiva,
    atualizarProximaExecucao
};

// Supabase API inicializada
    </script>
    
    <!-- JavaScript Principal (INLINE para garantir funcionamento) -->
    <script>
// ================================================
// App de ManutenÃ§Ã£o - JavaScript Principal  
// VERSÃƒO INLINE PARA MOBILE PWA
// ================================================

// CONFIGURAÃ‡ÃƒO
const CONFIG = {
    // âŒ DESATIVADO - Migrado para Supabase v3.6.8
    // GOOGLE_SHEETS_URL: 'https://script.google.com/macros/s/AKfycbxsgLa1qTwDRg13sItlTHg5cqhFaxrvjj_Oq-7f7VCBUcMNog_qPvRDrYm1vgAkoB-w-g/exec',
    
    // ğŸ“¸ v3.6.18: Aumentar limites para fotos (Storage)
    MAX_IMAGE_SIZE: 5 * 1024 * 1024,  // 5 MB (era 2 MB)
    IMAGE_QUALITY: 0.85,               // 85% (era 80%)
    MAX_IMAGE_WIDTH: 2560,             // 2560px (era 1920px)
    MAX_IMAGE_HEIGHT: 2560,            // 2560px (era 1920px),
    LOGO_PATHS: [
        'icons/android-chrome-192x192.png',
        './icons/android-chrome-192x192.png',
        '/icons/android-chrome-192x192.png'
    ],
    STORAGE_KEYS: {
        REQUESTS: 'maintenance_requests',
        OFFLINE_QUEUE: 'maintenance_offline_queue',
        USER_NAME: 'maintenance_user_name',
        PLANNING: 'maintenance_planning',
        USER_SESSION: 'maintenance_user_session',
        USER_TOKEN: 'maintenance_user_token'
    },
    PLANNING_WEEKS: 2,
    INCLUDE_WEEKENDS: true,
    MACHINES: {
        // ğŸš€ v3.8.3.10.27.40: URLs migradas para Supabase Storage (autonomas/)
        'crivo': { 
            name: 'Crivo de excÃªntrico', 
            url: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/crivo-de-excentrico.pdf', 
            embedUrl: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/crivo-de-excentrico.pdf' 
        },
        'destrocador': { 
            name: 'DestroÃ§ador', 
            url: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/destrocador.pdf', 
            embedUrl: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/destrocador.pdf' 
        },
        'l01-dupla': { 
            name: 'L01 - Dupla', 
            url: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/l01---dupla.pdf', 
            embedUrl: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/l01---dupla.pdf' 
        },
        'l01-multiserra': { 
            name: 'L01 - Multiserra', 
            url: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/l01---multiserra.pdf', 
            embedUrl: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/l01---multiserra.pdf' 
        },
        'l01-paletizadora': { 
            name: 'L01 - Paletizadora', 
            url: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/l01---paletizadora.pdf', 
            embedUrl: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/l01---paletizadora.pdf' 
        },
        'l01-retestadeira': { 
            name: 'L01 - Retestadeira', 
            url: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/l01---retestadeira.pdf', 
            embedUrl: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/l01---retestadeira.pdf' 
        },
        'l01-tracador': { 
            name: 'L01 - TraÃ§ador', 
            url: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/l01---tracador.pdf', 
            embedUrl: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/l01---tracador.pdf' 
        },
        'l02-charriot': { 
            name: 'L02 - Charriot', 
            url: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/l02---charriot.pdf', 
            embedUrl: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/l02---charriot.pdf' 
        },
        'l02-retestadeira': { 
            name: 'L02 - Retestadeira', 
            url: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/l02---retestadeira.pdf', 
            embedUrl: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/l02---retestadeira.pdf' 
        },
        'l03-alinhadeira': { 
            name: 'L03 - Alinhadeira', 
            url: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/l03---alinhadeira.pdf', 
            embedUrl: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/l03---alinhadeira.pdf' 
        },
        'l03-paletizadora': { 
            name: 'L03 - Paletizadora', 
            url: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/l03---paletizadora.pdf', 
            embedUrl: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/l03---paletizadora.pdf' 
        },
        'l03-retestadeira': { 
            name: 'L03 - Retestadeira', 
            url: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/l03---retestadeira.pdf', 
            embedUrl: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/l03---retestadeira.pdf' 
        },
        'tinas': { 
            name: 'Tinas impregnante', 
            url: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/tinas-impregnante.pdf', 
            embedUrl: 'https://wegftalccimrnnlmoiyn.supabase.co/storage/v1/object/public/manuais/autonomas/tinas-impregnante.pdf' 
        }
    },
    
    // âŒ REMOVIDO v3.7.0.9: Migrado para Supabase (tabela lista_equipamentos)
    // Os equipamentos agora sÃ£o carregados dinamicamente do Supabase
    EQUIPAMENTOS_OLD: {
        'Triagem': [
            'Redler superior Silo Casca',
            'Redler transporte para Silo Casca',
            'Rampa Entrada principal Triagem',
            'Descascadeira',
            'Corrente SaÃ­da Descascadeira',
            'Rampa Entrada PÃ³s-Descascadeira',
            'Raixo X',
            'Corrente SaÃ­da Raio X',
            'Redler Principal Triagem',
            'Redler Cascas Descascador Charriot',
            'Corrente Transporte Triagem',
            'Box 1',
            'Box 2',
            'Box 3',
            'Box 4',
            'Box 5',
            'Box 6',
            'Box 7',
            'Box 8 - Rampa Linha Principal',
            'Triagem Outros'
        ],
        'L01 - Linha Principal': [
            'Tapete desperdicio L01',
            'Quadro ElÃ©ctrico/AutÃ³mato L01',
            'Tapete Costaneiros L01-L03',
            'Tapete Superior de Escolha L01',
            'Tapete Escolha L01',
            'Progrow',
            'Estrutura L01',
            'Separador do TraÃ§ador L01',
            'Rampa Entrada Exterior TraÃ§ador L01',
            'Redler Entrada TraÃ§ador L01',
            'TraÃ§ador L01',
            'Tapete SaÃ­da TraÃ§ador L01',
            'Rampa saÃ­da TraÃ§ador L01',
            'Comandos Controlo Dupla L01',
            'Separador Dupla L1',
            'Rolos rotaÃ§Ã£o Dupla L01',
            'Calcador Dupla L01',
            'Serra Esquerda Dupla L01',
            'Serra Direita Dupla L01',
            'Corrente de traÃ§Ã£o Dupla L01',
            'Tapete SaÃ­da Dupla L01',
            'Rolos TraÃ§Ã£o Centrador L01',
            'Centrador L01',
            'Tapete Entrada 3/4 Face L01',
            '3/4 Face L01',
            'Rolos traÃ§Ã£o 3/4 Face L01',
            'Rolos traÃ§Ã£o Retestadeira L01',
            'Retestadeira L01',
            'Rolos traÃ§Ã£o Multiserra L01',
            'Multiserra L01',
            'Tapete saida Multiserra L01',
            'Tapete entrada Paletizador L01',
            'Paletizador L01',
            'Descarga Paletizador L01',
            'L01 - Linha Principal - Outros'
        ],
        'L03 - Linha Aproveitamentos': [
            'Tapete desperdicio L03.01',
            'Tapete desperdicio L03.02',
            'Tapete inferior da Escolha L03.01',
            'Tapete Escolha L03.02',
            'Plataforma elevatoria L03',
            'Estrutura L03',
            'Tapete Entrada Alinhadeira L03',
            'Alinhadeira L03',
            'Tapete Entrada Retestadeira L03',
            'Retestadeira L03',
            'Corrente de saÃ­da Retestadeira L03',
            'Tapete Transporte Retest. L03-Multiserra',
            'Corrente entrada Multis.L03.01',
            'Multiserra L03.01',
            'Corrente entrada Multis.L03.02',
            'Multiserra L03.02',
            'Tapete entrada-Mesa de Escolha L03.01',
            'Paletizador L03',
            'L03 - Linha Aproveitamentos - Outros'
        ],
        'L02 - Charriot': [
            'Rampa Entrada Descascadeira Charriot L02',
            'Descascadeira Charriot L02',
            'Corrente Transporte Desc. - Charriot L02',
            'Redler Charriot L02',
            'Rampa Entrada Charriot L02',
            'Charriot L02',
            'Cabine Comando Charriot L02',
            'Tapete Desperdicio Charriot L02',
            'Rampa Descarga Charriot L02',
            'Rampa Carga-Descarga Charriot L02',
            'Rolos traÃ§Ã£o Charriot - Multiserra L02',
            'Mesa entrada Multiserra L02',
            'Cabine Comando Multiserra L02',
            'Tapete Saida Multiserra L02',
            'Mesa Escolha do Paletizador L02',
            'Tapete inferior Escolha Paletizador L02',
            'Retestadeira L02',
            'Rolos Entrada Retestadeira L02',
            'L02 - Charriot - Outros'
        ],
        'DestroÃ§ador': [
            'Quadro ElÃ©ctrico/Automato',
            'Tapete  Desperdicio',
            'Tapete Entrada',
            'DestroÃ§ador',
            'Tapete Saida DestroÃ§ador',
            'Crivos',
            'Tapete Finos',
            'Tapete Estilha',
            'DestroÃ§ador - Outros'
        ],
        'AspiraÃ§Ã£o': [
            'Tubagem AspiraÃ§Ã£o',
            'Ventilador',
            'Ciclones',
            'AspiraÃ§Ã£o - Outros'
        ],
        'Redlers Interiores': [
            'Redler Dupla L01',
            'Redler 3/4 Face',
            'Redler Dupla-3/4 Face',
            'Redler Retestadeira L01-Alinh. L03',
            'Redler Multiserra L01',
            'Redler Retest. L01-Multis.L01',
            'Redler Linha Principal - Silo',
            'Redler L03',
            'Redler DestroÃ§ador - Charriot',
            'Redler Charriot-Silo'
        ],
        'Empilhadores': [
            'Nissan',
            'Linde',
            'Caterpillar'
        ],
        'PÃ¡s Carregadoras': [
            'Caterpillar 1',
            'Caterpillar 2',
            'Case'
        ],
        'High-Liflts': [
            'Volvo C',
            'Volvo D',
            'Volvo E'
        ],
        'Tinas Tratamento': [
            'Tina 1',
            'Tina 2',
            'Tina 3'
        ],
        'Bomba GasÃ³leo': [
            'Bomba GasÃ³leo'
        ],
        'Estufa': [
            'Estufa Secagem'
        ],
        'Caldeiras': [
            'Caldeira 1',
            'Caldeira 2'
        ],
        'Rede Ar comprimido': [
            'Compressor 1',
            'Compressor 2',
            'Compressor 3',
            'Secador 1',
            'Secador 2',
            'Rede DistribuiÃ§Ã£o Ar Comprimido'
        ],
        'Edificio': [
            'Electricidade',
            'CanalizaÃ§Ã£o Ãgua',
            'Saneamento',
            'Rede InformÃ¡tica',
            'Estrutura',
            'Edificio - Outros'
        ],
        'MCF': [
            'MCF - Outros'
        ]
    }
};

// ================================================
// FUNÃ‡ÃƒO DE FALLBACK PARA LOGOS
// ================================================
let logoAttempts = 0;

function handleLogoError(imgElement) {
    console.error('ğŸš¨ ERRO ao carregar logo:', imgElement.src);
    logoAttempts++;
    
    // Tentar prÃ³ximo path da lista
    if (logoAttempts < CONFIG.LOGO_PATHS.length) {
        const nextPath = CONFIG.LOGO_PATHS[logoAttempts];
        console.log(`ğŸ”„ Tentando path alternativo (${logoAttempts + 1}/${CONFIG.LOGO_PATHS.length}):`, nextPath);
        imgElement.src = nextPath;
        return;
    }
    
    // Se todos os paths falharam, usar SVG como fallback
    console.warn('âš ï¸ Todos os paths de imagem falharam. Usando SVG fallback.');
    
    const svgLogo = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: ${imgElement.classList.contains('login-logo') ? '140px' : '32px'}; height: ${imgElement.classList.contains('login-logo') ? '140px' : '32px'}; color: #667eea;">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v12M6 12h12"/>
            <circle cx="12" cy="12" r="3"/>
        </svg>
    `;
    
    imgElement.outerHTML = svgLogo;
}

// Testar caminhos dos logos ao carregar
// Logo paths test removed (v3.8.3.3 - cleanup)

// ESTADO DA APLICAÃ‡ÃƒO
const AppState = {
    requests: [],
    filteredRequests: [],
    sortOrder: 'desc',
    groupMode: false,
    // ğŸ¯ v3.8.3.10.27.37: Filtros padrÃ£o - Preventivas (Para breve + Atrasadas) + Corretiva + Melhoria
    currentFilters: { 
        tipo: ['Para breve', 'Atrasadas', 'Corretiva', 'Melhoria'], 
        prioridade: [], 
        estado: ['Novo', 'Em curso'], 
        empresa: [], 
        tipoIntervencao: [], 
        urgente: [], 
        paragemProducao: [], 
        exigeCompra: [] 
    },
    isOnline: navigator.onLine,
    planning: { 
        tasks: {},  // âœ… v3.7.0.8: { pedidoId: { responsavel, horasEstimadas, diasAlocados: [] } }
        allocations: {},  // ğŸ”„ Mantido por compatibilidade (serÃ¡ migrado)
        startDate: null, 
        endDate: null,
        apenasPlanadas: false  // ğŸ†• v3.8.3.10.27.20: Filtro para mostrar apenas OTs planeadas
    },
    artigos: [],
    movimentos: [],
    utilizadores: [],  // âœ… NOVO: Lista de utilizadores para dropdown
    equipamentos: [],  // âœ… v3.7.0.9: Lista de equipamentos do Supabase
    artigoSelecionado: null,
    currentUser: null,  // { username, nomeCompleto, departamento, role, podeEditarPlaneamento, token }
    filtroEquipamentoSelecionados: [],  // ğŸ†• v3.8.3.10.27.46: Equipamentos selecionados (Lista de OTs)
    filtroEquipamentoPlanningSelecionados: []  // ğŸ†• v3.8.3.10.27.46: Equipamentos selecionados (Planeamento)
};

// âœ… v3.6.8: App migrado para SUPABASE
// Artigos, movimentos e pedidos sÃ£o carregados do Supabase
// Se nÃ£o houver dados, app mostra erro (nÃ£o usa dados falsos)

let currentMachine = null;

// ============================================
// SISTEMA DE AUTENTICAÃ‡ÃƒO
// ============================================

async function checkAuthentication() {
    console.log('ğŸ” checkAuthentication() chamado');
    
    if (AppState.currentUser) {
        console.log('âœ… User jÃ¡ em memÃ³ria:', AppState.currentUser.username);
        showUserInterface();
        return true;
    }
    
    let savedSession = localStorage.getItem(CONFIG.STORAGE_KEYS.USER_SESSION);
    let savedToken = localStorage.getItem(CONFIG.STORAGE_KEYS.USER_TOKEN);
    
    console.log('ğŸ“¦ localStorage:', {
        session: savedSession ? 'EXISTE' : 'VAZIO',
        token: savedToken ? 'EXISTE' : 'VAZIO'
    });
    
    // Se localStorage vazio, tentar restaurar dos cookies
    if (!savedSession || !savedToken) {
        const cookieSession = getCookie('maintenance_user_session');
        const cookieToken = getCookie('maintenance_user_token');
        
        if (cookieSession && cookieToken) {
            localStorage.setItem(CONFIG.STORAGE_KEYS.USER_SESSION, cookieSession);
            localStorage.setItem(CONFIG.STORAGE_KEYS.USER_TOKEN, cookieToken);
            savedSession = cookieSession;
            savedToken = cookieToken;
        }
    }
    
    if (savedSession && savedToken) {
        try {
            const userData = JSON.parse(savedSession);
            AppState.currentUser = userData;
            showUserInterface();
            return true;
        } catch (e) {
            console.error('âŒ Erro ao parsear sessÃ£o:', e);
            clearSession();
        }
    } else {
        console.log('âŒ Sem sessÃ£o guardada - mostrar login');
    }
    
    showLoginModal();
    return false;
}

function showLoginModal() {
    const modal = document.getElementById('loginModal');
    const mainContent = document.querySelector('.app-main');
    const header = document.querySelector('.app-header');
    
    if (modal) {
        modal.style.display = 'flex'; // Inline sobrescreve tudo
        modal.classList.add('show');
    }
    if (mainContent) mainContent.style.display = 'none';
    if (header) header.style.opacity = '0.5';
    
    console.log('ğŸ”“ Modal de login mostrado');
}

function hideLoginModal() {
    const modal = document.getElementById('loginModal');
    const mainContent = document.querySelector('.app-main');
    const header = document.querySelector('.app-header');
    
    if (modal) {
        modal.style.display = 'none'; // Inline garante esconder
        modal.classList.remove('show');
    }
    if (mainContent) mainContent.style.display = 'block';
    if (header) header.style.opacity = '1';
    
    console.log('ğŸ”’ Modal de login escondido');
}

async function handleLogin(event) {
    event.preventDefault();
    
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    const errorDiv = document.getElementById('loginError');
    const submitBtn = event.target.querySelector('button[type="submit"]');
    
    if (!username || !password) {
        showLoginError('Por favor, preencha todos os campos');
        return;
    }
    
    try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'A validar...';
        errorDiv.style.display = 'none';
        
        console.log('ğŸ” A tentar login:', username);
        
        // ğŸ”¥ LOGIN COM SUPABASE v3.6.8
        const user = await window.SupabaseAPI.loginUtilizador(username, password);
        
        // Criar sessÃ£o local
        const sessionData = {
            username: user.Username,
            nomeCompleto: user['Nome Completo'],
            departamento: user.Departamento,
            role: user.Role,
            // ğŸ”§ Aceitar: 'Sim', 'true', true, TRUE
            podeEditarPlaneamento: user['Pode editar'] === 'Sim' || 
                                  user['Pode editar'] === 'true' || 
                                  user['Pode editar'] === true || 
                                  user['Pode editar'] === 'TRUE',
            // ğŸ”§ Aceitar: 'Sim', 'true', true, TRUE
            ativo: user.Ativo === 'Sim' || 
                   user.Ativo === 'true' || 
                   user.Ativo === true || 
                   user.Ativo === 'TRUE',
            token: 'supabase_' + Date.now()
        };
        
        AppState.currentUser = sessionData;
        localStorage.setItem(CONFIG.STORAGE_KEYS.USER_SESSION, JSON.stringify(sessionData));
        localStorage.setItem(CONFIG.STORAGE_KEYS.USER_TOKEN, sessionData.token);
        setCookie('maintenance_user_session', JSON.stringify(sessionData), 30);
        setCookie('maintenance_user_token', sessionData.token, 30);
        
        showToast(`Bem-vindo, ${sessionData.nomeCompleto}!`, 'success');
        
        hideLoginModal();
        showUserInterface();
        
        setTimeout(() => {
            applyUserAutoFill();
            applyPermissions();
        }, 200);
        
        // ğŸ”¥ CARREGAR DADOS DO SUPABASE
        if (AppState.isOnline) await loadDataFromSupabase();
        renderRequestsList();
        
    } catch (e) {
        console.error('âŒ Erro ao fazer login:', e);
        showLoginError('Erro ao conectar ao servidor. Verifique a ligaÃ§Ã£o Ã  internet.');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<svg style="width: 20px; height: 20px; margin-right: 8px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M13.8 12H3"/></svg>Entrar';
    }
}

// ğŸ”¥ NOVA FUNÃ‡ÃƒO v3.6.8: Carregar dados do Supabase
async function loadDataFromSupabase() {
    try {
        console.log('ğŸ“¥ A carregar dados do Supabase...');
        
        // Carregar pedidos
        const pedidos = await window.SupabaseAPI.getPedidos();
        
        // ğŸ” DEBUG: Ver estrutura dos dados
        console.log('ğŸ” PEDIDOS RECEBIDOS DO SUPABASE:');
        console.log('Total:', pedidos.length);
        if (pedidos.length > 0) {
            console.log('Primeiro pedido:', JSON.stringify(pedidos[0], null, 2));
        }
        
        // ğŸ†• v3.7.7.0: Carregar utilizadores
        const utilizadores = await window.SupabaseAPI.getUtilizadores();
        AppState.utilizadores = utilizadores;
        
        // Converter formato Supabase â†’ formato da app
        AppState.requests = pedidos.map(p => ({
            id: p.ID,
            dataHora: p['Data/hora'],           // âœ… Corrigido: era timestamp
            tipo: p.Tipo,                       // âœ… Corrigido: era type
            frequencia: p.frequencia || '',     // âœ… v3.7.0.8: snake_case
            dataPrimeiraIntervencao: p.data_primeira_intervencao || '',  // âœ… v3.7.0.8: snake_case
            prioridade: p.Prioridade,           // âœ… Corrigido: era priority
            departamento: p.Departamento,       // âœ… Corrigido: era department
            descricao: p.DescriÃ§Ã£o,             // âœ… Corrigido: era description
            nome: p['Registado por'],           // âœ… Corrigido: era registeredBy
            estado: p.Estado,                   // âœ… Corrigido: era status
            foto: p.Foto || '',                 // âœ… OK
            artigos: p.Artigos ? (typeof p.Artigos === 'string' ? JSON.parse(p.Artigos) : p.Artigos) : [],
            empresa: p.Empresa,                 // âœ… Corrigido: era company
            tipoIntervencao: p['Tipo IntervenÃ§Ã£o'] || '', // âœ… Corrigido: era interventionType
            areaEquipamento: p['Ãrea/Equipamento'] || '', // âœ… Corrigido: era areaEquipment
            componente: p.Componente || '',     // âœ… Corrigido: era component
            urgente: p.Urgente === 'TRUE' || p.Urgente === true,
            paragemProducao: p['Paragem ProduÃ§Ã£o'] === 'TRUE' || p['Paragem ProduÃ§Ã£o'] === true,
            exigeCompra: p['Exige Compra'] === 'TRUE' || p['Exige Compra'] === true,  // ğŸ†• v3.8.3.10.6
            responsavel: p.ResponsÃ¡vel || '',   // âœ… ADICIONADO v3.6.21 (display)
            responsavelUsername: p.responsavel_username || '',  // ğŸ†• v3.7.7.0: FK
            segundoResponsavel: p.segundo_responsavel || '',  // ğŸ†• v3.8.3.10.27.46: 2Âº ResponsÃ¡vel
            segundoResponsavelUsername: p.segundo_responsavel_username || '',  // ğŸ†• v3.8.3.10.27.46: FK
            criadoPorUsername: p.criado_por_username || '',     // ğŸ†• v3.7.7.0: FK
            horasEstimadas: parseFloat(p['Horas Estimadas']) || 0,  // âœ… ADICIONADO v3.6.21
            fechadoPor: p['Fechado Por'] || '',  // ğŸ†• v3.7.6.9: Quem fechou (display)
            fechadoPorUsername: p.fechado_por_username || '',  // ğŸ†• v3.7.7.0: FK
            observacoesFecho: p.observacoes_fecho || '',  // ğŸ†• v3.8.3.5: ObservaÃ§Ãµes de fecho
            fotoFecho: p.foto_fecho || '',  // ğŸ†• v3.8.3.5: Foto de fecho
            ultimaExecucao: p.ultima_execucao || null,  // ğŸ†• v3.8.3.10.27: Ãšltima execuÃ§Ã£o (preventivas)
            proximaExecucao: p.proxima_execucao || null,  // ğŸ†• v3.8.3.10.27: PrÃ³xima execuÃ§Ã£o (preventivas)
            totalExecucoes: parseInt(p.total_execucoes) || 0,  // ğŸ†• v3.8.3.10.27: Total de execuÃ§Ãµes (preventivas)
            numeroHoras: p.numero_horas ? parseInt(p.numero_horas) : null,  // ğŸ†• v3.8.3.10.27.45: NÃºmero de horas (revisÃµes)
            tiposRevisao: p.tipos_revisao || []  // ğŸ†• v3.8.3.10.27.45: Tipos de revisÃ£o selecionados
        }));
        
        // âœ… Ordenar por data (mais recentes primeiro) - ordem no JavaScript
        AppState.requests.sort((a, b) => {
            const dateA = new Date(a.dataHora);  // âœ… Corrigido: era timestamp
            const dateB = new Date(b.dataHora);  // âœ… Corrigido: era timestamp
            return dateB - dateA; // DESC
        });
        
        // Guardar localmente
        localStorage.setItem(CONFIG.STORAGE_KEYS.REQUESTS, JSON.stringify(AppState.requests));
        
    } catch (error) {
        console.error('âŒ Erro ao carregar dados do Supabase:', error);
        showToast('Erro ao carregar dados', 'error');
        
        // Em caso de erro, carregar do localStorage
        const cached = localStorage.getItem(CONFIG.STORAGE_KEYS.REQUESTS);
        if (cached) {
            AppState.requests = JSON.parse(cached);
            console.log('ğŸ“¦ Dados carregados do cache local');
        }
    }
}

async function validateSession(username, token) {
    // ğŸ”¥ v3.6.8: Simplificado - validaÃ§Ã£o local apenas
    try {
        // Validando sessÃ£o
        
        // Verificar se existe sessÃ£o local vÃ¡lida
        const sessionData = localStorage.getItem(CONFIG.STORAGE_KEYS.USER_SESSION);
        const sessionToken = localStorage.getItem(CONFIG.STORAGE_KEYS.USER_TOKEN);
        
        if (sessionData && sessionToken === token) {
            const userData = JSON.parse(sessionData);
            
            if (userData.username === username) {
                console.log('âœ… validateSession() - SessÃ£o VÃLIDA (local)');
                AppState.currentUser = userData;
                return true;
            }
        }
        
        console.warn('âš ï¸ validateSession() - SessÃ£o INVÃLIDA');
        return false;
        
    } catch (e) {
        console.error('âŒ validateSession() - ERRO:', e);
        return false;
    }
}

function showLoginError(message) {
    const errorDiv = document.getElementById('loginError');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
}

function showUserInterface() {
    if (!AppState.currentUser) return;
    
    hideLoginModal();
    
    const userInfo = document.getElementById('userInfo');
    const logoutBtn = document.getElementById('logoutBtn');
    
    if (userInfo) {
        userInfo.querySelector('.user-name').textContent = AppState.currentUser.nomeCompleto;
        userInfo.querySelector('.user-dept').textContent = AppState.currentUser.departamento;
        userInfo.style.display = 'flex';
    }
    
    if (logoutBtn) {
        logoutBtn.style.display = 'flex';
    }
    
    // ğŸ§ª Mostrar botÃµes de teste para Marco e GonÃ§alo
    const testarAlertasBtn = document.getElementById('testarAlertasBtn');
    const processarManualBtn = document.getElementById('processarManualBtn');
    
    const utilizadorNormalizado = AppState.currentUser.username.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    const isMarcoOuGoncalo = utilizadorNormalizado === 'marco' || utilizadorNormalizado === 'goncalo';
    
    if (isMarcoOuGoncalo) {
        if (testarAlertasBtn) {
            testarAlertasBtn.style.display = 'block';
    
        }
        
        if (processarManualBtn) {
            processarManualBtn.style.display = 'flex';
    
        }
    }
    
    applyUserAutoFill();
    applyPermissions();
    
    // ğŸ“Š Mostrar info de armazenamento (sÃ³ para admins)
    if (AppState.currentUser.role === 'admin' || AppState.currentUser.role === 'Administrador') {
        showStorageInfo();
    }
}

// Mostrar informaÃ§Ã£o de armazenamento (para admins)
function showStorageInfo() {
    setTimeout(() => {
        const storageInfo = getLocalStorageInfo();
        if (parseFloat(storageInfo.usagePercent) > 50) {
            console.warn(`âš ï¸ [ADMIN] LocalStorage: ${storageInfo.totalMB} MB (${storageInfo.usagePercent}% usado)`);
            
            if (storageInfo.isNearLimit) {
                showToast(`âš ï¸ Cache prÃ³ximo do limite (${storageInfo.usagePercent}%). Auto-limpeza ativa.`, 'warning');
            }
        }
    }, 2000);
}

function applyUserAutoFill() {
    if (!AppState.currentUser) return;
    
    const nomeInput = document.getElementById('nome');
    if (nomeInput) {
        nomeInput.value = AppState.currentUser.nomeCompleto;
        nomeInput.readOnly = true;
        nomeInput.style.background = '#F5F5F7';
        nomeInput.style.cursor = 'not-allowed';
    }
    
    const departamentoInput = document.getElementById('departamento');
    if (departamentoInput) {
        departamentoInput.value = AppState.currentUser.departamento;
        departamentoInput.readOnly = true;
        departamentoInput.style.background = '#F5F5F7';
        departamentoInput.style.cursor = 'not-allowed';
    }
    
    const movimentoResponsavel = document.getElementById('movimentoResponsavel');
    if (movimentoResponsavel) {
        movimentoResponsavel.value = AppState.currentUser.nomeCompleto;
    }
}

function applyPermissions() {
    if (!AppState.currentUser) return;
    
    const role = AppState.currentUser.role;
    const podeEditarPlaneamento = AppState.currentUser.podeEditarPlaneamento;
    const username = AppState.currentUser.username.toLowerCase();
    
    // ğŸ”’ v3.7.4.1: Mostrar aba Manuais apenas para admins e GonÃ§alo
    const tabManuaisBtn = document.getElementById('tabManuaisBtn');
    if (tabManuaisBtn) {
        // Normalizar nome (remover acentos/cedilhas)
        const usernameNormalizado = username.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
        const isAdmin = role === 'admin' || role === 'Administrador';
        const isGoncalo = usernameNormalizado === 'goncalo' || username === 'gonÃ§alo';
        
        if (isAdmin || isGoncalo) {
            tabManuaisBtn.style.display = 'flex';
            console.log('âœ… Aba Manuais habilitada para:', username);
        } else {
            tabManuaisBtn.style.display = 'none';
            console.log('ğŸ”’ Aba Manuais oculta para:', username);
        }
    }
    
    // Controlo de acesso ao Planeamento
    if (!podeEditarPlaneamento && role !== 'admin') {
        const planningTab = document.querySelector('.tab-content[data-tab="planeamento"]');
        if (planningTab) {
            const allInputs = planningTab.querySelectorAll('input, select, button, textarea');
            allInputs.forEach(input => {
                input.disabled = true;
                input.style.opacity = '0.6';
                input.title = 'Sem permissÃ£o para editar o planeamento';
            });
            
            // Adicionar aviso
            const warningDiv = document.createElement('div');
            warningDiv.className = 'permission-warning';
            warningDiv.style.cssText = 'background: #FFF4E5; border: 1px solid #FF9500; padding: 12px; border-radius: 8px; margin-bottom: 16px; color: #1D1D1F; font-size: 14px;';
            warningDiv.innerHTML = '<strong>âš ï¸ VisualizaÃ§Ã£o apenas:</strong> NÃ£o tem permissÃ£o para editar o planeamento.';
            planningTab.insertBefore(warningDiv, planningTab.firstChild);
        }
    }
    
    console.log('ğŸ”’ PermissÃµes aplicadas - Role:', role, '| Editar Planeamento:', podeEditarPlaneamento);
}

// ============================================
// FUNÃ‡Ã•ES DE COOKIES (BACKUP PERSISTENTE)
// ============================================

function setCookie(name, value, days = 30) {
    try {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        const expires = "expires=" + date.toUTCString();
        
        // Tentar com SameSite=None para PWA (precisa Secure em HTTPS)
        if (window.location.protocol === 'https:') {
            document.cookie = name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/;SameSite=None;Secure";
        } else {
            // HTTP ou file:// - usar Lax (mais compatÃ­vel)
            document.cookie = name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/;SameSite=Lax";
        }
        
        // BACKUP: Sempre salvar no localStorage tambÃ©m (iOS pode bloquear cookies)
        try {
            localStorage.setItem('cookie_' + name, value);
            localStorage.setItem('cookie_' + name + '_expires', date.getTime().toString());
        } catch (e) {
            console.warn('localStorage backup falhou:', e);
        }
    } catch (e) {
        console.error('Erro ao definir cookie:', e);
    }
}

function getCookie(name) {
    // Tentar ler do cookie primeiro
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for(let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) {
            return decodeURIComponent(c.substring(nameEQ.length, c.length));
        }
    }
    
    // BACKUP: Se cookie nÃ£o existe, tentar localStorage (iOS pode bloquear cookies)
    try {
        const backupValue = localStorage.getItem('cookie_' + name);
        const backupExpires = localStorage.getItem('cookie_' + name + '_expires');
        
        if (backupValue && backupExpires) {
            const expiresTime = parseInt(backupExpires);
            if (Date.now() < expiresTime) {
                return backupValue;
            } else {
                // Expirado - limpar
                localStorage.removeItem('cookie_' + name);
                localStorage.removeItem('cookie_' + name + '_expires');
            }
        }
    } catch (e) {
        console.warn('localStorage backup read falhou:', e);
    }
    
    return null;
}

function deleteCookie(name) {
    document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;";
}

function logout() {
    clearSession();
    AppState.currentUser = null;
    
    const userInfo = document.getElementById('userInfo');
    const logoutBtn = document.getElementById('logoutBtn');
    
    if (userInfo) userInfo.style.display = 'none';
    if (logoutBtn) logoutBtn.style.display = 'none';
    
    showToast('SessÃ£o terminada', 'info');
    showLoginModal();
    
    document.getElementById('loginForm').reset();
    document.getElementById('loginError').style.display = 'none';
}

function clearSession() {
    localStorage.removeItem(CONFIG.STORAGE_KEYS.USER_SESSION);
    localStorage.removeItem(CONFIG.STORAGE_KEYS.USER_TOKEN);
    deleteCookie('maintenance_user_session');
    deleteCookie('maintenance_user_token');
    APP_INITIALIZED = false;
}

// ============================================
// PROTEÃ‡ÃƒO CONTRA REINICIALIZAÃ‡Ã•ES
// ============================================

// Flag global para evitar mÃºltiplas inicializaÃ§Ãµes
let APP_INITIALIZED = false;

// Verificar se jÃ¡ existe sessÃ£o ativa ANTES do DOMContentLoaded
(function checkExistingSession() {
    const savedSession = localStorage.getItem('maintenance_user_session');
    const savedToken = localStorage.getItem('maintenance_user_token');
    const cookieSession = getCookie('maintenance_user_session');
    const cookieToken = getCookie('maintenance_user_token');
    
    if ((savedSession && savedToken) || (cookieSession && cookieToken)) {
        APP_INITIALIZED = true;
        console.log('ğŸ” SessÃ£o detectada ANTES do DOM - modal permanecerÃ¡ escondido');
        
        // ESCONDER MODAL IMEDIATAMENTE ao carregar DOM
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('loginModal');
            if (modal) {
                modal.style.display = 'none';
                console.log('âœ… Modal escondido imediatamente');
            }
        }, { once: true, capture: true });
    }
})();

// ğŸ” DEBUG: FunÃ§Ã£o para testar equipamentos e atualizar painel visual
async function testarEquipamentos() {
    const statusEl = document.getElementById('debugEquipStatus');
    const totalEl = document.getElementById('debugEquipTotal');
    const areasEl = document.getElementById('debugEquipAreas');
    const firstEl = document.getElementById('debugEquipFirst');
    
    try {
        statusEl.textContent = 'ğŸ”„ Carregando...';
        statusEl.style.color = '#ff9800';
        
        const resultado = await window.SupabaseAPI.getEquipamentos();
        AppState.equipamentos = resultado || [];
        
        const total = AppState.equipamentos.length;
        const areasUnicas = [...new Set(AppState.equipamentos.map(e => e.area))];
        const primeiro = AppState.equipamentos[0] || null;
        
        totalEl.textContent = total;
        totalEl.style.color = total > 0 ? '#4CAF50' : '#f44336';
        areasEl.textContent = areasUnicas.length;
        areasEl.style.color = areasUnicas.length > 0 ? '#4CAF50' : '#f44336';
        
        if (primeiro) {
            firstEl.textContent = `${primeiro.area} â†’ ${primeiro.componente}`;
            firstEl.style.color = '#4CAF50';
        } else {
            firstEl.textContent = 'âŒ Nenhum equipamento encontrado';
            firstEl.style.color = '#f44336';
        }
        
        if (total > 0) {
            statusEl.textContent = `âœ… ${total} equipamentos carregados!`;
            statusEl.style.color = '#4CAF50';
            
            // âœ… NÃƒO popular equipamentos automaticamente
            // Aguardar utilizador selecionar empresa primeiro
            const areaSelect = document.getElementById('areaEquipamento');
            if (areaSelect) {
                areaSelect.innerHTML = '<option value="">Escolha primeiro a empresa</option>';
                areaSelect.disabled = true;
            }
            
            populateEquipamentoFilter();
        } else {
            statusEl.textContent = 'âŒ ERRO: Supabase retornou 0 equipamentos!';
            statusEl.style.color = '#f44336';
        }
    } catch (error) {
        statusEl.textContent = `âŒ ${error.message}`;
        statusEl.style.color = '#f44336';
        totalEl.textContent = '0';
        areasEl.textContent = '0';
        firstEl.textContent = error.message;
    }
}

function atualizarPainelDebug() {
    const totalEl = document.getElementById('debugEquipTotal');
    if (!totalEl) return;
    
    const total = AppState.equipamentos.length;
    const areasUnicas = [...new Set(AppState.equipamentos.map(e => e.area))];
    const primeiro = AppState.equipamentos[0] || null;
    
    totalEl.textContent = total;
    totalEl.style.color = total > 0 ? '#4CAF50' : '#f44336';
    document.getElementById('debugEquipAreas').textContent = areasUnicas.length;
    
    if (primeiro) {
        document.getElementById('debugEquipFirst').textContent = `${primeiro.area} â†’ ${primeiro.componente}`;
        document.getElementById('debugEquipFirst').style.color = '#4CAF50';
    } else {
        document.getElementById('debugEquipFirst').textContent = 'Vazio';
        document.getElementById('debugEquipFirst').style.color = '#999';
    }
    
    document.getElementById('debugEquipStatus').textContent = total > 0 ? 'âœ… OK' : 'âš ï¸ Vazio';
    document.getElementById('debugEquipStatus').style.color = total > 0 ? '#4CAF50' : '#ff9800';
}

// INICIALIZAÃ‡ÃƒO
document.addEventListener('DOMContentLoaded', () => { initializeApp(); });

window.addEventListener('pageshow', (event) => {
    console.log('ğŸ”„ pageshow event - verificando sessÃ£o...');
    setTimeout(() => {
        if (!AppState.currentUser) {
            checkAuthentication();
        }
    }, 100);
});

async function initializeApp() {
    // Se jÃ¡ estÃ¡ inicializado e tem sessÃ£o vÃ¡lida, apenas restaurar UI
    if (APP_INITIALIZED && AppState.currentUser) {
        showUserInterface();
        renderRequestsList();
        return;
    }
    
    // ğŸ§¹ LIMPEZA AUTOMÃTICA DIÃRIA (primeiro que tudo!)
    cleanOldDataFromLocalStorage();
    
    await unregisterServiceWorkers();
    setupEventListeners();
    setupOnlineOfflineListeners();
    
    const isAuthenticated = await checkAuthentication();
    
    if (!isAuthenticated) {
        APP_INITIALIZED = false;
        return;
    }
    
    APP_INITIALIZED = true;
    
    // Carregando localStorage
    loadFromLocalStorage();
    console.log('ğŸ“Š Pedidos do localStorage:', AppState.requests?.length || 0);
    
    loadSavedUserName();
    
    // ğŸ”¥ AGUARDAR sincronizaÃ§Ã£o ANTES de restaurar aba
    if (AppState.isOnline) {
        console.log('ğŸŒ Online - sincronizando com Supabase...');
        await syncWithGoogleSheets();  // ğŸ”¥ Nome legacy, usa Supabase internamente
        console.log('âœ… SincronizaÃ§Ã£o completa - Pedidos:', AppState.requests?.length || 0);
    } else {
        console.warn('ğŸ“µ Offline - usando apenas localStorage');
    }
    
    renderRequestsList();
    await initializePlanning();  // âœ… v3.7.0.8: AWAIT para carregar planeamento do Supabase
    initializeAutonomousMaintenance();
    initializeStockModule();
    
    // ğŸ†• v3.8.3.10.27.42: Inicializar RevisÃµes e Multiselect
    if (typeof window.initializeRevisao === 'function') {
        window.initializeRevisao();
    }
    if (typeof window.initializeMultiselect === 'function') {
        window.initializeMultiselect();
    }
    
    // ğŸ“š Carregar manuais em background (para chatbot)
    carregarManuaisBackground();
    
    // âœ… CORREÃ‡ÃƒO: Restaurar aba ativa DEPOIS dos dados carregarem
    restoreActiveTab();
    
    // ğŸš¨ ALERTAS DE PRODUTIVIDADE: Verificar se tÃ©cnicos fecharam OTs ontem
    // Aguardar um momento para garantir que AppState.currentUser estÃ¡ carregado
    setTimeout(() => {

        verificarAlertasDiarios();
    }, 500);
}

// ===========================================
// ğŸš¨ SISTEMA DE ALERTAS DE PRODUTIVIDADE
// ===========================================

/**
 * Calcular o Ãºltimo dia Ãºtil (Segunda a SÃ¡bado)
 * @returns {Date|null} Data do Ãºltimo dia Ãºtil ou null se hoje for domingo
 */
function calcularUltimoDiaUtil() {
    const hoje = new Date();
    const diaDaSemana = hoje.getDay(); // 0=Domingo, 1=Segunda, ..., 6=SÃ¡bado
    
    // ğŸš« Se hoje Ã© DOMINGO (0), nÃ£o alertar (sem produÃ§Ã£o)
    if (diaDaSemana === 0) {
        console.log('ğŸ“… Hoje Ã© Domingo - SEM ALERTAS');
        return null;
    }
    
    // âœ… Se hoje Ã© SEGUNDA-FEIRA (1), verificar SÃBADO
    if (diaDaSemana === 1) {
        const sabado = new Date(hoje);
        sabado.setDate(hoje.getDate() - 2); // SÃ¡bado = Segunda - 2 dias
        console.log('ğŸ“… Segunda-feira â†’ Verificar SÃ¡bado:', sabado.toLocaleDateString('pt-PT'));
        return sabado;
    }
    
    // âœ… TerÃ§a a SÃ¡bado (2-6): verificar DIA ANTERIOR
    const ontem = new Date(hoje);
    ontem.setDate(hoje.getDate() - 1);
    console.log('ğŸ“… Dia Ãºtil â†’ Verificar ontem:', ontem.toLocaleDateString('pt-PT'));
    return ontem;
}

/**
 * Verificar se tÃ©cnicos fecharam OTs no Ãºltimo dia Ãºtil
 * Alertar Marco e GonÃ§alo se algum tÃ©cnico nÃ£o produziu
 */
async function verificarAlertasDiarios() {
    // ğŸ”’ Apenas para Marco e GonÃ§alo (com ou sem cedilha)
    const utilizadorAtual = AppState.currentUser?.username || '';
    
    // Normalizar nome (remover acentos para comparaÃ§Ã£o)
    const utilizadorNormalizado = utilizadorAtual.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    const isMarcoOuGoncalo = utilizadorNormalizado === 'marco' || utilizadorNormalizado === 'goncalo';
    
    if (!isMarcoOuGoncalo) {
        return; // NÃ£o mostrar alertas para outros utilizadores
    }
    
    // ğŸ†• v3.8.3.10.3: Limpar alertas antigos (antes da versÃ£o com filtro)
    // Se houver alertas guardados, verificar se tÃªm mais de 3 tÃ©cnicos (lista antiga)
    const alertasAntigos = localStorage.getItem('alertas_pendentes');
    if (alertasAntigos) {
        try {
            const alertasData = JSON.parse(alertasAntigos);
            // Se a lista tem mais de 3 tÃ©cnicos, Ã© alerta antigo - limpar
            if (alertasData.tecnicos && alertasData.tecnicos.length > 3) {
                console.log('ğŸ—‘ï¸ Limpando alertas antigos (lista completa)...');
                localStorage.removeItem('alertas_pendentes');
                localStorage.removeItem('ultima_verificacao_alertas');
            }
        } catch (e) {
            // Se erro ao ler, limpar tambÃ©m
            localStorage.removeItem('alertas_pendentes');
            localStorage.removeItem('ultima_verificacao_alertas');
        }
    }
    
    // ğŸ“… Calcular Ãºltimo dia Ãºtil
    const ultimoDiaUtil = calcularUltimoDiaUtil();
    
    if (!ultimoDiaUtil) {
        return; // Domingo - sem verificaÃ§Ã£o
    }
    
    // ğŸ”„ Verificar se jÃ¡ foi alertado HOJE
    const hoje = new Date().toISOString().split('T')[0];
    const ultimaVerificacao = localStorage.getItem('ultima_verificacao_alertas');
    
    if (ultimaVerificacao === hoje) {
        console.log('âœ… Alertas jÃ¡ verificados hoje');
        return; // JÃ¡ foi alertado hoje
    }
    
    // ğŸ• Definir horÃ¡rio do dia Ãºtil (00:00:00 atÃ© 23:59:59)
    const inicioDia = new Date(ultimoDiaUtil);
    inicioDia.setHours(0, 0, 0, 0);
    
    const fimDia = new Date(ultimoDiaUtil);
    fimDia.setHours(23, 59, 59, 999);
    
    // ğŸ” Buscar TODOS os pedidos do Supabase
    const todosPedidos = await window.SupabaseAPI.getPedidos();
    
    // ğŸ‘¥ TÃ©cnicos a monitorizar - APENAS Paulo Abrunhosa, Alan e Vitor Hugo
    // ğŸ†• v3.8.3.10.3: Filtro especÃ­fico de tÃ©cnicos para alerta de produtividade
    const tecnicosMonitorizados = ['Paulo Abrunhosa', 'Alan', 'Vitor Hugo'];
    
    console.log('ğŸ” [ALERTA] TÃ©cnicos a monitorizar:', tecnicosMonitorizados);
    console.log('ğŸ” [ALERTA] Total utilizadores na BD:', AppState.utilizadores?.length || 0);
    
    const tecnicos = AppState.utilizadores && AppState.utilizadores.length > 0
        ? AppState.utilizadores
            .filter(u => {
                const nomeKey = Object.keys(u).find(k => k.toLowerCase().replace(/[_\s]/g, '') === 'nomecompleto') || 'nomeCompleto';
                const nomeCompleto = u[nomeKey];
                const incluir = tecnicosMonitorizados.includes(nomeCompleto);
                if (incluir) {
                    console.log('âœ… [ALERTA] Incluir tÃ©cnico:', nomeCompleto);
                }
                return incluir;
            })
            .map(u => {
                const nomeKey = Object.keys(u).find(k => k.toLowerCase().replace(/[_\s]/g, '') === 'nomecompleto') || 'nomeCompleto';
                return u[nomeKey];
            })
        : tecnicosMonitorizados;  // Fallback
    
    console.log('ğŸ” [ALERTA] TÃ©cnicos filtrados FINAL:', tecnicos);
    
    const tecnicosSemProducao = [];
    
    // ğŸ” Verificar cada tÃ©cnico
    for (const tecnico of tecnicos) {
        try {
            
            // Filtrar pedidos do tÃ©cnico, estado Resolvido e no perÃ­odo
            // ğŸ†• v3.8.2: Corrigido para usar fechado_por_username e verificar data correta
            const pedidosFiltrados = todosPedidos.filter(p => {
                // Verificar estado
                if (p.Estado !== 'Resolvido') return false;
                
                // ğŸ†• v3.8.2: Comparar por username (mais confiÃ¡vel que nome completo)
                const tecnicoUsername = AppState.utilizadores?.find(u => {
                    const nomeKey = Object.keys(u).find(k => k.toLowerCase().replace(/[_\s]/g, '') === 'nomecompleto') || 'nomeCompleto';
                    return u[nomeKey] === tecnico;
                })?.username;
                
                // Verificar se este tÃ©cnico fechou a OT
                const fechouEsteUser = p.fechado_por_username === tecnicoUsername;
                
                // âš ï¸ Fallback antigo (caso fechado_por_username nÃ£o exista)
                const fechouPorNome = p['Fechado Por'] === tecnico || (!p['Fechado Por'] && p['ResponsÃ¡vel'] === tecnico);
                
                if (!fechouEsteUser && !fechouPorNome) return false;
                
                // ğŸ†• v3.8.2: Usar updated_at (quando foi fechada) em vez de Data/hora (criaÃ§Ã£o)
                // Se OT foi resolvida, updated_at Ã© a data de fecho
                const dataFecho = p.updated_at ? new Date(p.updated_at) : new Date(p['Data/hora']);
                
                return dataFecho >= inicioDia && dataFecho <= fimDia;
            });
            
            const data = pedidosFiltrados;
            const error = null;
            
            if (error) {
                console.error(`âŒ Erro ao verificar OTs de ${tecnico}:`, error);
                continue;
            }
            
            const totalOTsFechadas = data?.length || 0;
            console.log(`ğŸ“‹ ${tecnico}: ${totalOTsFechadas} OT(s) fechadas`);
            
            // ğŸ› [DEBUG] Mostrar OTs encontradas
            if (data && data.length > 0) {
                console.log(`   â†³ OTs de ${tecnico}:`, data.map(ot => ({
                    id: ot.ID,
                    responsavel: ot['ResponsÃ¡vel'],
                    fechadoPor: ot['Fechado Por'],
                    fechadoPorUsername: ot.fechado_por_username, // ğŸ†• v3.8.2
                    estado: ot.Estado,
                    dataCriacao: new Date(ot['Data/hora']).toLocaleString('pt-PT'),
                    dataFecho: ot.updated_at ? new Date(ot.updated_at).toLocaleString('pt-PT') : 'N/A' // ğŸ†• v3.8.2
                })));
            } else {
                console.log(`   â†³ ${tecnico}: NENHUMA OT fechada no perÃ­odo!`);
            }
            
            // ğŸš¨ Se ZERO OTs fechadas, adicionar Ã  lista
            if (totalOTsFechadas === 0) {
                tecnicosSemProducao.push(tecnico);
            }
            
        } catch (err) {
            console.error(`âŒ Erro na verificaÃ§Ã£o de ${tecnico}:`, err);
        }
    }
    
    // ğŸ¯ Mostrar banner se houver tÃ©cnicos sem produÃ§Ã£o
    if (tecnicosSemProducao.length > 0) {
        console.log('ğŸš¨ TÃ©cnicos sem produÃ§Ã£o:', tecnicosSemProducao);
        mostrarBannerAlerta(tecnicosSemProducao, ultimoDiaUtil);
        
        // ğŸ’¾ Guardar alertas pendentes
        localStorage.setItem('alertas_pendentes', JSON.stringify({
            tecnicos: tecnicosSemProducao,
            data: ultimoDiaUtil.toISOString(),
            timestamp: new Date().toISOString()
        }));
    } else {
        console.log('âœ… Todos os tÃ©cnicos produziram OTs');
    }
    
    // ğŸ—“ï¸ Marcar como verificado HOJE
    localStorage.setItem('ultima_verificacao_alertas', hoje);
}

/**
 * Mostrar banner de alerta no topo da pÃ¡gina
 * @param {string[]} tecnicos - Lista de tÃ©cnicos sem produÃ§Ã£o
 * @param {Date} dataReferencia - Data do Ãºltimo dia Ãºtil
 */
function mostrarBannerAlerta(tecnicos, dataReferencia) {
    // ğŸ—‘ï¸ Remover banner antigo (se existir)
    const bannerAntigo = document.getElementById('bannerAlertaProducao');
    if (bannerAntigo) {
        bannerAntigo.remove();
    }
    
    // ğŸ“… Formatar data
    const dataFormatada = dataReferencia.toLocaleDateString('pt-PT', {
        weekday: 'long',
        day: 'numeric',
        month: 'long'
    });
    
    // ğŸ¨ Criar HTML do banner
    const banner = document.createElement('div');
    banner.id = 'bannerAlertaProducao';
    banner.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        color: white;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        z-index: 10000;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        animation: slideDown 0.3s ease-out;
    `;
    
    // Adicionar animaÃ§Ã£o CSS
    if (!document.getElementById('alertaAnimationStyle')) {
        const style = document.createElement('style');
        style.id = 'alertaAnimationStyle';
        style.textContent = `
            @keyframes slideDown {
                from {
                    transform: translateY(-100%);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    // ğŸ“ Texto do alerta
    const tecnicosTexto = tecnicos.length === 1 
        ? tecnicos[0] 
        : tecnicos.slice(0, -1).join(', ') + ' e ' + tecnicos[tecnicos.length - 1];
    
    const mensagem = tecnicos.length === 1
        ? `${tecnicosTexto} nÃ£o fechou nenhuma Ordem de Trabalho em ${dataFormatada}.`
        : `${tecnicosTexto} nÃ£o fecharam nenhuma Ordem de Trabalho em ${dataFormatada}.`;
    
    banner.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
            <div style="font-size: 24px;">âš ï¸</div>
            <div>
                <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px;">
                    Alerta de Produtividade
                </div>
                <div style="font-size: 13px; opacity: 0.95;">
                    ${mensagem}
                </div>
            </div>
        </div>
        <button 
            onclick="fecharAlerta()" 
            style="
                background: rgba(255, 255, 255, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.3);
                color: white;
                padding: 8px 16px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                transition: all 0.2s;
                backdrop-filter: blur(10px);
            "
            onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'"
            onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'"
        >
            Entendido
        </button>
    `;
    
    // ğŸ“ Inserir no inÃ­cio do body
    document.body.insertBefore(banner, document.body.firstChild);
    
    // â¬‡ï¸ Ajustar padding do conteÃºdo principal
    const mainContent = document.querySelector('.app-wrapper') || document.body;
    const bannerHeight = banner.offsetHeight;
    mainContent.style.paddingTop = `${bannerHeight + 20}px`;
    
    console.log('ğŸš¨ Banner de alerta exibido');
}

/**
 * Fechar banner de alerta
 */
window.fecharAlerta = function() {
    const banner = document.getElementById('bannerAlertaProducao');
    if (banner) {
        // AnimaÃ§Ã£o de saÃ­da
        banner.style.animation = 'slideDown 0.3s ease-out reverse';
        setTimeout(() => {
            banner.remove();
            // â¬†ï¸ Remover padding do conteÃºdo principal
            const mainContent = document.querySelector('.app-wrapper') || document.body;
            mainContent.style.paddingTop = '';
        }, 300);
        
        console.log('âœ… Banner fechado');
    }
};

/**
 * Mostrar alertas pendentes (ao clicar no botÃ£o)
 */
window.mostrarAlertasPendentes = async function() {
    console.log('ğŸš¨ Verificando alertas pendentes...');
    
    // Verificar se hÃ¡ alertas guardados
    const alertasPendentes = localStorage.getItem('alertas_pendentes');
    
    if (alertasPendentes) {
        try {
            const alertasData = JSON.parse(alertasPendentes);
            const dataAlerta = new Date(alertasData.data);
            
            console.log('ğŸš¨ Alertas pendentes encontrados:', alertasData);
            
            // Mostrar banner com alertas guardados
            mostrarBannerAlerta(alertasData.tecnicos, dataAlerta);
            
        } catch (e) {
            console.error('âŒ Erro ao ler alertas pendentes:', e);
        }
    } else {
        // Se nÃ£o hÃ¡ alertas, forÃ§ar nova verificaÃ§Ã£o
        console.log('ğŸ”„ Sem alertas pendentes - forÃ§ando nova verificaÃ§Ã£o...');
        
        // Limpar flag de verificaÃ§Ã£o para forÃ§ar nova checagem
        localStorage.removeItem('ultima_verificacao_alertas');
        
        // Fechar banner existente (se houver)
        const bannerAntigo = document.getElementById('bannerAlertaProducao');
        if (bannerAntigo) {
            bannerAntigo.remove();
        }
        
        // ForÃ§ar nova verificaÃ§Ã£o
        await verificarAlertasDiarios();
    }
};

// ===========================================
// ğŸ“š PROCESSAMENTO DE MANUAIS (PDF)
// ===========================================

/**
 * Processar manual: extrair texto do PDF e dividir em secÃ§Ãµes
 * @param {string} manualId - UUID do manual na BD
 */
// âŒ FUNÃ‡ÃƒO ANTIGA REMOVIDA - Usava manualId em vez de dados do formulÃ¡rio
// A nova funÃ§Ã£o processarManual estÃ¡ abaixo (linha ~6894)

/**
 * Extrair texto de um PDF usando PDF.js
 * @param {string} pdfUrl - URL do PDF
 * @returns {Promise<{textoCompleto: string, numPaginas: number}>}
 */
async function extrairTextoDoPDF(pdfUrl) {
    if (typeof pdfjsLib === 'undefined') {
        throw new Error('PDF.js nÃ£o estÃ¡ carregado');
    }
    
    // Carregar PDF
    const loadingTask = pdfjsLib.getDocument(pdfUrl);
    const pdf = await loadingTask.promise;
    const numPaginas = pdf.numPages;
    
    let textoCompleto = '';
    
    // Extrair texto de cada pÃ¡gina
    for (let i = 1; i <= numPaginas; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(' ');
        
        textoCompleto += `\n\n--- PÃGINA ${i} ---\n${pageText}`;
        
        // Log de progresso a cada 10 pÃ¡ginas
        if (i % 10 === 0) {
            console.log(`  ğŸ“„ Processadas ${i}/${numPaginas} pÃ¡ginas...`);
        }
    }
    
    return { textoCompleto, numPaginas };
}

// ============================================
// ğŸ†• v3.7.6.10: CHUNKING INTELIGENTE POR CAPÃTULOS
// ============================================

/**
 * ğŸ†• v3.7.6.10: Dividir texto em chunks por capÃ­tulos (mais inteligente)
 * ROLLBACK: Use dividirEmSeccoesLegacy() se precisar voltar ao comportamento antigo
 * 
 * @param {string} texto - Texto completo do manual
 * @param {number} numPaginas - NÃºmero total de pÃ¡ginas
 * @returns {Array} Array de chunks por capÃ­tulo
 */
function dividirEmSeccoesInteligente(texto, numPaginas) {
    console.log('ğŸ§  [CHUNKING] Iniciando divisÃ£o inteligente por capÃ­tulos...');
    
    const chunks = [];
    
    // Regex para detectar capÃ­tulos (diversos formatos)
    const regexCapitulos = [
        /^CapÃ­tulo\s+(\d+[\.\:]?\s*[-â€“â€”]?\s*.+)$/gim,           // CapÃ­tulo 8 - ManutenÃ§Ã£o
        /^CAPÃTULO\s+(\d+[\.\:]?\s*[-â€“â€”]?\s*.+)$/gim,           // CAPÃTULO 8 - MANUTENÃ‡ÃƒO
        /^Cap\.\s*(\d+[\.\:]?\s*[-â€“â€”]?\s*.+)$/gim,              // Cap. 8 - ManutenÃ§Ã£o
        /^(\d+)\.\s+([A-ZÃÃ€Ã‚ÃƒÃ‰ÃŠÃÃ“Ã”Ã•ÃšÃ‡][A-ZÃÃ€Ã‚ÃƒÃ‰ÃŠÃÃ“Ã”Ã•ÃšÃ‡a-zÃ¡Ã Ã¢Ã£Ã©ÃªÃ­Ã³Ã´ÃµÃºÃ§\s]{3,})$/gm, // 8. MANUTENÃ‡ÃƒO
        /^(\d+\.\d+)\.\s+([A-ZÃÃ€Ã‚ÃƒÃ‰ÃŠÃÃ“Ã”Ã•ÃšÃ‡].+)$/gm              // 8.1. LubrificaÃ§Ã£o
    ];
    
    // Tentar encontrar capÃ­tulos com cada regex
    let matches = [];
    for (const regex of regexCapitulos) {
        const found = [...texto.matchAll(regex)];
        if (found.length > 0) {
            matches = found;
            console.log(`âœ… [CHUNKING] Encontrados ${found.length} capÃ­tulos com padrÃ£o:`, regex.source.substring(0, 50));
            break;
        }
    }
    
    // Se nÃ£o encontrou capÃ­tulos, usar divisÃ£o por pÃ¡ginas
    if (matches.length === 0) {
        console.log('âš ï¸ [CHUNKING] Nenhum capÃ­tulo detectado, usando divisÃ£o por pÃ¡ginas...');
        return dividirEmSeccoesLegacy(texto, numPaginas);
    }
    
    // Dividir texto por capÃ­tulos
    for (let i = 0; i < matches.length; i++) {
        const match = matches[i];
        const nextMatch = matches[i + 1];
        
        const tituloCapitulo = match[0].trim();
        const posicaoInicio = match.index;
        const posicaoFim = nextMatch ? nextMatch.index : texto.length;
        
        const conteudoCapitulo = texto.substring(posicaoInicio, posicaoFim).trim();
        
        // Estimar pÃ¡ginas baseado na posiÃ§Ã£o no texto
        const percentualInicio = posicaoInicio / texto.length;
        const percentualFim = posicaoFim / texto.length;
        const paginaInicio = Math.max(1, Math.floor(percentualInicio * numPaginas));
        const paginaFim = Math.min(numPaginas, Math.ceil(percentualFim * numPaginas));
        
        // Extrair palavras-chave do tÃ­tulo
        const palavrasChave = tituloCapitulo
            .toLowerCase()
            .replace(/[^\wÃ¡Ã Ã¢Ã£Ã©ÃªÃ­Ã³Ã´ÃµÃºÃ§\s]/g, '')
            .split(/\s+/)
            .filter(p => p.length > 3);
        
        chunks.push({
            titulo: tituloCapitulo,
            texto: conteudoCapitulo,
            paginaInicio: paginaInicio,
            paginaFim: paginaFim,
            palavrasChave: palavrasChave
        });
        
        console.log(`  ğŸ“„ [CHUNKING] Chunk ${i + 1}: "${tituloCapitulo}" (PÃ¡gs ${paginaInicio}-${paginaFim}, ${conteudoCapitulo.length} chars)`);
    }
    
    console.log(`âœ… [CHUNKING] ${chunks.length} chunks criados com sucesso!`);
    return chunks;
}

/**
 * ğŸ”„ LEGACY: Dividir texto em secÃ§Ãµes baseado em keywords e estrutura
 * Mantida para rollback se chunking inteligente nÃ£o funcionar
 * @param {string} texto - Texto completo do manual
 * @param {number} numPaginas - NÃºmero total de pÃ¡ginas
 * @returns {Array} Array de secÃ§Ãµes
 */
function dividirEmSeccoesLegacy(texto, numPaginas) {
    const seccoes = [];
    const linhas = texto.split('\n');
    
    // Definir keywords para identificar secÃ§Ãµes
    const keywordsSeccoes = {
        'EspecificaÃ§Ãµes TÃ©cnicas': ['especificaÃ§Ãµes', 'caracterÃ­sticas tÃ©cnicas', 'dados tÃ©cnicos', 'technical data'],
        'OperaÃ§Ã£o': ['operaÃ§Ã£o', 'funcionamento', 'operation', 'como usar'],
        'ManutenÃ§Ã£o Preventiva': ['manutenÃ§Ã£o preventiva', 'preventive maintenance', 'manutenÃ§Ã£o programada'],
        'Troubleshooting': ['troubleshooting', 'resoluÃ§Ã£o de problemas', 'problemas', 'falhas'],
        'CalibraÃ§Ã£o': ['calibraÃ§Ã£o', 'ajuste', 'calibration', 'afinaÃ§Ã£o'],
        'SeguranÃ§a': ['seguranÃ§a', 'safety', 'avisos', 'precauÃ§Ãµes'],
        'PeÃ§as': ['peÃ§as', 'componentes', 'parts', 'spare parts'],
        'Diagramas': ['diagrama', 'esquema', 'desenho tÃ©cnico']
    };
    
    // EstratÃ©gia simples: dividir em blocos de ~200 linhas ou por keywords
    let secaoAtual = {
        titulo: 'IntroduÃ§Ã£o e InformaÃ§Ãµes Gerais',
        texto: '',
        paginaInicio: 1,
        paginaFim: 10,
        palavrasChave: ['geral', 'introduÃ§Ã£o']
    };
    
    let linhasProcessadas = 0;
    const linhasPorSecao = Math.ceil(linhas.length / 8); // ~8 secÃ§Ãµes
    
    for (let i = 0; i < linhas.length; i++) {
        const linha = linhas[i];
        secaoAtual.texto += linha + '\n';
        linhasProcessadas++;
        
        // Verificar se encontramos um tÃ­tulo de secÃ§Ã£o
        let tituloEncontrado = false;
        for (const [titulo, keywords] of Object.entries(keywordsSeccoes)) {
            if (keywords.some(kw => linha.toLowerCase().includes(kw))) {
                // Salvar secÃ§Ã£o atual (se tiver conteÃºdo)
                if (secaoAtual.texto.length > 100) {
                    secaoAtual.paginaFim = Math.min(secaoAtual.paginaInicio + 15, numPaginas);
                    seccoes.push(secaoAtual);
                }
                
                // Iniciar nova secÃ§Ã£o
                secaoAtual = {
                    titulo: titulo,
                    texto: '',
                    paginaInicio: secaoAtual.paginaFim + 1,
                    paginaFim: Math.min(secaoAtual.paginaFim + 15, numPaginas),
                    palavrasChave: keywords
                };
                
                tituloEncontrado = true;
                break;
            }
        }
        
        // Se nÃ£o encontrou tÃ­tulo e jÃ¡ processou muitas linhas, criar nova secÃ§Ã£o
        if (!tituloEncontrado && linhasProcessadas >= linhasPorSecao && secaoAtual.texto.length > 500) {
            secaoAtual.paginaFim = Math.min(secaoAtual.paginaInicio + 10, numPaginas);
            seccoes.push(secaoAtual);
            
            secaoAtual = {
                titulo: `SecÃ§Ã£o ${seccoes.length + 1}`,
                texto: '',
                paginaInicio: secaoAtual.paginaFim + 1,
                paginaFim: Math.min(secaoAtual.paginaFim + 10, numPaginas),
                palavrasChave: []
            };
            
            linhasProcessadas = 0;
        }
    }
    
    // Adicionar Ãºltima secÃ§Ã£o
    if (secaoAtual.texto.length > 100) {
        secaoAtual.paginaFim = numPaginas;
        seccoes.push(secaoAtual);
    }
    
    // Limitar tamanho do texto de cada secÃ§Ã£o (mÃ¡x 5000 chars para performance)
    return seccoes.map(s => ({
        ...s,
        texto: s.texto.substring(0, 5000)
    }));
}

/**
 * ğŸ†• v3.7.6.10: Wrapper - Escolhe entre chunking inteligente ou legacy
 * Para DESATIVAR chunking inteligente, mude USE_CHUNKING_INTELIGENTE para false
 */
const USE_CHUNKING_INTELIGENTE = true; // ğŸ”„ ROLLBACK: Mude para false

function dividirEmSeccoes(texto, numPaginas) {
    if (USE_CHUNKING_INTELIGENTE) {
        console.log('ğŸ§  Usando chunking INTELIGENTE (v3.7.6.10)');
        return dividirEmSeccoesInteligente(texto, numPaginas);
    } else {
        console.log('ğŸ”„ Usando chunking LEGACY (antigo)');
        return dividirEmSeccoesLegacy(texto, numPaginas);
    }
}

// ========================================
// ğŸ“š SISTEMA DE MANUAIS - PROCESSAMENTO PDF
// ========================================

// ============================================================================
// ğŸ¨ PRÃ‰-PROCESSAMENTO DE IMAGEM PARA OCR (v3.7.5.0)
// ============================================================================

/**
 * Aumentar contraste da imagem
 * @param {ImageData} imageData - Dados da imagem
 * @param {number} factor - Fator de contraste (1.0 = sem mudanÃ§a, 2.0 = dobro)
 * @returns {ImageData} - Imagem com contraste aumentado
 */
function enhanceContrast(imageData, factor = 1.5) {
    const data = imageData.data;
    const contrastFactor = (259 * (factor * 255 + 255)) / (255 * (259 - factor * 255));
    
    for (let i = 0; i < data.length; i += 4) {
        data[i] = contrastFactor * (data[i] - 128) + 128;         // R
        data[i + 1] = contrastFactor * (data[i + 1] - 128) + 128; // G
        data[i + 2] = contrastFactor * (data[i + 2] - 128) + 128; // B
    }
    
    return imageData;
}

/**
 * Aplicar sharpening (nitidez) Ã  imagem
 * @param {CanvasRenderingContext2D} ctx - Contexto do canvas
 * @param {number} width - Largura
 * @param {number} height - Altura
 */
function sharpenImage(ctx, width, height) {
    const imageData = ctx.getImageData(0, 0, width, height);
    const data = imageData.data;
    const output = new Uint8ClampedArray(data);
    
    // Kernel de sharpening 3x3
    const kernel = [
        0, -1,  0,
       -1,  5, -1,
        0, -1,  0
    ];
    
    for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
            for (let c = 0; c < 3; c++) { // RGB (sem alpha)
                let sum = 0;
                for (let ky = -1; ky <= 1; ky++) {
                    for (let kx = -1; kx <= 1; kx++) {
                        const idx = ((y + ky) * width + (x + kx)) * 4 + c;
                        const kernelIdx = (ky + 1) * 3 + (kx + 1);
                        sum += data[idx] * kernel[kernelIdx];
                    }
                }
                output[(y * width + x) * 4 + c] = sum;
            }
        }
    }
    
    for (let i = 0; i < data.length; i++) {
        data[i] = output[i];
    }
    
    ctx.putImageData(imageData, 0, 0);
}

/**
 * Remover ruÃ­do (denoising) da imagem
 * @param {ImageData} imageData - Dados da imagem
 * @returns {ImageData} - Imagem sem ruÃ­do
 */
function denoiseImage(imageData) {
    const data = imageData.data;
    const width = imageData.width;
    const height = imageData.height;
    const output = new Uint8ClampedArray(data);
    
    // Median filter 3x3 (simples mas eficaz)
    for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
            for (let c = 0; c < 3; c++) { // RGB
                const values = [];
                for (let ky = -1; ky <= 1; ky++) {
                    for (let kx = -1; kx <= 1; kx++) {
                        const idx = ((y + ky) * width + (x + kx)) * 4 + c;
                        values.push(data[idx]);
                    }
                }
                values.sort((a, b) => a - b);
                output[(y * width + x) * 4 + c] = values[4]; // Mediana
            }
        }
    }
    
    for (let i = 0; i < data.length; i++) {
        data[i] = output[i];
    }
    
    return imageData;
}

/**
 * BinarizaÃ§Ã£o (preto/branco puro) - melhor para OCR
 * @param {ImageData} imageData - Dados da imagem
 * @param {number} threshold - Limiar (0-255, padrÃ£o: 128)
 * @returns {ImageData} - Imagem binarizada
 */
function binarizeImage(imageData, threshold = 128) {
    const data = imageData.data;
    
    for (let i = 0; i < data.length; i += 4) {
        // Converter para escala de cinza
        const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
        
        // Aplicar threshold
        const value = gray > threshold ? 255 : 0;
        
        data[i] = value;     // R
        data[i + 1] = value; // G
        data[i + 2] = value; // B
    }
    
    return imageData;
}

/**
 * Pipeline completo de prÃ©-processamento
 * @param {Canvas} canvas - Canvas com a imagem
 * @param {Object} options - OpÃ§Ãµes de processamento
 * @returns {Canvas} - Canvas processado
 */
function preprocessImageForOCR(canvas, options = {}) {
    const {
        contrast = true,
        sharpen = true,
        denoise = true,
        binarize = false, // Opcional: pode piorar se o PDF for colorido
        contrastFactor = 1.5
    } = options;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    console.log('ğŸ¨ PrÃ©-processando imagem para OCR...');
    
    // 1. Aumentar contraste
    if (contrast) {
        let imageData = ctx.getImageData(0, 0, width, height);
        imageData = enhanceContrast(imageData, contrastFactor);
        ctx.putImageData(imageData, 0, 0);
        console.log('  âœ… Contraste aumentado');
    }
    
    // 2. Remover ruÃ­do
    if (denoise) {
        let imageData = ctx.getImageData(0, 0, width, height);
        imageData = denoiseImage(imageData);
        ctx.putImageData(imageData, 0, 0);
        console.log('  âœ… RuÃ­do removido');
    }
    
    // 3. Aplicar sharpening
    if (sharpen) {
        sharpenImage(ctx, width, height);
        console.log('  âœ… Nitidez aplicada');
    }
    
    // 4. BinarizaÃ§Ã£o (opcional)
    if (binarize) {
        let imageData = ctx.getImageData(0, 0, width, height);
        imageData = binarizeImage(imageData);
        ctx.putImageData(imageData, 0, 0);
        console.log('  âœ… BinarizaÃ§Ã£o aplicada');
    }
    
    console.log('âœ… PrÃ©-processamento concluÃ­do');
    return canvas;
}

// ============================================================================
// ğŸ“„ CONVERSÃƒO E EXTRAÃ‡ÃƒO
// ============================================================================

/**
 * Converter pÃ¡gina PDF em imagem (Canvas) para OCR
 * @param {Object} page - PÃ¡gina do PDF.js
 * @param {number} scale - Escala de renderizaÃ§Ã£o (padrÃ£o: 3.0 para melhor qualidade)
 * @returns {Promise<Canvas>} - Canvas com a imagem
 */
async function pdfPageToImage(page, scale = 3.0) {
    const viewport = page.getViewport({ scale });
    
    // Criar canvas temporÃ¡rio
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    
    // Renderizar pÃ¡gina no canvas
    const renderContext = {
        canvasContext: context,
        viewport: viewport
    };
    
    await page.render(renderContext).promise;
    
    // ğŸ¨ v3.7.5.0: Aplicar prÃ©-processamento para melhorar OCR
    preprocessImageForOCR(canvas, {
        contrast: true,
        sharpen: true,
        denoise: true,
        binarize: false, // MantÃ©m cores (pode ajudar em diagramas)
        contrastFactor: 1.5
    });
    
    // Retornar Canvas (Tesseract aceita Canvas diretamente)
    return canvas;
}

/**
 * Detectar regiÃµes com imagens/tabelas em uma pÃ¡gina
 * v3.7.6.0: DetecÃ§Ã£o melhorada com scoring e classificaÃ§Ã£o
 * @param {Canvas} canvas - Canvas com a pÃ¡gina renderizada
 * @returns {Array} - Array de regiÃµes detectadas {x, y, width, height, type, score}
 */
function detectImageRegions(canvas) {
    const ctx = canvas.getContext('2d');
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;
    const width = canvas.width;
    const height = canvas.height;
    
    // Detectar Ã¡reas com alta densidade de conteÃºdo nÃ£o-textual
    // (tabelas, diagramas, imagens tÃ©cnicas)
    const regions = [];
    const gridSize = 25; // ğŸ†• v3.7.6.2: Blocos AINDA MENORES para tabelas pequenas (40â†’25)
    console.log(`ğŸ”¬ v3.7.6.9: GridSize=${gridSize}px, AdjacÃªncia=${3.0*gridSize}px (ZOOM OUT: raio 1.5xâ†’3.0x), MinArea=3500pxÂ², tableScore>18, MinSize=80x80`);
    
    for (let y = 0; y < height; y += gridSize) {
        for (let x = 0; x < width; x += gridSize) {
            let edgeCount = 0;
            let horizontalLines = 0;
            let verticalLines = 0;
            let varianceSum = 0;
            let darkPixels = 0;
            
            // Analisar bloco
            for (let by = y; by < Math.min(y + gridSize, height); by++) {
                for (let bx = x; bx < Math.min(x + gridSize, width); bx++) {
                    const idx = (by * width + bx) * 4;
                    const gray = 0.299 * data[idx] + 0.587 * data[idx + 1] + 0.114 * data[idx + 2];
                    
                    if (gray < 100) darkPixels++;
                    
                    // Detectar bordas horizontais
                    if (bx < width - 1) {
                        const nextIdx = (by * width + (bx + 1)) * 4;
                        const nextGray = 0.299 * data[nextIdx] + 0.587 * data[nextIdx + 1] + 0.114 * data[nextIdx + 2];
                        const diff = Math.abs(gray - nextGray);
                        if (diff > 30) {
                            edgeCount++;
                            horizontalLines++;
                        }
                        varianceSum += diff;
                    }
                    
                    // Detectar bordas verticais
                    if (by < height - 1) {
                        const belowIdx = ((by + 1) * width + bx) * 4;
                        const belowGray = 0.299 * data[belowIdx] + 0.587 * data[belowIdx + 1] + 0.114 * data[belowIdx + 2];
                        if (Math.abs(gray - belowGray) > 30) verticalLines++;
                    }
                }
            }
            
            // Calcular scores
            const avgVariance = varianceSum / (gridSize * gridSize);
            const darkRatio = darkPixels / (gridSize * gridSize);
            const lineBalance = Math.min(horizontalLines, verticalLines) / Math.max(horizontalLines, verticalLines, 1);
            
            // Score de tabela: linhas cruzadas + equilÃ­brio H/V
            const tableScore = (edgeCount * 0.3) + (avgVariance * 0.3) + (lineBalance * 40);
            
            // Score de diagrama: bordas + contraste
            const diagramScore = (edgeCount * 0.4) + (avgVariance * 0.4) + (darkRatio * 20);
            
            // ğŸ†• v3.8.3.10.27.9: Thresholds REDUZIDOS (detectar mais esquemas/Ã­ndices)
            // ANTES: tableScore > 18, diagramScore > 15 (muito restritivo, perdia esquemas simples)
            // v3.8.3.10.27.9: ULTRA-BAIXO para mÃ¡xima detecÃ§Ã£o + fallback pÃ¡gina inteira
            const isTable = tableScore > 8 && lineBalance > 0.20; // ULTRA: 12â†’8, 0.25â†’0.20
            const isDiagram = diagramScore > 6 && darkRatio > 0.03 && darkRatio < 0.90; // ULTRA: 10â†’6, 0.05â†’0.03
            
            // ğŸ†• DEBUG: Log das primeiras 5 regiÃµes com score alto
            if ((tableScore > 10 || diagramScore > 10) && regions.length < 5) {
                console.log(`  [DEBUG] RegiÃ£o em (${x},${y}): tableScore=${tableScore.toFixed(1)}, diagramScore=${diagramScore.toFixed(1)}, lineBalance=${lineBalance.toFixed(2)}, darkRatio=${darkRatio.toFixed(2)}`);
            }
            
            if (isTable || isDiagram) {
                regions.push({
                    x: x,
                    y: y,
                    width: gridSize,
                    height: gridSize,
                    edgeCount: edgeCount,
                    avgVariance: avgVariance,
                    tableScore: tableScore,
                    diagramScore: diagramScore,
                    type: isTable ? 'table' : 'diagram',
                    score: Math.max(tableScore, diagramScore)
                });
            }
        }
    }
    
    // Mesclar regiÃµes adjacentes
    let mergedRegions = []; // ğŸ”§ v3.7.6.4: 'let' em vez de 'const' (permite reatribuiÃ§Ã£o no limite)
    const processed = new Set();
    
    for (let i = 0; i < regions.length; i++) {
        if (processed.has(i)) continue;
        
        let merged = { ...regions[i] };
        let typeCount = { table: 0, diagram: 0 };
        typeCount[merged.type]++;
        processed.add(i);
        
        // Procurar regiÃµes adjacentes
        for (let j = i + 1; j < regions.length; j++) {
            if (processed.has(j)) continue;
            
            const r2 = regions[j];
            // ğŸ†• v3.8.3.10.27.9: AUMENTAR raio de adjacÃªncia para evitar fragmentaÃ§Ã£o
            // v3.7.6.9: raio 3.0Ã— (75px) â†’ capturava tabela mas fragmentava esquemas
            // v3.8.3.10.27.9: raio 5.0Ã— (125px) â†’ deve capturar esquema completo SEM cortar
            const adjacencyRadius = 5.0 * gridSize; // 125px (AUMENTADO!)
            const isAdjacent = 
                (r2.x <= merged.x + merged.width + adjacencyRadius && 
                 r2.x + r2.width >= merged.x - adjacencyRadius) &&
                (r2.y <= merged.y + merged.height + adjacencyRadius && 
                 r2.y + r2.height >= merged.y - adjacencyRadius);
            
            if (isAdjacent) {
                // ğŸ†• v3.7.6.8: CORREÃ‡ÃƒO CRÃTICA - Salvar coordenadas ANTES de atualizar
                const oldX = merged.x;
                const oldY = merged.y;
                const oldMaxX = merged.x + merged.width;
                const oldMaxY = merged.y + merged.height;
                
                // Atualizar posiÃ§Ã£o (canto superior esquerdo)
                merged.x = Math.min(oldX, r2.x);
                merged.y = Math.min(oldY, r2.y);
                
                // Calcular novo tamanho (usar coordenadas ANTIGAS!)
                const newMaxX = Math.max(oldMaxX, r2.x + r2.width);
                const newMaxY = Math.max(oldMaxY, r2.y + r2.height);
                merged.width = newMaxX - merged.x;
                merged.height = newMaxY - merged.y;
                
                merged.score = Math.max(merged.score, r2.score);
                typeCount[r2.type]++;
                processed.add(j);
            }
        }
        
        // Determinar tipo final baseado na maioria
        merged.type = typeCount.table > typeCount.diagram ? 'table' : 'diagram';
        
        // SÃ³ adicionar se a regiÃ£o for significativa
        const area = merged.width * merged.height;
        const minArea = 3500; // ğŸ†• v3.7.6.6: Ãrea mÃ­nima REDUZIDA (5000â†’3500, ~59x59 px)
        const aspectRatio = merged.width / merged.height;
        
        // ğŸ†• v3.8.3.10.27.9: ValidaÃ§Ã£o ULTRA-RELAXADA para mÃ¡xima detecÃ§Ã£o
        const isValidAspectRatio = aspectRatio > 0.2 && aspectRatio < 5.0; // ULTRA: era 0.3-3.5
        
        // ğŸ†• v3.8.3.10.27.9: DimensÃµes mÃ­nimas ULTRA-BAIXAS (50â†’40px)
        const isValidSize = merged.width >= 40 && merged.height >= 40; // ULTRA: era 50x50px
        
        // ğŸ†• v3.8.3.10.27.9: Score mÃ­nimo ULTRA-BAIXO (10â†’6)
        if (area > minArea && merged.score > 6 && isValidAspectRatio && isValidSize) { // ULTRA: era score>10
            console.log(`  [DEBUG-MERGE] RegiÃ£o vÃ¡lida: (${merged.x},${merged.y}) ${merged.width}x${merged.height} = ${area}pxÂ² (score: ${merged.score.toFixed(1)}, tipo: ${merged.type}, aspect: ${aspectRatio.toFixed(2)})`);
            mergedRegions.push(merged);
        } else if (area > 2000) { // SÃ³ log se for razoavelmente grande
            const rejectReasons = [];
            if (area <= minArea) rejectReasons.push(`Ã¡rea=${area}pxÂ²<${minArea}`);
            if (merged.score <= 10) rejectReasons.push(`score=${merged.score.toFixed(1)}<10`);
            if (!isValidAspectRatio) rejectReasons.push(`aspect=${aspectRatio.toFixed(2)} fora de 0.3-3.5`);
            if (!isValidSize) rejectReasons.push(`tamanho=${merged.width}x${merged.height}<50x50`);
            console.log(`  [DEBUG-REJECT] RegiÃ£o rejeitada: ${rejectReasons.join(', ')}`);
        }
    }
    
    // Ordenar por score (mais confiante primeiro)
    mergedRegions.sort((a, b) => b.score - a.score);
    
    // ğŸ†• v3.7.6.4: LIMITE MÃXIMO de 10 tabelas/pÃ¡gina (previne explosÃ£o)
    if (mergedRegions.length > 10) {
        console.warn(`âš ï¸ ALERTA: ${mergedRegions.length} tabelas detectadas! Limitando a 10 (top scores).`);
        mergedRegions = mergedRegions.slice(0, 10);
    }
    
    console.log(`ğŸ“Š Total de regiÃµes vÃ¡lidas: ${mergedRegions.length}`);
    return mergedRegions;
}

/**
 * Extrair imagem de uma regiÃ£o especÃ­fica
 * @param {Canvas} sourceCanvas - Canvas original
 * @param {Object} region - RegiÃ£o {x, y, width, height}
 * @returns {Canvas} - Canvas com a regiÃ£o extraÃ­da
 */
function extractImageRegion(sourceCanvas, region) {
    const canvas = document.createElement('canvas');
    canvas.width = region.width;
    canvas.height = region.height;
    const ctx = canvas.getContext('2d');
    
    ctx.drawImage(
        sourceCanvas,
        region.x, region.y, region.width, region.height,
        0, 0, region.width, region.height
    );
    
    return canvas;
}

/**
 * Converter canvas para Blob (para upload)
 * @param {Canvas} canvas - Canvas
 * @param {string} type - Tipo MIME (padrÃ£o: 'image/png')
 * @returns {Promise<Blob>} - Blob da imagem
 */
function canvasToBlob(canvas, type = 'image/png') {
    return new Promise((resolve) => {
        canvas.toBlob(resolve, type, 0.95);
    });
}

/**
 * Upload de imagem extraÃ­da para Supabase Storage
 * v3.7.6.0: Suporte para tabelas e diagramas
 * @param {Blob} imageBlob - Blob da imagem
 * @param {string} manualId - ID do manual
 * @param {number} pageNum - NÃºmero da pÃ¡gina
 * @param {string} type - Tipo da imagem ('table' ou 'diagram')
 * @param {number} index - Ãndice da imagem na pÃ¡gina (para mÃºltiplas imagens)
 * @returns {Promise<string>} - URL pÃºblica da imagem
 */
async function uploadExtractedImage(imageBlob, manualId, pageNum, type, index = 0) {
    try {
        // Nome do arquivo: manual_id/page_XX_type_YY.png
        const fileName = `${manualId}/page_${String(pageNum).padStart(3, '0')}_${type}_${String(index).padStart(2, '0')}.png`;
        
        console.log(`ğŸ“¤ Uploading ${type} image: ${fileName} (${(imageBlob.size / 1024).toFixed(1)} KB)`);
        
        // Upload via FormData (como no uploadManualPDF)
        const formData = new FormData();
        formData.append('file', imageBlob, fileName);
        
        const uploadUrl = `${SUPABASE_CONFIG.URL}/storage/v1/object/manuais/${fileName}`;
        
        const response = await fetch(uploadUrl, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_CONFIG.ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_CONFIG.ANON_KEY}`,
                'x-upsert': 'true' // Sobrescrever se jÃ¡ existir
            },
            body: formData
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            console.error('âŒ Erro ao fazer upload da imagem:', errorData);
            throw new Error(`Erro no upload: ${response.status}`);
        }
        
        // URL pÃºblica da imagem
        const publicUrl = `${SUPABASE_CONFIG.URL}/storage/v1/object/public/manuais/${fileName}`;
        
        console.log(`âœ… Imagem uploaded: ${publicUrl}`);
        return publicUrl;
        
    } catch (error) {
        console.error('âŒ Erro ao fazer upload da imagem:', error);
        throw error;
    }
}

/**
 * Renomear ficheiro no Supabase Storage
 * ğŸ†• v3.8.3.10.5: Renomear imagens com metadata GPT-4 Vision
 * @param {string} oldPath - Caminho antigo (ex: manualId/page_003_table_00.png)
 * @param {string} newPath - Caminho novo (ex: manualId/page_003_figura_25_lubrificacao.png)
 * @returns {Promise<string>} - Nova URL pÃºblica
 */
async function renameStorageFile(oldPath, newPath) {
    try {
        console.log(`ğŸ”„ Renomeando: ${oldPath} â†’ ${newPath}`);
        
        // âš¡ FIX v3.8.3.10.7: Usar endpoint correto de MOVE
        // API: POST /storage/v1/object/move
        const moveUrl = `${SUPABASE_CONFIG.URL}/storage/v1/object/move`;
        const moveResponse = await fetch(moveUrl, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_CONFIG.ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_CONFIG.ANON_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                bucketId: 'manuais',
                sourceKey: oldPath,
                destinationKey: newPath
            })
        });
        
        if (!moveResponse.ok) {
            const errorData = await moveResponse.text();
            console.warn(`âš ï¸ NÃ£o foi possÃ­vel renomear: ${oldPath}`);
            console.warn(`Erro: ${errorData}`);
            // Retornar URL antiga se falhar
            return `${SUPABASE_CONFIG.URL}/storage/v1/object/public/manuais/${oldPath}`;
        }
        
        const newPublicUrl = `${SUPABASE_CONFIG.URL}/storage/v1/object/public/manuais/${newPath}`;
        console.log(`âœ… Ficheiro renomeado com sucesso!`);
        console.log(`   OLD: ${oldPath}`);
        console.log(`   NEW: ${newPath}`);
        return newPublicUrl;
        
    } catch (error) {
        console.error('âŒ Erro ao renomear ficheiro:', error);
        // Retornar URL antiga em caso de erro
        return `${SUPABASE_CONFIG.URL}/storage/v1/object/public/manuais/${oldPath}`;
    }
}

/**
 * Extrair texto de uma imagem usando Tesseract.js OCR
 * @param {ImageData|Canvas|string} image - Imagem para OCR
 * @param {string} lang - Idioma (padrÃ£o: 'por' = PortuguÃªs)
 * @returns {Promise<string>} - Texto extraÃ­do
 */
async function extractTextFromImage(image, lang = 'por') {
    try {
        const result = await Tesseract.recognize(
            image,
            lang,
            {
                logger: (m) => {
                    // Log de progresso opcional
                    if (m.status === 'recognizing text') {
                        console.log(`OCR: ${Math.round(m.progress * 100)}%`);
                    }
                }
            }
        );
        
        return result.data.text.trim();
    } catch (error) {
        console.error('âŒ Erro no OCR:', error);
        return '';
    }
}

/**
 * Extrair texto completo de um ficheiro PDF usando PDF.js + OCR (fallback)
 * @param {File} file - Ficheiro PDF
 * @param {Function} progressCallback - Callback para atualizar progresso (opcional)
 * @returns {Promise<Object>} - { textoCompleto, numPaginas, secoes }
 */
async function extractTextFromPDF(file, progressCallback = null) {
    try {
        console.log('ğŸ“„ A extrair texto do PDF:', file.name);
        
        // Converter File para ArrayBuffer
        const arrayBuffer = await file.arrayBuffer();
        
        // Carregar PDF com PDF.js
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        console.log(`ğŸ“„ PDF carregado: ${pdf.numPages} pÃ¡ginas`);
        
        let textoCompleto = '';
        const secoes = [];
        let textosPorPagina = {}; // Guardar texto de cada pÃ¡gina
        let imagensPorPagina = {}; // ğŸ†• v3.8.2.1: Guardar imagens extraÃ­das (OCR ou nÃ£o)
        let usouOCR = false;
        
        // PASSO 1: Tentar extrair texto normal (rÃ¡pido)
        console.log('ğŸ” Tentando extrair texto nativo do PDF...');
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            const page = await pdf.getPage(pageNum);
            const textContent = await page.getTextContent();
            
            // Juntar todos os items de texto
            const textoPage = textContent.items
                .map(item => item.str)
                .join(' ')
                .trim();
            
            textosPorPagina[pageNum] = textoPage;
            textoCompleto += textoPage + '\n\n';
        }
        
        // PASSO 2: Se nÃ£o encontrou texto (PDF escaneado), usar OCR PREMIUM
        // ğŸ”´ v3.7.6.2: FORÃ‡AR OCR EM TODOS OS PDFs para testar detecÃ§Ã£o de tabelas
        // Threshold: 999999 caracteres (FORÃ‡AR OCR sempre)
        if (textoCompleto.length < 999999) { // ğŸ”´ TESTE: Era 500, agora 999999
            console.log('ğŸ”´ MODO TESTE: OCR FORÃ‡ADO em TODOS os PDFs (threshold: 999999)');
            console.log(`ğŸ“Š Texto nativo encontrado: ${textoCompleto.length} caracteres`);
            console.log('ğŸ”¬ Iniciando OCR ULTRA (v3.7.6.2) com Tesseract.js...');
            console.log('â±ï¸ ATENÃ‡ÃƒO: OCR de alta qualidade pode levar 10-15 minutos');
            console.log('ğŸ¯ Melhorias ativadas: PrÃ©-processamento + Scale adaptativo (3.0-5.0) + ExtraÃ§Ã£o de imagens');
            console.log('ğŸ†• v3.7.6.2: Thresholds ULTRA-AGRESSIVOS (gridSize 25px, tableScore>8, minArea 3000pxÂ²)');
            
            if (typeof Tesseract === 'undefined') {
                console.error('âŒ Tesseract.js nÃ£o estÃ¡ carregado! OCR nÃ£o disponÃ­vel.');
                throw new Error('OCR nÃ£o disponÃ­vel. PDF escaneado sem texto extraÃ­vel.');
            }
            
            usouOCR = true;
            textoCompleto = '';
            textosPorPagina = {};
            imagensPorPagina = {}; // ğŸ†• Reset para OCR (jÃ¡ declarado acima)
            
            // Criar worker do Tesseract (reutilizÃ¡vel) com configuraÃ§Ã£o otimizada
            console.log('ğŸ”§ Configurando Tesseract.js com detecÃ§Ã£o de layout...');
            const worker = await Tesseract.createWorker('por', 1, {
                logger: (m) => {
                    if (m.status === 'recognizing text' && progressCallback) {
                        const progress = Math.round(m.progress * 100);
                        progressCallback(`OCR Premium: ${progress}%`);
                    }
                }
            });
            
            // ğŸ†• Configurar parÃ¢metros do Tesseract para melhor qualidade
            await worker.setParameters({
                tessedit_pageseg_mode: Tesseract.PSM.AUTO_OSD, // Detectar orientaÃ§Ã£o e layout
                preserve_interword_spaces: '1'
            });
            
            // ğŸ†• v3.7.6.0: Passar primeiro rÃ¡pido para detectar pÃ¡ginas com tabelas
            console.log('ğŸ” Passo 1/2: Detectando pÃ¡ginas com tabelas...');
            const paginasComTabelas = new Set();
            
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const canvas = await pdfPageToImage(page, 3.5); // ğŸ†• v3.7.6.2: Scale AUMENTADO para melhor detecÃ§Ã£o (2.0â†’3.5)
                const imageRegions = detectImageRegions(canvas);
                
                if (imageRegions.length > 0) {
                    paginasComTabelas.add(pageNum);
                    console.log(`  ğŸ“Š PÃ¡gina ${pageNum}: ${imageRegions.length} tabela(s)/diagrama(s)`);
                }
            }
            
            console.log(`âœ… ${paginasComTabelas.size} pÃ¡ginas com tabelas detectadas`);
            console.log('');
            console.log('ğŸ” Passo 2/2: OCR com qualidade adaptativa...');
            
            // Processar cada pÃ¡gina com OCR PREMIUM
            const manualId = crypto.randomUUID(); // ID temporÃ¡rio para imagens
            
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                if (progressCallback) {
                    progressCallback(`OCR Premium: PÃ¡gina ${pageNum}/${pdf.numPages}`);
                }
                
                const temTabelas = paginasComTabelas.has(pageNum);
                const scale = temTabelas ? 5.0 : 3.0; // ğŸ†• Scale maior para pÃ¡ginas com tabelas
                
                console.log(`ğŸ”¬ OCR Premium - PÃ¡gina ${pageNum}/${pdf.numPages}... ${temTabelas ? 'ğŸ“Š (COM TABELAS - Scale 5.0)' : '(Scale 3.0)'}`);
                
                const page = await pdf.getPage(pageNum);
                
                // ğŸ†• Usar scale adaptativo + prÃ©-processamento otimizado
                const canvas = await pdfPageToImage(page, scale);
                
                // ğŸ†• Para pÃ¡ginas com tabelas, aplicar binarizaÃ§Ã£o
                if (temTabelas) {
                    preprocessImageForOCR(canvas, {
                        contrast: true,
                        sharpen: true,
                        denoise: true,
                        binarize: true, // ğŸ†• BinarizaÃ§Ã£o para tabelas
                        contrastFactor: 2.0 // ğŸ†• Contraste maior
                    });
                    console.log('  ğŸ¨ PrÃ©-processamento agressivo aplicado');
                }
                
                // ğŸ†• Detectar e extrair imagens/tabelas
                const imageRegions = detectImageRegions(canvas);
                const imagensExtraidas = [];
                
                if (imageRegions.length > 0) {
                    console.log(`  ğŸ“Š Extraindo ${imageRegions.length} imagem(ns)...`);
                    
                    for (let idx = 0; idx < imageRegions.length; idx++) {
                        const region = imageRegions[idx];
                        
                        // Extrair regiÃ£o como imagem
                        const regionCanvas = extractImageRegion(canvas, region);
                        const regionBlob = await canvasToBlob(regionCanvas);
                        
                        // ğŸ†• v3.8.3.10.20: Filtrar imagens muito pequenas (< 50KB) - Simplificar bucket
                        const MIN_IMAGE_SIZE = 50 * 1024; // 50KB (anteriormente 20KB)
                        if (regionBlob.size < MIN_IMAGE_SIZE) {
                            console.log(`    â­ï¸ ${region.type} ${idx + 1} ignorada (${(regionBlob.size / 1024).toFixed(1)}KB < 50KB)`);
                            continue; // Pular esta imagem
                        }
                        
                        try {
                            // âš¡ v3.8.3.10.8: OTIMIZAÃ‡ÃƒO - Analisar ANTES do upload
                            // Assim fazemos upload DIRETO com nome correto (evita criar 2 ficheiros)
                            
                            // 1. Analisar imagem com GPT-4 Vision (antes do upload!)
                            let metadata = null;
                            const textoPage = textosPorPagina[pageNum] || '';
                            const dataUrl = regionCanvas.toDataURL('image/png');
                            
                            console.log(`    ğŸ” Analisando ${region.type} ${idx + 1} com GPT-4 Vision...`);
                            metadata = await analisarImagemComGPT4Vision(dataUrl, textoPage, pageNum);
                            
                            // ğŸ” DEBUG: Log completo da metadata recebida
                            console.log(`    ğŸ” [DEBUG] Metadata recebida do GPT-4 Vision:`, JSON.stringify(metadata, null, 2));
                            
                            // 2. Determinar nome do ficheiro (com ou sem metadata)
                            let fileName;
                            
                            // ğŸ” DEBUG: Verificar condiÃ§Ã£o
                            console.log(`    ğŸ” [DEBUG] DecisÃ£o de nome: metadata=${!!metadata}, metadata.tipo="${metadata?.tipo}"`);
                            
                            if (metadata && metadata.tipo) {
                                // ğŸ†• v3.8.3.10.21: Gerar nome descritivo SEMPRE que GPT-4 identificar o tipo
                                const tipo = metadata.tipo.toLowerCase().replace(/[^a-z0-9]/g, '');
                                const tags = metadata.tags || [];
                                
                                // Gerar nome baseado no tipo e tags
                                let nomeBase;
                                if (tipo === 'esquema' || tags.includes('esquema_eletrico')) {
                                    nomeBase = 'esquema_eletrico';
                                } else if (tipo === 'indice' || tags.includes('indice')) {
                                    // ğŸ†• v3.8.3.10.27.9: DetecÃ§Ã£o de Ã­ndices
                                    nomeBase = 'indice_manual';
                                } else if (tipo === 'diagrama') {
                                    const subtipo = tags.find(t => ['lubrificacao', 'componentes', 'instalacao'].includes(t));
                                    nomeBase = subtipo ? `diagrama_${subtipo}` : 'diagrama';
                                } else if (tipo === 'tabela') {
                                    const subtipo = tags.find(t => ['especificacoes', 'manutencao', 'problemas'].includes(t));
                                    nomeBase = subtipo ? `tabela_${subtipo}` : 'tabela';
                                } else if (tipo === 'anexo') {
                                    const numero = metadata.numero ? `_${metadata.numero}` : '';
                                    nomeBase = `anexo${numero}`;
                                } else {
                                    nomeBase = tipo;
                                }
                                
                                // Adicionar Ã­ndice sequencial
                                fileName = `${manualId}/${nomeBase}_${String(idx + 1).padStart(2, '0')}.png`;
                                
                                console.log(`    âœ… GPT-4 identificou: ${tipo} - "${metadata.titulo || 'sem tÃ­tulo'}" â†’ ${nomeBase}_${String(idx + 1).padStart(2, '0')}.png`);
                            } else {
                                // Fallback: nome genÃ©rico se GPT-4 nÃ£o identificar
                                const typeLabel = region.type.toLowerCase();
                                const indexStr = String(idx).padStart(2, '0');
                                fileName = `${manualId}/page_${String(pageNum).padStart(3, '0')}_${typeLabel}_${indexStr}.png`;
                                console.log(`    âš ï¸ GPT-4 nÃ£o identificou tipo, usando nome genÃ©rico: ${fileName.split('/').pop()}`);
                            }
                            
                            // 3. Upload DIRETO com nome final (nÃ£o cria ficheiro temporÃ¡rio!)
                            const formData = new FormData();
                            formData.append('file', regionBlob, fileName.split('/').pop());
                            
                            const uploadUrl = `${SUPABASE_CONFIG.URL}/storage/v1/object/manuais/${fileName}`;
                            const uploadResponse = await fetch(uploadUrl, {
                                method: 'POST',
                                headers: {
                                    'apikey': SUPABASE_CONFIG.ANON_KEY,
                                    'Authorization': `Bearer ${SUPABASE_CONFIG.ANON_KEY}`
                                },
                                body: formData
                            });
                            
                            if (!uploadResponse.ok) {
                                console.error(`    âŒ Erro ao fazer upload: ${uploadResponse.status}`);
                                throw new Error(`Erro no upload: ${uploadResponse.status}`);
                            }
                            
                            const finalImageUrl = `${SUPABASE_CONFIG.URL}/storage/v1/object/public/manuais/${fileName}`;
                            console.log(`    âœ… Upload completo: ${fileName.split('/').pop()} (${(regionBlob.size / 1024).toFixed(1)}KB)`);
                            
                            // 4. Guardar imagem com metadata
                            imagensExtraidas.push({
                                url: finalImageUrl,
                                type: region.type,
                                score: region.score,
                                gpt_metadata: metadata
                            });
                        } catch (uploadError) {
                            console.error(`    âŒ Erro ao fazer upload/anÃ¡lise da ${region.type} ${idx + 1}:`, uploadError);
                        }
                    }
                    
                    imagensPorPagina[pageNum] = imagensExtraidas;
                }
                
                // ğŸ†• v3.8.3.10.27.9: FALLBACK - AnÃ¡lise da pÃ¡gina inteira se nenhuma regiÃ£o foi detectada
                if (regions.length === 0) {
                    console.log(`  ğŸ” Nenhuma regiÃ£o detectada na pÃ¡gina ${pageNum}, analisando pÃ¡gina inteira...`);
                    
                    try {
                        // Converter canvas para data URL
                        const dataUrl = canvas.toDataURL('image/png');
                        
                        // Analisar com GPT-4 Vision
                        const metadata = await analisarImagemComGPT4Vision(dataUrl, textoPage, pageNum);
                        
                        if (metadata && metadata.tipo) {
                            // Tipos que QUEREMOS salvar a pÃ¡gina inteira
                            const tiposRelevantes = ['indice', 'esquema', 'tabela', 'diagrama', 'anexo'];
                            
                            if (tiposRelevantes.includes(metadata.tipo)) {
                                console.log(`  âœ… GPT-4 detectou '${metadata.tipo}' na pÃ¡gina inteira! Salvando...`);
                                
                                // Gerar nome descritivo
                                const tipo = metadata.tipo.toLowerCase().replace(/[^a-z0-9]/g, '');
                                const tags = metadata.tags || [];
                                let nomeBase = tipo;
                                
                                // LÃ³gica de renomeaÃ§Ã£o (igual Ã  atual)
                                if (tipo === 'esquema' || tags.includes('esquema_eletrico')) {
                                    nomeBase = 'esquema_eletrico';
                                } else if (tipo === 'diagrama') {
                                    const subtipo = tags.find(t => ['lubrificacao', 'componentes', 'instalacao'].includes(t));
                                    nomeBase = subtipo ? `diagrama_${subtipo}` : 'diagrama';
                                } else if (tipo === 'tabela') {
                                    if (tags.includes('indice')) {
                                        nomeBase = 'indice_manual';
                                    } else {
                                        const subtipo = tags.find(t => ['especificacoes', 'manutencao', 'problemas'].includes(t));
                                        nomeBase = subtipo ? `tabela_${subtipo}` : 'tabela';
                                    }
                                } else if (tipo === 'indice') {
                                    nomeBase = 'indice_manual';
                                } else if (tipo === 'anexo' && metadata.numero) {
                                    nomeBase = `anexo_${metadata.numero}`;
                                }
                                
                                // Contar Ã­ndice para nome Ãºnico
                                const imagensExistentes = imagensPorPagina[pageNum] || [];
                                const idx = imagensExistentes.length;
                                const fileName = `${manualId}/${nomeBase}_${String(idx + 1).padStart(2, '0')}.png`;
                                
                                console.log(`  ğŸ“ Nome do ficheiro: ${fileName.split('/').pop()}`);
                                
                                // Upload da pÃ¡gina inteira
                                canvas.toBlob(async (blob) => {
                                    if (!blob) {
                                        console.error('  âŒ Erro ao converter canvas para blob');
                                        return;
                                    }
                                    
                                    try {
                                        const formData = new FormData();
                                        formData.append('file', blob, fileName.split('/').pop());
                                        
                                        const uploadResponse = await fetch(`${SUPABASE_CONFIG.URL}/storage/v1/object/manuais/${fileName}`, {
                                            method: 'POST',
                                            headers: {
                                                'apikey': SUPABASE_CONFIG.ANON_KEY,
                                                'Authorization': `Bearer ${SUPABASE_CONFIG.ANON_KEY}`,
                                                'x-upsert': 'true'
                                            },
                                            body: formData
                                        });
                                        
                                        if (!uploadResponse.ok) {
                                            throw new Error(`Upload falhou: ${uploadResponse.status}`);
                                        }
                                        
                                        const finalImageUrl = `${SUPABASE_CONFIG.URL}/storage/v1/object/public/manuais/${fileName}`;
                                        console.log(`  âœ… PÃ¡gina inteira salva: ${fileName.split('/').pop()} (${(blob.size / 1024).toFixed(1)}KB)`);
                                        
                                        // Adicionar Ã s imagens extraÃ­das
                                        if (!imagensPorPagina[pageNum]) {
                                            imagensPorPagina[pageNum] = [];
                                        }
                                        imagensPorPagina[pageNum].push({
                                            url: finalImageUrl,
                                            type: metadata.tipo,
                                            score: 100, // PÃ¡gina inteira sempre tem score alto
                                            gpt_metadata: metadata
                                        });
                                    } catch (uploadError) {
                                        console.error(`  âŒ Erro ao fazer upload da pÃ¡gina inteira:`, uploadError);
                                    }
                                }, 'image/png');
                            } else {
                                console.log(`  â„¹ï¸ Tipo '${metadata.tipo}' nÃ£o Ã© relevante, ignorando pÃ¡gina.`);
                            }
                        } else {
                            console.log(`  â„¹ï¸ GPT-4 nÃ£o detectou conteÃºdo relevante na pÃ¡gina ${pageNum}.`);
                        }
                    } catch (fallbackError) {
                        console.error(`  âš ï¸ Erro na anÃ¡lise fallback da pÃ¡gina ${pageNum}:`, fallbackError);
                    }
                }
                
                // Extrair texto com OCR (alta qualidade)
                const { data: { text, confidence } } = await worker.recognize(canvas);
                const textoPage = text.trim();
                
                textosPorPagina[pageNum] = textoPage;
                textoCompleto += textoPage + '\n\n';
                
                const confIcon = confidence > 90 ? 'âœ…' : confidence > 75 ? 'âš ï¸' : 'âŒ';
                console.log(`  ${confIcon} PÃ¡gina ${pageNum}: ${textoPage.length} chars (confianÃ§a: ${Math.round(confidence)}%)`);
            }
            
            // Terminar worker
            await worker.terminate();
            console.log('âœ… OCR Premium concluÃ­do!');
            console.log(`ğŸ“Š EstatÃ­sticas finais:`);
            console.log(`   - Texto extraÃ­do: ${textoCompleto.length} caracteres`);
            console.log(`   - PÃ¡ginas com imagens/tabelas: ${Object.keys(imagensPorPagina).length}`);
            
            // ğŸ†• v3.8.3.10: Adicionar referÃªncias a imagens no texto COM METADATA GPT-4
            for (const [pageNum, images] of Object.entries(imagensPorPagina)) {
                if (images && images.length > 0) {
                    const pageText = textosPorPagina[pageNum] || '';
                    let imageRefs = '\n\n';
                    
                    images.forEach((img, idx) => {
                        const metadata = img.gpt_metadata;
                        
                        if (metadata && metadata.numero) {
                            // ğŸ†• GPT-4 identificou o nÃºmero da figura/tabela!
                            const tipoLabel = metadata.tipo || img.type;
                            const numero = metadata.numero;
                            const descricao = metadata.descricao || '';
                            
                            imageRefs += `ğŸ“Š [${tipoLabel.toUpperCase()} ${numero}]: ${img.url}\n`;
                            if (descricao) {
                                imageRefs += `   DescriÃ§Ã£o: ${descricao}\n`;
                            }
                            if (metadata.componentes && metadata.componentes.length > 0) {
                                imageRefs += `   Componentes: ${metadata.componentes.join(', ')}\n`;
                            }
                        } else {
                            // Fallback: formato antigo
                            const emoji = img.type === 'table' ? 'ğŸ“Š' : 'ğŸ–¼ï¸';
                            imageRefs += `${emoji} [${img.type.toUpperCase()} ${idx + 1}]: ${img.url}\n`;
                        }
                    });
                    
                    textosPorPagina[pageNum] = pageText + imageRefs;
                }
            }
            
            // ğŸ†• v3.7.6.10: Re-criar textoCompleto COM as URLs das imagens
            textoCompleto = '';
            for (let p = 1; p <= pdf.numPages; p++) {
                if (textosPorPagina[p]) {
                    textoCompleto += textosPorPagina[p] + '\n\n';
                }
            }
            console.log('âœ… [CHUNKING] Texto completo atualizado com URLs de imagens');
            
        } else {
            console.log('âœ… Texto nativo extraÃ­do com sucesso (PDF nÃ£o escaneado)');
        }
        
        // PASSO 3: ğŸ†• v3.7.6.10 - Dividir texto em chunks inteligentes (por capÃ­tulos)
        console.log('ğŸ§  [CHUNKING] Iniciando divisÃ£o inteligente do manual...');
        const chunks = dividirEmSeccoes(textoCompleto, pdf.numPages);
        
        // Converter chunks para o formato esperado pela API do Supabase
        console.log(`ğŸ” [DEBUG] Chunks retornados:`, chunks.length);
        
        // ğŸ†• v3.8.0: Processar chunks com auto-tagging
        for (let idx = 0; idx < chunks.length; idx++) {
            const chunk = chunks[idx];
            console.log(`ğŸ” [DEBUG] Chunk ${idx + 1}:`, {
                titulo: chunk.titulo,
                textoLength: chunk.texto?.length || 0,
                temTexto: !!chunk.texto
            });
            
            // ğŸ†• v3.8.0: Detectar tags automaticamente
            const tags = await detectarTagsAutomaticas(chunk.texto || '');
            
            // ğŸ†• v3.8.3.10: Extrair URLs e METADATA de imagens desta secÃ§Ã£o
            const imagensSecao = [];
            const imagensMetadata = []; // ğŸ†• Array separado para metadata GPT-4
            
            if (imagensPorPagina && Object.keys(imagensPorPagina).length > 0) {
                for (let p = chunk.paginaInicio; p <= chunk.paginaFim; p++) {
                    if (imagensPorPagina[p]) {
                        // Adicionar URLs e metadata das imagens desta pÃ¡gina
                        imagensPorPagina[p].forEach(img => {
                            imagensSecao.push(img.url);
                            
                            // ğŸ†• v3.8.3.10: Guardar metadata GPT-4 se existir
                            if (img.gpt_metadata) {
                                imagensMetadata.push({
                                    url: img.url,
                                    ...img.gpt_metadata
                                });
                            }
                        });
                    }
                }
            }
            
            if (imagensSecao.length > 0) {
                console.log(`  ğŸ“Š SecÃ§Ã£o "${chunk.titulo}": ${imagensSecao.length} imagem(ns) encontrada(s)`);
                if (imagensMetadata.length > 0) {
                    console.log(`     ğŸ” ${imagensMetadata.length} com metadata GPT-4 Vision`);
                }
            }
            
            secoes.push({
                secao: chunk.titulo,                // TÃ­tulo do capÃ­tulo
                conteudo: chunk.texto,              // Texto completo do capÃ­tulo
                pagina_inicio: chunk.paginaInicio,  // PÃ¡gina estimada
                pagina_fim: chunk.paginaFim,        // PÃ¡gina estimada
                palavras_chave: chunk.palavrasChave, // Keywords extraÃ­das
                tags: tags,                         // ğŸ†• v3.8.0: Tags auto-detectadas
                imagens_urls: imagensSecao,         // ğŸ†• v3.8.1: URLs de imagens/tabelas
                imagens_metadata: imagensMetadata,  // ğŸ†• v3.8.3.10: Metadata GPT-4 Vision
                ordem: idx + 1
            });
        }
        
        console.log(`âœ… [CHUNKING] ${secoes.length} chunks criados com sucesso!`);
        
        console.log(`âœ… Texto extraÃ­do: ${textoCompleto.length} caracteres, ${secoes.length} secÃ§Ãµes`);
        console.log(`ğŸ“Š MÃ©todo usado: ${usouOCR ? 'OCR (Tesseract.js)' : 'Texto nativo (PDF.js)'}`);
        
        return {
            textoCompleto,
            numPaginas: pdf.numPages,
            secoes,
            usouOCR  // Informar se usou OCR
        };
        
    } catch (error) {
        console.error('âŒ Erro ao extrair texto do PDF:', error);
        throw error;
    }
}

/**
 * Processar e fazer upload de manual completo
 */
async function processarManual(equipamento, titulo, descricao, file) {
    try {
        // 1. Extrair texto do PDF (com callback de progresso)
        setProgress('A extrair texto do PDF...', 10);
        const { textoCompleto, numPaginas, secoes, usouOCR } = await extractTextFromPDF(file, (msg) => {
            setProgress(msg, 10 + Math.random() * 20); // 10-30%
        });
        
        if (usouOCR) {
            console.log('ğŸ”¬ Texto extraÃ­do via OCR (Tesseract.js)');
        }
        
        // 2. Upload do PDF para Storage PRIMEIRO (para ter URL)
        setProgress('A fazer upload do PDF...', 30);
        // Criar ID temporÃ¡rio para o ficheiro
        const tempId = crypto.randomUUID();
        const pdfUrl = await window.SupabaseAPI.uploadManualPDF(tempId, file);
        console.log('âœ… PDF enviado:', pdfUrl);
        
        // 3. Criar registo do manual no Supabase (agora com URL)
        setProgress('A criar registo do manual...', 50);
        
        // Extrair Ã¡rea e nome do equipamento
        // Ex: "Alinhadeira L03" â†’ area: "L03", nome: "Alinhadeira"
        // Ex: "DestroÃ§ador" â†’ area: "Triagem", nome: "DestroÃ§ador"
        let equipamentoArea = 'Geral';
        let equipamentoNome = equipamento;
        
        console.log('ğŸ” [DEBUG] equipamento original:', equipamento);
        
        // Tentar detectar Ã¡rea (L01, L02, L03, etc)
        const matchArea = equipamento.match(/L0[123]|Triagem|Silo/i);
        if (matchArea) {
            equipamentoArea = matchArea[0];
            equipamentoNome = equipamento.replace(matchArea[0], '').trim();
        }
        
        console.log('ğŸ” [DEBUG] equipamentoArea:', equipamentoArea);
        console.log('ğŸ” [DEBUG] equipamentoNome:', equipamentoNome);
        
        const manualData = {
            equipamento_area: equipamentoArea,
            equipamento_nome: equipamentoNome || equipamento,
            titulo: titulo,
            descricao: descricao || '',
            empresa: 'MCF', // Default MCF (pode ser alterado depois)
            ficheiro_url: pdfUrl,
            ficheiro_nome: file.name,
            tamanho_kb: Math.round(file.size / 1024),
            num_paginas: numPaginas,
            processado: false,
            ativo: true
        };
        
        console.log('ğŸ” [DEBUG] manualData a enviar:', JSON.stringify(manualData, null, 2));
        
        const [manual] = await window.SupabaseAPI.addManual(manualData);
        console.log('âœ… Manual criado:', manual);
        
        // 5. Inserir secÃ§Ãµes de conteÃºdo
        setProgress('A processar conteÃºdo...', 70);
        
        // ğŸ†• v3.7.6.10: Gerar embeddings para cada secÃ§Ã£o
        const totalSeccoes = secoes.length;
        for (let i = 0; i < totalSeccoes; i++) {
            const secao = secoes[i];
            
            // Atualizar progresso
            const progressoSecao = 70 + (i / totalSeccoes) * 15; // 70% -> 85%
            setProgress(`A processar secÃ§Ã£o ${i + 1}/${totalSeccoes}...`, Math.round(progressoSecao));
            
            // Gerar embedding se estiver ativado
            let embedding = null;
            if (USE_EMBEDDINGS && OPENAI_API_KEY && OPENAI_API_KEY !== 'sk-proj-...') {
                // ğŸ†• v3.7.6.10: Validar que conteudo existe
                if (!secao.conteudo) {
                    console.error(`âŒ [EMBEDDING] SecÃ§Ã£o ${i + 1} SEM CONTEÃšDO! Secao:`, secao.secao);
                    console.error(`âŒ [DEBUG] Objeto secao completo:`, secao);
                } else {
                    try {
                        console.log(`ğŸ§  [EMBEDDING] Gerando embedding para: "${secao.secao}" (${secao.conteudo.length} chars)`);
                        embedding = await gerarEmbedding(secao.conteudo);  // ğŸ†• v3.7.6.10: Usar "conteudo" (nÃ£o "texto")
                        console.log(`âœ… [EMBEDDING] Embedding gerado (${embedding.length} dimensÃµes)`);
                    } catch (error) {
                        console.error('âš ï¸ [EMBEDDING] Erro ao gerar embedding:', error);
                        // Continuar sem embedding
                    }
                }
            }
            
            // Salvar secÃ§Ã£o (com ou sem embedding)
            await window.SupabaseAPI.addConteudoManual({
                manual_id: manual.id,
                ...secao,
                embedding: embedding  // ğŸ†• Pode ser null se embeddings desativados
            });
        }
        
        // 6. Marcar como processado
        setProgress('A finalizar...', 90);
        await window.SupabaseAPI.updateManual(manual.id, {
            processado: true
        });
        
        // 7. ğŸ†• v3.7.6.10: Recarregar manuais em background para o chatbot
        console.log('ğŸ”„ Recarregando manuais para o chatbot...');
        await carregarManuaisBackground();
        
        setProgress('âœ… ConcluÃ­do!', 100);
        
        return manual;
        
    } catch (error) {
        console.error('âŒ Erro ao processar manual:', error);
        throw error;
    }
}

// ============================================
// ğŸš€ v3.8.3.10.27.38: UPLOAD EM BATCH DE PDFs
// ============================================

/**
 * Upload em batch de PDFs de ManutenÃ§Ãµes AutÃ³nomas para o Supabase Storage
 * Usado para migrar os 13 PDFs do OneDrive para o Supabase
 */
// ============================================
// ğŸ†• v3.7.6.10: FUNÃ‡ÃƒO GERAR EMBEDDINGS
// ============================================

/**
 * Gerar embedding de um texto usando OpenAI API
 * ROLLBACK: Comente esta funÃ§Ã£o se USE_EMBEDDINGS = false
 * 
 * @param {string} texto - Texto para gerar embedding
 * @returns {Promise<Array<number>>} - Array de 1536 nÃºmeros (embedding)
 */
async function gerarEmbedding(texto) {
    // Validar API key
    if (!OPENAI_API_KEY || OPENAI_API_KEY === 'sk-proj-...') {
        throw new Error('OPENAI_API_KEY nÃ£o configurada! Insira sua chave na linha ~12888');
    }
    
    // ğŸ†• v3.7.6.10: Validar que texto nÃ£o Ã© undefined/null
    if (!texto || typeof texto !== 'string') {
        throw new Error(`gerarEmbedding() recebeu texto invÃ¡lido: ${typeof texto}`);
    }
    
    // Limitar tamanho do texto (OpenAI tem limite de ~8000 tokens)
    // 1 token â‰ˆ 4 caracteres, entÃ£o ~30000 caracteres Ã© seguro
    const textoLimitado = texto.substring(0, 30000);
    
    console.log(`ğŸ§  [EMBEDDING] Texto: ${textoLimitado.length} chars`);
    
    try {
        const response = await fetch('https://api.openai.com/v1/embeddings', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${OPENAI_API_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                input: textoLimitado,
                model: OPENAI_EMBEDDINGS_MODEL
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            console.error('âŒ [EMBEDDING] Erro da OpenAI:', errorData);
            throw new Error(`OpenAI API error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
        }
        
        const data = await response.json();
        const embedding = data.data[0].embedding;
        
        console.log(`âœ… [EMBEDDING] Sucesso! Embedding: [${embedding[0].toFixed(4)}, ${embedding[1].toFixed(4)}, ..., ${embedding[1535].toFixed(4)}]`);
        
        return embedding;
        
    } catch (error) {
        console.error('âŒ [EMBEDDING] Erro ao gerar embedding:', error);
        throw error;
    }
}

// ============================================
// ğŸ†• v3.8.3.10: ANÃLISE DE IMAGENS COM GPT-4 VISION
// ============================================

/**
 * Analisar imagem com GPT-4 Vision para identificar figuras/tabelas
 * 
 * @param {string} imageUrl - URL da imagem (pode ser data: URL ou http(s)://)
 * @param {string} textoContexto - Texto da pÃ¡gina (para contexto)
 * @param {number} pageNum - NÃºmero da pÃ¡gina
 * @returns {Promise<Object>} - Metadata da imagem
 */
async function analisarImagemComGPT4Vision(imageUrl, textoContexto = '', pageNum = 0) {
    console.log(`ğŸ” [GPT-4 VISION] Analisando imagem da pÃ¡gina ${pageNum}...`);
    
    try {
        // ğŸ†• v3.8.3.10.3: Usar proxy Cloudflare Worker (resolve CORS + seguranÃ§a)
        const WORKER_URL = 'https://chatbot-manutencao.goncalobarata.workers.dev/gpt4-vision';
        
        const response = await fetch(WORKER_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                imageUrl: imageUrl,
                textoContexto: textoContexto,
                pageNum: pageNum
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            console.error('âŒ [GPT-4 VISION] Erro do Worker:', errorData);
            throw new Error(`Worker error: ${response.status} - ${errorData.erro || 'Unknown error'}`);
        }
        
        const data = await response.json();
        
        if (!data.sucesso) {
            console.error('âŒ [GPT-4 VISION] Worker retornou erro:', data);
            return null;
        }
        
        const metadata = data.metadata;
        
        console.log('âœ… [GPT-4 VISION] Metadata extraÃ­da:', metadata);
        
        return metadata;
        
    } catch (error) {
        console.error('âŒ [GPT-4 VISION] Erro ao analisar imagem:', error);
        // NÃ£o falhar o upload por causa disto
        return null;
    }
}

/**
 * Atualizar barra de progresso
 */
function setProgress(label, percent) {
    const progressDiv = document.getElementById('uploadProgress');
    const progressLabel = document.getElementById('uploadProgressLabel');
    const progressPercent = document.getElementById('uploadProgressPercent');
    const progressBar = document.getElementById('uploadProgressBar');
    
    if (progressDiv) progressDiv.style.display = 'block';
    if (progressLabel) progressLabel.textContent = label;
    if (progressPercent) progressPercent.textContent = percent + '%';
    if (progressBar) progressBar.style.width = percent + '%';
}

/**
 * Carregar manuais em background (para uso no chatbot)
 */
async function carregarManuaisBackground() {
    try {
        console.log('ğŸ“š A carregar manuais em background...');
        const manuais = await window.SupabaseAPI.getManuais();
        AppState.manuais = manuais;
        console.log(`ğŸ“š ${manuais.length} manuais carregados em background`);
        
        // Carregar conteÃºdo dos primeiros 5 manuais para cache
        if (manuais.length > 0) {
            AppState.manuaisConteudo = {};
            for (let i = 0; i < Math.min(5, manuais.length); i++) {
                const m = manuais[i];
                console.log(`ğŸ” [DEBUG] Carregando conteÃºdo do manual: ${m.titulo} (${m.id})`);
                const conteudo = await window.SupabaseAPI.getConteudoManual(m.id);
                console.log(`ğŸ” [DEBUG] ConteÃºdo recebido:`, conteudo.length, 'secÃ§Ãµes');
                if (conteudo.length > 0) {
                    console.log(`ğŸ” [DEBUG] Primeira secÃ§Ã£o:`, {
                        secao: conteudo[0].secao,
                        conteudoLength: conteudo[0].conteudo?.length || 0
                    });
                }
                AppState.manuaisConteudo[m.id] = conteudo;
            }
            console.log(`ğŸ“š ConteÃºdo de ${Object.keys(AppState.manuaisConteudo).length} manuais carregado`);
        }
    } catch (error) {
        console.error('âŒ Erro ao carregar manuais em background:', error);
        AppState.manuais = [];
        AppState.manuaisConteudo = {};
    }
}

/**
 * Carregar lista de manuais
 */
async function carregarManuais() {
    try {
        const lista = document.getElementById('manuaisLista');
        const emptyState = document.getElementById('manuaisEmptyState');
        
        lista.innerHTML = '<div class="loading-spinner">A carregar manuais...</div>';
        
        const manuais = await window.SupabaseAPI.getManuais();
        
        // âœ… Guardar no AppState para uso no chatbot
        AppState.manuais = manuais;
        
        if (manuais.length === 0) {
            lista.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }
        
        emptyState.style.display = 'none';
        
        lista.innerHTML = manuais.map(m => `
            <div class="manual-card">
                <div class="manual-card-header">
                    <div>
                        <div class="manual-card-equipment">ğŸ“˜ ${m.equipamento_nome || 'Sem equipamento'}</div>
                        <h3 class="manual-card-title">${m.titulo || 'Sem tÃ­tulo'}</h3>
                    </div>
                    <span class="manual-status-badge ${m.processado ? 'manual-status-processado' : 'manual-status-pendente'}">
                        ${m.processado ? 'âœ… Processado' : 'â³ A processar'}
                    </span>
                </div>
                
                ${m.descricao ? `<p class="manual-card-description">${m.descricao}</p>` : ''}
                
                <div class="manual-card-meta">
                    <span>ğŸ“„ ${m.num_paginas || 0} pÃ¡ginas</span>
                    <span>ğŸ“¦ ${m.tamanho_kb ? Math.round(m.tamanho_kb / 1024) + ' MB' : 'N/D'}</span>
                    <span>ğŸ“… ${m.data_upload ? new Date(m.data_upload).toLocaleDateString('pt-PT') : 'N/D'}</span>
                </div>
                
                <div class="manual-card-actions">
                    <button class="btn btn-secondary btn-sm" onclick="window.open('${m.ficheiro_url}', '_blank')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; margin-right: 4px;">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                        Ver PDF
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="verConteudoManual('${m.id}')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; margin-right: 4px;">
                            <path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                        </svg>
                        Ver ConteÃºdo
                    </button>
                </div>
            </div>
        `).join('');
        
        console.log(`âœ… ${manuais.length} manuais carregados`);
        
    } catch (error) {
        console.error('âŒ Erro ao carregar manuais:', error);
        const lista = document.getElementById('manuaisLista');
        lista.innerHTML = '<div class="empty-state-small">âŒ Erro ao carregar manuais</div>';
    }
}

/**
 * Ver conteÃºdo de um manual (secÃ§Ãµes extraÃ­das)
 */
async function verConteudoManual(manualId) {
    try {
        const conteudo = await window.SupabaseAPI.getConteudoManual(manualId);
        
        let html = `
            <div style="padding: var(--spacing-lg); max-width: 800px;">
                <h3 style="margin-bottom: var(--spacing-md);">ğŸ“– ConteÃºdo do Manual</h3>
        `;
        
        conteudo.forEach((secao, i) => {
            html += `
                <div style="margin-bottom: var(--spacing-lg); padding: var(--spacing-md); background: var(--color-background); border-radius: 8px;">
                    <h4 style="color: var(--color-blue); margin-bottom: var(--spacing-sm);">
                        ${secao.secao || `SecÃ§Ã£o ${i + 1}`}
                    </h4>
                    <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">
                        PÃ¡ginas ${secao.pagina_inicio} - ${secao.pagina_fim}
                    </p>
                    <p style="line-height: 1.6; color: var(--color-text-primary); max-height: 200px; overflow-y: auto;">
                        ${secao.conteudo.substring(0, 500)}${secao.conteudo.length > 500 ? '...' : ''}
                    </p>
                </div>
            `;
        });
        
        html += '</div>';
        
        showToast(html, 'info', 0);  // Duration 0 = manual close
        
    } catch (error) {
        console.error('âŒ Erro ao ver conteÃºdo:', error);
        showToast('âŒ Erro ao carregar conteÃºdo do manual', 'error');
    }
}

// EVENT LISTENERS
function setupEventListeners() {
    // Login e Logout
    document.getElementById('loginForm')?.addEventListener('submit', handleLogin);
    document.getElementById('logoutBtn')?.addEventListener('click', logout);
    
    // Tab navegaÃ§Ã£o e formulÃ¡rios principais
    document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', handleTabChange));
    document.getElementById('maintenanceForm').addEventListener('submit', handleFormSubmit);
    document.getElementById('clearBtn').addEventListener('click', clearForm);
    document.getElementById('foto').addEventListener('change', handlePhotoUpload);
    
    // âš¡ NOVO: Mostrar/ocultar campo FrequÃªncia baseado no tipo de manutenÃ§Ã£o
    const tipoSelect = document.getElementById('tipo');
    const frequenciaGroup = document.getElementById('frequenciaGroup');
    const frequenciaSelect = document.getElementById('frequencia');
    const dataPrimeiraIntervencaoGroup = document.getElementById('dataPrimeiraIntervencaoGroup');
    const dataPrimeiraIntervencaoInput = document.getElementById('dataPrimeiraIntervencao');
    const prioridadeGroup = document.getElementById('prioridadeGroup');
    const prioridadeInputs = document.querySelectorAll('input[name="prioridade"]');
    
    if (tipoSelect && frequenciaGroup && frequenciaSelect) {
        tipoSelect.addEventListener('change', () => {
            if (tipoSelect.value === 'Preventiva') {
                // Mostrar campos de preventiva
                frequenciaGroup.style.display = 'block';
                frequenciaSelect.required = true;
                // âœ… v3.7.0.8: Mostrar Data 1Âª IntervenÃ§Ã£o
                if (dataPrimeiraIntervencaoGroup && dataPrimeiraIntervencaoInput) {
                    dataPrimeiraIntervencaoGroup.style.display = 'block';
                    dataPrimeiraIntervencaoInput.required = true;
                }
                // ğŸ†• Ocultar prioridade em Preventivas
                if (prioridadeGroup) {
                    prioridadeGroup.style.display = 'none';
                    prioridadeInputs.forEach(input => {
                        input.required = false;
                        input.checked = false;
                    });
                }
            } else {
                // Ocultar campos de preventiva
                frequenciaGroup.style.display = 'none';
                frequenciaSelect.required = false;
                frequenciaSelect.value = '';
                // âœ… v3.7.0.8: Ocultar Data 1Âª IntervenÃ§Ã£o
                if (dataPrimeiraIntervencaoGroup && dataPrimeiraIntervencaoInput) {
                    dataPrimeiraIntervencaoGroup.style.display = 'none';
                    dataPrimeiraIntervencaoInput.required = false;
                    dataPrimeiraIntervencaoInput.value = '';
                }
                // ğŸ†• Mostrar prioridade em Corretivas/Melhorias
                if (prioridadeGroup) {
                    prioridadeGroup.style.display = 'block';
                    prioridadeInputs.forEach(input => {
                        input.required = true;
                    });
                }
            }
        });
    }
    
    document.querySelectorAll('.filter-tipo, .filter-prioridade, .filter-estado, .filter-empresa, .filter-tipoIntervencao, .filter-urgente, .filter-paragemProducao, .filter-exigeCompra').forEach(checkbox => checkbox.addEventListener('change', handleFilterChange));
    
    // ğŸ†• v3.8.3.10.24: Event listener para filtro "Para breve"
    const filterPreventivaBreve = document.getElementById('filterPreventivaBreve');
    if (filterPreventivaBreve) {
        filterPreventivaBreve.addEventListener('change', () => {
            console.log('âš¡ Filtro "Para breve" mudou:', filterPreventivaBreve.checked);
            renderRequestsList();
        });
    }
    
    // âš¡ NOVO: Event listener para filtro de equipamento (SELECT, nÃ£o checkbox!)
    const filterEquipamento = document.getElementById('filterEquipamento');
    if (filterEquipamento) {
        filterEquipamento.addEventListener('change', () => {
            console.log('ğŸ”§ Filtro de Equipamento mudou:', filterEquipamento.value);
            renderRequestsList(); // âœ… ForÃ§ar re-render quando muda
        });
        populateEquipamentoFilter(); // Popular dropdown ao carregar
    }
    
    // âœ… v3.7.0.9: Event listener para filtro de responsÃ¡vel
    const filterResponsavel = document.getElementById('filterResponsavel');
    if (filterResponsavel) {
        filterResponsavel.addEventListener('change', () => {
            console.log('ğŸ‘¤ Filtro de ResponsÃ¡vel mudou:', filterResponsavel.value);
            renderRequestsList();
        });
        // Nota: populateResponsavelFilter() Ã© chamado em initializePlanning()
    }
    
    document.getElementById('clearFilters').addEventListener('click', clearFilters);
    document.getElementById('sortBtn').addEventListener('click', toggleSortOrder);
    document.getElementById('groupBtn').addEventListener('click', toggleGroupMode);
    document.getElementById('closeModal').addEventListener('click', closeModal);
    
    // ğŸ†• v3.8.3.10.27.10: Event listeners para RelatÃ³rio de OTs
    document.getElementById('btnImprimirRelatorio').addEventListener('click', abrirModalRelatorio);
    document.getElementById('closeModalRelatorio').addEventListener('click', fecharModalRelatorio);
    document.getElementById('btnCopiarTabela').addEventListener('click', copiarTabelaRelatorio);
    document.getElementById('btnExportarCSV').addEventListener('click', exportarRelatorioCSV);
    document.getElementById('btnExportarImagem').addEventListener('click', exportarRelatorioImagem);
    document.getElementById('btnImprimirPDF').addEventListener('click', imprimirRelatorio);
    document.querySelector('.modal-overlay').addEventListener('click', closeModal);
    document.getElementById('prevWeekBtn').addEventListener('click', () => movePlanningWeek(-1));
    document.getElementById('nextWeekBtn').addEventListener('click', () => movePlanningWeek(1));
    document.getElementById('todayBtn').addEventListener('click', resetPlanningToToday);
    document.getElementById('savePlanningBtn').addEventListener('click', savePlanning);
    
    // âš¡ NOVO: Event listener para resumo de preventivas
    const atualizarPreventivasBtn = document.getElementById('atualizarPreventivasBtn');
    if (atualizarPreventivasBtn) {
        atualizarPreventivasBtn.addEventListener('click', renderPreventivasList);
    }
    
    // âœ… v3.7.0.9: Event listeners para filtros do planeamento
    document.querySelectorAll('.planning-filter-tipo, .planning-filter-prioridade, .planning-filter-estado, .planning-filter-empresa, .planning-filter-tipoIntervencao, .planning-filter-urgente, .planning-filter-paragemProducao, .planning-filter-exigeCompra').forEach(cb => {
        cb.addEventListener('change', () => {
            renderPlanningGrid();
            populatePlanningFilters(); // ğŸš¨ FIX v3.8.3.10.27.17: Atualizar contagens quando filtros mudam
        });
    });
    
    // ğŸ†• v3.8.3.10.27: Event listeners para filtros de preventivas no Planeamento
    const planningFilterPreventivaTodas = document.getElementById('planningFilterPreventivaTodas');
    if (planningFilterPreventivaTodas) {
        planningFilterPreventivaTodas.addEventListener('change', renderPlanningGrid);
    }
    
    const planningFilterPreventivaBreve = document.getElementById('planningFilterPreventivaBreve');
    if (planningFilterPreventivaBreve) {
        planningFilterPreventivaBreve.addEventListener('change', renderPlanningGrid);
    }
    
    const planningFilterPreventivaAtrasadas = document.getElementById('planningFilterPreventivaAtrasadas');
    if (planningFilterPreventivaAtrasadas) {
        planningFilterPreventivaAtrasadas.addEventListener('change', renderPlanningGrid);
    }
    
    const planningFilterEquipamento = document.getElementById('planningFilterEquipamento');
    if (planningFilterEquipamento) {
        planningFilterEquipamento.addEventListener('change', renderPlanningGrid);
    }
    
    const planningFilterResponsavel = document.getElementById('planningFilterResponsavel');
    if (planningFilterResponsavel) {
        planningFilterResponsavel.addEventListener('change', renderPlanningGrid);
    }
    
    const clearPlanningFilters = document.getElementById('clearPlanningFilters');
    if (clearPlanningFilters) {
        clearPlanningFilters.addEventListener('click', clearPlanningFiltersFunc);
    }
    
    // ğŸ“š Event listener para formulÃ¡rio de upload de manuais
    const uploadManualForm = document.getElementById('uploadManualForm');
    if (uploadManualForm) {
        uploadManualForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const equipamento = document.getElementById('manualEquipamento').value;
                const titulo = document.getElementById('manualTitulo').value;
                const descricao = document.getElementById('manualDescricao').value;
                const fileInput = document.getElementById('manualPDF');
                const file = fileInput.files[0];
                
                if (!file) {
                    showToast('âŒ Por favor selecione um ficheiro PDF', 'error');
                    return;
                }
                
                // Validar tamanho (50MB max)
                if (file.size > 50 * 1024 * 1024) {
                    showToast('âŒ Ficheiro muito grande! MÃ¡ximo: 50MB', 'error');
                    return;
                }
                
                // Validar tipo
                if (file.type !== 'application/pdf') {
                    showToast('âŒ Apenas ficheiros PDF sÃ£o permitidos', 'error');
                    return;
                }
                
                console.log('ğŸ“š A processar manual:', { equipamento, titulo, file: file.name });
                
                // Processar manual
                await processarManual(equipamento, titulo, descricao, file);
                
                showToast('âœ… Manual processado com sucesso!', 'success');
                
                // Limpar formulÃ¡rio
                uploadManualForm.reset();
                document.getElementById('uploadProgress').style.display = 'none';
                
                // Recarregar lista
                await carregarManuais();
                
            } catch (error) {
                console.error('âŒ Erro ao processar manual:', error);
                showToast('âŒ Erro ao processar manual: ' + error.message, 'error');
                document.getElementById('uploadProgress').style.display = 'none';
            }
        });
    }
    
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
    
    // âš¡ Event listeners para Equipamentos/Componentes
    const areaSelect = document.getElementById('areaEquipamento');
    const componenteSelect = document.getElementById('componente');
    const empresaSelect = document.getElementById('empresa');
    
    if (areaSelect) {
        areaSelect.addEventListener('change', handleAreaEquipamentoChange);
        // âš ï¸ NÃƒO popular aqui! SerÃ¡ populado DEPOIS de carregar do Supabase em syncWithSupabase()
    }
    
    // âœ… Event listener para EMPRESA â†’ Filtrar equipamentos
    if (empresaSelect) {
        empresaSelect.addEventListener('change', (e) => {
            const empresaSelecionada = e.target.value;
            console.log('ğŸ¢ Empresa selecionada:', empresaSelecionada);
            
            if (empresaSelecionada) {
                // Popular e habilitar dropdown de Ã¡reas/equipamentos
                populateAreaEquipamento(empresaSelecionada);
                if (areaSelect) {
                    areaSelect.disabled = false;
                }
            } else {
                // Se nÃ£o houver empresa, limpar e desabilitar equipamentos
                if (areaSelect) {
                    areaSelect.innerHTML = '<option value="">Escolha primeiro a empresa</option>';
                    areaSelect.disabled = true;
                }
                if (componenteSelect) {
                    componenteSelect.innerHTML = '<option value="">Escolha primeiro a Ã¡rea/equipamento</option>';
                    componenteSelect.disabled = true;
                }
            }
        });
    }
}

// âš¡ EQUIPAMENTOS - Popular dropdown de Ãreas/Equipamentos (filtrado por empresa)
function populateAreaEquipamento(empresaFiltro = null) {
    const areaSelect = document.getElementById('areaEquipamento');
    if (!areaSelect) {
        console.error('âŒ Elemento areaEquipamento nÃ£o encontrado!');
        return;
    }
    
    console.log('ğŸ”„ populateAreaEquipamento chamado - Empresa filtro:', empresaFiltro);
    console.log('ğŸ“Š AppState.equipamentos:', AppState.equipamentos.length, 'registos');
    
    // Limpar opÃ§Ãµes existentes (exceto a primeira)
    areaSelect.innerHTML = '<option value="">Selecione a Ã¡rea/equipamento</option>';
    
    if (AppState.equipamentos.length === 0) {
        console.error('âš ï¸ AppState.equipamentos estÃ¡ vazio! NÃ£o hÃ¡ Ã¡reas para popular.');
        return;
    }
    
    // ğŸ” Log primeiro equipamento para ver estrutura
    if (AppState.equipamentos.length > 0) {
        console.log('ğŸ“‹ Exemplo de equipamento:', AppState.equipamentos[0]);
    }
    
    // âœ… Filtrar por empresa (se especificada)
    let equipamentosFiltrados = AppState.equipamentos;
    if (empresaFiltro) {
        equipamentosFiltrados = AppState.equipamentos.filter(e => e.empresa === empresaFiltro);
        console.log(`ğŸ¢ Equipamentos filtrados para ${empresaFiltro}:`, equipamentosFiltrados.length);
    }
    
    // âœ… Obter Ã¡reas Ãºnicas
    const areasUnicas = [...new Set(equipamentosFiltrados.map(e => e.area))].sort();
    console.log('ğŸ“‹ Ãreas Ãºnicas extraÃ­das:', areasUnicas);
    
    areasUnicas.forEach(area => {
        const option = document.createElement('option');
        option.value = area;
        option.textContent = area;
        areaSelect.appendChild(option);
    });
    
    console.log('âœ… Ãreas/Equipamentos populadas:', areasUnicas.length);
    
    // Limpar componente tambÃ©m
    const componenteSelect = document.getElementById('componente');
    if (componenteSelect) {
        componenteSelect.innerHTML = '<option value="">Escolha primeiro a Ã¡rea/equipamento</option>';
        componenteSelect.disabled = true;
    }
}

// âš¡ EQUIPAMENTOS - Filtrar componentes ao escolher Ã¡rea
function handleAreaEquipamentoChange(e) {
    const areaSelected = e.target.value;
    const componenteSelect = document.getElementById('componente');
    const empresaSelect = document.getElementById('empresa');
    
    if (!componenteSelect) return;
    
    // Limpar e desabilitar se nÃ£o houver Ã¡rea selecionada
    if (!areaSelected) {
        componenteSelect.innerHTML = '<option value="">Escolha primeiro a Ã¡rea/equipamento</option>';
        componenteSelect.disabled = true;
        return;
    }
    
    // Obter empresa selecionada
    const empresaSelecionada = empresaSelect?.value || null;
    
    // âœ… Filtrar por Ã¡rea E empresa
    let componentes = AppState.equipamentos.filter(e => e.area === areaSelected);
    
    // Se houver empresa selecionada, filtrar tambÃ©m por ela
    if (empresaSelecionada) {
        componentes = componentes.filter(e => e.empresa === empresaSelecionada);
    }
    
    componentes.sort((a, b) => (a.ordem || 0) - (b.ordem || 0));
    
    // Limpar e popular dropdown de componentes
    componenteSelect.innerHTML = '<option value="">Selecione o componente</option>';
    
    componentes.forEach(equip => {
        const option = document.createElement('option');
        option.value = equip.componente;
        option.textContent = equip.componente;
        componenteSelect.appendChild(option);
    });
    
    // Habilitar dropdown
    componenteSelect.disabled = false;
    
    console.log(`âš¡ Componentes filtrados para "${areaSelected}" (Empresa: ${empresaSelecionada}):`, componentes.length);
}

function handleTabChange(e) {
    const tab = e.currentTarget.dataset.tab;
    
    // ğŸ”’ v3.7.4.1: Verificar permissÃ£o para aba Manuais
    if (tab === 'manuais' && AppState.currentUser) {
        const role = AppState.currentUser.role;
        const username = AppState.currentUser.username.toLowerCase();
        const usernameNormalizado = username.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
        const isAdmin = role === 'admin' || role === 'Administrador';
        const isGoncalo = usernameNormalizado === 'goncalo' || username === 'gonÃ§alo';
        
        if (!isAdmin && !isGoncalo) {
            console.warn('ğŸ”’ Acesso negado Ã  aba Manuais para:', username);
            showToast('â›” NÃ£o tem permissÃ£o para aceder aos Manuais', 'error');
            return; // Bloquear troca de aba
        }
    }
    
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    e.currentTarget.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
    
    // âœ… CORREÃ‡ÃƒO 1: Guardar aba ativa no localStorage
    try {
        localStorage.setItem('activeTab', tab);
        console.log('ğŸ’¾ Aba ativa guardada:', tab);
    } catch (e) {
        console.warn('Erro ao guardar aba:', e);
    }
    
    if (tab === 'planeamento') {
        renderPlanningGrid();
        // âœ… v3.8.3.10.27.50: Inicializar Filtro Excel de Equipamento para Planeamento
        setTimeout(() => {
            const planningBtn = document.getElementById('planningFilterEquipamentoBtn');
            if (planningBtn && !window.filtroEquipamentoPlanning) {
                console.log('ğŸ”§ Inicializando Filtro Excel para Planeamento...');
                const areaMap = {};
                AppState.equipamentos.forEach(e => {
                    if (!areaMap[e.area]) areaMap[e.area] = 0;
                    areaMap[e.area]++;
                });
                const areas = Object.keys(areaMap).sort();
                
                window.filtroEquipamentoPlanning = new FiltroExcel({
                    id: 'equipamento-planning',
                    targetInputId: 'planningFilterEquipamentoBtn',
                    options: areas,
                    selectedOptions: areas,
                    placeholder: 'Todos os equipamentos',
                    onApply: (selected) => {
                        AppState.filtroEquipamentoPlanningSelecionados = selected;
                        renderWeekView();
                    }
                });
            }
        }, 100);
    }
    
    // âœ… NOVO: Renderizar alertas de stock mÃ­nimo ao abrir tab Stock
    if (tab === 'stock') {
        renderStockMinimo();
        // renderMovimentos() - removido, agora usa pesquisa
    }
    
    // âœ… v3.7.0: Atualizar anÃ¡lises ao abrir tab AnÃ¡lise
    if (tab === 'analise') {
        setTimeout(() => {
            if (typeof window.atualizarAnalises === 'function') {
                console.log('ğŸ“Š Chamando atualizarAnalises() - Pedidos:', AppState.requests?.length || 0);
                window.atualizarAnalises();
            } else {
                console.error('âŒ window.atualizarAnalises nÃ£o Ã© uma funÃ§Ã£o!');
            }
        }, 300); // Aumentado de 100ms para 300ms
    }
    
    // ğŸ“š Carregar manuais ao abrir tab Manuais
    if (tab === 'manuais') {
        setTimeout(() => carregarManuais(), 100);
    }
    
    // Re-aplicar auto-preenchimento quando mudar de tab
    if (tab === 'novo') {
        setTimeout(() => applyUserAutoFill(), 100);
    }
}

// âœ… CORREÃ‡ÃƒO 1: Restaurar aba ativa ao carregar (SEM FLASH)
function restoreActiveTab() {
    try {
        let activeTab = localStorage.getItem('activeTab');
        
        // ğŸ”’ v3.7.4.1: Verificar permissÃ£o para aba Manuais
        if (activeTab === 'manuais' && AppState.currentUser) {
            const role = AppState.currentUser.role;
            const username = AppState.currentUser.username.toLowerCase();
            const usernameNormalizado = username.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
            const isAdmin = role === 'admin' || role === 'Administrador';
            const isGoncalo = usernameNormalizado === 'goncalo' || username === 'gonÃ§alo';
            
            if (!isAdmin && !isGoncalo) {
                console.warn('ğŸ”’ RestauraÃ§Ã£o da aba Manuais bloqueada para:', username);
                activeTab = 'novo'; // Redirecionar para aba Nova OT
            }
        }
        
        if (activeTab && activeTab !== 'novo') {
            console.log('ğŸ”„ Restaurando aba:', activeTab);
            
            // âœ… Ativar diretamente SEM click (evita animaÃ§Ã£o/flash)
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            const tabBtn = document.querySelector(`.tab-btn[data-tab="${activeTab}"]`);
            const tabContent = document.getElementById(`tab-${activeTab}`);
            
            if (tabBtn && tabContent) {
                tabBtn.classList.add('active');
                tabContent.classList.add('active');
                
                // âœ… Renderizar conteÃºdo se necessÃ¡rio
                if (activeTab === 'stock') {
                    renderStockMinimo();
                    // renderMovimentos() - removido, agora usa pesquisa
                }
                
                // âœ… v3.7.0: Atualizar anÃ¡lises ao restaurar tab AnÃ¡lise
                if (activeTab === 'analise') {
                    setTimeout(() => {
                        if (typeof window.atualizarAnalises === 'function') {
                            console.log('ğŸ“Š Chamando atualizarAnalises() - Pedidos:', AppState.requests?.length || 0);
                            window.atualizarAnalises();
                        } else {
                            console.error('âŒ window.atualizarAnalises nÃ£o Ã© uma funÃ§Ã£o!');
                        }
                    }, 500); // Aumentado de 200ms para 500ms
                }
                
                // ğŸ“š Carregar manuais ao restaurar tab Manuais
                if (activeTab === 'manuais') {
                    setTimeout(() => carregarManuais(), 100);
                }
                
                // âœ… v3.8.3.10.27.50: Inicializar Filtro Excel ao restaurar Planeamento
                if (activeTab === 'planeamento') {
                    setTimeout(() => {
                        const planningBtn = document.getElementById('planningFilterEquipamentoBtn');
                        if (planningBtn && !window.filtroEquipamentoPlanning) {
                            console.log('ğŸ”§ Inicializando Filtro Excel para Planeamento (restore)...');
                            const areaMap = {};
                            AppState.equipamentos.forEach(e => {
                                if (!areaMap[e.area]) areaMap[e.area] = 0;
                                areaMap[e.area]++;
                            });
                            const areas = Object.keys(areaMap).sort();
                            
                            window.filtroEquipamentoPlanning = new FiltroExcel({
                                id: 'equipamento-planning',
                                targetInputId: 'planningFilterEquipamentoBtn',
                                options: areas,
                                selectedOptions: areas,
                                placeholder: 'Todos os equipamentos',
                                onApply: (selected) => {
                                    AppState.filtroEquipamentoPlanningSelecionados = selected;
                                    renderWeekView();
                                }
                            });
                        }
                    }, 100);
                }
                
                console.log('âœ… Aba restaurada:', activeTab);
            }
        }
        
        // âœ… CORREÃ‡ÃƒO v3.6.22: Remover classe app-loading (mostrar conteÃºdo)
        document.body.classList.remove('app-loading');
        
    } catch (e) {
        console.warn('Erro ao restaurar aba:', e);
        // âœ… Remover classe mesmo em caso de erro
        document.body.classList.remove('app-loading');
    }
}

// FORMULÃRIO
async function handleFormSubmit(e) {
    e.preventDefault();
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.classList.add('loading');
    submitBtn.disabled = true;
    try {
        // âœ… v3.7.0.9: Gerar ID sequencial OT_XXXXX
        const pedidoId = await generateOTID();
        
        // ğŸ“¸ v3.6.18: Upload foto ANTES de criar pedido
        let fotoUrl = '';
        const fotoFile = await getImageData();
        
        if (fotoFile) {
            console.log('ğŸ“¸ A fazer upload da foto...');
            showToast('A enviar foto...', 'info');
            
            try {
                fotoUrl = await window.SupabaseAPI.uploadFoto(pedidoId, fotoFile);
                if (fotoUrl) {
                    console.log('âœ… Foto enviada:', fotoUrl);
                } else {
                    console.warn('âš ï¸ Foto nÃ£o foi enviada, pedido serÃ¡ criado sem foto');
                }
            } catch (error) {
                console.error('âŒ Erro ao enviar foto:', error);
                // Continuar mesmo se foto falhar
            }
        }
        
        const tipoValue = document.getElementById('tipo').value;
        const prioridadeValue = document.querySelector('input[name="prioridade"]:checked')?.value;
        
        // ğŸ†• Prioridade sÃ³ Ã© obrigatÃ³ria para Corretivas e Melhorias
        if (!prioridadeValue && tipoValue !== 'Preventiva') {
            showToast('âŒ Por favor, seleciona uma prioridade!', 'error');
            return;
        }
        
        // ğŸ†• v3.8.3.10.27.42: Coletar dados de RevisÃ£o (se aplicÃ¡vel)
        let revisaoData = {};
        if (tipoValue === 'RevisÃ£o' && typeof window.getRevisaoData === 'function') {
            revisaoData = window.getRevisaoData();
            console.log('ğŸ”§ Dados de RevisÃ£o coletados:', revisaoData);
            
            // Validar dados de RevisÃ£o
            if (typeof window.validateRevisao === 'function') {
                const isValid = window.validateRevisao({
                    tipo: tipoValue,
                    empresa: document.getElementById('empresa').value,
                    areaEquipamento: document.getElementById('areaEquipamento').value,
                    dataPrimeiraIntervencao: revisaoData.dataPrimeiraIntervencao,
                    frequencia: revisaoData.frequencia,
                    tiposRevisao: revisaoData.tiposRevisao
                });
                
                if (!isValid) {
                    submitBtn.classList.remove('loading');
                    submitBtn.disabled = false;
                    return;  // Bloquear submit se validaÃ§Ã£o falhar
                }
            }
        }
        
        const formData = {
            id: pedidoId,
            tipo: tipoValue,
            frequencia: tipoValue === 'RevisÃ£o' ? (revisaoData.frequencia || null) : (document.getElementById('frequencia').value || '-'),  // âœ… NOVO campo
            dataPrimeiraIntervencao: tipoValue === 'RevisÃ£o' ? (revisaoData.dataPrimeiraIntervencao || '') : (document.getElementById('dataPrimeiraIntervencao').value || ''),  // âœ… v3.7.0.8: Data 1Âª IntervenÃ§Ã£o
            prioridade: prioridadeValue || '-',  // ğŸ†• "-" se nÃ£o houver prioridade (Preventivas)
            empresa: document.getElementById('empresa').value,
            tipoIntervencao: document.getElementById('tipoIntervencao').value || '-',
            areaEquipamento: document.getElementById('areaEquipamento').value,
            componente: document.getElementById('componente').value,
            urgente: document.getElementById('urgente').checked,
            paragemProducao: document.getElementById('paragemProducao').checked,
            exigeCompra: document.getElementById('exigeCompra').checked,  // ğŸ†• v3.8.3.10.6
            departamento: document.getElementById('departamento').value || '-',
            descricao: document.getElementById('descricao').value,
            foto: fotoUrl,  // âœ… URL do Storage (ou vazio)
            nome: document.getElementById('nome').value,
            criadoPorUsername: AppState.currentUser ? AppState.currentUser.username : '',  // ğŸ†• v3.7.7.0: FK para utilizadores
            dataHora: new Date().toISOString(),
            estado: 'Novo',
            // ğŸ†• v3.8.3.10.27.42: Campos de RevisÃ£o
            numeroHoras: revisaoData.numeroHoras || null,
            tiposRevisao: revisaoData.tiposRevisao || null
        };
        
        localStorage.setItem(CONFIG.STORAGE_KEYS.USER_NAME, formData.nome);
        AppState.requests.unshift(formData);
        saveToLocalStorage();
        
        if (AppState.isOnline) {
            await sendToGoogleSheets(formData);  // ğŸ”¥ Nome legacy, usa Supabase internamente
        } else {
            addToOfflineQueue(formData);
            showToast('Pedido salvo offline. SerÃ¡ sincronizado quando estiver online.', 'info');
        }
        
        clearForm();
        showToast('Pedido criado com sucesso!', 'success');
        document.querySelector('.tab-btn[data-tab="lista"]').click();
        renderRequestsList();
        
    } catch (error) {
        console.error('Erro ao criar pedido:', error);
        showToast('Erro ao criar pedido. Tente novamente.', 'error');
    } finally {
        submitBtn.classList.remove('loading');
        submitBtn.disabled = false;
    }
}

function clearForm() {
    document.getElementById('maintenanceForm').reset();
    clearImagePreview();
    
    // âš¡ Resetar campos de Equipamento/Componente
    const componenteSelect = document.getElementById('componente');
    if (componenteSelect) {
        componenteSelect.innerHTML = '<option value="">Escolha primeiro a Ã¡rea/equipamento</option>';
        componenteSelect.disabled = true;
    }
}

function loadSavedUserName() {
    const savedName = localStorage.getItem(CONFIG.STORAGE_KEYS.USER_NAME);
    if (savedName) document.getElementById('nome').value = savedName;
}

// ğŸ“¸ v3.6.18: VariÃ¡vel global para guardar o File original
let currentPhotoFile = null;

// UPLOAD DE IMAGENS E PDFs
async function handlePhotoUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // ğŸ†• v3.8.3.10.22: Validar tamanho (5MB para imagens e PDFs)
    if (file.size > CONFIG.MAX_IMAGE_SIZE) {
        showToast('O ficheiro deve ter no mÃ¡ximo 5MB.', 'error');
        e.target.value = '';
        return;
    }
    
    // ğŸ†• v3.8.3.10.22: Aceitar imagens OU PDFs
    const isImage = file.type.startsWith('image/');
    const isPDF = file.type === 'application/pdf';
    
    if (!isImage && !isPDF) {
        showToast('Por favor, selecione uma imagem (JPG, PNG, etc.) ou um PDF.', 'error');
        e.target.value = '';
        return;
    }
    
    try {
        // âœ… Guardar File original para upload posterior
        currentPhotoFile = file;
        
        if (isImage) {
            // Criar preview comprimido (sÃ³ para visualizaÃ§Ã£o de imagens)
            const compressedImage = await compressImage(file);
            showImagePreview(compressedImage);
            document.getElementById('fileName').textContent = file.name;
            console.log('ğŸ“¸ Imagem selecionada:', file.name, (file.size / 1024 / 1024).toFixed(2) + ' MB');
        } else if (isPDF) {
            // Mostrar preview de PDF (Ã­cone)
            showPDFPreview(file.name);
            document.getElementById('fileName').textContent = file.name;
            console.log('ğŸ“„ PDF selecionado:', file.name, (file.size / 1024 / 1024).toFixed(2) + ' MB');
        }
    } catch (error) {
        console.error('Erro ao processar ficheiro:', error);
        showToast('Erro ao processar ficheiro.', 'error');
        e.target.value = '';
        currentPhotoFile = null;
    }
}

function compressImage(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width, height = img.height;
                if (width > CONFIG.MAX_IMAGE_WIDTH || height > CONFIG.MAX_IMAGE_HEIGHT) {
                    if (width > height) {
                        height = (height / width) * CONFIG.MAX_IMAGE_WIDTH;
                        width = CONFIG.MAX_IMAGE_WIDTH;
                    } else {
                        width = (width / height) * CONFIG.MAX_IMAGE_HEIGHT;
                        height = CONFIG.MAX_IMAGE_HEIGHT;
                    }
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                const compressedDataUrl = canvas.toDataURL('image/jpeg', CONFIG.IMAGE_QUALITY);
                resolve(compressedDataUrl);
            };
            img.onerror = reject;
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

function showImagePreview(dataUrl) {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = `<img src="${dataUrl}" alt="Preview"><button type="button" class="remove-image" onclick="clearImagePreview()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>`;
    preview.classList.add('active');
}

// ğŸ†• v3.8.3.10.22: Preview para PDFs
function showPDFPreview(fileName) {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f5f5f5; border-radius: 8px; border: 2px solid #e0e0e0;">
            <svg style="width: 48px; height: 48px; color: #d32f2f;" viewBox="0 0 24 24" fill="currentColor">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M10,19L12,15H9V10H15V15L13,19H10Z"/>
            </svg>
            <div style="flex: 1;">
                <div style="font-weight: 600; color: #333; font-size: 14px;">ğŸ“„ PDF Anexado</div>
                <div style="font-size: 12px; color: #666; margin-top: 4px;">${fileName}</div>
            </div>
            <button type="button" class="remove-image" onclick="clearImagePreview()" style="position: static;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
    `;
    preview.classList.add('active');
}

function clearImagePreview() {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    preview.classList.remove('active');
    document.getElementById('foto').value = '';
    document.getElementById('fileName').textContent = 'Escolher imagem ou PDF';  // ğŸ†• v3.8.3.10.22
    currentPhotoFile = null;  // âœ… Limpar File guardado
}

// ğŸ“¸ v3.6.18: Retornar File original em vez de base64
async function getImageData() {
    return currentPhotoFile;  // Retorna File ou null
}

// LISTAGEM
function renderRequestsList() {
    applyFilters();
    
    // Aplicar ordenaÃ§Ã£o por hierarquia OU por data
    if (AppState.groupMode) {
        applySortingByHierarchy();
    } else {
        applySorting();
    }
    
    const container = document.getElementById('requestsList');
    const emptyState = document.getElementById('emptyState');
    const listCount = document.getElementById('listCount');
    const count = AppState.filteredRequests.length;
    listCount.textContent = `${count} ${count === 1 ? 'pedido' : 'pedidos'}`;
    if (AppState.filteredRequests.length === 0) {
        container.innerHTML = '';
        emptyState.classList.add('active');
        return;
    }
    emptyState.classList.remove('active');
    
    // Se modo grupo, adicionar separadores
    if (AppState.groupMode) {
        container.innerHTML = renderWithGroups();
    } else {
        container.innerHTML = AppState.filteredRequests.map(request => renderRequestCard(request)).join('');
    }
}

function renderRequestCard(request) {
        // âœ… VERIFICAÃ‡Ã•ES DE SEGURANÃ‡A para evitar erros de undefined
        const tipo = request.tipo || 'N/A';
        const frequencia = request.frequencia || '-';
        const prioridade = request.prioridade || 'Media';
        const estado = request.estado || 'Novo';
        // Remover acentos para classe CSS
        const prioridadeClass = prioridade.toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, ''); // Remove acentos
        const estadoClass = estado.toLowerCase().replace(' ', '');
        const descricao = request.descricao || '';
        const nome = request.nome || 'Desconhecido';
        const departamento = request.departamento || '-';
        const areaEquipamento = request.areaEquipamento || '';
        const componente = request.componente || '';
        
        // ğŸ†• v3.7.6.9: InformaÃ§Ã£o de alocaÃ§Ã£o/fechamento
        const task = AppState.planning.tasks[request.id];
        const responsavelAlocado = task?.responsavel || request.responsavel || null;  // ğŸ”§ v3.7.6.9.1: Tentar tambÃ©m request.responsavel
        const fechadoPor = request.fechadoPor || null;
        
        return `<div class="request-card" onclick="openRequestDetails('${request.id}')">
            <div class="request-header">
                <div class="request-badges">
                    <span class="badge" style="background: #2c3e50; color: white; font-size: 11px; font-weight: 600; letter-spacing: 0.5px;">ğŸ†” ${request.id}</span>
                    <span class="badge badge-tipo">${tipo}</span>
                    ${tipo === 'Preventiva' && frequencia !== '-' ? `<span class="badge" style="background: #4CAF50; color: white; font-size: 11px;">â±ï¸ ${frequencia}</span>` : ''}
                    ${tipo === 'RevisÃ£o' && frequencia !== '-' ? `<span class="badge" style="background: #8B5CF6; color: white; font-size: 11px;">â±ï¸ ${frequencia}</span>` : ''}
                    ${tipo === 'RevisÃ£o' && request.numeroHoras ? `<span class="badge" style="background: #F59E0B; color: white; font-size: 11px;">â° ${request.numeroHoras}h</span>` : ''}
                    ${tipo !== 'Preventiva' && tipo !== 'RevisÃ£o' ? `<span class="badge badge-prioridade ${prioridadeClass}">${prioridade}</span>` : ''}
                    <span class="badge badge-estado ${estadoClass}">${estado}</span>
                    ${areaEquipamento && areaEquipamento !== '-' ? `<span class="badge" style="background: #667eea; color: white; font-size: 11px;">ğŸ”§ ${areaEquipamento}</span>` : ''}
                    ${componente && componente !== '-' ? `<span class="badge" style="background: #9b59b6; color: white; font-size: 11px;">âš™ï¸ ${componente}</span>` : ''}
                    ${request.urgente ? `<span class="badge" style="background: #ff4757; color: white; font-size: 11px;">ğŸ”´ Urgente</span>` : ''}
                    ${request.paragemProducao ? `<span class="badge" style="background: #ffa502; color: white; font-size: 11px;">âš ï¸ Paragem</span>` : ''}
                    ${request.exigeCompra ? `<span class="badge" style="background: #3498db; color: white; font-size: 11px;">ğŸ›’ Compra</span>` : ''}
                </div>
                <span class="request-date">${formatDate(request.dataHora)}</span>
            </div>
            <div class="request-body">
                <h4>${tipo}</h4>
                <p>${descricao}</p>
            </div>
            <div class="request-footer">
                <div class="request-meta">
                    <span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>${nome}</span>
                    ${departamento !== '-' ? `<span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>${departamento}</span>` : ''}
                    ${estado === 'Resolvido' && fechadoPor ? `<span style="color: #27ae60; font-weight: 500;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>Fechado por: ${fechadoPor}</span>` : ''}
                    ${estado !== 'Resolvido' && responsavelAlocado ? `<span style="color: #3498db; font-weight: 500;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>Alocado: ${responsavelAlocado}</span>` : ''}
                </div>
                <div class="request-actions" onclick="event.stopPropagation()">
                    ${estado !== 'Resolvido' ? `<button class="btn-icon" onclick="changeRequestState('${request.id}')" title="Mudar estado"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg></button>` : ''}
                    <button class="btn-icon" onclick="deleteRequest('${request.id}')" title="Eliminar"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                </div>
            </div>
        </div>`;
}

function applyFilters() {
    AppState.filteredRequests = AppState.requests.filter(request => {
        // âš¡ NORMALIZAR valores para evitar problemas com espaÃ§os/maiÃºsculas
        const estadoPedido = (request.estado || '').trim();
        const tipoPedido = (request.tipo || '').trim();
        const prioridadePedido = (request.prioridade || '').trim();
        
        // Filtros
        const passaTipo = AppState.currentFilters.tipo.length === 0 || AppState.currentFilters.tipo.includes(tipoPedido);
        const passaPrioridade = AppState.currentFilters.prioridade.length === 0 || AppState.currentFilters.prioridade.includes(prioridadePedido);
        const passaEstado = AppState.currentFilters.estado.length === 0 || AppState.currentFilters.estado.includes(estadoPedido);
        
        const empresaPedido = request.empresa || 'MCF';
        const passaEmpresa = AppState.currentFilters.empresa.length === 0 || AppState.currentFilters.empresa.includes(empresaPedido);
        
        // âš¡ v3.8.3.10.27.46: Filtro de Equipamento (Filtro Excel)
        const equipamentosSelecionados = AppState.filtroEquipamentoSelecionados || [];
        const areaEquipamentoPedido = (request.areaEquipamento || '').trim();
        const passaEquipamento = equipamentosSelecionados.length === 0 || equipamentosSelecionados.includes(areaEquipamentoPedido);
        
        // âœ… Filtro de ResponsÃ¡vel (do PLANEAMENTO)
        const filterResponsavel = document.getElementById('filterResponsavel')?.value || '';
        const task = AppState.planning.tasks[request.id];
        const responsavelPedido = (task?.responsavel || '').trim();
        const passaResponsavel = !filterResponsavel || responsavelPedido === filterResponsavel;
        
        // Novos filtros
        const tipoIntervencaoPedido = request.tipoIntervencao || '-';
        const passaTipoIntervencao = AppState.currentFilters.tipoIntervencao.length === 0 || 
                                     (tipoIntervencaoPedido !== '-' && AppState.currentFilters.tipoIntervencao.includes(tipoIntervencaoPedido));
        
        const passaUrgente = AppState.currentFilters.urgente.length === 0 || 
                            (AppState.currentFilters.urgente.includes('true') && request.urgente === true);
        
        const passaParagem = AppState.currentFilters.paragemProducao.length === 0 || 
                            (AppState.currentFilters.paragemProducao.includes('true') && request.paragemProducao === true);
        
        const passaExigeCompra = AppState.currentFilters.exigeCompra.length === 0 || 
                                (AppState.currentFilters.exigeCompra.includes('true') && request.exigeCompra === true);
        
        // ğŸ†• v3.8.3.10.25: Filtros de preventivas (todas, para breve, atrasadas)
        const filterPreventivaTodas = document.getElementById('filterPreventivaTodas')?.checked || false;
        const filterPreventivaBreve = document.getElementById('filterPreventivaBreve')?.checked || false;
        const filterPreventivaAtrasadas = document.getElementById('filterPreventivaAtrasadas')?.checked || false;
        let passaFiltroPreventiva = true;
        
        // SÃ³ aplicar filtros se for preventiva
        if (tipoPedido === 'Preventiva') {
            // Se NENHUM filtro de preventiva estiver ativo, ocultar todas
            if (!filterPreventivaTodas && !filterPreventivaBreve && !filterPreventivaAtrasadas) {
                passaFiltroPreventiva = false;
            } else if (request.dataPrimeiraIntervencao && request.frequencia) {
                // Calcular prÃ³xima intervenÃ§Ã£o
                const proximaData = calcularProximaIntervencao(request.dataPrimeiraIntervencao, request.frequencia);
                if (proximaData) {
                    const hoje = new Date();
                    hoje.setHours(0, 0, 0, 0);
                    const diasRestantes = Math.ceil((proximaData - hoje) / (1000 * 60 * 60 * 24));
                    
                    // Verificar se passa em algum dos filtros ativos
                    const passaTodas = filterPreventivaTodas;
                    const passaBreve = filterPreventivaBreve && diasRestantes <= 30;
                    const passaAtrasadas = filterPreventivaAtrasadas && diasRestantes < 0;
                    
                    passaFiltroPreventiva = passaTodas || passaBreve || passaAtrasadas;
                } else {
                    // Sem data calculada, sÃ³ mostrar se "Todas" estiver ativo
                    passaFiltroPreventiva = filterPreventivaTodas;
                }
            } else {
                // Sem data/frequÃªncia, sÃ³ mostrar se "Todas" estiver ativo
                passaFiltroPreventiva = filterPreventivaTodas;
            }
        }
        
        return passaTipo && passaPrioridade && passaEstado && passaEmpresa && passaEquipamento && passaResponsavel && passaTipoIntervencao && passaUrgente && passaParagem && passaExigeCompra && passaFiltroPreventiva;
    });
    
    console.log(`âœ… Filtros aplicados: ${AppState.filteredRequests.length} de ${AppState.requests.length} pedidos`);
}

function applySorting() {
    AppState.filteredRequests.sort((a, b) => {
        const dateA = new Date(a.dataHora), dateB = new Date(b.dataHora);
        return AppState.sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
    });
}

function applySortingByHierarchy() {
    AppState.filteredRequests.sort((a, b) => {
        // 1. Por empresa
        const empresaA = a.empresa || 'MCF';
        const empresaB = b.empresa || 'MCF';
        if (empresaA !== empresaB) return empresaA.localeCompare(empresaB);
        
        // 2. Por Ã¡rea/equipamento
        const areaA = a.areaEquipamento || '';
        const areaB = b.areaEquipamento || '';
        if (areaA !== areaB) return areaA.localeCompare(areaB);
        
        // 3. Por componente
        const compA = a.componente || '';
        const compB = b.componente || '';
        if (compA !== compB) return compA.localeCompare(compB);
        
        // 4. Por prioridade
        const prioridadeOrdem = { 'Alta': 1, 'MÃ©dia': 2, 'Baixa': 3 };
        const prioA = prioridadeOrdem[a.prioridade] || 4;
        const prioB = prioridadeOrdem[b.prioridade] || 4;
        return prioA - prioB;
    });
}

function renderWithGroups() {
    let html = '';
    let currentEmpresa = '';
    let currentArea = '';
    
    AppState.filteredRequests.forEach((request, index) => {
        const empresa = request.empresa || 'MCF';
        const area = request.areaEquipamento || 'Sem Ãrea';
        
        // CabeÃ§alho de Empresa
        if (empresa !== currentEmpresa) {
            const countEmpresa = AppState.filteredRequests.filter(r => (r.empresa || 'MCF') === empresa).length;
            html += `
                <div style="background: #E5E7EB; padding: 12px 16px; margin: 20px 0 10px 0; border-radius: 8px; font-weight: bold; font-size: 14px; color: #1F2937;">
                    ğŸ“Š ${empresa} (${countEmpresa} OTs)
                </div>
            `;
            currentEmpresa = empresa;
            currentArea = ''; // Reset Ã¡rea
        }
        
        // CabeÃ§alho de Ãrea
        if (area !== currentArea) {
            const countArea = AppState.filteredRequests.filter(r => 
                (r.empresa || 'MCF') === empresa && 
                (r.areaEquipamento || 'Sem Ãrea') === area
            ).length;
            html += `
                <div style="background: #F3F4F6; padding: 10px 16px; margin: 10px 0 8px 0; border-radius: 6px; font-weight: 600; font-size: 13px; color: #374151;">
                    ğŸ”§ ${area} (${countArea} OTs)
                </div>
            `;
            currentArea = area;
        }
        
        // Card da OT
        html += renderRequestCard(request);
    });
    
    return html;
}

function handleFilterChange(e) {
    const filterType = e.target.classList[0].replace('filter-', '');
    const value = e.target.value;
    if (e.target.checked) {
        AppState.currentFilters[filterType].push(value);
    } else {
        const index = AppState.currentFilters[filterType].indexOf(value);
        if (index > -1) AppState.currentFilters[filterType].splice(index, 1);
    }
    renderRequestsList();
    // ğŸš¨ FIX: Atualizar contagens do filtro de responsÃ¡vel apÃ³s mudar filtros
    populateResponsavelFilter();
}

// âš¡ EQUIPAMENTOS - Popular filtro de equipamento
function populateEquipamentoFilter() {
    // âœ… v3.8.3.10.27.46: Criar Filtros Excel para Equipamento
    
    // Obter Ã¡reas Ãºnicas do Supabase
    const areaMap = {};
    AppState.equipamentos.forEach(e => {
        if (!areaMap[e.area]) areaMap[e.area] = 0;
        areaMap[e.area]++;
    });
    
    const areas = Object.keys(areaMap).sort();
    
    // Criar Filtro Excel para Lista de OTs
    if (!window.filtroEquipamentoLista) {
        window.filtroEquipamentoLista = new FiltroExcel({
            id: 'equipamento-lista',
            targetInputId: 'filterEquipamentoBtn',
            options: areas,
            selectedOptions: areas, // Tudo selecionado por padrÃ£o
            placeholder: 'Todos os equipamentos',
            onApply: (selected) => {
                // Atualizar AppState e re-renderizar lista
                AppState.filtroEquipamentoSelecionados = selected;
                applyFilters();
                renderRequestsList();
            }
        });
    } else {
        window.filtroEquipamentoLista.updateOptions(areas);
        window.filtroEquipamentoLista.selectAll();
    }
    
    // Criar Filtro Excel para Planeamento
    const planningBtn = document.getElementById('planningFilterEquipamentoBtn');
    if (planningBtn) {
        if (!window.filtroEquipamentoPlanning) {
            window.filtroEquipamentoPlanning = new FiltroExcel({
                id: 'equipamento-planning',
                targetInputId: 'planningFilterEquipamentoBtn',
                options: areas,
                selectedOptions: areas, // Tudo selecionado por padrÃ£o
                placeholder: 'Todos os equipamentos',
                onApply: (selected) => {
                    // Atualizar filtro de planeamento
                    AppState.filtroEquipamentoPlanningSelecionados = selected;
                    renderWeekView();
                }
            });
        } else {
            window.filtroEquipamentoPlanning.updateOptions(areas);
            window.filtroEquipamentoPlanning.selectAll();
        }
    } else {
        console.warn('âš ï¸ BotÃ£o de filtro de Planeamento ainda nÃ£o existe (serÃ¡ criado quando abrir a aba)');
    }
    
    console.log('âš¡ Filtros Excel de Equipamento criados com', areas.length, 'Ã¡reas');
}

// ğŸ†• v3.8.3.10.27.11: FunÃ§Ãµes do RelatÃ³rio de OTs (CORRIGIDO - respeita checkboxes)
function abrirModalRelatorio() {
    console.log('ğŸ–¨ï¸ Abrindo modal de relatÃ³rio...');
    
    // ğŸ”§ FORÃ‡AR atualizaÃ§Ã£o dos filtros baseado nos checkboxes VISUALMENTE marcados
    sincronizarFiltrosComCheckboxes();
    
    // Aplicar filtros para obter OTs filtradas
    applyFilters();
    
    const otsFiltered = AppState.filteredRequests;
    
    console.log(`ğŸ“Š OTs filtradas: ${otsFiltered.length} de ${AppState.requests.length}`);
    
    if (otsFiltered.length === 0) {
        showToast('âš ï¸ Nenhuma OT para gerar relatÃ³rio. Ajuste os filtros.', 'warning');
        return;
    }
    
    // Gerar texto dos filtros aplicados
    const filtrosTexto = gerarTextoFiltros();
    
    // Atualizar informaÃ§Ãµes do relatÃ³rio
    document.getElementById('relatorioFiltrosTexto').textContent = filtrosTexto;
    document.getElementById('relatorioData').textContent = new Date().toLocaleDateString('pt-PT');
    document.getElementById('relatorioTotal').textContent = `${otsFiltered.length} OTs`;
    
    // Gerar relatÃ³rio
    gerarRelatorio(otsFiltered);
    
    // Mostrar modal
    document.getElementById('modalRelatorio').style.display = 'flex';
}

// ğŸ†• v3.8.3.10.27.11: Sincronizar AppState.currentFilters com checkboxes marcados
function sincronizarFiltrosComCheckboxes() {
    console.log('ğŸ”„ Sincronizando filtros com checkboxes...');
    
    // Limpar filtros atuais
    AppState.currentFilters = {
        tipo: [],
        prioridade: [],
        estado: [],
        empresa: [],
        tipoIntervencao: [],
        urgente: [],
        paragemProducao: [],
        exigeCompra: []
    };
    
    // Ler TIPO (checkboxes marcados)
    document.querySelectorAll('.filter-tipo:checked').forEach(cb => {
        AppState.currentFilters.tipo.push(cb.value);
    });
    
    // Ler PRIORIDADE
    document.querySelectorAll('.filter-prioridade:checked').forEach(cb => {
        AppState.currentFilters.prioridade.push(cb.value);
    });
    
    // Ler ESTADO
    document.querySelectorAll('.filter-estado:checked').forEach(cb => {
        AppState.currentFilters.estado.push(cb.value);
    });
    
    // Ler EMPRESA
    document.querySelectorAll('.filter-empresa:checked').forEach(cb => {
        AppState.currentFilters.empresa.push(cb.value);
    });
    
    // Ler TIPO DE INTERVENÃ‡ÃƒO
    document.querySelectorAll('.filter-tipoIntervencao:checked').forEach(cb => {
        AppState.currentFilters.tipoIntervencao.push(cb.value);
    });
    
    // Ler ESPECIAIS
    document.querySelectorAll('.filter-urgente:checked').forEach(cb => {
        AppState.currentFilters.urgente.push(cb.value);
    });
    
    document.querySelectorAll('.filter-paragemProducao:checked').forEach(cb => {
        AppState.currentFilters.paragemProducao.push(cb.value);
    });
    
    document.querySelectorAll('.filter-exigeCompra:checked').forEach(cb => {
        AppState.currentFilters.exigeCompra.push(cb.value);
    });
    
    console.log('âœ… Filtros sincronizados:', AppState.currentFilters);
}

function fecharModalRelatorio() {
    document.getElementById('modalRelatorio').style.display = 'none';
}

function gerarTextoFiltros() {
    const filtros = [];
    
    // Tipo
    if (AppState.currentFilters.tipo.length > 0) {
        filtros.push(`Tipo: ${AppState.currentFilters.tipo.join(', ')}`);
    }
    
    // Prioridade
    if (AppState.currentFilters.prioridade.length > 0) {
        filtros.push(`Prioridade: ${AppState.currentFilters.prioridade.join(', ')}`);
    }
    
    // Estado
    if (AppState.currentFilters.estado.length > 0) {
        filtros.push(`Estado: ${AppState.currentFilters.estado.join(', ')}`);
    }
    
    // Empresa
    if (AppState.currentFilters.empresa.length > 0) {
        filtros.push(`Empresa: ${AppState.currentFilters.empresa.join(', ')}`);
    }
    
    // Equipamento
    const filterEquipamento = document.getElementById('filterEquipamento')?.value || '';
    if (filterEquipamento) {
        filtros.push(`Equipamento: ${filterEquipamento}`);
    }
    
    // ResponsÃ¡vel
    const filterResponsavel = document.getElementById('filterResponsavel')?.value || '';
    if (filterResponsavel) {
        filtros.push(`ResponsÃ¡vel: ${filterResponsavel}`);
    }
    
    // Tipo de IntervenÃ§Ã£o
    if (AppState.currentFilters.tipoIntervencao.length > 0) {
        filtros.push(`Tipo IntervenÃ§Ã£o: ${AppState.currentFilters.tipoIntervencao.join(', ')}`);
    }
    
    // Especiais
    if (AppState.currentFilters.urgente.length > 0) {
        filtros.push(`Urgente`);
    }
    if (AppState.currentFilters.paragemProducao.length > 0) {
        filtros.push(`Paragem ProduÃ§Ã£o`);
    }
    if (AppState.currentFilters.exigeCompra.length > 0) {
        filtros.push(`Exige Compra`);
    }
    
    const textoFiltros = filtros.length > 0 ? filtros.join(' | ') : 'Todos';
    console.log('ğŸ“‹ Texto dos filtros:', textoFiltros);
    return textoFiltros;
}

function gerarRelatorio(ots) {
    console.log(`ğŸ“Š Gerando relatÃ³rio para ${ots.length} OTs`);
    
    const container = document.getElementById('relatorioContainer');
    
    // Agrupar por Empresa â†’ Ãrea/Equipamento â†’ Componente
    const grupos = agruparOTsPorHierarquia(ots);
    
    let html = '<table class="relatorio-tabela">';
    
    // CabeÃ§alho da tabela - 8 COLUNAS (+ PLANEADO)
    // ğŸ¯ Larguras otimizadas: +15% para DESCRIÃ‡ÃƒO (roubado de ÃREA/COMP/OT)
    html += `
        <thead>
            <tr>
                <th style="width: 7%;">EMPRESA</th>
                <th style="width: 10%;">ÃREA/EQUIP.</th>
                <th style="width: 10%;">COMPONENTE</th>
                <th style="width: 6%;">OT</th>
                <th style="width: 8%;">PRIORIDADE</th>
                <th style="width: 10%;">RESPONSÃVEL</th>
                <th style="width: 7%;">PLANEADO</th>
                <th style="width: 42%;">DESCRIÃ‡ÃƒO</th>
            </tr>
        </thead>
        <tbody>
    `;
    
    // Iterar por empresas
    Object.keys(grupos).sort().forEach(empresa => {
        const areas = grupos[empresa];
        
        // ğŸ“Š CABEÃ‡ALHO DE EMPRESA (como no PDF)
        html += `
            <tr class="relatorio-grupo-header">
                <td colspan="8" style="background-color: #E8E8E8; font-weight: bold; padding: 8px;">
                    ğŸ“Š ${empresa} (${contarOTsEmpresa(areas)} OTs)
                </td>
            </tr>
        `;
        
        // Iterar por Ã¡reas/equipamentos
        Object.keys(areas).sort().forEach(area => {
            const componentes = areas[area];
            
            // ğŸ”§ CABEÃ‡ALHO DE ÃREA (como no PDF)
            html += `
                <tr class="relatorio-area-header">
                    <td colspan="8" style="background-color: #F3F4F6; font-weight: 600; padding: 6px;">
                        ğŸ”§ ${area} (${contarOTsArea(componentes)} OTs)
                    </td>
                </tr>
            `;
            
            // Iterar por componentes
            Object.keys(componentes).sort().forEach(componente => {
                const otsDoComponente = componentes[componente];
                
                // Ordenar OTs por prioridade
                const prioridadeOrdem = { 'Alta': 1, 'MÃ©dia': 2, 'Baixa': 3 };
                otsDoComponente.sort((a, b) => {
                    const prioA = prioridadeOrdem[a.prioridade] || 4;
                    const prioB = prioridadeOrdem[b.prioridade] || 4;
                    return prioA - prioB;
                });
                
                // Linhas de OTs
                otsDoComponente.forEach((ot, idx) => {
                    const task = AppState.planning.tasks[ot.id];
                    const responsavel = task?.responsavel || ot.responsavel || '';
                    const segundoResponsavel = task?.segundoResponsavel || ot.segundoResponsavel || '';
                    
                    // ğŸ†• v3.8.3.10.27.46: Formatar responsÃ¡veis (1Âº | 2Âº)
                    let responsavelDisplay = responsavel;
                    if (segundoResponsavel) {
                        responsavelDisplay = `${responsavel} | ${segundoResponsavel}`;
                    }
                    
                    // Prioridade
                    let prioridadeDisplay = ot.prioridade || '';
                    if (ot.tipo === 'Preventiva') {
                        prioridadeDisplay = ot.frequencia || 'Preventiva';
                    } else if (!prioridadeDisplay) {
                        prioridadeDisplay = 'MÃ©dia';
                    }
                    
                    // ğŸ¯ Verificar se estÃ¡ planeado
                    const planningData = AppState.planning.tasks[ot.id];
                    const diasAlocados = planningData?.diasAlocados || [];
                    const estÃ¡Planeado = diasAlocados.length > 0;
                    const planeadoDisplay = estÃ¡Planeado ? 'âœ… Sim' : 'âŒ NÃ£o';
                    
                    // Linha da OT (8 colunas) - ğŸ¯ TODAS CENTRALIZADAS exceto DESCRIÃ‡ÃƒO
                    // ğŸ¯ EMPRESA, ÃREA e COMPONENTE em TODAS as linhas (nÃ£o sÃ³ idx=0)
                    html += `
                        <tr class="relatorio-item-row">
                            <td style="text-align: center;">${empresa}</td>
                            <td style="text-align: center;">${area}</td>
                            <td style="text-align: center;">${componente}</td>
                            <td style="text-align: center; font-family: monospace; font-weight: 600;">${ot.id}</td>
                            <td style="text-align: center; text-transform: uppercase;">${prioridadeDisplay}</td>
                            <td style="text-align: center;">${responsavelDisplay}</td>
                            <td style="text-align: center; font-weight: 600;">${planeadoDisplay}</td>
                            <td style="text-align: left;">${ot.descricao || ''}</td>
                        </tr>
                    `;
                });
            });
        });
    });
    
    html += '</tbody></table>';
    
    // Adicionar cabeÃ§alho para impressÃ£o (como no PDF)
    const headerHTML = `
        <div id="relatorioHeader" style="text-align: center; margin-bottom: 20px; display: none;">
            <h1 style="color: #1E3A8A; margin: 0 0 10px 0; font-size: 16pt;">ğŸ“‹ RELATÃ“RIO DE ORDENS DE TRABALHO</h1>
            <p style="margin: 5px 0; color: #4B5563; font-size: 10pt;">
                <strong>Empresa:</strong> MCF + PSY | 
                <strong>Data:</strong> ${new Date().toLocaleDateString('pt-PT')} | 
                <strong>Total de OTs:</strong> ${ots.length} OTs
            </p>
            <p style="margin: 5px 0 15px 0; color: #4B5563; font-size: 10pt;">
                <strong>Filtros:</strong> ${gerarTextoFiltros()}
            </p>
        </div>
    `;
    
    container.innerHTML = headerHTML + html;
    console.log('âœ… RelatÃ³rio gerado:', {
        totalOTs: ots.length,
        totalEmpresas: Object.keys(grupos).length,
        htmlLength: html.length
    });
}

function agruparOTsPorHierarquia(ots) {
    const grupos = {};
    
    ots.forEach(ot => {
        const empresa = ot.empresa || 'MCF';
        const area = ot.areaEquipamento || 'Sem Ãrea';
        const componente = ot.componente || 'Sem Componente';
        
        // ğŸ”§ Debug: Logar OTs com dados faltando
        if (!ot.empresa || !ot.areaEquipamento) {
            console.log(`âš ï¸ OT ${ot.id} sem dados completos:`, {
                empresa: ot.empresa,
                areaEquipamento: ot.areaEquipamento,
                componente: ot.componente
            });
        }
        
        if (!grupos[empresa]) grupos[empresa] = {};
        if (!grupos[empresa][area]) grupos[empresa][area] = {};
        if (!grupos[empresa][area][componente]) grupos[empresa][area][componente] = [];
        
        grupos[empresa][area][componente].push(ot);
    });
    
    return grupos;
}

function contarOTsEmpresa(areas) {
    let total = 0;
    Object.values(areas).forEach(componentes => {
        Object.values(componentes).forEach(ots => {
            total += ots.length;
        });
    });
    return total;
}

function contarOTsArea(componentes) {
    let total = 0;
    Object.values(componentes).forEach(ots => {
        total += ots.length;
    });
    return total;
}

function copiarTabelaRelatorio() {
    const tabela = document.querySelector('.relatorio-tabela');
    if (!tabela) return;
    
    // Extrair dados da tabela
    let texto = '';
    const rows = tabela.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        if (row.classList.contains('relatorio-grupo-header') || row.classList.contains('relatorio-subgrupo-header')) {
            texto += '\n' + row.textContent.trim() + '\n';
        } else {
            const cells = row.querySelectorAll('td');
            const linha = Array.from(cells).map(cell => cell.textContent.trim()).join('\t');
            texto += linha + '\n';
        }
    });
    
    // Copiar para clipboard
    navigator.clipboard.writeText(texto).then(() => {
        showToast('âœ… Tabela copiada para a Ã¡rea de transferÃªncia!', 'success');
    }).catch(err => {
        console.error('Erro ao copiar:', err);
        showToast('âŒ Erro ao copiar tabela', 'error');
    });
}

function exportarRelatorioCSV() {
    applyFilters();
    const ots = AppState.filteredRequests;
    
    // CabeÃ§alho CSV
    let csv = 'EMPRESA,ÃREA/EQUIP.,COMPONENTE,OT,PRIORIDADE,RESPONSÃVEL,DESCRIÃ‡ÃƒO\n';
    
    // Dados
    ots.forEach(ot => {
        const empresa = ot.empresa || 'MCF';
        const area = (ot.areaEquipamento || '').replace(/,/g, ';');
        const componente = (ot.componente || '').replace(/,/g, ';');
        const id = ot.id;
        const prioridade = ot.prioridade || 'MÃ©dia';
        const task = AppState.planning.tasks[ot.id];
        const responsavel = (task?.responsavel || ot.responsavel || '-').replace(/,/g, ';');
        const descricao = (ot.descricao || '').replace(/,/g, ';').replace(/\n/g, ' ');
        
        csv += `"${empresa}","${area}","${componente}","${id}","${prioridade}","${responsavel}","${descricao}"\n`;
    });
    
    // Download
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    const dataAtual = new Date().toISOString().split('T')[0];
    
    link.setAttribute('href', url);
    link.setAttribute('download', `relatorio-ots-${dataAtual}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('âœ… CSV exportado com sucesso!', 'success');
}

async function exportarRelatorioImagem() {
    showToast('ğŸ“¸ Gerando imagem do relatÃ³rio completo...', 'info');
    
    try {
        // Importar html2canvas via CDN se necessÃ¡rio
        if (typeof html2canvas === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
            document.head.appendChild(script);
            
            await new Promise((resolve, reject) => {
                script.onload = resolve;
                script.onerror = reject;
            });
        }
        
        // Mostrar cabeÃ§alho
        const header = document.getElementById('relatorioHeader');
        if (header) header.style.display = 'block';
        
        // Criar container temporÃ¡rio com cabeÃ§alho + conteÃºdo
        const tempContainer = document.createElement('div');
        tempContainer.style.backgroundColor = 'white';
        tempContainer.style.padding = '20px';
        tempContainer.style.width = '1200px'; // Largura fixa para melhor qualidade
        
        // Copiar cabeÃ§alho
        if (header) {
            const headerClone = header.cloneNode(true);
            headerClone.style.display = 'block';
            headerClone.style.marginBottom = '20px';
            tempContainer.appendChild(headerClone);
        }
        
        // Copiar tabela
        const container = document.getElementById('relatorioContainer');
        const containerClone = container.cloneNode(true);
        tempContainer.appendChild(containerClone);
        
        // Adicionar ao body temporariamente
        tempContainer.style.position = 'absolute';
        tempContainer.style.left = '-9999px';
        tempContainer.style.top = '0';
        document.body.appendChild(tempContainer);
        
        // Capturar como imagem
        const canvas = await html2canvas(tempContainer, {
            backgroundColor: '#ffffff',
            scale: 2,
            logging: false,
            useCORS: true,
            windowWidth: 1200
        });
        
        // Remover container temporÃ¡rio
        document.body.removeChild(tempContainer);
        
        // Esconder cabeÃ§alho novamente
        if (header) header.style.display = 'none';
        
        // Converter para blob e fazer download
        canvas.toBlob(blob => {
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const dataAtual = new Date().toISOString().split('T')[0];
            
            link.setAttribute('href', url);
            link.setAttribute('download', `relatorio-ots-${dataAtual}.png`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('âœ… Imagem gerada! Abra-a e use Ctrl+P para imprimir.', 'success');
        });
    } catch (error) {
        console.error('Erro ao exportar imagem:', error);
        showToast('âŒ Erro ao gerar imagem', 'error');
    }
}

function imprimirRelatorio() {
    try {
        console.log('Impressao iniciada');
        const header = document.getElementById('relatorioHeader');
        if (header) header.style.display = 'block';
        setTimeout(function() {
            window.print();
            setTimeout(function() {
                if (header) header.style.display = 'none';
            }, 500);
        }, 100);
    } catch (error) {
        console.error('Erro impressao:', error);
        alert('Erro ao imprimir');
    }
}

// âœ… v3.7.0.9: NOVO - Popular filtro de ResponsÃ¡vel
function populateResponsavelFilter() {
    const select = document.getElementById('filterResponsavel');
    if (!select) {
        console.warn('âŒ Elemento #filterResponsavel nÃ£o encontrado');
        return;
    }
    
    console.log('ğŸ”„ Populando filtro de responsÃ¡vel...');
    console.log('ğŸ“Š AppState.currentFilters.estado:', AppState.currentFilters.estado);
    
    // ğŸš¨ FIX: Se filtros vazios, ler dos checkboxes
    if (AppState.currentFilters.estado.length === 0) {
        document.querySelectorAll('.filter-estado:checked').forEach(cb => {
            AppState.currentFilters.estado.push(cb.value);
        });
        console.log('ğŸ“Š Filtros lidos dos checkboxes:', AppState.currentFilters.estado);
    }
    
    // Limpar opÃ§Ãµes existentes
    select.innerHTML = '<option value="">Todos os responsÃ¡veis</option>';
    
    // ğŸ†• v3.7.7.0: Buscar responsÃ¡veis da tabela utilizadores (jÃ¡ vÃªm ATIVOS!)
    if (AppState.utilizadores && AppState.utilizadores.length > 0) {
        // Utilizadores carregados
        
        // Detectar nome correto do campo
        const primeiroUser = AppState.utilizadores[0];
        const nomeCompletoKey = Object.keys(primeiroUser).find(k => k.toLowerCase().replace(/[_\s]/g, '') === 'nomecompleto') || 'nomeCompleto';
        
        // ğŸ”¥ NÃƒO FILTRAR! A funÃ§Ã£o SQL jÃ¡ retorna sÃ³ os ativos!
        AppState.utilizadores
            .sort((a, b) => (a[nomeCompletoKey] || '').localeCompare(b[nomeCompletoKey] || ''))
            .forEach(user => {
                // ğŸš¨ FIX: Contar APENAS pedidos que passam nos filtros ativos
                const nomeCompleto = user[nomeCompletoKey];
                const allTasksForUser = AppState.requests.filter(r => {
                    const task = AppState.planning.tasks[r.id];
                    return task?.responsavel === nomeCompleto;
                });
                const count = allTasksForUser.filter(r => {
                    // âœ… Aplicar MESMOS filtros de estado que na lista
                    const estadoPedido = (r.estado || '').trim();
                    const passaEstado = AppState.currentFilters.estado.length === 0 || 
                                       AppState.currentFilters.estado.includes(estadoPedido);
                    
                    if (!passaEstado) {
                        console.log(`   âŒ OT ${r.id} do ${nomeCompleto}: estado="${estadoPedido}" NÃƒO passa (filtros: ${AppState.currentFilters.estado.join(', ')})`);
                    }
                    
                    return passaEstado;
                }).length;
                
                if (allTasksForUser.length > 0) {
                    console.log(`ğŸ‘¤ ${nomeCompleto}: ${allTasksForUser.length} total â†’ ${count} visÃ­veis apÃ³s filtro de estado`);
                }
                
                const option = document.createElement('option');
                option.value = nomeCompleto;
                option.textContent = count > 0 ? `${nomeCompleto} (${count})` : nomeCompleto;
                select.appendChild(option);
            });
        
        // Filtro populado
    } else {
        // Fallback: buscar do planeamento (como antes)
        console.log('âš ï¸ Utilizadores nÃ£o carregados, usando responsÃ¡veis do planeamento');
        const responsaveis = new Set();
        AppState.requests.forEach(request => {
            const task = AppState.planning.tasks[request.id];
            const resp = (task?.responsavel || '').trim();
            if (resp && resp !== '') {
                responsaveis.add(resp);
            }
        });
        
        Array.from(responsaveis).sort().forEach(responsavel => {
            // ğŸš¨ FIX: Contar APENAS pedidos que passam nos filtros ativos
            const allTasksForUser = AppState.requests.filter(r => {
                const task = AppState.planning.tasks[r.id];
                return task?.responsavel === responsavel;
            });
            const count = allTasksForUser.filter(r => {
                // âœ… Aplicar MESMOS filtros de estado que na lista
                const estadoPedido = (r.estado || '').trim();
                const passaEstado = AppState.currentFilters.estado.length === 0 || 
                                   AppState.currentFilters.estado.includes(estadoPedido);
                
                if (!passaEstado) {
                    console.log(`   âŒ OT ${r.id} do ${responsavel}: estado="${estadoPedido}" NÃƒO passa (filtros: ${AppState.currentFilters.estado.join(', ')})`);
                }
                
                return passaEstado;
            }).length;
            
            if (allTasksForUser.length > 0) {
                console.log(`ğŸ‘¤ ${responsavel}: ${allTasksForUser.length} total â†’ ${count} visÃ­veis apÃ³s filtro de estado`);
            }
            
            const option = document.createElement('option');
            option.value = responsavel;
            option.textContent = `${responsavel} (${count})`;
            select.appendChild(option);
        });
    }
}

// âœ… v3.7.0.9: Popular filtros do planeamento
function populatePlanningFilters() {
    // Popular dropdown de Equipamento
    const planningFilterEquipamento = document.getElementById('planningFilterEquipamento');
    if (planningFilterEquipamento) {
        const areasUnicas = [...new Set(AppState.equipamentos.map(e => e.area))].sort();
        planningFilterEquipamento.innerHTML = '<option value="">Todos os equipamentos</option>';
        areasUnicas.forEach(area => {
            const option = document.createElement('option');
            option.value = area;
            option.textContent = area;
            planningFilterEquipamento.appendChild(option);
        });
    }
    
    // Popular dropdown de ResponsÃ¡vel
    const planningFilterResponsavel = document.getElementById('planningFilterResponsavel');
    if (planningFilterResponsavel) {
        planningFilterResponsavel.innerHTML = '<option value="">Todos os responsÃ¡veis</option>';
        
        // ğŸ†• v3.8.3.10: Usar tabela utilizadores (igual ao filtro principal)
        if (AppState.utilizadores && AppState.utilizadores.length > 0) {
            // Detectar nome correto do campo
            const primeiroUser = AppState.utilizadores[0];
            const nomeCompletoKey = Object.keys(primeiroUser).find(k => k.toLowerCase().replace(/[_\s]/g, '') === 'nomecompleto') || 'nomeCompleto';
            
            // Utilizadores ativos da BD
            AppState.utilizadores
                .sort((a, b) => (a[nomeCompletoKey] || '').localeCompare(b[nomeCompletoKey] || ''))
                .forEach(user => {
                    // ğŸš¨ FIX v3.8.3.10.27.17: Contar APENAS pedidos que passam nos filtros de estado do Planeamento
                    const nomeCompleto = user[nomeCompletoKey];
                    
                    // Obter filtros ativos do Planeamento (checkboxes marcados)
                    const estadosFiltrados = Array.from(document.querySelectorAll('.planning-filter-estado:checked'))
                        .map(cb => cb.value);
                    
                    const count = AppState.requests.filter(r => {
                        const task = AppState.planning.tasks[r.id];
                        if (task?.responsavel !== nomeCompleto) return false;
                        
                        // âœ… Aplicar filtro de estado (igual Ã  lista de OTs)
                        const estadoPedido = (r.estado || '').trim();
                        const passaEstado = estadosFiltrados.length === 0 || estadosFiltrados.includes(estadoPedido);
                        
                        return passaEstado;
                    }).length;
                    
                    const option = document.createElement('option');
                    option.value = nomeCompleto;
                    option.textContent = count > 0 ? `${nomeCompleto} (${count})` : nomeCompleto;
                    planningFilterResponsavel.appendChild(option);
                });
        } else {
            // Fallback: buscar do planeamento (responsÃ¡veis que jÃ¡ tÃªm tarefas)
            console.warn('âš ï¸ Utilizadores nÃ£o carregados no filtro de planeamento');
            const responsaveis = new Set();
            AppState.requests.forEach(request => {
                const task = AppState.planning.tasks[request.id];
                const resp = (task?.responsavel || '').trim();
                if (resp && resp !== '') {
                    responsaveis.add(resp);
                }
            });
            
            Array.from(responsaveis).sort().forEach(responsavel => {
                // ğŸš¨ FIX v3.8.3.10.27.17: Aplicar filtros de estado (fallback)
                const estadosFiltrados = Array.from(document.querySelectorAll('.planning-filter-estado:checked'))
                    .map(cb => cb.value);
                
                const count = AppState.requests.filter(r => {
                    const task = AppState.planning.tasks[r.id];
                    if (task?.responsavel !== responsavel) return false;
                    
                    // âœ… Aplicar filtro de estado
                    const estadoPedido = (r.estado || '').trim();
                    const passaEstado = estadosFiltrados.length === 0 || estadosFiltrados.includes(estadoPedido);
                    
                    return passaEstado;
                }).length;
                const option = document.createElement('option');
                option.value = responsavel;
                option.textContent = `${responsavel} (${count})`;
                planningFilterResponsavel.appendChild(option);
            });
        }
        
        console.log('âœ… Filtros de Planeamento populados (responsÃ¡veis da BD)');
    }
}

// âœ… v3.7.0.9: Limpar filtros do planeamento
function clearPlanningFiltersFunc() {
    // Marcar todas as checkboxes
    document.querySelectorAll('.planning-filter-tipo, .planning-filter-prioridade, .planning-filter-tipoIntervencao, .planning-filter-empresa').forEach(cb => cb.checked = true);
    
    // Estado: marcar apenas Novo e Em curso
    document.querySelectorAll('.planning-filter-estado').forEach(cb => {
        cb.checked = (cb.value === 'Novo' || cb.value === 'Em curso');
    });
    
    // Desmarcar Especiais
    document.querySelectorAll('.planning-filter-urgente, .planning-filter-paragemProducao, .planning-filter-exigeCompra').forEach(cb => cb.checked = false);
    
    // Limpar dropdowns
    const planningFilterEquipamento = document.getElementById('planningFilterEquipamento');
    if (planningFilterEquipamento) planningFilterEquipamento.value = '';
    
    const planningFilterResponsavel = document.getElementById('planningFilterResponsavel');
    if (planningFilterResponsavel) planningFilterResponsavel.value = '';
    
    // Re-renderizar grid
    renderPlanningGrid();
    showToast('Filtros do planeamento limpos', 'success');
}

function clearFilters() {
    AppState.currentFilters = { tipo: [], prioridade: [], estado: ['Novo', 'Em curso'], empresa: [], tipoIntervencao: [], urgente: [], paragemProducao: [], exigeCompra: [] };
    document.querySelectorAll('.filter-tipo, .filter-prioridade, .filter-estado, .filter-empresa, .filter-tipoIntervencao, .filter-urgente, .filter-paragemProducao, .filter-exigeCompra').forEach(checkbox => checkbox.checked = false);
    document.querySelectorAll('.filter-estado').forEach(checkbox => {
        if (checkbox.value === 'Novo' || checkbox.value === 'Em curso') checkbox.checked = true;
    });
    
    // âš¡ NOVO: Limpar filtros de equipamento e responsÃ¡vel
    const filterEquipamento = document.getElementById('filterEquipamento');
    if (filterEquipamento) {
        filterEquipamento.value = '';
    }
    
    const filterResponsavel = document.getElementById('filterResponsavel');
    if (filterResponsavel) {
        filterResponsavel.value = '';
    }
    
    renderRequestsList();
}

function toggleSortOrder() {
    AppState.sortOrder = AppState.sortOrder === 'desc' ? 'asc' : 'desc';
    AppState.groupMode = false; // Desativar modo grupo
    renderRequestsList();
    showToast(`OrdenaÃ§Ã£o: ${AppState.sortOrder === 'desc' ? 'Mais recentes primeiro' : 'Mais antigos primeiro'}`, 'info');
}

function toggleGroupMode() {
    AppState.groupMode = !AppState.groupMode;
    renderRequestsList();
    showToast(AppState.groupMode ? 'ğŸ“Š Agrupado por Hierarquia' : 'ğŸ“… Ordenado por Data', 'info');
}

// DETALHES
function openRequestDetails(id) {
    const request = AppState.requests.find(r => r.id === id);
    if (!request) return;
    
    const modal = document.getElementById('detailsModal');
    const modalBody = document.getElementById('modalBody');
    
    let html = `
        <div class="detail-group">
            <div class="detail-label">ID da Ordem</div>
            <div class="detail-value">${request.id}</div>
        </div>
        <div class="detail-group">
            <div class="detail-label">Data e Hora</div>
            <div class="detail-value">${formatDateLong(request.dataHora)}</div>
        </div>
        <div class="detail-group">
            <div class="detail-label">Tipo</div>
            <div class="detail-badges"><span class="badge badge-tipo">${request.tipo}</span></div>
        </div>`;
    
    // ğŸ†• Prioridade sÃ³ aparece se NÃƒO for Preventiva
    if (request.tipo !== 'Preventiva') {
        html += `
        <div class="detail-group">
            <div class="detail-label">Prioridade</div>
            <div class="detail-priority-selector">
                <label class="priority-option-inline ${request.prioridade === 'Alta' ? 'active' : ''}" onclick="changePriority('${request.id}', 'Alta')">
                    <input type="radio" name="priority-${request.id}" value="Alta" ${request.prioridade === 'Alta' ? 'checked' : ''}>
                    <span class="priority-badge priority-alta">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
                            <path d="M12 2L2 12h3v8h14v-8h3L12 2z"/>
                        </svg>
                        Alta
                    </span>
                </label>
                <label class="priority-option-inline ${request.prioridade === 'MÃ©dia' ? 'active' : ''}" onclick="changePriority('${request.id}', 'MÃ©dia')">
                    <input type="radio" name="priority-${request.id}" value="MÃ©dia" ${request.prioridade === 'MÃ©dia' ? 'checked' : ''}>
                    <span class="priority-badge priority-media">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
                            <circle cx="12" cy="12" r="10"/>
                        </svg>
                        MÃ©dia
                    </span>
                </label>
                <label class="priority-option-inline ${request.prioridade === 'Baixa' ? 'active' : ''}" onclick="changePriority('${request.id}', 'Baixa')">
                    <input type="radio" name="priority-${request.id}" value="Baixa" ${request.prioridade === 'Baixa' ? 'checked' : ''}>
                    <span class="priority-badge priority-baixa">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
                            <path d="M12 22L22 12h-3V4H5v8H2l10 10z"/>
                        </svg>
                        Baixa
                    </span>
                </label>
            </div>
        </div>`;
    }
    
    html += `
        <div class="detail-group">
            <div class="detail-label">Estado</div>
            <div class="detail-badges"><span class="badge badge-estado ${(request.estado || 'Novo').toLowerCase().replace(' ', '')}">${request.estado || 'Novo'}</span></div>
        </div>
        <div class="detail-group">
            <div class="detail-label">Empresa</div>
            <div class="detail-value">${request.empresa || 'MCF'}</div>
        </div>`;
    
    // âœ… v3.7.0.8: Mostrar FrequÃªncia e Data PrÃ³xima IntervenÃ§Ã£o para Preventivas
    if (request.tipo === 'Preventiva') {
        if (request.frequencia && request.frequencia !== '-') {
            html += `
        <div class="detail-group">
            <div class="detail-label">FrequÃªncia</div>
            <div class="detail-value"><strong>${request.frequencia}</strong></div>
        </div>`;
        }
        
        if (request.dataPrimeiraIntervencao) {
            const proximaData = calcularProximaIntervencao(request.dataPrimeiraIntervencao, request.frequencia);
            if (proximaData) {
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                const diasRestantes = Math.ceil((proximaData - hoje) / (1000 * 60 * 60 * 24));
                
                let indicador = '';
                if (diasRestantes === 0) indicador = '<span style="color: #2ecc71; font-weight: bold;">ğŸ“… HOJE</span>';
                else if (diasRestantes > 0) indicador = `<span style="color: #f39c12; font-weight: bold;">âš¡ Em ${diasRestantes} dias</span>`;
                else indicador = `<span style="color: #e74c3c; font-weight: bold;">âš ï¸ Atrasada ${Math.abs(diasRestantes)} dias</span>`;
                
                html += `
        <div class="detail-group">
            <div class="detail-label">Data 1Âª IntervenÃ§Ã£o</div>
            <div class="detail-value">${new Date(request.dataPrimeiraIntervencao).toLocaleDateString('pt-PT')}</div>
        </div>
        <div class="detail-group">
            <div class="detail-label">PrÃ³xima IntervenÃ§Ã£o</div>
            <div class="detail-value">
                <strong>${proximaData.toLocaleDateString('pt-PT')}</strong>
                <br>${indicador}
            </div>
        </div>`;
            }
        }
    }
    
    // Tipo de IntervenÃ§Ã£o
    if (request.tipoIntervencao && request.tipoIntervencao !== '-') {
        html += `
        <div class="detail-group">
            <div class="detail-label">Tipo de IntervenÃ§Ã£o</div>
            <div class="detail-value">${request.tipoIntervencao}</div>
        </div>`;
    }
    
    // âš¡ NOVO: Ãrea/Equipamento
    if (request.areaEquipamento && request.areaEquipamento !== '-') {
        html += `
        <div class="detail-group">
            <div class="detail-label">Ãrea/Equipamento</div>
            <div class="detail-value"><strong>${request.areaEquipamento}</strong></div>
        </div>`;
    }
    
    // âš¡ NOVO: Componente
    if (request.componente && request.componente !== '-') {
        html += `
        <div class="detail-group">
            <div class="detail-label">Componente</div>
            <div class="detail-value">${request.componente}</div>
        </div>`;
    }
    
    // Urgente e Paragem ProduÃ§Ã£o
    if (request.urgente || request.paragemProducao || request.exigeCompra) {
        html += `<div class="detail-group"><div class="detail-label">Especiais</div><div class="detail-badges">`;
        if (request.urgente) html += `<span class="badge" style="background: #ff4757; color: white;">ğŸ”´ Urgente</span>`;
        if (request.paragemProducao) html += `<span class="badge" style="background: #ffa502; color: white;">âš ï¸ Paragem ProduÃ§Ã£o</span>`;
        if (request.exigeCompra) html += `<span class="badge" style="background: #3498db; color: white;">ğŸ›’ Exige compra material</span>`;
        html += `</div></div>`;
    }
    
    if (request.departamento !== '-') {
        html += `
        <div class="detail-group">
            <div class="detail-label">Departamento</div>
            <div class="detail-value">${request.departamento}</div>
        </div>`;
    }
    
    html += `
        <div class="detail-group">
            <div class="detail-label">DescriÃ§Ã£o</div>
            <div class="detail-value">${request.descricao}</div>
        </div>
        <div class="detail-group">
            <div class="detail-label">Registado por</div>
            <div class="detail-value">${request.nome}</div>
        </div>`;
    
    // ğŸ“¸ v3.8.3.10.22: ANEXO (INICIAL) - Imagem ou PDF
    if (request.foto) {
        const fotoSrc = request.foto.startsWith('http') || request.foto.startsWith('data:') 
            ? request.foto 
            : window.SupabaseAPI.getFotoUrl(request.id);
        
        // ğŸ†• v3.8.3.10.22: Verificar se Ã© PDF pela extensÃ£o
        const isPDF = fotoSrc.toLowerCase().endsWith('.pdf');
        
        if (isPDF) {
            // Renderizar como link para PDF
            html += `
            <div class="detail-group">
                <div class="detail-label">ğŸ“„ Anexo (inicial)</div>
                <div class="detail-value">
                    <a href="${fotoSrc}" target="_blank" style="display: inline-flex; align-items: center; gap: 10px; padding: 12px 16px; background: #f5f5f5; border: 2px solid #e0e0e0; border-radius: 8px; text-decoration: none; color: #333; transition: all 0.2s;">
                        <svg style="width: 32px; height: 32px; color: #d32f2f;" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M10,19L12,15H9V10H15V15L13,19H10Z"/>
                        </svg>
                        <div>
                            <div style="font-weight: 600; font-size: 14px;">ğŸ“„ Documento PDF</div>
                            <div style="font-size: 12px; color: #666; margin-top: 2px;">Clique para abrir</div>
                        </div>
                    </a>
                </div>
            </div>`;
        } else {
            // Renderizar como imagem
            html += `
            <div class="detail-group">
                <div class="detail-label">ğŸ“¸ Fotografia (inicial)</div>
                <div class="detail-value">
                    <img src="${fotoSrc}" 
                         alt="Foto da ordem de trabalho" 
                         class="detail-image"
                         style="max-width: 100%; max-height: 500px; border-radius: 8px; margin-top: 8px; display: block; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                         onerror="this.style.display='none'; this.parentElement.innerHTML='<p style=color:red>âš ï¸ Foto nÃ£o disponÃ­vel</p>'">
                </div>
            </div>`;
        }
    }
    
    // ğŸ†• v3.8.3.0: OBSERVAÃ‡Ã•ES DE FECHO (editÃ¡vel)
    html += `
        <div class="detail-group" style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-top: 12px;">
            <div class="detail-label" style="margin-bottom: 8px;">ğŸ“ ObservaÃ§Ãµes de Fecho</div>
            <textarea 
                id="observacoesFecho" 
                class="form-input" 
                style="min-height: 80px; font-family: inherit; width: 100%; padding: 12px; border: 1px solid #dee2e6; border-radius: 6px; resize: vertical;"
                placeholder="Adicione observaÃ§Ãµes sobre o fecho desta OT...">${request.observacoesFecho || ''}</textarea>
            <button 
                class="btn btn-sm btn-secondary" 
                onclick="guardarObservacoesFecho('${request.id}')"
                style="margin-top: 8px; background: #3498db; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                ğŸ’¾ Guardar ObservaÃ§Ãµes
            </button>
        </div>`;
    
    // ğŸ†• v3.8.3.0: FOTO DE FECHO (upload)
    html += `
        <div class="detail-group" style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-top: 12px;">
            <div class="detail-label" style="margin-bottom: 8px;">ğŸ“¸ Foto de Fecho</div>`;
    
    if (request.fotoFecho) {
        html += `
            <img src="${request.fotoFecho}" 
                 alt="Foto de fecho" 
                 class="detail-image"
                 style="max-width: 100%; max-height: 300px; border-radius: 8px; margin-bottom: 8px; display: block;">
            <button 
                class="btn btn-sm btn-secondary" 
                onclick="removerFotoFecho('${request.id}')"
                style="background: #e74c3c; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                ğŸ—‘ï¸ Remover Foto
            </button>`;
    } else {
        html += `
            <input 
                type="file" 
                id="fotoFechoInput" 
                accept="image/*" 
                style="display: none;"
                onchange="uploadFotoFecho('${request.id}', this.files[0])">
            <button 
                class="btn btn-secondary" 
                onclick="document.getElementById('fotoFechoInput').click()"
                style="background: #27ae60; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                ğŸ“¸ + Adicionar Foto de Fecho
            </button>`;
    }
    
    html += `</div>`;
    
    // ğŸ†• MATERIAIS USADOS (sempre visÃ­vel)
    const materiaisUsados = AppState.movimentos.filter(m => m.pedidoId === request.id);
    if (materiaisUsados.length > 0) {
        let custoTotal = 0;
        html += `
        <div class="detail-group" style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-top: 20px;">
            <div class="detail-label" style="font-size: 16px; margin-bottom: 12px;">ğŸ’° Materiais Usados</div>
            <div style="display: flex; flex-direction: column; gap: 8px;">`;
        
        materiaisUsados.forEach(mov => {
            const artigo = AppState.artigos.find(a => a.id === mov.artigoId);
            if (artigo) {
                const custo = Math.abs(mov.quantidade) * artigo.preco;
                custoTotal += custo;
                const dataFormatada = new Date(mov.dataHora).toLocaleString('pt-PT', {day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'});
                html += `
                <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 4px; border: 1px solid #dee2e6;">
                    <div>
                        <strong>${artigo.designacao}</strong><br>
                        <small style="color: #6c757d;">${Math.abs(mov.quantidade)} ${artigo.unidade || 'un'} Ã— â‚¬${artigo.preco.toFixed(2)} | ${dataFormatada} | ${mov.responsavel}</small>
                    </div>
                    <div style="font-weight: 600; color: #dc3545;">â‚¬${custo.toFixed(2)}</div>
                </div>`;
            }
        });
        
        html += `
            </div>
            <div style="margin-top: 12px; padding-top: 12px; border-top: 2px solid #dee2e6; text-align: right; font-size: 18px; font-weight: 700; color: #dc3545;">
                Total: â‚¬${custoTotal.toFixed(2)}
            </div>
        </div>`;
    }
    
    html += `<div class="modal-actions">`;
    html += `
        <button class="btn btn-secondary" onclick="printRequest('${request.id}');" style="background: #2196F3; color: white;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9V2h12v7M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                <rect x="6" y="14" width="12" height="8"/>
            </svg>
            Imprimir
        </button>
        <button class="btn btn-secondary" onclick="openBaixaMultiplaModal('${request.id}')" style="background: #28a745; color: white;">
            + Movimento
        </button>`;
    if (request.estado !== 'Resolvido') {
        html += `
        <button class="btn btn-primary" onclick="changeRequestState('${request.id}'); closeModal();">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
            </svg>
            ${request.estado === 'Novo' ? 'Iniciar' : 'Marcar como Resolvido'}
        </button>`;
    }
    html += `
        <button class="btn btn-secondary" onclick="deleteRequest('${request.id}'); closeModal();">Eliminar</button>
    </div>`;
    
    modalBody.innerHTML = html;
    modal.classList.add('active');
}

function closeModal() {
    document.getElementById('detailsModal').classList.remove('active');
}

// âœ… v3.7.0.9: Imprimir Ordem de Trabalho (MÃ‰TODO SIMPLES - SEM BLOQUEIOS)
function printRequest(id) {
    const request = AppState.requests.find(r => r.id === id);
    if (!request) {
        alert('Ordem de trabalho nÃ£o encontrada!');
        return;
    }
    
    const container = document.getElementById('printContainer');
    
    // Montar HTML de impressÃ£o
    let html = '<h1>PEDIDO DE MANUTENÃ‡ÃƒO</h1>';
    html += '<div class="print-header">';
    html += '<p><strong>ID:</strong> ' + request.id + '</p>';
    html += '<p><strong>Data:</strong> ' + formatDate(request.dataHora) + '</p>';
    html += '</div>';
    
    html += '<div class="print-section">';
    html += '<h2>InformaÃ§Ãµes Gerais</h2>';
    html += '<table>';
    html += '<tr><td>Tipo:</td><td>' + (request.tipo || '-') + '</td></tr>';
    html += '<tr><td>Prioridade:</td><td>' + (request.prioridade || '-') + '</td></tr>';
    html += '<tr><td>Estado:</td><td>' + (request.estado || '-') + '</td></tr>';
    html += '<tr><td>Empresa:</td><td>' + (request.empresa || 'MCF') + '</td></tr>';
    if (request.areaEquipamento) html += '<tr><td>Ãrea/Equipamento:</td><td>' + request.areaEquipamento + '</td></tr>';
    if (request.componente) html += '<tr><td>Componente:</td><td>' + request.componente + '</td></tr>';
    if (request.departamento) html += '<tr><td>Departamento:</td><td>' + request.departamento + '</td></tr>';
    if (request.responsavel) html += '<tr><td>ResponsÃ¡vel:</td><td>' + request.responsavel + '</td></tr>';
    if (request.horasEstimadas) html += '<tr><td>Horas Estimadas:</td><td>' + request.horasEstimadas + 'h</td></tr>';
    if (request.urgente === 'Sim') html += '<tr><td>Urgente:</td><td>âš ï¸ SIM</td></tr>';
    if (request.paragemProducao === 'Sim') html += '<tr><td>Paragem ProduÃ§Ã£o:</td><td>ğŸ›‘ SIM</td></tr>';
    html += '<tr><td>Registado por:</td><td>' + (request.nome || '-') + '</td></tr>';
    html += '</table>';
    html += '</div>';
    
    html += '<div class="print-section">';
    html += '<h2>DescriÃ§Ã£o</h2>';
    html += '<p class="description">' + (request.descricao || '-').replace(/\n/g, '<br>') + '</p>';
    html += '</div>';
    
    if (request.foto) {
        html += '<div class="print-section photo-section">';
        html += '<h2>Fotografia</h2>';
        html += '<img src="' + request.foto + '" alt="Foto da ordem de trabalho">';
        html += '</div>';
    }
    
    html += '<div class="print-footer">';
    html += '<p><strong>MCF + PSY - Sistema de GestÃ£o de ManutenÃ§Ã£o</strong></p>';
    html += '<p>Impresso em ' + new Date().toLocaleDateString('pt-PT') + ' Ã s ' + new Date().toLocaleTimeString('pt-PT') + '</p>';
    html += '</div>';
    
    container.innerHTML = html;
    
    // Fechar modal e imprimir
    closeModal();
    setTimeout(function() {
        window.print();
        // Limpar apÃ³s impressÃ£o
        setTimeout(function() {
            container.innerHTML = '';
        }, 100);
    }, 300);
}

// AÃ‡Ã•ES
// ğŸ†• v3.8.3.10.27: Registrar execuÃ§Ã£o de preventiva
async function registrarExecucaoPreventiva(id) {
    const request = AppState.requests.find(r => r.id === id);
    if (!request) return;
    
    console.log('ğŸ“ Iniciando registro de execuÃ§Ã£o preventiva:', id);
    
    // Modal para coletar dados da execuÃ§Ã£o
    console.log('ğŸ”¨ Criando modal de execuÃ§Ã£o...');
    showCustomAlert({
        title: 'âœ… Registrar ExecuÃ§Ã£o da Preventiva',
        message: `
            <div style="text-align: left; margin: 20px 0;">
                <p style="margin-bottom: 15px;"><strong>ğŸ“‹ ${request.descricao}</strong></p>
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">
                    ObservaÃ§Ãµes da execuÃ§Ã£o:
                </label>
                <textarea 
                    id="execucaoObservacoes" 
                    style="width: 100%; height: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                    placeholder="Ex: Troca de Ã³leo realizada, filtros limpos..."
                ></textarea>
                
                <label style="display: block; margin: 15px 0 5px; font-weight: 600;">
                    Horas gastas (opcional):
                </label>
                <input 
                    type="number" 
                    id="execucaoHoras" 
                    step="0.5" 
                    min="0"
                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                    placeholder="Ex: 2.5"
                />
                
                <p style="margin-top: 15px; padding: 10px; background: #e8f5e9; border-left: 3px solid #4caf50; font-size: 13px;">
                    â„¹ï¸ A prÃ³xima execuÃ§Ã£o serÃ¡ calculada automaticamente com base na frequÃªncia (${request.frequencia})
                </p>
            </div>
        `,
        icon: 'âœ…',
        buttonText: 'Registrar ExecuÃ§Ã£o',
        secondaryButtonText: 'Cancelar',
        onConfirm: async () => {
            try {
                // ğŸ†• v3.8.3.10.27.2: VerificaÃ§Ã£o defensiva dos elementos
                const observacoesEl = document.getElementById('execucaoObservacoes');
                const horasEl = document.getElementById('execucaoHoras');
                
                if (!observacoesEl || !horasEl) {
                    console.error('âŒ Elementos do modal nÃ£o encontrados!', {
                        observacoesEl,
                        horasEl,
                        modalExists: !!document.querySelector('.custom-alert-overlay')
                    });
                    showToast('âŒ Erro: Elementos do formulÃ¡rio nÃ£o encontrados', 'error');
                    return false;
                }
                
                const observacoes = observacoesEl.value;
                const horasGastas = parseFloat(horasEl.value) || 0;
                
                if (!observacoes.trim()) {
                    showToast('âš ï¸ Por favor, adicione observaÃ§Ãµes sobre a execuÃ§Ã£o', 'warning');
                    return false; // ğŸ†• v3.8.3.10.27: Retornar false para nÃ£o fechar o modal
                }
                
                // Registrar execuÃ§Ã£o no Supabase
                const execucao = await window.SupabaseAPI.addExecucaoPreventiva(id, {
                    responsavel: AppState.currentUser?.nomeCompleto || request.responsavel || 'Desconhecido',
                    observacoes: observacoes.trim(),
                    horasGastas: horasGastas,
                    custoMateriais: 0 // Pode ser preenchido depois
                });
                
                console.log('âœ… ExecuÃ§Ã£o registrada:', execucao);
                
                // Atualizar prÃ³xima execuÃ§Ã£o
                const proximaData = await window.SupabaseAPI.atualizarProximaExecucao(
                    id, 
                    request.frequencia, 
                    request.dataPrimeiraIntervencao
                );
                
                console.log('âœ… PrÃ³xima execuÃ§Ã£o calculada:', proximaData);
                
                // Atualizar request local
                request.ultimaExecucao = new Date().toISOString();
                request.proximaExecucao = proximaData;
                request.totalExecucoes = (request.totalExecucoes || 0) + 1;
                
                // Recarregar dados do Supabase para garantir sincronizaÃ§Ã£o
                await loadDataFromSupabase();
                
                // Atualizar interface
                renderRequestsList();
                
                showToast(`âœ… ExecuÃ§Ã£o registrada! PrÃ³xima em: ${formatDateShort(new Date(proximaData))}`, 'success');
                
                // Reabrir modal para mostrar histÃ³rico atualizado
                setTimeout(() => openRequestDetails(id), 500);
                
            } catch (error) {
                console.error('âŒ Erro ao registrar execuÃ§Ã£o:', error);
                showToast('âŒ Erro ao registrar execuÃ§Ã£o: ' + error.message, 'error');
            }
        }
    });
}

async function changeRequestState(id) {
    const request = AppState.requests.find(r => r.id === id);
    if (!request) return;
    
    const stateTransitions = { 'Novo': 'Em curso', 'Em curso': 'Resolvido', 'Resolvido': 'Resolvido' };
    const newState = stateTransitions[request.estado];
    
    // âœ… v3.7.0.9: Registar responsÃ¡vel ao iniciar pedido
    if (newState === 'Em curso' && request.estado === 'Novo') {
        if (AppState.currentUser && !request.responsavel) {
            request.responsavel = AppState.currentUser.nomeCompleto;
            console.log('âœ… [INICIAR] ResponsÃ¡vel registado:', request.responsavel);
        } else {
            console.log('â­ï¸ [INICIAR] JÃ¡ tem responsÃ¡vel:', request.responsavel);
        }
    }
    
    // ğŸ†• v3.8.3.10.27: PREVENTIVAS nÃ£o fecham - registram execuÃ§Ã£o!
    if (newState === 'Resolvido' && request.estado !== 'Resolvido') {
        
        // ğŸ”„ Se for PREVENTIVA, registrar execuÃ§Ã£o em vez de fechar
        if (request.tipo === 'Preventiva') {
            registrarExecucaoPreventiva(id);
            return; // NÃ£o fecha a OT
        }
        
        // ğŸ†• v3.7.6.9: Registar quem fechou a OT (Corretivas/Melhorias)
        if (AppState.currentUser) {
            request.fechadoPor = AppState.currentUser.nomeCompleto;  // Display
            request.fechadoPorUsername = AppState.currentUser.username;  // ğŸ†• v3.7.7.0: FK
            console.log('âœ… [FECHAR] OT fechada por:', request.fechadoPor, '(', request.fechadoPorUsername, ')');
            console.log('ğŸ“‹ [FECHAR] ResponsÃ¡vel atual:', request.responsavel);
            console.log('ğŸ“‹ [FECHAR] Estado do request:', {
                id: request.id,
                responsavel: request.responsavel,
                fechadoPor: request.fechadoPor,
                fechadoPorUsername: request.fechadoPorUsername,
                estado: request.estado
            });
        }
        
        // ğŸ†• v3.8.3.8.2: Confirmar fecho de OT (permite voltar atrÃ¡s)
        showCustomAlert({
            title: 'âš ï¸ Fechar Ordem de Trabalho?',
            message: 'ğŸ’¡ NÃ£o esquecer de registar os consumos de materiais na aba Stocks!',
            icon: 'ğŸ“¦',
            buttonText: 'Continuar',
            secondaryButtonText: 'Voltar',
            onConfirm: () => {
                // SÃ³ fecha se confirmar
                request.estado = newState;
                saveToLocalStorage();
                if (AppState.isOnline) updateInGoogleSheets(request);  // ğŸ”¥ Nome legacy, usa Supabase
                renderRequestsList();
                showToast('âœ… Ordem de Trabalho Fechada', 'success');
            }
            // Se clicar "Voltar", nÃ£o faz nada (OT permanece aberta)
        });
    } else {
        // Estados normais (Novo â†’ Em curso)
        request.estado = newState;
        saveToLocalStorage();
        if (AppState.isOnline) await updateInGoogleSheets(request);  // ğŸ”¥ Nome legacy, usa Supabase
        renderRequestsList();
        showToast(`Estado alterado para: ${newState}`, 'success');
    }
}

async function deleteRequest(id) {
    if (!confirm('Tem a certeza que deseja eliminar esta ordem de trabalho?')) return;
    const index = AppState.requests.findIndex(r => r.id === id);
    if (index === -1) return;
    AppState.requests.splice(index, 1);
    saveToLocalStorage();
    if (AppState.isOnline) await deleteFromGoogleSheets(id);  // ğŸ”¥ Nome legacy, usa Supabase
    renderRequestsList();
    showToast('Ordem de trabalho eliminada com sucesso.', 'success');
}

// âœ… v3.7.0.9: Alterar Prioridade do Pedido
async function changePriority(id, novaPrioridade) {
    console.log(`ğŸ”„ Alterando prioridade da ordem ${id}: ${novaPrioridade}`);
    
    const request = AppState.requests.find(r => r.id === id);
    if (!request) {
        console.error('âŒ Ordem de trabalho nÃ£o encontrada:', id);
        return;
    }
    
    // Se jÃ¡ estÃ¡ na mesma prioridade, nÃ£o fazer nada
    if (request.prioridade === novaPrioridade) {
        console.log('âœ… Prioridade jÃ¡ Ã©', novaPrioridade);
        return;
    }
    
    const prioridadeAnterior = request.prioridade;
    console.log(`ğŸ“ Prioridade anterior: ${prioridadeAnterior} â†’ Nova: ${novaPrioridade}`);
    
    request.prioridade = novaPrioridade;
    
    // Atualizar localStorage
    saveToLocalStorage();
    console.log('âœ… Prioridade atualizada no localStorage');
    
    // Atualizar Supabase
    if (AppState.isOnline) {
        try {
            console.log('ğŸ”„ Atualizando prioridade no Supabase...');
            await updateInGoogleSheets(request);  // ğŸ”¥ Nome legacy, usa Supabase
            console.log('âœ… Prioridade atualizada no Supabase com sucesso!');
            showToast(`âœ… Prioridade alterada: ${prioridadeAnterior} â†’ ${novaPrioridade}`, 'success');
        } catch (error) {
            console.error('âŒ Erro ao atualizar prioridade no Supabase:', error);
            showToast('âŒ Erro ao atualizar prioridade no servidor', 'error');
            // Reverter mudanÃ§a em caso de erro
            request.prioridade = prioridadeAnterior;
            saveToLocalStorage();
            console.log('â†©ï¸ Prioridade revertida devido a erro');
        }
    } else {
        console.log('âš ï¸ App offline - prioridade guardada apenas localmente');
        showToast(`Prioridade alterada: ${prioridadeAnterior} â†’ ${novaPrioridade} (offline)`, 'info');
    }
    
    // Atualizar lista de ordens de trabalho
    renderRequestsList();
    console.log('âœ… Lista de ordens de trabalho atualizada');
    
    // Reabrir modal com dados atualizados
    openRequestDetails(id);
    console.log('âœ… Modal reaberto com dados atualizados');
}

// ===================================
// SINCRONIZAÃ‡ÃƒO COM SUPABASE
// ===================================
// ğŸ”¥ v3.6.8: Migrado para Supabase (funÃ§Ãµes mantÃªm nomes antigos para compatibilidade)
// ğŸ”¥ v3.7.0.8: Adicionados campos Frequencia e Data 1Âª IntervenÃ§Ã£o

async function sendToGoogleSheets(data) {
    try {
        console.log('ğŸ”¥ DEBUG: ID gerado no JavaScript:', data.id);
        
        // Converter formato da app â†’ formato Supabase
        const supabaseData = {
            ID: data.id,
            'Data/hora': data.dataHora,
            Tipo: data.tipo,
            frequencia: data.frequencia || null,  // âœ… v3.7.0.8: null se vazio
            data_primeira_intervencao: data.dataPrimeiraIntervencao || null,  // âœ… v3.7.0.8: null se vazio
            Prioridade: data.prioridade,
            Departamento: data.departamento,
            DescriÃ§Ã£o: data.descricao,
            'Registado por': data.nome,
            Estado: data.estado,
            Foto: data.foto || '',
            Artigos: '[]',
            Empresa: data.empresa,
            'Tipo IntervenÃ§Ã£o': data.tipoIntervencao || '',
            'Ãrea/Equipamento': data.areaEquipamento || '',
            Componente: data.componente || '',
            Urgente: data.urgente ? 'TRUE' : 'FALSE',
            'Paragem ProduÃ§Ã£o': data.paragemProducao ? 'TRUE' : 'FALSE',
            'ResponsÃ¡vel': data.responsavel || '',  // âœ… ADICIONADO (display)
            'Horas Estimadas': data.horasEstimadas || 0,  // âœ… ADICIONADO
            criado_por_username: AppState.currentUser?.username || null,  // ğŸ†• v3.7.7.0: FK
            responsavel_username: data.responsavelUsername || null,  // ğŸ†• v3.8.1.2: FK
            segundo_responsavel: data.segundoResponsavel || null,  // ğŸ†• v3.8.3.10.27.46: 2Âº ResponsÃ¡vel
            segundo_responsavel_username: data.segundoResponsavelUsername || null,  // ğŸ†• v3.8.3.10.27.46: FK
            fechado_por_username: null,  // ğŸ†• v3.8.1.2: Preenchido quando fechar
            numero_horas: data.numeroHoras || null,  // ğŸ†• v3.8.3.10.27.42: RevisÃµes
            tipos_revisao: data.tiposRevisao || null  // ğŸ†• v3.8.3.10.27.42: RevisÃµes
        };
        
        console.log('ğŸ”¥ DEBUG: Dados enviados para Supabase:', JSON.stringify(supabaseData, null, 2));
        
        const result = await window.SupabaseAPI.addPedido(supabaseData);
        console.log('âœ… Pedido guardado no Supabase');
        console.log('ğŸ”¥ DEBUG: Resposta do Supabase:', result);
        
    } catch (error) {
        console.error('âŒ Erro ao enviar para Supabase:', error);
        addToOfflineQueue(data);
        throw error;
    }
}

async function updateInGoogleSheets(data) {
    try {
        console.log('ğŸ“¤ Preparando atualizaÃ§Ã£o no Supabase para pedido:', data.id);
        
        // ğŸ†• v3.8.3.10.27.46: Buscar 2Âº ResponsÃ¡vel do planeamento
        const planningData = AppState.planning.tasks[data.id];
        if (planningData && planningData.segundoResponsavel) {
            data.segundoResponsavel = planningData.segundoResponsavel;
            // TODO: Se quiser, pode buscar o username na lista de utilizadores
            data.segundoResponsavelUsername = planningData.segundoResponsavel; // Por agora, usar o nome
        }
        
        // Converter formato da app â†’ formato Supabase
        const supabaseData = {
            'Data/hora': data.dataHora,
            Tipo: data.tipo,
            frequencia: data.frequencia || null,  // âœ… v3.7.0.8: null se vazio
            data_primeira_intervencao: data.dataPrimeiraIntervencao || null,  // âœ… v3.7.0.8: null se vazio
            Prioridade: data.prioridade,
            Departamento: data.departamento,
            DescriÃ§Ã£o: data.descricao,
            'Registado por': data.nome,
            Estado: data.estado,
            Foto: data.foto || '',
            Empresa: data.empresa,
            'Tipo IntervenÃ§Ã£o': data.tipoIntervencao || '',
            'Ãrea/Equipamento': data.areaEquipamento || '',
            Componente: data.componente || '',
            Urgente: data.urgente ? 'TRUE' : 'FALSE',
            'Paragem ProduÃ§Ã£o': data.paragemProducao ? 'TRUE' : 'FALSE',
            'ResponsÃ¡vel': data.responsavel || '',  // âœ… ADICIONADO (display)
            responsavel_username: data.responsavelUsername || null,  // ğŸ†• v3.7.7.0: FK
            segundo_responsavel: data.segundoResponsavel || null,  // ğŸ†• v3.8.3.10.27.46: 2Âº ResponsÃ¡vel
            segundo_responsavel_username: data.segundoResponsavelUsername || null,  // ğŸ†• v3.8.3.10.27.46: FK
            'Horas Estimadas': data.horasEstimadas || 0,  // âœ… ADICIONADO
            'Fechado Por': data.fechadoPor || '',  // ğŸ†• v3.7.6.9: Quem fechou (display)
            fechado_por_username: data.fechadoPorUsername || null,  // ğŸ†• v3.7.7.0: FK
            numero_horas: data.numeroHoras || null,  // ğŸ†• v3.8.3.10.27.42: RevisÃµes
            tipos_revisao: data.tiposRevisao || null  // ğŸ†• v3.8.3.10.27.42: RevisÃµes
        };
        
        console.log('ğŸ“Š [SUPABASE] Dados a enviar:', {
            ID: data.id,
            Prioridade: supabaseData.Prioridade,
            Estado: supabaseData.Estado,
            ResponsÃ¡vel: supabaseData['ResponsÃ¡vel'],
            'Fechado Por': supabaseData['Fechado Por']
        });
        
        await window.SupabaseAPI.updatePedido(data.id, supabaseData);
        console.log('âœ… Ordem de trabalho atualizada no Supabase com sucesso!');
        
    } catch (error) {
        console.error('âŒ Erro ao atualizar Supabase:', error);
        console.error('âŒ Detalhes do erro:', error.message);
        addToOfflineQueue({ action: 'update', data: data });
        throw error;
    }
}

async function deleteFromGoogleSheets(id) {
    try {
        await window.SupabaseAPI.deletePedido(id);
        console.log('âœ… Ordem de trabalho eliminada do Supabase');
        
    } catch (error) {
        console.error('âŒ Erro ao eliminar do Supabase:', error);
        throw error;
    }
}

// ğŸ”¥ RENOMEADO v3.6.8: syncWithSupabase (era syncWithGoogleSheets)
async function syncWithGoogleSheets() {
    // âš ï¸ MantÃ©m o nome syncWithGoogleSheets para compatibilidade, mas usa Supabase
    await syncWithSupabase();
}

async function syncWithSupabase() {
    if (!AppState.isOnline) {
        console.log('ğŸ“¡ Offline - sync cancelado');
        return;
    }
    
    try {
        // Sincronizando Supabase
        
        // Carregar PEDIDOS
        await loadDataFromSupabase();
        
        // Carregar ARTIGOS
        const artigos = await window.SupabaseAPI.getArtigos();
        AppState.artigos = artigos.map(a => ({
            id: a.ID,
            codigo: a.ID,
            familia: a.FamÃ­lia,
            designacao: a.DesignaÃ§Ã£o,
            referencia: a.ReferÃªncia,
            fornecedor: a.Fornecedor,
            preco: parseFloat(a['PreÃ§o UnitÃ¡rio']) || 0,
            stockMinimo: parseInt(a['Stock MÃ­nimo']) || 0,
            // âœ… NOTA: Stock NÃƒO Ã© guardado na tabela! Ã‰ calculado via calcularStockAtual()
            empresa: a.Empresa,
            unidade: a.Unidade
        }));
        console.log(`âœ… ${AppState.artigos.length} artigos carregados`);
        
        // Carregar MOVIMENTOS
        const movimentos = await window.SupabaseAPI.getMovimentos();
        AppState.movimentos = movimentos.map(m => ({
            id: m.ID,
            dataHora: m['Data/Hora'],
            artigoId: m['Artigo ID'],
            tipo: m.Tipo,
            quantidade: parseInt(m.Quantidade) || 0,
            pedidoId: m['Pedido ID'],
            responsavel: m.ResponsÃ¡vel,
            observacoes: m.ObservaÃ§Ãµes,
            empresa: m.Empresa
        }));
        
        // âœ… Ordenar movimentos por data (mais recentes primeiro)
        AppState.movimentos.sort((a, b) => {
            const dateA = new Date(a.dataHora);
            const dateB = new Date(b.dataHora);
            return dateB - dateA;
        });
        
        console.log(`âœ… ${AppState.movimentos.length} movimentos carregados`);
        
        // ğŸ”¥ v3.8.3.10.2: Atualizar badge de stock DEPOIS de carregar artigos E movimentos
        renderStockMinimo();
        
        // ğŸ”¥ v3.7.7.3: Carregar UTILIZADORES (DIRETO sem filtrar!)
        console.log('ğŸ”¥ Carregando utilizadores...');
        const utilizadores = await window.SupabaseAPI.getUtilizadores();
        console.log('ğŸ”¥ Recebido do getUtilizadores():', utilizadores?.length, 'utilizadores');
        console.log('ğŸ”¥ Primeiro:', utilizadores?.[0]);
        
        // ğŸ”¥ NÃƒO FILTRAR! JÃ¡ vem correto de getUtilizadores()!
        AppState.utilizadores = utilizadores || [];
        
        console.log(`âœ… ${AppState.utilizadores.length} utilizadores carregados FINAL`);
        // Utilizadores mapeados
        
        // âœ… v3.7.0.9: Carregar EQUIPAMENTOS do Supabase
        console.log('ğŸ”„ A carregar equipamentos do Supabase...');
        const equipamentos = await window.SupabaseAPI.getEquipamentos();
        console.log('ğŸ” Equipamentos recebidos:', equipamentos);
        AppState.equipamentos = equipamentos || [];
        console.log(`âœ… ${AppState.equipamentos.length} equipamentos carregados do Supabase`);
        
        if (AppState.equipamentos.length === 0) {
            console.error('âš ï¸ AVISO: Nenhum equipamento carregado! Verificar:');
            console.error('  1. Tabela lista_equipamentos existe no Supabase?');
            console.error('  2. Dados foram inseridos?');
            console.error('  3. RLS permite SELECT pÃºblico?');
        }
        
        // ğŸ” Atualizar painel de debug visual
        atualizarPainelDebug();
        
        // âœ… v3.7.0.9: Popular dropdowns DEPOIS de carregar equipamentos
        // âœ… NÃƒO popular Ã¡rea/equipamento automaticamente - aguardar empresa ser selecionada
        const areaSelect = document.getElementById('areaEquipamento');
        if (areaSelect) {
            areaSelect.innerHTML = '<option value="">Escolha primeiro a empresa</option>';
            areaSelect.disabled = true;
        }
        
        populateEquipamentoFilter();
        // Dropdowns configurados
        
        // Guardar localmente
        saveToLocalStorage();
        
        showToast('Dados sincronizados', 'success');
        console.log('âœ… SincronizaÃ§Ã£o com Supabase completa');
        
        renderRequestsList();
        
    } catch (error) {
        console.error('âŒ Erro ao sincronizar com Supabase:', error);
        console.warn('âš ï¸ Usando dados locais');
    }
}

// OFFLINE SUPPORT
function setupOnlineOfflineListeners() {
    window.addEventListener('online', async () => {
        AppState.isOnline = true;
        showToast('ConexÃ£o restaurada. Sincronizando...', 'info');
        await processOfflineQueue();
        await syncWithGoogleSheets();
        renderRequestsList();
    });
    window.addEventListener('offline', () => {
        AppState.isOnline = false;
        showToast('Sem conexÃ£o. Os dados serÃ£o sincronizados quando a conexÃ£o for restaurada.', 'info');
    });
}

function addToOfflineQueue(item) {
    const queue = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.OFFLINE_QUEUE) || '[]');
    // Se item jÃ¡ tem action, usa-a; senÃ£o default Ã© 'create'
    const queueItem = item.action ? item : { action: 'create', data: item, timestamp: Date.now() };
    if (!queueItem.timestamp) queueItem.timestamp = Date.now();
    queue.push(queueItem);
    localStorage.setItem(CONFIG.STORAGE_KEYS.OFFLINE_QUEUE, JSON.stringify(queue));
    console.log(`ğŸ“¥ Item adicionado Ã  fila offline: ${queueItem.action}`);
}

async function processOfflineQueue() {
    const queue = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.OFFLINE_QUEUE) || '[]');
    if (queue.length === 0) return;
    console.log(`ğŸ“¤ Processando ${queue.length} itens da fila offline...`);
    for (const item of queue) {
        try {
            if (item.action === 'create') {
                await sendToGoogleSheets(item.data);
            } else if (item.action === 'update') {
                await updateInGoogleSheets(item.data);
            } else if (item.action === 'delete') {
                await deleteFromGoogleSheets(item.id || item.data.id);
            }
        } catch (error) {
            console.error('Erro ao processar item da fila:', error);
        }
    }
    localStorage.setItem(CONFIG.STORAGE_KEYS.OFFLINE_QUEUE, '[]');
    showToast('Dados sincronizados com sucesso!', 'success');
}

// ============================================
// LOCAL STORAGE - GESTÃƒO SUSTENTÃVEL
// ============================================

// Auto-limpeza diÃ¡ria de dados antigos
function cleanOldDataFromLocalStorage() {
    try {
        const lastCleanup = localStorage.getItem('last_cleanup');
        const now = Date.now();
        const oneDayMs = 24 * 60 * 60 * 1000;
        
        // ğŸ¯ LOG DE DIAGNÃ“STICO
        console.log('========================================');
        console.log('ğŸ“¦ APP MANUTENÃ‡ÃƒO MCF - v3.8.3.10.27.40');
        console.log('ğŸ“… Data:', new Date().toLocaleString('pt-PT'));
        console.log('ğŸ‘¤ Utilizador:', AppState.user?.username || 'NÃƒO AUTENTICADO');
        console.log('ğŸ”§ Pode Editar Planeamento:', AppState.user?.podeEditarPlaneamento ? 'SIM âœ…' : 'NÃƒO âŒ');
        console.log('ğŸ“Š Total OTs:', AppState.requests?.length || 0);
        console.log('ğŸ“… Total AlocaÃ§Ãµes:', Object.keys(AppState.planning?.allocations || {}).length);
        console.log('========================================');
        
        // SÃ³ limpar se passou mais de 1 dia
        if (!lastCleanup || (now - parseInt(lastCleanup)) > oneDayMs) {
            console.log('ğŸ§º Limpeza automÃ¡tica de dados antigos...');
            
            // Remover pedidos com mais de 7 dias
            const saved = localStorage.getItem(CONFIG.STORAGE_KEYS.REQUESTS);
            if (saved) {
                const requests = JSON.parse(saved);
                const sevenDaysAgo = now - (7 * oneDayMs);
                const recentRequests = requests.filter(req => {
                    const reqDate = new Date(req.dataHora).getTime();
                    return reqDate > sevenDaysAgo;
                });
                
                if (recentRequests.length < requests.length) {
                    console.log(`âœ… Removidos ${requests.length - recentRequests.length} pedidos antigos (>7 dias)`);
                    localStorage.setItem(CONFIG.STORAGE_KEYS.REQUESTS, JSON.stringify(recentRequests));
                }
            }
            
            // Limpar fila offline antiga
            localStorage.removeItem('maintenance_offline_queue');
            
            // Marcar Ãºltima limpeza
            localStorage.setItem('last_cleanup', now.toString());
            console.log('âœ… Limpeza concluÃ­da!');
        }
    } catch (error) {
        console.error('âŒ Erro na limpeza automÃ¡tica:', error);
    }
}

// Verificar espaÃ§o disponÃ­vel no localStorage
function getLocalStorageInfo() {
    try {
        const total = JSON.stringify(localStorage).length;
        const totalMB = (total / 1024 / 1024).toFixed(2);
        const limitMB = 5; // Limite aproximado
        const usagePercent = ((total / (limitMB * 1024 * 1024)) * 100).toFixed(1);
        
        return {
            totalBytes: total,
            totalMB: totalMB,
            usagePercent: usagePercent,
            isNearLimit: usagePercent > 70
        };
    } catch (error) {
        return { totalMB: '?', usagePercent: '?', isNearLimit: true };
    }
}

function saveToLocalStorage() {
    try {
        // ğŸ§º Auto-limpeza diÃ¡ria
        cleanOldDataFromLocalStorage();
        
        // ğŸ“Š Verificar espaÃ§o
        const storageInfo = getLocalStorageInfo();
        console.log(`ğŸ“Š LocalStorage: ${storageInfo.totalMB} MB (${storageInfo.usagePercent}% usado)`);
        
        if (storageInfo.isNearLimit) {
            console.warn('âš ï¸ LocalStorage prÃ³ximo do limite! ForÃ§ando limpeza...');
            cleanOldDataFromLocalStorage();
        }
        
        // ğŸ›¡ï¸ NUNCA guardar fotos base64!
        // ğŸ›¡ï¸ Limitar a 30 pedidos mais recentes (7 dias de trabalho tÃ­pico)
        let requestsToSave = AppState.requests
            .sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora))
            .slice(0, 30);
        
        // Remover TODAS as fotos (apenas URLs do Drive sÃ£o mantidas no Google Sheets)
        const requestsWithoutPhotos = requestsToSave.map(req => ({
            id: req.id,
            dataHora: req.dataHora,
            tipo: req.tipo,
            prioridade: req.prioridade,
            departamento: req.departamento,
            descricao: req.descricao,
            nome: req.nome,
            estado: req.estado,
            empresa: req.empresa,
            urgente: req.urgente,
            tipoIntervencao: req.tipoIntervencao,
            paragemProducao: req.paragemProducao
            // foto: REMOVIDO - Fotos sÃ³ no Google Sheets!
            // artigos: REMOVIDO - Dados de stock sempre do servidor
        }));
        
        const dataToSave = JSON.stringify(requestsWithoutPhotos);
        const sizeKB = (dataToSave.length / 1024).toFixed(2);
        
        console.log(`ğŸ’¾ Guardando ${requestsWithoutPhotos.length} pedidos (${sizeKB} KB - SEM fotos)`);
        
        // Verificar espaÃ§o disponÃ­vel
        const testKey = 'test_quota_' + Date.now();
        try {
            localStorage.setItem(testKey, dataToSave);
            localStorage.removeItem(testKey);
            
            // Se chegou aqui, hÃ¡ espaÃ§o suficiente
            localStorage.setItem(CONFIG.STORAGE_KEYS.REQUESTS, dataToSave);
            console.log('âœ… Dados guardados com sucesso!');
            
        } catch (quotaError) {
            console.error('âŒ LocalStorage cheio! Limpeza de emergÃªncia...');
            
            // LIMPEZA DE EMERGÃŠNCIA TOTAL
            localStorage.removeItem('maintenance_offline_queue');
            localStorage.removeItem('maintenance_planning');
            localStorage.removeItem('maintenance_user_session'); // ForÃ§ar novo login (seguranÃ§a)
            
            // Tentar novamente com apenas 10 pedidos
            const minimalRequests = requestsWithoutPhotos.slice(0, 10);
            try {
                localStorage.setItem(CONFIG.STORAGE_KEYS.REQUESTS, JSON.stringify(minimalRequests));
                // Limpeza concluÃ­da
            } catch (finalError) {
                // Se ainda assim falhar, limpar TUDO
                console.error('âŒ Limpeza de emergÃªncia falhou. Limpando TUDO...');
                localStorage.clear();
                showToast('âš ï¸ Cache limpo por falta de espaÃ§o. FaÃ§a login novamente.', 'warning');
                setTimeout(() => location.reload(), 2000);
            }
        }
        
    } catch (error) {
        console.error('âŒ Erro crÃ­tico ao guardar no localStorage:', error);
        // NÃƒO mostrar toast - modo silencioso para nÃ£o incomodar utilizador
        // App continua a funcionar sÃ³ com dados do servidor
    }
}

function loadFromLocalStorage() {
    const saved = localStorage.getItem(CONFIG.STORAGE_KEYS.REQUESTS);
    if (saved) AppState.requests = JSON.parse(saved);
}

// EXPORTAR EXCEL
function exportToExcel() {
    if (AppState.requests.length === 0) {
        showToast('NÃ£o hÃ¡ pedidos para exportar.', 'info');
        return;
    }
    try {
        // Preparar dados para exportaÃ§Ã£o
        const exportData = AppState.requests.map(request => ({
            'ID': request.id, 
            'Data/Hora': formatDateLong(request.dataHora), 
            'Tipo': request.tipo,
            'Prioridade': request.prioridade, 
            'Estado': request.estado, 
            'Departamento': request.departamento,
            'ResponsÃ¡vel': request.responsavel || '-',  // ğŸ†• Quem iniciou/alocado
            'Fechado Por': request.fechadoPor || '-',  // ğŸ†• v3.7.6.9: Quem fechou
            'DescriÃ§Ã£o': request.descricao,
            'Registado por': request.nome, 
            'Foto': request.foto ? 'Ver Foto' : 'Sem foto'
        }));
        
        // Criar worksheet
        const ws = XLSX.utils.json_to_sheet(exportData);
        
        // ğŸ“¸ ADICIONAR HIPERLINKS PARA FOTOS!
        // Percorrer cada linha e adicionar hiperlink se tiver foto
        AppState.requests.forEach((request, index) => {
            if (request.foto) {
                const cellAddress = XLSX.utils.encode_cell({ r: index + 1, c: 10 }); // Coluna K (Foto) - v3.7.6.9: era c:8
                
                // Criar hiperlink clicÃ¡vel
                ws[cellAddress].l = { 
                    Target: request.foto, 
                    Tooltip: "Clique para ver a foto" 
                };
                
                // Estilo azul e sublinhado (como link)
                if (!ws[cellAddress].s) ws[cellAddress].s = {};
                ws[cellAddress].s = {
                    font: { color: { rgb: "0563C1" }, underline: true }
                };
            }
        });
        
        // Criar workbook e adicionar sheet
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Pedidos de ManutenÃ§Ã£o");
        
        // Configurar largura das colunas
        ws['!cols'] = [
            { wch: 36 }, // ID
            { wch: 20 }, // Data/Hora
            { wch: 12 }, // Tipo
            { wch: 12 }, // Prioridade
            { wch: 12 }, // Estado
            { wch: 15 }, // Departamento
            { wch: 50 }, // DescriÃ§Ã£o
            { wch: 20 }, // Registado por
            { wch: 15 }  // Foto (hiperlink)
        ];
        
        const fileName = `Manutencao_${formatDateForFilename()}.xlsx`;
        XLSX.writeFile(wb, fileName, { bookType: 'xlsx', type: 'binary' });
        
        showToast('âœ… Excel exportado com fotos clicÃ¡veis!', 'success');
    } catch (error) {
        console.error('Erro ao exportar Excel:', error);
        showToast('Erro ao exportar ficheiro Excel.', 'error');
    }
}

// SERVICE WORKER - DESATIVADO (causa conflitos com login)
// async function registerServiceWorker() {
//     try {
//         const registration = await navigator.serviceWorker.register('./sw.js');
//         console.log('âœ… Service Worker registado:', registration);
//     } catch (error) {
//         console.error('âŒ Erro ao registar Service Worker:', error);
//     }
// }

// DESATIVAR Service Workers existentes
async function unregisterServiceWorkers() {
    if ('serviceWorker' in navigator) {
        const registrations = await navigator.serviceWorker.getRegistrations();
        for (let registration of registrations) {
            await registration.unregister();
            console.log('ğŸ—‘ï¸ Service Worker removido');
        }
    }
}

// TOAST
function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    const icons = {
        success: '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>',
        error: '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>',
        info: '<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>'
    };
    toast.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${icons[type]}</svg><div class="toast-message">${message}</div>`;
    container.appendChild(toast);
    setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

// âš¡ LOADING SPINNER - Feedback visual durante carregamento do Google Sheets
function showLoadingSpinner(message = 'Carregando...') {
    let spinner = document.getElementById('loadingSpinner');
    
    // Se nÃ£o existe, criar
    if (!spinner) {
        spinner = document.createElement('div');
        spinner.id = 'loadingSpinner';
        spinner.className = 'loading-spinner-overlay';
        spinner.innerHTML = `
            <div class="loading-spinner-content">
                <div class="spinner-circle"></div>
                <p class="spinner-message">${message}</p>
            </div>
        `;
        document.body.appendChild(spinner);
    } else {
        // Atualizar mensagem
        const messageEl = spinner.querySelector('.spinner-message');
        if (messageEl) messageEl.textContent = message;
    }
    
    // Mostrar com animaÃ§Ã£o
    setTimeout(() => spinner.classList.add('active'), 10);
    console.log('âš¡ Loading spinner MOSTRADO:', message);
}

function hideLoadingSpinner() {
    const spinner = document.getElementById('loadingSpinner');
    if (spinner) {
        spinner.classList.remove('active');
        setTimeout(() => {
            if (spinner.parentNode) {
                spinner.parentNode.removeChild(spinner);
            }
        }, 300); // Aguarda animaÃ§Ã£o
        console.log('âš¡ Loading spinner ESCONDIDO');
    }
}

// UTILS
// âœ… v3.7.0.9: Gerar ID sequencial para Ordens de Trabalho (OT_XXXXX)
async function generateOTID() {
    try {
        // Obter todas as OTs do Supabase para descobrir o prÃ³ximo nÃºmero
        const response = await window.SupabaseAPI.getPedidos();
        
        let nextNumber = 1;
        
        if (response && response.length > 0) {
            // Filtrar apenas IDs do formato OT_XXXXX e ordenar
            const otIDs = response
                .map(r => r.ID)
                .filter(id => id && id.startsWith('OT_') && !isNaN(parseInt(id.replace('OT_', ''))))
                .map(id => parseInt(id.replace('OT_', '')))
                .sort((a, b) => b - a); // Ordenar decrescente
            
            if (otIDs.length > 0) {
                nextNumber = otIDs[0] + 1;
            } else {
                // Se nÃ£o hÃ¡ OT_XXXXX, contar total de registros
                nextNumber = response.length + 1;
            }
        }
        
        // Formatar como OT_00001, OT_00002, etc.
        const otID = `OT_${String(nextNumber).padStart(5, '0')}`;
        console.log(`âœ… Novo ID gerado: ${otID} (prÃ³ximo apÃ³s ${nextNumber - 1})`);
        return otID;
        
    } catch (error) {
        console.error('âŒ Erro ao gerar ID OT:', error);
        // Fallback: usar timestamp
        const fallbackID = `OT_${Date.now()}`;
        console.warn(`âš ï¸ Usando ID fallback: ${fallbackID}`);
        return fallbackID;
    }
}

// Manter generateUUID para compatibilidade (caso seja usado em outro lugar)
function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

function formatDate(isoString) {
    const date = new Date(isoString), now = new Date(), diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000), diffHours = Math.floor(diffMs / 3600000), diffDays = Math.floor(diffMs / 86400000);
    if (diffMins < 1) return 'Agora';
    if (diffMins < 60) return `HÃ¡ ${diffMins}m`;
    if (diffHours < 24) return `HÃ¡ ${diffHours}h`;
    if (diffDays < 7) return `HÃ¡ ${diffDays}d`;
    return date.toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function formatDateLong(isoString) {
    const date = new Date(isoString);
    return date.toLocaleString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function formatDateForFilename() {
    return new Date().toISOString().split('T')[0];
}

// âœ… v3.7.0.8: Calcular prÃ³xima intervenÃ§Ã£o baseada na frequÃªncia
function calcularProximaIntervencao(dataPrimeiraIntervencao, frequencia) {
    if (!dataPrimeiraIntervencao || !frequencia) return null;
    
    const dataBase = new Date(dataPrimeiraIntervencao);
    if (isNaN(dataBase.getTime())) return null;
    
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    
    // Mapeamento de frequÃªncias para dias
    const diasPorFrequencia = {
        'Semanal': 7,
        'Quinzenal': 14,
        'Mensal': 30,
        'Trimestral': 90,
        'Semestral': 180,
        'Anual': 365,
        '2 anos': 730
    };
    
    const diasIntervalo = diasPorFrequencia[frequencia];
    if (!diasIntervalo) return null;
    
    let proximaData = new Date(dataBase);
    
    // Encontrar a prÃ³xima data no futuro
    while (proximaData <= hoje) {
        proximaData.setDate(proximaData.getDate() + diasIntervalo);
    }
    
    return proximaData;
}

// PLANEAMENTO
async function initializePlanning() {
    try {
        loadPlanningFromStorage(); 
        await loadPlanningFromSupabase();  // âœ… v3.7.0.8: Carregar do Supabase
        resetPlanningToToday(); 
        renderPlanningGrid();
        
        // âœ… Popular filtros DEPOIS de carregar planeamento
        populateResponsavelFilter();
        populatePlanningFilters();  // âœ… v3.7.0.9: Popular filtros do planeamento
    } catch (error) {
        console.error('âŒ Erro ao inicializar planeamento:', error);
        // âœ… FALLBACK: Garantir que datas estÃ£o definidas
        resetPlanningToToday();
        renderPlanningGrid();
    }
}
function resetPlanningToToday() {
    const today = new Date(); today.setHours(0,0,0,0);
    AppState.planning.startDate = new Date(today);
    AppState.planning.endDate = new Date(today);
    AppState.planning.endDate.setDate(today.getDate() + (CONFIG.PLANNING_WEEKS * 7) - 1);
    renderPlanningGrid();
}
function movePlanningWeek(direction) {
    const daysToMove = 7 * direction;
    AppState.planning.startDate.setDate(AppState.planning.startDate.getDate() + daysToMove);
    AppState.planning.endDate.setDate(AppState.planning.endDate.getDate() + daysToMove);
    renderPlanningGrid();
}
function generateDateRange() {
    const dates = [], current = new Date(AppState.planning.startDate);
    while (current <= AppState.planning.endDate) {
        if (CONFIG.INCLUDE_WEEKENDS || (current.getDay() !== 0 && current.getDay() !== 6)) dates.push(new Date(current));
        else if (!CONFIG.INCLUDE_WEEKENDS && current.getDay() === 6) dates.push(new Date(current));
        current.setDate(current.getDate() + 1);
    }
    return dates;
}

// âœ… NOVO: Renderizar lista de manutenÃ§Ãµes preventivas
function renderPreventivasList() {
    console.log('ğŸ“‹ Renderizando preventivas...');
    
    const preventivasList = document.getElementById('preventivasList');
    const periodoFilter = document.getElementById('preventivaPeriodoFilter').value;
    const empresaFilter = document.getElementById('preventivaEmpresaFilter').value;
    const frequenciaFilter = document.getElementById('preventivaFrequenciaFilter').value;
    
    // Filtrar pedidos preventivos
    let preventivas = AppState.requests.filter(r => r.tipo === 'Preventiva');
    
    // Aplicar filtros
    if (empresaFilter !== 'todas') {
        preventivas = preventivas.filter(r => r.empresa === empresaFilter);
    }
    
    if (frequenciaFilter !== 'todas') {
        preventivas = preventivas.filter(r => r.frequencia === frequenciaFilter);
    }
    
    // Calcular data limite baseada no perÃ­odo
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    let dataLimite = new Date();
    
    switch(periodoFilter) {
        case 'mes':
            dataLimite.setMonth(dataLimite.getMonth() + 1);
            break;
        case '3meses':
            dataLimite.setMonth(dataLimite.getMonth() + 3);
            break;
        case '6meses':
            dataLimite.setMonth(dataLimite.getMonth() + 6);
            break;
        case 'ano':
            dataLimite.setFullYear(dataLimite.getFullYear() + 1);
            break;
    }
    
    // âœ… v3.7.0.8: Calcular prÃ³xima intervenÃ§Ã£o e ordenar por urgÃªncia
    preventivas = preventivas.map(p => {
        const proximaData = calcularProximaIntervencao(p.dataPrimeiraIntervencao, p.frequencia);
        const diasRestantes = proximaData ? Math.ceil((proximaData - hoje) / (1000 * 60 * 60 * 24)) : 999999;
        
        return {
            ...p,
            proximaData,
            diasRestantes
        };
    }).sort((a, b) => {
        // Ordenar por dias restantes (mais urgente primeiro)
        return a.diasRestantes - b.diasRestantes;
    });
    
    console.log(`ğŸ“Š ${preventivas.length} preventivas encontradas (perÃ­odo: ${periodoFilter})`);
    
    // Renderizar lista
    if (preventivas.length === 0) {
        preventivasList.innerHTML = `
            <div class="empty-state" style="padding: 40px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 64px; height: 64px; margin: 0 auto 16px;">
                    <path d="M9 11l3 3L22 4"/>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                </svg>
                <h3>Nenhuma manutenÃ§Ã£o preventiva encontrada</h3>
                <p style="color: #666;">Ajuste os filtros ou crie novas manutenÃ§Ãµes preventivas</p>
            </div>
        `;
        return;
    }
    
    // Agrupar por frequÃªncia
    const porFrequencia = {};
    preventivas.forEach(p => {
        const freq = p.frequencia || '-';
        if (!porFrequencia[freq]) porFrequencia[freq] = [];
        porFrequencia[freq].push(p);
    });
    
    // Gerar HTML
    let html = '';
    
    // Cards de resumo
    const vencidas = preventivas.filter(p => p.diasRestantes < 0).length;
    const proximas = preventivas.filter(p => p.diasRestantes >= 0 && p.diasRestantes <= 7).length;
    
    html += `
        <div class="stats-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px;">
                <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">${preventivas.length}</div>
                <div style="opacity: 0.9;">Total de Preventivas</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f5576c 0%, #e74c3c 100%); color: white; padding: 20px; border-radius: 8px;">
                <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">${vencidas}</div>
                <div style="opacity: 0.9;">âš ï¸ Atrasadas</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f39c12 0%, #f093fb 100%); color: white; padding: 20px; border-radius: 8px;">
                <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">${proximas}</div>
                <div style="opacity: 0.9;">âš¡ PrÃ³x. 7 dias</div>
            </div>
        </div>
    `;
    
    // âœ… v3.7.0.8: Listar ORDENADO por prÃ³xima intervenÃ§Ã£o
    html += `
        <div style="margin-bottom: 20px;">
            <h3 style="color: #2196F3; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #2196F3;">
                ğŸ“‹ Preventivas Ordenadas por UrgÃªncia
            </h3>
            <div style="display: grid; gap: 10px;">
    `;
    
    preventivas.forEach(p => {
        const prioridadeClass = p.prioridade === 'Alta' ? 'priority-alta' : 
                               p.prioridade === 'MÃ©dia' ? 'priority-media' : 'priority-baixa';
        const estadoClass = p.estado === 'Resolvido' ? 'estado-resolvido' : 
                          p.estado === 'Em curso' ? 'estado-em-curso' : 'estado-novo';
        
        // âœ… v3.7.0.8: Indicador visual de urgÃªncia
        let indicadorUrgencia = '';
        let borderColor = '#ddd';
        
        if (p.proximaData) {
            if (p.diasRestantes === 0) {
                indicadorUrgencia = '<span style="color: #2ecc71; font-weight: bold; font-size: 0.875rem;">ğŸ“… HOJE</span>';
                borderColor = '#2ecc71';
            } else if (p.diasRestantes > 0 && p.diasRestantes <= 7) {
                indicadorUrgencia = `<span style="color: #f39c12; font-weight: bold; font-size: 0.875rem;">âš¡ Em ${p.diasRestantes} dias</span>`;
                borderColor = '#f39c12';
            } else if (p.diasRestantes < 0) {
                indicadorUrgencia = `<span style="color: #e74c3c; font-weight: bold; font-size: 0.875rem;">âš ï¸ Atrasada ${Math.abs(p.diasRestantes)} dias</span>`;
                borderColor = '#e74c3c';
            } else {
                indicadorUrgencia = `<span style="color: #666; font-size: 0.875rem;">Em ${p.diasRestantes} dias</span>`;
            }
        }
        
        html += `
            <div class="request-card" style="background: white; border-left: 4px solid ${borderColor}; border: 1px solid #ddd; border-left: 4px solid ${borderColor}; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.2s;" 
                 onclick="openRequestDetails('${p.id}')">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                    <div>
                        <span class="badge ${prioridadeClass}" style="font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; margin-right: 8px;">
                            ${p.prioridade}
                        </span>
                        <span class="badge ${estadoClass}" style="font-size: 0.75rem; padding: 4px 8px; border-radius: 4px;">
                            ${p.estado}
                        </span>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: #666; font-size: 0.875rem;">${p.empresa}</div>
                        <div style="color: #666; font-size: 0.75rem;">ğŸ“… ${p.frequencia}</div>
                    </div>
                </div>
                <div style="font-weight: 600; margin-bottom: 8px;">
                    ${p.areaEquipamento}${p.componente && p.componente !== '-' ? ' - ' + p.componente : ''}
                </div>
                <div style="color: #666; font-size: 0.875rem; margin-bottom: 8px;">
                    ${p.descricao.substring(0, 100)}${p.descricao.length > 100 ? '...' : ''}
                </div>
                ${p.proximaData ? `
                <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                    <strong style="font-size: 0.875rem;">PrÃ³xima IntervenÃ§Ã£o: ${p.proximaData.toLocaleDateString('pt-PT')}</strong>
                    <br>${indicadorUrgencia}
                </div>
                ` : ''}
                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #999;">
                    <span>ğŸ“… Criado: ${new Date(p.dataHora).toLocaleDateString('pt-PT')}</span>
                    <span>ğŸ‘¤ ${p.nome}</span>
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
        </div>
    `;
    
    preventivasList.innerHTML = html;
}

// âœ… v3.7.0.9: Obter filtros do planeamento
function getPlanningFilters() {
    const filters = {
        tipo: Array.from(document.querySelectorAll('.planning-filter-tipo:checked')).map(cb => cb.value),
        prioridade: Array.from(document.querySelectorAll('.planning-filter-prioridade:checked')).map(cb => cb.value),
        estado: Array.from(document.querySelectorAll('.planning-filter-estado:checked')).map(cb => cb.value),
        empresa: Array.from(document.querySelectorAll('.planning-filter-empresa:checked')).map(cb => cb.value),
        equipamento: document.getElementById('planningFilterEquipamento')?.value || '',
        responsavel: document.getElementById('planningFilterResponsavel')?.value || '',
        tipoIntervencao: Array.from(document.querySelectorAll('.planning-filter-tipoIntervencao:checked')).map(cb => cb.value),
        urgente: Array.from(document.querySelectorAll('.planning-filter-urgente:checked')).map(cb => cb.value),
        paragemProducao: Array.from(document.querySelectorAll('.planning-filter-paragemProducao:checked')).map(cb => cb.value),
        exigeCompra: Array.from(document.querySelectorAll('.planning-filter-exigeCompra:checked')).map(cb => cb.value)
    };
    return filters;
}

// âœ… v3.7.0.9: Aplicar filtros aos pedidos do planeamento
function applyPlanningFilters(requests) {
    const filters = getPlanningFilters();
    console.log('ğŸ” APPLY PLANNING FILTERS - INÃCIO:', {
        totalRequests: requests.length,
        filters: filters,
        preventivasNaEntrada: requests.filter(r => r.tipo === 'Preventiva').length
    });
    
    console.log('ğŸ” Aplicando filtros de planeamento:', {
        totalRequests: requests.length,
        filters,
        checkboxPreventiva: document.querySelector('.planning-filter-tipo[value="Preventiva"]')?.checked,
        preventivas: requests.filter(r => r.tipo === 'Preventiva').length
    });
    
    const filtered = requests.filter(request => {
        // Tipo
        const passaTipo = filters.tipo.length === 0 || filters.tipo.includes(request.tipo);
        
        if (request.tipo === 'Preventiva') {
            console.log(`ğŸ”§ Preventiva ${request.id}: passaTipo=${passaTipo}, filters.tipo=${JSON.stringify(filters.tipo)}`);
        }
        
        // Prioridade
        const passaPrioridade = filters.prioridade.length === 0 || filters.prioridade.includes(request.prioridade);
        
        if (request.tipo === 'Preventiva') {
            console.log(`   â†’ Prioridade: request=${request.prioridade}, filters=${JSON.stringify(filters.prioridade)}, passa=${passaPrioridade}`);
        }
        
        // Estado
        const passaEstado = filters.estado.length === 0 || filters.estado.includes(request.estado);
        
        // Empresa
        const passaEmpresa = filters.empresa.length === 0 || filters.empresa.includes(request.empresa);
        
        // Equipamento
        const equipamentoPedido = request.areaEquipamento || '';
        const passaEquipamento = !filters.equipamento || equipamentoPedido === filters.equipamento;
        
        // ResponsÃ¡vel (do planeamento) - ğŸ†• v3.8.3.10.27.46: Incluir 2Âº ResponsÃ¡vel
        const responsavelPedido = AppState.planning.tasks[request.id]?.responsavel || '';
        const segundoResponsavelPedido = AppState.planning.tasks[request.id]?.segundoResponsavel || '';
        const passaResponsavel = !filters.responsavel || 
                                 responsavelPedido === filters.responsavel || 
                                 segundoResponsavelPedido === filters.responsavel;
        
        // Tipo de IntervenÃ§Ã£o
        const passaTipoIntervencao = filters.tipoIntervencao.length === 0 || filters.tipoIntervencao.includes(request.tipoIntervencao);
        
        // Urgente
        const passaUrgente = filters.urgente.length === 0 || (filters.urgente.includes('true') && request.urgente);
        
        // Paragem ProduÃ§Ã£o
        const passaParagem = filters.paragemProducao.length === 0 || (filters.paragemProducao.includes('true') && request.paragemProducao);
        
        // Exige Compra
        const passaExigeCompra = filters.exigeCompra.length === 0 || (filters.exigeCompra.includes('true') && request.exigeCompra);
        
        // ğŸ†• v3.8.3.10.27: Filtros de preventivas (todas, para breve, atrasadas)
        const filterPreventivaTodas = document.getElementById('planningFilterPreventivaTodas')?.checked || false;
        const filterPreventivaBreve = document.getElementById('planningFilterPreventivaBreve')?.checked || false;
        const filterPreventivaAtrasadas = document.getElementById('planningFilterPreventivaAtrasadas')?.checked || false;
        let passaFiltroPreventiva = true;
        
        // SÃ³ aplicar filtros se for preventiva
        if (request.tipo === 'Preventiva') {
            console.log(`ğŸ”§ Processando preventiva ${request.id || request.ID}:`, {
                id: request.id || request.ID,
                estado: request.estado,
                filterPreventivaTodas,
                filterPreventivaBreve,
                filterPreventivaAtrasadas,
                dataPrimeiraIntervencao: request.dataPrimeiraIntervencao || request.data_primeira_intervencao,
                frequencia: request.frequencia,
                passaTipo: filters.tipo.length === 0 || filters.tipo.includes(request.tipo)
            });
            // âœ… FIX v3.8.3.10.27.6: Se NENHUM filtro estÃ¡ ativo, mostrar TODAS
            if (!filterPreventivaTodas && !filterPreventivaBreve && !filterPreventivaAtrasadas) {
                passaFiltroPreventiva = true;  // âœ… MUDOU: mostrar todas quando nenhum filtro ativo
                console.log(`   â†’ NENHUM sub-filtro ativo, MOSTRAR TODAS`);
            } else if (request.dataPrimeiraIntervencao && request.frequencia) {
                // Calcular prÃ³xima intervenÃ§Ã£o
                const proximaData = calcularProximaIntervencao(request.dataPrimeiraIntervencao, request.frequencia);
                if (proximaData) {
                    const hoje = new Date();
                    hoje.setHours(0, 0, 0, 0);
                    const diasRestantes = Math.ceil((proximaData - hoje) / (1000 * 60 * 60 * 24));
                    
                    // Verificar se passa em algum dos filtros ativos
                    const passaTodas = filterPreventivaTodas;
                    const passaBreve = filterPreventivaBreve && diasRestantes <= 30;
                    const passaAtrasadas = filterPreventivaAtrasadas && diasRestantes < 0;
                    
                    passaFiltroPreventiva = passaTodas || passaBreve || passaAtrasadas;
                    console.log(`   â†’ diasRestantes: ${diasRestantes}, passa: ${passaFiltroPreventiva} (todas:${passaTodas}, breve:${passaBreve}, atrasadas:${passaAtrasadas})`);
                } else {
                    // Sem data calculada, sÃ³ mostrar se "Todas" estiver ativo
                    passaFiltroPreventiva = filterPreventivaTodas;
                    console.log(`   â†’ SEM proximaData calculada, passa: ${passaFiltroPreventiva}`);
                }
            } else {
                // Sem data/frequÃªncia, sÃ³ mostrar se "Todas" estiver ativo
                passaFiltroPreventiva = filterPreventivaTodas;
                console.log(`   â†’ SEM data/frequÃªncia, passa: ${passaFiltroPreventiva}`);
            }
        }
        
        const resultado = passaTipo && passaPrioridade && passaEstado && passaEmpresa && 
               passaEquipamento && passaResponsavel && passaTipoIntervencao && 
               passaUrgente && passaParagem && passaExigeCompra && passaFiltroPreventiva;
        
        if (request.tipo === 'Preventiva') {
            console.log(`   âœ… RESULTADO FINAL ${request.id || request.ID}:`, {
                resultado,
                passaTipo,
                passaPrioridade,
                passaEstado,
                passaEmpresa,
                passaEquipamento,
                passaResponsavel,
                passaTipoIntervencao,
                passaUrgente,
                passaParagem,
                passaExigeCompra,
                passaFiltroPreventiva
            });
        }
        
        return resultado;
    });
    
    console.log(`âœ… Filtros aplicados: ${filtered.length} de ${requests.length} pedidos`, {
        preventivas: filtered.filter(r => r.tipo === 'Preventiva').length,
        corretivas: filtered.filter(r => r.tipo === 'Corretiva').length
    });
    return filtered;
}

// ğŸ†• v3.8.3.10.27.20: Imprimir Planeamento em PDF
function imprimirPlaneamento() {
    // Ativar filtro "Apenas Planeadas" temporariamente
    const filtroAnterior = AppState.planning.apenasPlanadas;
    if (!AppState.planning.apenasPlanadas) {
        AppState.planning.apenasPlanadas = true;
        renderPlanningGrid(); // Re-renderizar com filtro
    }
    
    // Preparar conteÃºdo para impressÃ£o
    const rangeText = document.getElementById('planningRange').textContent;
    
    // ğŸ¯ v3.8.3.10.27.33: SOLUÃ‡ÃƒO RADICAL - CONVERTER <thead> EM <tbody>!
    const originalGrid = document.getElementById('planningGrid');
    
    const originalThead = originalGrid.querySelector('thead');
    const originalTbody = originalGrid.querySelector('tbody');
    
    if (!originalThead || !originalTbody) {
        console.error('âŒ Thead ou Tbody nÃ£o encontrados!');
        showToast('Erro ao preparar impressÃ£o', 'error');
        return;
    }
    
    // Criar nova tabela do zero
    const newTable = document.createElement('table');
    newTable.className = 'planning-grid';
    newTable.id = 'planningGrid_print';
    
    // ğŸ¯ SOLUÃ‡ÃƒO RADICAL: Usar APENAS <tbody>, sem <thead>!
    const newTbody = document.createElement('tbody');
    
    // Converter <thead><tr> em <tbody><tr> (primeira linha)
    const theadRow = originalThead.querySelector('tr').cloneNode(true);
    theadRow.classList.add('header-row'); // Marcar como linha de cabeÃ§alho
    newTbody.appendChild(theadRow);
    
    // Adicionar todas as linhas do tbody original
    const tbodyRows = originalTbody.querySelectorAll('tr');
    tbodyRows.forEach(row => {
        newTbody.appendChild(row.cloneNode(true));
    });
    
    // Adicionar APENAS o tbody (com cabeÃ§alho como primeira linha)
    newTable.appendChild(newTbody);
    
    console.log('ğŸ“Š ESTRUTURA DA TABELA (SEM THEAD):');
    console.log('- Tabela tem tbody?', !!newTbody);
    console.log('- Tbody tem linhas:', newTbody.children.length);
    console.log('- Primeira linha Ã© cabeÃ§alho?', newTbody.children[0]?.classList.contains('header-row'));
    
    // ğŸ¯ v3.8.3.10.27.30: Adicionar classe ANTES de criar container
    document.body.classList.add('printing-planning');
    
    // Criar container temporÃ¡rio para impressÃ£o
    const printContainer = document.createElement('div');
    printContainer.id = 'planningPrintContainer';
    // âœ… NÃƒO esconder - criar jÃ¡ visÃ­vel!
    printContainer.style.display = 'block';
    printContainer.style.visibility = 'hidden'; // â† Esconder visualmente mas manter no layout
    
    // Adicionar cabeÃ§alho
    const header = document.createElement('div');
    header.style.cssText = 'text-align: center; margin-bottom: 15px; padding: 10px 0; border-bottom: 2px solid #1E3A8A;';
    header.innerHTML = `
        <h1 style="color: #1E3A8A; font-size: 20pt; font-weight: bold; margin: 0 0 8px 0; letter-spacing: 0.5px;">
            ğŸ“… Planeamento de ManutenÃ§Ã£o
        </h1>
        <p style="color: #374151; font-size: 12pt; font-weight: 600; margin: 5px 0;">
            ${rangeText}
        </p>
        <p style="color: #6B7280; font-size: 9pt; margin: 3px 0 0 0; font-style: italic;">
            Gerado em: ${new Date().toLocaleString('pt-PT', { dateStyle: 'short', timeStyle: 'short' })}
        </p>
    `;
    
    printContainer.appendChild(header);
    printContainer.appendChild(newTable);
    
    document.body.appendChild(printContainer);
    
    // Tornar visÃ­vel
    printContainer.style.visibility = 'visible';
    
    // ğŸ¯ v3.8.3.10.27.27: FORÃ‡AR REFLOW antes de imprimir!
    // ForÃ§ar o browser a recalcular layout ANTES de window.print()
    void printContainer.offsetHeight; // ForÃ§a reflow
    void document.body.offsetHeight; // ForÃ§a reflow do body
    
    // Imprimir com delay para dar tempo aos estilos CSS serem aplicados
    setTimeout(() => {
        console.log('ğŸ–¨ï¸ Iniciando impressÃ£o... CSS aplicado:', document.body.classList.contains('printing-planning'));
        
        // ğŸ¯ v3.8.3.10.27.32: LOG FINAL antes de imprimir
        const finalTable = document.querySelector('#planningPrintContainer table');
        if (finalTable) {
            console.log('ğŸ“‹ TABELA NO DOM ANTES DE IMPRIMIR:');
            console.log('- Children count:', finalTable.children.length);
            console.log('- Child 0:', finalTable.children[0]?.tagName);
            console.log('- Child 1:', finalTable.children[1]?.tagName);
            console.log('- Thead existe?', !!finalTable.querySelector('thead'));
            console.log('- Tbody existe?', !!finalTable.querySelector('tbody'));
            console.log('- Thead Ã© primeiro?', finalTable.children[0]?.tagName === 'THEAD');
        }
        
        window.print();
        
        // Limpar apÃ³s impressÃ£o
        setTimeout(() => {
            document.body.classList.remove('printing-planning');
            document.body.removeChild(printContainer);
            
            // Restaurar filtro anterior
            if (AppState.planning.apenasPlanadas !== filtroAnterior) {
                AppState.planning.apenasPlanadas = filtroAnterior;
                renderPlanningGrid();
            }
        }, 1000); // âœ… 1 segundo para limpar
    }, 800); // âœ… 800ms para dar tempo ao CSS ser aplicado
}

// ğŸ†• v3.8.3.10.27.20: Toggle filtro "Apenas Planeadas"
function toggleApenasPlanadas() {
    AppState.planning.apenasPlanadas = !AppState.planning.apenasPlanadas;
    
    // Atualizar visual do botÃ£o
    const btn = document.getElementById('togglePlaneadasBtn');
    const icon = document.getElementById('togglePlaneadasIcon');
    const text = document.getElementById('togglePlaneadasText');
    
    if (AppState.planning.apenasPlanadas) {
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-primary');
        icon.textContent = 'âœ“';
        text.textContent = 'Apenas Planeadas';
    } else {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
        icon.textContent = 'ğŸ‘ï¸';
        text.textContent = 'Apenas Planeadas';
    }
    
    // Re-renderizar grid
    renderPlanningGrid();
    
    showToast(
        AppState.planning.apenasPlanadas 
            ? 'âœ“ Mostrar apenas OTs planeadas' 
            : 'ğŸ‘ï¸ Mostrar todas as OTs', 
        'success'
    );
}


function renderPlanningGrid() {
    const grid = document.getElementById('planningGrid');
    
    // âœ… VALIDAÃ‡ÃƒO: Verificar se startDate e endDate existem
    if (!AppState.planning.startDate || !AppState.planning.endDate) {
        console.warn('âš ï¸ Planning dates nÃ£o definidas, a inicializar...');
        AppState.planning.startDate = new Date();
        AppState.planning.endDate = new Date(Date.now() + 14 * 24 * 60 * 60 * 1000); // +2 semanas
    }
    
    const dates = generateDateRange();
    const rangeText = `${formatDateShort(AppState.planning.startDate)} - ${formatDateShort(AppState.planning.endDate)}`;
    document.getElementById('planningRange').textContent = rangeText;
    
    // âœ… v3.7.0.9: Aplicar filtros
    const allRequests = AppState.requests.filter(r => r.estado !== 'Resolvido');
    console.log('ğŸ” RENDER PLANNING GRID - INÃCIO:', {
        totalRequests: AppState.requests.length,
        allRequests: allRequests.length,
        preventivas: allRequests.filter(r => r.tipo === 'Preventiva').length,
        corretivas: allRequests.filter(r => r.tipo === 'Corretiva').length,
        preventivasNaoResolvidas: allRequests.filter(r => r.tipo === 'Preventiva' && r.estado !== 'Resolvido').length
    });
    let activeTasks = applyPlanningFilters(allRequests);
    
    // ğŸ†• v3.8.3.10.27.20: Filtrar apenas OTs planeadas (se filtro ativo)
    if (AppState.planning.apenasPlanadas) {
        activeTasks = activeTasks.filter(task => {
            const planningData = AppState.planning.tasks[task.id];
            // ğŸ¯ CORREÃ‡ÃƒO: "Planeada" = TEM DIAS ALOCADOS (cÃ©lulas marcadas no calendÃ¡rio)
            const temDias = planningData?.diasAlocados && planningData.diasAlocados.length > 0;
            return temDias;
        });
    }
    
    console.log('ğŸ” RENDER PLANNING GRID - APÃ“S FILTROS:', {
        activeTasks: activeTasks.length,
        apenasPlanadas: AppState.planning.apenasPlanadas,
        preventivas: activeTasks.filter(r => r.tipo === 'Preventiva').length,
        corretivas: activeTasks.filter(r => r.tipo === 'Corretiva').length
    });
    if (activeTasks.length === 0) {
        grid.innerHTML = `<tr><td colspan="${dates.length + 1}" style="text-align: center; padding: var(--spacing-xl);"><p>NÃ£o hÃ¡ ordens de trabalho ativas para planear.</p><p style="color: var(--color-text-secondary); font-size: 0.875rem;">Crie novas ordens na tab "Nova Ordem"</p></td></tr>`;
        return;
    }
    let html = '<thead><tr><th class="task-header">Ordem / Tarefa</th><th class="responsible-header">ResponsÃ¡vel</th><th class="responsible-header">2Âº ResponsÃ¡vel</th><th class="hours-header">Horas</th>';
    dates.forEach(date => {
        const isWeekend = date.getDay() === 0 || date.getDay() === 6, weekendClass = isWeekend ? 'weekend' : '';
        const dayName = date.toLocaleDateString('pt-PT', { weekday: 'short' }), dayNum = date.getDate();
        const monthName = date.toLocaleDateString('pt-PT', { month: 'short' });
        html += `<th class="date-header ${weekendClass}" title="${formatDateLong2(date)}"><div>${dayName}</div><div>${dayNum} ${monthName}</div></th>`;
    });
    html += '</tr></thead><tbody>';
    activeTasks.forEach(task => {
        html += '<tr>';
        html += `<td class="task-cell"><div class="task-info"><div class="task-title"><span style="font-weight: 600; color: #3B82F6; margin-right: 8px; cursor: pointer; text-decoration: underline;" onclick="openRequestDetails('${task.id}')" title="Clique para ver detalhes">#${task.id}</span>${task.descricao}</div><div class="task-meta"><span class="badge badge-tipo">${task.tipo}</span><span class="badge badge-prioridade ${task.prioridade.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '')}">${task.prioridade}</span>`;
        if (task.responsavel && task.responsavel !== '-') html += `<span class="task-responsible"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>${task.responsavel}</span>`;
        html += `</div></div></td>`;
        
        // âœ… v3.7.0.8: Ler dados do PLANEAMENTO (nÃ£o da ordem de trabalho)
        const planningData = AppState.planning.tasks[task.id] || { responsavel: '', segundoResponsavel: '', horasEstimadas: 0, diasAlocados: [] };
        const taskResponsavel = planningData.responsavel || task.responsavel || '';  // Fallback: pedido se nÃ£o tiver no planeamento
        const taskSegundoResponsavel = planningData.segundoResponsavel || '';  // ğŸ†• v3.8.3.10.27.46: 2Âº ResponsÃ¡vel
        const taskHours = planningData.horasEstimadas || task.horasEstimadas || '';  // Fallback: pedido se nÃ£o tiver no planeamento
        
        html += `<td class="responsible-cell">`;
        html += `<select class="responsible-select" data-task-id="${task.id}" onchange="updateTaskResponsible('${task.id}', this.value)">`;
        html += `<option value="">-</option>`;
        
        // ğŸ†• v3.7.7.1: Usar utilizadores da BD (jÃ¡ vÃªm ATIVOS da funÃ§Ã£o SQL!)
        if (AppState.utilizadores && AppState.utilizadores.length > 0) {
            // Detectar nome correto do campo (pode ser "nomeCompleto" ou "Nome Completo")
            const primeiroUser = AppState.utilizadores[0];
            const nomeCompletoKey = Object.keys(primeiroUser).find(k => k.toLowerCase().replace(/[_\s]/g, '') === 'nomecompleto') || 'nomeCompleto';
            
            // ğŸ”¥ NÃƒO FILTRAR! A funÃ§Ã£o SQL jÃ¡ retorna sÃ³ os ativos!
            AppState.utilizadores
                .sort((a, b) => (a[nomeCompletoKey] || '').localeCompare(b[nomeCompletoKey] || ''))
                .forEach(user => {
                    const nomeCompleto = user[nomeCompletoKey];
                    const selected = taskResponsavel === nomeCompleto ? 'selected' : '';
                    html += `<option value="${nomeCompleto}" ${selected}>${nomeCompleto}</option>`;
                });
        } else {
            // Fallback: buscar responsÃ¡veis Ãºnicos existentes
            const responsaveisUnicos = [...new Set(AppState.requests.map(r => {
                const task = AppState.planning.tasks[r.id];
                return task?.responsavel;
            }).filter(r => r))].sort();
            
            responsaveisUnicos.forEach(resp => {
                const selected = taskResponsavel === resp ? 'selected' : '';
                html += `<option value="${resp}" ${selected}>${resp}</option>`;
            });
        }
        html += `</select></td>`;
        
        // ğŸ†• v3.8.3.10.27.46: 2Âº RESPONSÃVEL
        html += `<td class="responsible-cell">`;
        html += `<select class="responsible-select" data-task-id="${task.id}" onchange="updateTaskSecondResponsible('${task.id}', this.value)">`;
        html += `<option value="">-</option>`;
        
        // Reutilizar a mesma lista de utilizadores
        if (AppState.utilizadores && AppState.utilizadores.length > 0) {
            const primeiroUser = AppState.utilizadores[0];
            const nomeCompletoKey = Object.keys(primeiroUser).find(k => k.toLowerCase().replace(/[_\s]/g, '') === 'nomecompleto') || 'nomeCompleto';
            
            AppState.utilizadores
                .sort((a, b) => (a[nomeCompletoKey] || '').localeCompare(b[nomeCompletoKey] || ''))
                .forEach(user => {
                    const nomeCompleto = user[nomeCompletoKey];
                    const selected = taskSegundoResponsavel === nomeCompleto ? 'selected' : '';
                    html += `<option value="${nomeCompleto}" ${selected}>${nomeCompleto}</option>`;
                });
        }
        html += `</select></td>`;
        
        html += `<td class="hours-cell"><input type="number" class="hours-input" value="${taskHours}" min="0" step="0.5" placeholder="0" data-task-id="${task.id}" onchange="updateTaskHours('${task.id}', this.value)"></td>`;
        dates.forEach(date => {
            const dateKey = formatDateKey(date), allocationKey = `${task.id}-${dateKey}`;
            const isAllocated = AppState.planning.allocations[allocationKey] === true, isWeekend = date.getDay() === 0 || date.getDay() === 6;
            const classes = ['date-cell'];
            if (isAllocated) classes.push('allocated');
            if (isWeekend) classes.push('weekend');
            // ğŸ†• v3.8.3.10.23: Adicionar classe 'preventiva' se for OT Preventiva
            if (task.tipo === 'Preventiva') classes.push('preventiva');
            html += `<td class="${classes.join(' ')}" data-task="${task.id}" data-date="${dateKey}" onclick="toggleAllocation('${task.id}', '${dateKey}')" title="Clique para alocar/desalocar"></td>`;
        });
        html += '</tr>';
    });
    html += '</tbody>';
    grid.innerHTML = html;
    
    // ğŸ¯ LOG DE DIAGNÃ“STICO: CÃ©lulas azuis
    const totalCells = document.querySelectorAll('.date-cell').length;
    const allocatedCells = document.querySelectorAll('.date-cell.allocated').length;
    console.log('ğŸ”µ CÃ‰LULAS RENDERIZADAS:', {
        totalCells,
        allocatedCells,
        percentAllocated: totalCells > 0 ? Math.round((allocatedCells / totalCells) * 100) + '%' : '0%',
        allocations: Object.keys(AppState.planning.allocations).length,
        exemplo: Object.keys(AppState.planning.allocations).slice(0, 3)
    });
}
// âœ… v3.7.0.8: Alternar alocaÃ§Ã£o de dia + guardar em diasAlocados
function toggleAllocation(taskId, dateKey) {
    const allocationKey = `${taskId}-${dateKey}`;
    
    // Toggle na estrutura antiga (compatibilidade)
    if (AppState.planning.allocations[allocationKey]) {
        delete AppState.planning.allocations[allocationKey];
    } else {
        AppState.planning.allocations[allocationKey] = true;
    }
    
    // âœ… NOVO: Atualizar estrutura nova
    if (!AppState.planning.tasks[taskId]) {
        AppState.planning.tasks[taskId] = {
            responsavel: '',
            horasEstimadas: 0,
            diasAlocados: []
        };
    }
    
    const diasArray = AppState.planning.tasks[taskId].diasAlocados;
    const index = diasArray.indexOf(dateKey);
    
    if (index > -1) {
        // Remover dia
        diasArray.splice(index, 1);
    } else {
        // Adicionar dia
        diasArray.push(dateKey);
    }
    
    renderPlanningGrid();
    savePlanningToStorage();
}
// âœ… v3.7.0.8: Atualizar horas NO PLANEAMENTO (nÃ£o na ordem de trabalho)
async function updateTaskHours(taskId, hours) {
    // ğŸ”’ VERIFICAR PERMISSÃ•ES
    if (!AppState.currentUser) {
        showToast('âŒ SessÃ£o expirada. Por favor, faÃ§a login novamente.', 'error');
        return;
    }
    
    const podeEditar = AppState.currentUser.podeEditarPlaneamento || AppState.currentUser.role === 'admin';
    if (!podeEditar) {
        showToast('ğŸ”’ Sem permissÃ£o para editar o planeamento', 'error');
        return;
    }
    
    // Inicializar objeto do task se nÃ£o existir
    if (!AppState.planning.tasks[taskId]) {
        AppState.planning.tasks[taskId] = {
            responsavel: '',
            horasEstimadas: 0,
            diasAlocados: []
        };
    }
    
    // Atualizar horas NO PLANEAMENTO
    AppState.planning.tasks[taskId].horasEstimadas = hours ? parseFloat(hours) : 0;
    savePlanningToStorage();
    
    // âœ… Sincronizar com Supabase (tabela PLANEAMENTO, nÃ£o PEDIDOS)
    if (AppState.isOnline) {
        try {
            await syncSingleTask(taskId);
            console.log('âœ… Horas sincronizadas na tabela planeamento');
        } catch (error) {
            console.error('âŒ Erro ao sincronizar horas:', error);
        }
    }
    
    showToast(`Horas atualizadas: ${hours || 0}h`, 'success');
}

// âœ… v3.7.0.8: Atualizar responsÃ¡vel NO PLANEAMENTO (nÃ£o na ordem de trabalho)
async function updateTaskResponsible(taskId, responsavel) {
    // ğŸ”’ VERIFICAR PERMISSÃ•ES
    if (!AppState.currentUser) {
        showToast('âŒ SessÃ£o expirada. Por favor, faÃ§a login novamente.', 'error');
        return;
    }
    
    const podeEditar = AppState.currentUser.podeEditarPlaneamento || AppState.currentUser.role === 'admin';
    if (!podeEditar) {
        showToast('ğŸ”’ Sem permissÃ£o para editar o planeamento', 'error');
        return;
    }
    
    // Inicializar objeto do task se nÃ£o existir
    if (!AppState.planning.tasks[taskId]) {
        AppState.planning.tasks[taskId] = {
            responsavel: '',
            segundoResponsavel: '',  // ğŸ†• v3.8.3.10.27.46
            horasEstimadas: 0,
            diasAlocados: []
        };
    }
    
    // Atualizar responsÃ¡vel NO PLANEAMENTO
    AppState.planning.tasks[taskId].responsavel = responsavel || '';
    savePlanningToStorage();
    
    // âœ… Sincronizar com Supabase (tabela PLANEAMENTO, nÃ£o PEDIDOS)
    if (AppState.isOnline) {
        try {
            await syncSingleTask(taskId);
            console.log('âœ… ResponsÃ¡vel sincronizado na tabela planeamento');
        } catch (error) {
            console.error('âŒ Erro ao sincronizar responsÃ¡vel:', error);
        }
    }
    
    renderPlanningGrid();
    showToast(`ResponsÃ¡vel atualizado: ${responsavel || 'Nenhum'}`, 'success');
}

// ğŸ†• v3.8.3.10.27.46: Atualizar 2Âº responsÃ¡vel NO PLANEAMENTO
async function updateTaskSecondResponsible(taskId, segundoResponsavel) {
    // ğŸ”’ VERIFICAR PERMISSÃ•ES
    if (!AppState.currentUser) {
        showToast('âŒ SessÃ£o expirada. Por favor, faÃ§a login novamente.', 'error');
        return;
    }
    
    const podeEditar = AppState.currentUser.podeEditarPlaneamento || AppState.currentUser.role === 'admin';
    if (!podeEditar) {
        showToast('ğŸ”’ Sem permissÃ£o para editar o planeamento', 'error');
        return;
    }
    
    // Inicializar objeto do task se nÃ£o existir
    if (!AppState.planning.tasks[taskId]) {
        AppState.planning.tasks[taskId] = {
            responsavel: '',
            segundoResponsavel: '',
            horasEstimadas: 0,
            diasAlocados: []
        };
    }
    
    // Atualizar 2Âº responsÃ¡vel NO PLANEAMENTO
    AppState.planning.tasks[taskId].segundoResponsavel = segundoResponsavel || '';
    savePlanningToStorage();
    
    // âœ… Sincronizar com Supabase (tabela PLANEAMENTO)
    if (AppState.isOnline) {
        try {
            await syncSingleTask(taskId);
            console.log('âœ… 2Âº ResponsÃ¡vel sincronizado na tabela planeamento');
        } catch (error) {
            console.error('âŒ Erro ao sincronizar 2Âº responsÃ¡vel:', error);
        }
    }
    
    renderPlanningGrid();
    showToast(`2Âº ResponsÃ¡vel atualizado: ${segundoResponsavel || 'Nenhum'}`, 'success');
}

async function savePlanning() {
    // ğŸ”’ VERIFICAR PERMISSÃ•ES
    if (!AppState.currentUser) {
        showToast('âŒ SessÃ£o expirada. Por favor, faÃ§a login novamente.', 'error');
        return;
    }
    
    const podeEditar = AppState.currentUser.podeEditarPlaneamento || AppState.currentUser.role === 'admin';
    if (!podeEditar) {
        showToast('ğŸ”’ Sem permissÃ£o para salvar o planeamento', 'error');
        return;
    }
    
    // ğŸ¯ v3.8.3.10.27.36: VALIDAÃ‡ÃƒO ANTES DE GUARDAR
    const totalTasks = Object.keys(AppState.planning.tasks || {}).length;
    const totalAllocations = Object.keys(AppState.planning.allocations || {}).length;
    
    console.log('======================================');
    console.log('ğŸ’¾ GUARDANDO PLANEAMENTO');
    console.log('ğŸ‘¤ Utilizador:', AppState.currentUser.username);
    console.log('ğŸ“Š Total de tasks:', totalTasks);
    console.log('ğŸ“Š Total de alocaÃ§Ãµes:', totalAllocations);
    console.log('======================================');
    
    if (totalTasks === 0 && totalAllocations === 0) {
        showToast('âš ï¸ Nenhum dado para guardar. Aloque dias primeiro!', 'warning');
        return;
    }
    
    // Guardar localmente
    savePlanningToStorage();
    
    // Sincronizar com Supabase
    if (AppState.isOnline) {
        try {
            await syncPlanningWithGoogleSheets();
            console.log('âœ… SincronizaÃ§Ã£o com Supabase: SUCESSO');
            showToast('ğŸ‰ Planeamento salvo e sincronizado!', 'success');
        } catch (error) {
            console.error('âŒ Erro na sincronizaÃ§Ã£o:', error);
            showToast('âš ï¸ Salvo localmente, mas erro ao sincronizar: ' + error.message, 'warning');
        }
    } else {
        showToast('ğŸ’¾ Planeamento salvo localmente (offline)', 'info');
    }
}
function savePlanningToStorage() { localStorage.setItem(CONFIG.STORAGE_KEYS.PLANNING, JSON.stringify(AppState.planning)); }
// âœ… v3.7.0.8: Carregar planeamento do Supabase
async function loadPlanningFromSupabase() {
    if (!AppState.isOnline) {
        console.log('ğŸ“¡ Offline - planeamento nÃ£o carregado do Supabase');
        return;
    }
    
    try {
        // Carregando planeamento
        
        const planningData = await window.SupabaseAPI.getPlaneamento();
        
        if (!planningData || planningData.length === 0) {
            console.log('â„¹ï¸ Nenhum planeamento encontrado no Supabase');
            return;
        }
        
        // Converter dados do Supabase â†’ AppState.planning.tasks
        AppState.planning.tasks = {};
        
        planningData.forEach(p => {
            const taskId = p['Pedido ID'];
            const diasAlocados = p['Dias Alocados'] ? JSON.parse(p['Dias Alocados']) : [];
            
            AppState.planning.tasks[taskId] = {
                responsavel: p['ResponsÃ¡vel'] || '',
                horasEstimadas: parseFloat(p['Horas Estimadas']) || 0,
                diasAlocados: diasAlocados
            };
            
            // âœ… TambÃ©m popular a estrutura antiga (allocations) para compatibilidade
            diasAlocados.forEach(dateKey => {
                const allocationKey = `${taskId}-${dateKey}`;
                AppState.planning.allocations[allocationKey] = true;
            });
        });
        
        console.log(`âœ… ${planningData.length} tasks carregados do planeamento`);
        console.log('ğŸ¯ LOAD COMPLETO:', {
            usuario: AppState.currentUser?.username,
            tasks: Object.keys(AppState.planning.tasks).length,
            alocacoes: Object.keys(AppState.planning.allocations).length,
            timestamp: new Date().toISOString()
        });
        savePlanningToStorage();  // Guardar localmente
        
    } catch (error) {
        console.error('âŒ Erro ao carregar planeamento do Supabase:', error);
    }
}

function loadPlanningFromStorage() {
    const saved = localStorage.getItem(CONFIG.STORAGE_KEYS.PLANNING);
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            AppState.planning.allocations = parsed.allocations || {};
            if (parsed.startDate) {
                AppState.planning.startDate = new Date(parsed.startDate);
                AppState.planning.endDate = new Date(parsed.endDate);
            }
        } catch (error) { console.error('Erro ao carregar planeamento:', error); }
    }
}
// âœ… v3.7.0.8: Sincronizar um Ãºnico task (quando alterar responsÃ¡vel/horas)
async function syncSingleTask(taskId) {
    // ğŸ”’ VERIFICAR PERMISSÃ•ES
    if (!AppState.currentUser) {
        console.warn('âŒ Sem sessÃ£o - sync bloqueado');
        return;
    }
    
    const podeEditar = AppState.currentUser.podeEditarPlaneamento || AppState.currentUser.role === 'admin';
    if (!podeEditar) {
        console.warn('ğŸ”’ Sem permissÃ£o para sincronizar planeamento');
        return;
    }
    
    if (!AppState.isOnline) {
        console.log('âš ï¸ Offline - task nÃ£o sincronizado');
        return;
    }
    
    try {
        const task = AppState.requests.find(r => r.id === taskId);
        const planningData = AppState.planning.tasks[taskId];
        
        if (!task || !planningData) {
            console.warn('âš ï¸ Task ou planning data nÃ£o encontrado:', taskId);
            return;
        }
        
        // Buscar se jÃ¡ existe registo para este pedido
        const existing = await window.SupabaseAPI.getPlaneamento();
        const existingTask = existing.find(p => p['Pedido ID'] === taskId);
        
        const supabaseData = {
            'Pedido ID': taskId,
            'DescriÃ§Ã£o': task.descricao,
            'Tipo': task.tipo,
            'Prioridade': task.prioridade,
            'Empresa': task.empresa,
            'ResponsÃ¡vel': planningData.responsavel || '',
            'Horas Estimadas': planningData.horasEstimadas || 0,
            'Dias Alocados': JSON.stringify(planningData.diasAlocados || []),
            'Ãšltima AtualizaÃ§Ã£o': new Date().toISOString()
        };
        
        if (existingTask) {
            // Atualizar existente
            await window.SupabaseAPI.updatePlaneamento(existingTask.ID, supabaseData);
            console.log('âœ… Task atualizado no Supabase:', taskId);
        } else {
            // Criar novo
            await window.SupabaseAPI.addPlaneamento(supabaseData);
            console.log('âœ… Task criado no Supabase:', taskId);
        }
        
    } catch (error) {
        console.error('âŒ Erro ao sincronizar task:', error);
        throw error;
    }
}

// ğŸ”¥ v3.7.0.8: Guardar planeamento completo no Supabase
async function syncPlanningWithGoogleSheets() {
    // ğŸ”’ VERIFICAR PERMISSÃ•ES
    if (!AppState.currentUser) {
        console.warn('âŒ Sem sessÃ£o - sync bloqueado');
        return;
    }
    
    const podeEditar = AppState.currentUser.podeEditarPlaneamento || AppState.currentUser.role === 'admin';
    if (!podeEditar) {
        console.warn('ğŸ”’ Sem permissÃ£o para sincronizar planeamento');
        return;
    }
    
    if (!AppState.isOnline) {
        console.log('âš ï¸ Offline - planeamento nÃ£o sincronizado');
        return;
    }
    
    try {
        console.log('ğŸ”„ Sincronizando planeamento completo com Supabase...');
        console.log('ğŸ“Š AppState.planning.tasks:', AppState.planning.tasks);
        
        // Buscar planeamentos existentes
        const existingPlanning = await window.SupabaseAPI.getPlaneamento();
        console.log('ğŸ“¥ Planeamentos existentes no Supabase:', existingPlanning.length);
        
        // Preparar dados para guardar (da NOVA estrutura)
        const tasksToSync = [];
        
        Object.keys(AppState.planning.tasks).forEach(taskId => {
            const task = AppState.requests.find(r => r.id === taskId);
            const planningData = AppState.planning.tasks[taskId];
            
            if (!task) {
                console.error(`âŒ Task ${taskId} nÃ£o encontrado em AppState.requests!`);
                return;
            }
            
            if (!planningData) {
                console.warn(`âš ï¸ Task ${taskId} sem planningData!`);
                return;
            }
            
            // âœ… SEMPRE guardar se o objeto existir (mesmo vazio)
            const responsavel = planningData.responsavel || '';
            const horas = planningData.horasEstimadas || 0;
            const dias = planningData.diasAlocados || [];
            
            console.log(`ğŸ” Task ${taskId}:`, { 
                responsavel: responsavel || '(vazio)',
                horas: horas,
                dias: dias.length
            });
            
            tasksToSync.push({
                taskId,
                data: {
                    'Pedido ID': taskId,
                    'DescriÃ§Ã£o': task.descricao,
                    'Tipo': task.tipo,
                    'Prioridade': task.prioridade,
                    'Empresa': task.empresa,
                    'ResponsÃ¡vel': responsavel,
                    'Horas Estimadas': horas,
                    'Dias Alocados': JSON.stringify(dias),
                    'Ãšltima AtualizaÃ§Ã£o': new Date().toISOString()
                }
            });
        });
        
        console.log(`ğŸ“¦ Total de tasks em AppState.planning.tasks: ${Object.keys(AppState.planning.tasks).length}`);
        console.log(`ğŸ“¦ Tasks VÃLIDOS para sincronizar: ${tasksToSync.length}`);
        
        if (tasksToSync.length > 0) {
            tasksToSync.forEach(t => {
                console.log(`  âœ ${t.taskId.substring(0, 8)}...: ${t.data['ResponsÃ¡vel'] || '(sem)'} | ${t.data['Horas Estimadas']}h | ${JSON.parse(t.data['Dias Alocados']).length} dias`);
            });
        }
        
        if (tasksToSync.length === 0) {
            console.warn('âš ï¸ Nenhum task para sincronizar!');
            console.warn('âš ï¸ Verifica se definiste responsÃ¡vel, horas ou marcaste dias');
            console.warn('ğŸ“Š AppState.planning.tasks:', Object.keys(AppState.planning.tasks).length);
            console.warn('ğŸ“Š AppState.planning.allocations:', Object.keys(AppState.planning.allocations).length);
            // ğŸ¯ v3.8.3.10.27.36: LANÃ‡AR ERRO em vez de return silencioso
            throw new Error('Nenhum task vÃ¡lido para sincronizar. Verifique se alocou dias.');
        }
        
        // Limpar planeamentos antigos que jÃ¡ nÃ£o existem
        for (const existing of existingPlanning) {
            const stillExists = tasksToSync.find(t => t.taskId === existing['Pedido ID']);
            if (!stillExists) {
                await window.SupabaseAPI.deletePlaneamento(existing.ID);
                console.log('ğŸ—‘ï¸ Planeamento removido:', existing['Pedido ID']);
            }
        }
        
        // Inserir/Atualizar planeamentos
        for (const taskData of tasksToSync) {
            const existingTask = existingPlanning.find(p => p['Pedido ID'] === taskData.taskId);
            
            if (existingTask) {
                // Atualizar
                console.log('ğŸ”„ Atualizando task:', taskData.taskId);
                await window.SupabaseAPI.updatePlaneamento(existingTask.ID, taskData.data);
            } else {
                // Criar novo
                console.log('â• Criando novo task:', taskData.taskId);
                await window.SupabaseAPI.addPlaneamento(taskData.data);
            }
            
            // ğŸ†• v3.7.6.9: Atualizar tambÃ©m o campo "ResponsÃ¡vel" na tabela "pedidos"
            if (taskData.data['ResponsÃ¡vel']) {
                console.log(`ğŸ“ Atualizando ResponsÃ¡vel em pedidos: ${taskData.taskId} â†’ ${taskData.data['ResponsÃ¡vel']}`);
                
                // Atualizar no AppState local
                const request = AppState.requests.find(r => r.id === taskData.taskId);
                if (request) {
                    request.responsavel = taskData.data['ResponsÃ¡vel'];
                    request.horasEstimadas = taskData.data['Horas Estimadas'] || 0;
                }
                
                // Atualizar no Supabase (tabela pedidos)
                try {
                    await window.SupabaseAPI.updatePedido(taskData.taskId, {
                        'ResponsÃ¡vel': taskData.data['ResponsÃ¡vel'],
                        'Horas Estimadas': taskData.data['Horas Estimadas'] || 0
                    });
                    console.log(`âœ… ResponsÃ¡vel atualizado em pedidos: ${taskData.taskId}`);
                } catch (err) {
                    console.error(`âŒ Erro ao atualizar responsÃ¡vel em pedidos:`, err);
                }
            }
        }
        
        console.log(`âœ… ${tasksToSync.length} tasks sincronizados com Supabase`);
        console.log('ğŸ¯ SYNC COMPLETO:', {
            usuario: AppState.currentUser?.username,
            tasks: tasksToSync.length,
            timestamp: new Date().toISOString()
        });
        
        // ğŸ†• v3.7.6.9: Salvar mudanÃ§as no localStorage apÃ³s atualizar responsÃ¡veis
        saveToLocalStorage();
        
        // ğŸ¯ v3.8.3.10.27.36: NÃƒO mostrar toast aqui (jÃ¡ mostrado em savePlanning)
        // showToast('Planeamento guardado com sucesso!', 'success');
        
    } catch (error) {
        console.error('âŒ Erro ao sincronizar planeamento:', error);
        console.error('âŒ Stack:', error.stack);
        showToast('Erro ao guardar planeamento: ' + error.message, 'error');
    }
}
// âŒ REMOVIDO: BotÃ£o "Exportar Excel" (05/02/2026)
// function exportPlanningToExcel() {
//     if (AppState.requests.length === 0) { showToast('NÃ£o hÃ¡ dados para exportar.', 'info'); return; }
//     try {
//         const dates = generateDateRange(), activeTasks = AppState.requests.filter(r => r.estado !== 'Resolvido');
//         const requestsData = AppState.requests.map(request => ({ 'ID': request.id, 'Data/Hora': formatDateLong(request.dataHora), 'Tipo': request.tipo, 'Prioridade': request.prioridade, 'Estado': request.estado, 'Departamento': request.departamento, 'ResponsÃ¡vel': request.responsavel || '-', 'DescriÃ§Ã£o': request.descricao, 'Registado por': request.nome, 'Tem Foto': request.foto ? 'Sim' : 'NÃ£o' }));
//         const planningData = [];
//         activeTasks.forEach(task => {
//             const row = { 'Pedido ID': task.id, 'DescriÃ§Ã£o': task.descricao, 'Tipo': task.tipo, 'Prioridade': task.prioridade, 'ResponsÃ¡vel': task.responsavel || '-', 'Horas Estimadas': task.horasEstimadas || 0 };
//             dates.forEach(date => {
//                 const dateKey = formatDateKey(date), allocationKey = `${task.id}-${dateKey}`, dayLabel = `${date.getDate()}/${date.getMonth() + 1}`;
//                 row[dayLabel] = AppState.planning.allocations[allocationKey] ? 'X' : '';
//             });
//             planningData.push(row);
//         });
//         const wb = XLSX.utils.book_new();
//         const ws1 = XLSX.utils.json_to_sheet(requestsData);
//         ws1['!cols'] = [{ wch: 36 }, { wch: 20 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 15 }, { wch: 20 }, { wch: 50 }, { wch: 20 }, { wch: 10 }];
//         XLSX.utils.book_append_sheet(wb, ws1, "Pedidos de ManutenÃ§Ã£o");
//         if (planningData.length > 0) {
//             const ws2 = XLSX.utils.json_to_sheet(planningData);
//             const cols = [{ wch: 36 }, { wch: 50 }, { wch: 12 }, { wch: 12 }, { wch: 20 }, { wch: 12 }];
//             dates.forEach(() => cols.push({ wch: 8 }));
//             ws2['!cols'] = cols;
//             XLSX.utils.book_append_sheet(wb, ws2, "Planeamento");
//         }
//         const fileName = `Manutencao_Completo_${formatDateForFilename()}.xlsx`;
//         XLSX.writeFile(wb, fileName, { bookType: 'xlsx' });
//         showToast('Excel exportado com sucesso!', 'success');
//     } catch (error) { console.error('Erro ao exportar:', error); showToast('Erro ao exportar Excel.', 'error'); }
// }
function formatDateKey(date) {
    const year = date.getFullYear(), month = String(date.getMonth() + 1).padStart(2, '0'), day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}
function formatDateShort(date) { return date.toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric' }); }
function formatDateLong2(date) { return date.toLocaleDateString('pt-PT', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' }); }

// MANUTENÃ‡Ã•ES AUTÃ“NOMAS
function initializeAutonomousMaintenance() {
    const machineSelect = document.getElementById('machineSelect');
    const closePdfBtn = document.getElementById('closePdfBtn');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const printPdfBtn = document.getElementById('printPdfBtn');
    // âŒ v3.8.3.10.27.38: openOneDriveBtn REMOVIDO (migraÃ§Ã£o para Supabase)
    
    machineSelect.addEventListener('change', function() {
        const machineKey = this.value;
        if (!machineKey) { hidePdfViewer(); return; }
        const machine = CONFIG.MACHINES[machineKey];
        if (!machine) { showToast('MÃ¡quina nÃ£o encontrada.', 'error'); return; }
        loadPdfForMachine(machineKey, machine);
    });
    
    closePdfBtn.addEventListener('click', function() { hidePdfViewer(); machineSelect.value = ''; });
    downloadPdfBtn.addEventListener('click', function() { if (currentMachine) { window.open(currentMachine.url, '_blank'); showToast('Abrindo download...', 'info'); } });
    printPdfBtn.addEventListener('click', function() {
        if (currentMachine) {
            try {
                const iframe = document.getElementById('pdfIframe');
                iframe.contentWindow.print();
            } catch (error) {
                const printWindow = window.open(currentMachine.embedUrl, '_blank');
                if (printWindow) printWindow.onload = function() { printWindow.print(); };
            }
        }
    });
    // âŒ v3.8.3.10.27.38: Event listener do openOneDriveBtn REMOVIDO (migraÃ§Ã£o para Supabase)
}

function loadPdfForMachine(machineKey, machine) {
    const pdfActions = document.getElementById('pdfActions');
    const pdfViewerContainer = document.getElementById('pdfViewerContainer');
    const pdfEmptyState = document.getElementById('pdfEmptyState');
    const pdfIframe = document.getElementById('pdfIframe');
    const pdfTitle = document.getElementById('pdfTitle');
    const pdfViewer = document.querySelector('.pdf-viewer');
    currentMachine = machine;
    pdfViewer.classList.add('loading');
    pdfEmptyState.style.display = 'none';
    pdfActions.style.display = 'flex';
    pdfViewerContainer.style.display = 'block';
    pdfTitle.textContent = `Procedimento: ${machine.name}`;
    
    // ğŸš€ v3.8.3.10.27.38: Usar embedUrl se existir (Supabase), senÃ£o usar URL antiga (OneDrive)
    const pdfUrl = machine.embedUrl || machine.url;
    pdfIframe.src = pdfUrl;
    
    console.log(`ğŸ“„ Carregando PDF: ${machine.name}`, pdfUrl);
    
    setTimeout(() => { pdfViewer.classList.remove('loading'); }, 2000);
    setTimeout(() => { pdfViewerContainer.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 300);
    showToast(`Carregando: ${machine.name}`, 'info');
}

function hidePdfViewer() {
    const pdfActions = document.getElementById('pdfActions');
    const pdfViewerContainer = document.getElementById('pdfViewerContainer');
    const pdfEmptyState = document.getElementById('pdfEmptyState');
    const pdfIframe = document.getElementById('pdfIframe');
    const pdfViewer = document.querySelector('.pdf-viewer');
    currentMachine = null;
    pdfIframe.src = '';
    pdfViewer.classList.remove('loading');
    pdfActions.style.display = 'none';
    pdfViewerContainer.style.display = 'none';
    pdfEmptyState.style.display = 'flex';
}

// ============================================
// ============================================
// MÃ“DULO DE GESTÃƒO DE STOCK
// ============================================

// ============================================
// SINCRONIZAÃ‡ÃƒO COM GOOGLE SHEETS
// ============================================

// âš¡ CACHE DE ARTIGOS (24h)
function getCachedArtigos() {
    try {
        const cached = localStorage.getItem('artigos_cache');
        const cacheTime = localStorage.getItem('artigos_cache_time');
        
        if (cached && cacheTime) {
            const age = Date.now() - parseInt(cacheTime);
            const maxAge = 24 * 60 * 60 * 1000; // 24 horas
            
            if (age < maxAge) {
                console.log('âš¡ Usando artigos do cache (idade: ' + (age / 1000 / 60).toFixed(0) + ' min)');
                return JSON.parse(cached);
            }
        }
    } catch (error) {
        console.warn('âš ï¸ Erro ao ler cache:', error);
    }
    return null;
}

function setCachedArtigos(artigos) {
    try {
        localStorage.setItem('artigos_cache', JSON.stringify(artigos));
        localStorage.setItem('artigos_cache_time', Date.now().toString());
        console.log('ğŸ’¾ Artigos guardados em cache para 24h');
    } catch (error) {
        console.warn('âš ï¸ NÃ£o foi possÃ­vel guardar cache:', error);
    }
}

// ğŸ”¥ v3.6.13: Carregar artigos do Supabase (com cache e retry)
async function loadArtigosFromGoogleSheets(retryCount = 0, forceReload = false) {
    if (!AppState.isOnline) {
        console.log('âš ï¸ Offline - usando dados locais');
        // Carregar do cache se estiver offline
        const cached = getCachedArtigos();
        if (cached && cached.length > 0) {
            AppState.artigos = cached;
            console.log('âš¡ Artigos carregados do cache:', cached.length);
            hideLoadingSpinner();
        }
        return;
    }
    
    // âš¡ TENTAR CACHE PRIMEIRO (se nÃ£o for reload forÃ§ado)
    if (!forceReload) {
        const cached = getCachedArtigos();
        if (cached && cached.length > 0) {
            AppState.artigos = cached;
            console.log('âš¡ Artigos carregados do cache:', cached.length);
            hideLoadingSpinner();
            return;
        }
    }
    
    // âš¡ MOSTRAR LOADING SPINNER
    if (retryCount === 0) {
        showLoadingSpinner('Carregando artigos do Supabase...');
    }
    
    try {
        console.log('ğŸ”„ Carregando artigos do Supabase... (tentativa ' + (retryCount + 1) + ')');
        
        const artigos = await window.SupabaseAPI.getArtigos();
        
        if (artigos && artigos.length > 0) {
            AppState.artigos = artigos.map(a => ({
                id: a.ID,
                codigo: a.ID,
                familia: a.FamÃ­lia,
                designacao: a.DesignaÃ§Ã£o,
                referencia: a.ReferÃªncia,
                fornecedor: a.Fornecedor,
                preco: parseFloat(a['PreÃ§o UnitÃ¡rio']) || 0,
                stockMinimo: parseInt(a['Stock MÃ­nimo']) || 0,
                empresa: a.Empresa,
                unidade: a.Unidade
            }));
            
            setCachedArtigos(AppState.artigos);
            // Artigos carregados
            
            hideLoadingSpinner();
            showToast(`âœ… ${AppState.artigos.length} artigos carregados com sucesso!`, 'success');
            
            // Atualizar interface se jÃ¡ estiver no tab stock
            const stockTab = document.getElementById('tab-stock');
            if (stockTab && stockTab.classList.contains('active')) {
                const searchInput = document.getElementById('stockSearchInput');
                if (searchInput && searchInput.value.length >= 2) {
                    searchArtigos(searchInput.value);
                }
            }
        } else {
            console.error('âŒ ERRO: Nenhum artigo no Supabase!');
            
            // Retry automÃ¡tico (mÃ¡ximo 2 tentativas)
            if (retryCount < 2) {
                console.warn('âš ï¸ Tentando novamente em 2 segundos...');
                setTimeout(() => loadArtigosFromGoogleSheets(retryCount + 1), 2000);
            } else {
                AppState.artigos = [];
                hideLoadingSpinner();
                showToast('âŒ Nenhum artigo encontrado. Verifique o Supabase.', 'error');
            }
        }
    } catch (error) {
        console.error('âŒ Erro ao carregar artigos do Supabase:', error);
        
        // Retry automÃ¡tico em caso de erro de rede (mÃ¡ximo 2 tentativas)
        if (retryCount < 2) {
            console.warn('âš ï¸ Tentando novamente em 2 segundos...');
            setTimeout(() => loadArtigosFromGoogleSheets(retryCount + 1), 2000);
        } else {
            AppState.artigos = [];
            hideLoadingSpinner();
            showToast('âŒ Erro ao conectar com Supabase. Verifique a configuraÃ§Ã£o.', 'error');
        }
    }
}

// ğŸ”¥ v3.6.14: Carregar movimentos do Supabase
async function loadMovimentosFromGoogleSheets() {
    // âš ï¸ Nome mantido para compatibilidade, mas usa Supabase
    if (!AppState.isOnline) {
        console.log('âš ï¸ Offline - usando dados locais');
        return;
    }
    
    try {
        console.log('ğŸ”„ Carregando movimentos do Supabase...');
        const movimentos = await window.SupabaseAPI.getMovimentos();
        
        if (movimentos && movimentos.length > 0) {
            AppState.movimentos = movimentos.map(m => ({
                id: m.ID,
                dataHora: new Date(m['Data/Hora']),
                artigoId: m['Artigo ID'],
                tipo: m.Tipo,
                quantidade: parseInt(m.Quantidade) || 0,
                pedidoId: m['Pedido ID'],
                responsavel: m.ResponsÃ¡vel,
                observacoes: m.ObservaÃ§Ãµes,
                empresa: m.Empresa
            }));
            
            // Ordenar por data (mais recentes primeiro)
            AppState.movimentos.sort((a, b) => b.dataHora - a.dataHora);
            
            // Movimentos carregados
        } else {
            console.warn('âš ï¸ Nenhum movimento no Supabase');
            AppState.movimentos = [];
        }
    } catch (error) {
        console.error('âŒ Erro ao carregar movimentos:', error);
        AppState.movimentos = [];
    }
}

// ğŸ”¥ v3.6.16: Sincronizar movimento com Supabase (CORRIGIDO)
async function syncMovimentoToGoogleSheets(movimento) {
    // âš ï¸ Nome mantido para compatibilidade, mas usa Supabase
    if (!AppState.isOnline) {
        console.log('âš ï¸ Offline - movimento serÃ¡ sincronizado depois');
        addToOfflineQueue({action: 'createMovimento', movimento: movimento});
        return null;
    }
    
    try {
        console.log('ğŸ”„ Sincronizando movimento com Supabase...');
        
        // Converter formato app â†’ formato Supabase
        const quantidadeParaSupabase = (movimento.tipo === 'SaÃ­da' || movimento.tipo === 'Baixa') 
            ? -Math.abs(movimento.quantidade)  // âœ… SaÃ­da/Baixa = negativo
            : Math.abs(movimento.quantidade);   // âœ… Entrada = positivo
        
        const supabaseMovimento = {
            'ID': movimento.id || 'MOV' + Date.now(),
            'Data/Hora': movimento.dataHora ? new Date(movimento.dataHora).toISOString() : new Date().toISOString(),
            'Artigo ID': movimento.artigoId || '',
            'Tipo': movimento.tipo || '',
            'Quantidade': String(quantidadeParaSupabase),  // âœ… Negativo para SaÃ­da/Baixa
            'Pedido ID': movimento.pedidoId || '',
            'ResponsÃ¡vel': movimento.responsavel || '',
            'ObservaÃ§Ãµes': movimento.observacoes || '',
            'Empresa': movimento.empresa || 'MCF'
        };
        
        // âœ… CORREÃ‡ÃƒO 2: Debug detalhado
        console.log('ğŸ“¤ Movimento a enviar:', JSON.stringify(supabaseMovimento, null, 2));
        
        const result = await window.SupabaseAPI.addMovimento(supabaseMovimento);
        console.log('âœ… Movimento guardado no Supabase:', result);
        
        // Recarregar movimentos para atualizar interface
        setTimeout(() => {
            loadMovimentosFromGoogleSheets();
            renderStockMinimo(); // âœ… Atualizar alertas de stock
        }, 1000);
        
        return movimento.id;
    } catch (error) {
        console.error('âŒ Erro ao sincronizar movimento:', error);
        addToOfflineQueue({action: 'createMovimento', movimento: movimento});
        showToast('Erro ao guardar movimento', 'error');
        return null;
    }
}

// ============================================
// INICIALIZAÃ‡ÃƒO DO MÃ“DULO
// ============================================

function initializeStockModule() {
    // âœ… CORRIGIDO: JÃ¡ carregado em syncWithSupabase(), nÃ£o precisa recarregar
    // loadArtigosFromGoogleSheets(); // âŒ REMOVIDO - funÃ§Ã£o nÃ£o existe
    // loadMovimentosFromGoogleSheets(); // âŒ REMOVIDO - funÃ§Ã£o nÃ£o existe
    
    // Setup event listeners
    const stockTab = document.querySelector('.tab-btn[data-tab="stock"]');
    if (stockTab) {
        stockTab.addEventListener('click', () => {
            // renderMovimentos() - removido, agora usa pesquisa
        });
    }
    
    const searchInput = document.getElementById('stockSearchInput');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchArtigos(e.target.value);
            }, 300); // Debounce de 300ms
        });
    }
    
    // ğŸ†• Event listener para pesquisa de histÃ³rico
    const historicoSearchInput = document.getElementById('historicoSearchInput');
    if (historicoSearchInput) {
        let historicoTimeout;
        historicoSearchInput.addEventListener('input', (e) => {
            clearTimeout(historicoTimeout);
            historicoTimeout = setTimeout(() => {
                searchArtigoHistorico(e.target.value);
            }, 300); // Debounce de 300ms
        });
    }
    
    // ğŸ†• Event listener para pesquisa de OT na baixa mÃºltipla
    const baixaOTSearch = document.getElementById('baixaMultiplaOTSearch');
    if (baixaOTSearch) {
        baixaOTSearch.addEventListener('input', (e) => {
            const otId = e.target.value.trim().toUpperCase();
            const otInfo = document.getElementById('baixaMultiplaOTInfo');
            
            if (otId.length > 2) {
                const ot = AppState.requests.find(r => r.id.toUpperCase().includes(otId));
                if (ot) {
                    otInfo.style.display = 'block';
                    const descricaoPreview = ot.descricao && ot.descricao.length > 60 
                        ? ot.descricao.substring(0, 60) + '...' 
                        : ot.descricao || '';
                    otInfo.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
                            <div style="flex: 1;">
                                <div style="margin-bottom: 4px;">
                                    <strong style="font-size: 15px;">${ot.id}</strong> 
                                    <span class="badge badge-tipo" style="font-size: 11px; margin-left: 8px;">${ot.tipo}</span>
                                    <span class="badge badge-estado ${ot.estado.toLowerCase()}" style="font-size: 11px; margin-left: 4px;">${ot.estado}</span>
                                </div>
                                <div style="color: #6c757d; font-size: 13px; margin-bottom: 4px;">
                                    ${ot.areaEquipamento || ''} ${ot.componente ? 'â†’ ' + ot.componente : ''}
                                </div>
                                ${descricaoPreview ? `<div style="color: #495057; font-size: 12px; font-style: italic;">"${descricaoPreview}"</div>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    otInfo.style.display = 'none';
                }
            } else {
                otInfo.style.display = 'none';
            }
        });
    }
    
    const movimentoForm = document.getElementById('movimentoForm');
    if (movimentoForm) {
        movimentoForm.addEventListener('submit', handleMovimentoSubmit);
    }
}

// ğŸ”¥ v3.7.0.9: FunÃ§Ã£o auxiliar para calcular stock atual (FIX: quantidade jÃ¡ vem com sinal)
function calcularStockAtual(artigoId) {
    const movimentosArtigo = AppState.movimentos.filter(m => m.artigoId === artigoId);
    let stockAtual = 0;
    
    // âœ… SIMPLIFICADO: Quantidade jÃ¡ vem com o sinal correto do Supabase
    // Entrada: +10
    // SaÃ­da:   -5
    // Baixa:   -3
    movimentosArtigo.forEach(mov => {
        stockAtual += mov.quantidade;  // âœ… Simplesmente somar (funciona para positivos e negativos)
    });
    
    return stockAtual;
}

// âœ… v3.7.0.9: Filtrar artigos por famÃ­lia no modal de movimento
function filtrarArtigosPorFamilia() {
    const familiaSelect = document.getElementById('movimentoFamiliaSelect');
    const artigoSelect = document.getElementById('movimentoArtigoSelect');
    
    if (!familiaSelect || !artigoSelect) return;
    
    const familiaSelecionada = familiaSelect.value;
    
    // Filtrar artigos
    let artigosFiltrados = AppState.artigos;
    if (familiaSelecionada) {
        artigosFiltrados = AppState.artigos.filter(a => a.familia === familiaSelecionada);
    }
    
    // Popular dropdown de artigos
    artigoSelect.innerHTML = '<option value="">Selecione um artigo...</option>';
    artigosFiltrados.forEach(artigo => {
        const option = document.createElement('option');
        option.value = artigo.id;
        option.textContent = `${artigo.designacao} (${artigo.referencia})`;
        artigoSelect.appendChild(option);
    });
    
    console.log(`âœ… ${artigosFiltrados.length} artigos carregados no dropdown`);
}

// âœ… v3.7.0.9: Atualizar informaÃ§Ã£o do artigo selecionado
function updateArtigoInfo() {
    const artigoSelect = document.getElementById('movimentoArtigoSelect');
    const infoDiv = document.getElementById('artigoSelectedInfo');
    
    if (!artigoSelect || !infoDiv) return;
    
    const artigoId = artigoSelect.value;
    
    if (!artigoId) {
        infoDiv.style.display = 'none';
        return;
    }
    
    const artigo = AppState.artigos.find(a => a.id === artigoId);
    if (!artigo) return;
    
    const stock = calcularStockAtual(artigoId);
    const stockDisplay = (stock !== undefined && stock !== null) ? stock : 0;
    const stockBaixo = stockDisplay <= artigo.stockMinimo;
    
    infoDiv.style.display = 'block';
    infoDiv.innerHTML = `
        <div style="padding: 12px; background: ${stockBaixo ? '#fff3cd' : '#d4edda'}; border-radius: 8px; margin: 12px 0;">
            <div style="font-weight: 600; margin-bottom: 8px;">${artigo.designacao}</div>
            <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px; font-size: 0.875rem;">
                <strong>ReferÃªncia:</strong> <span>${artigo.referencia}</span>
                <strong>Stock Atual:</strong> <span style="color: ${stockBaixo ? '#856404' : '#155724'}; font-weight: 600;">${stockDisplay} ${artigo.unidade || 'UN'}</span>
                <strong>Stock MÃ­nimo:</strong> <span>${artigo.stockMinimo} ${artigo.unidade || 'UN'}</span>
                <strong>Fornecedor:</strong> <span>${artigo.fornecedor || '-'}</span>
            </div>
            ${stockBaixo ? '<div style="margin-top: 8px; color: #856404; font-weight: 600;">âš ï¸ Stock abaixo do mÃ­nimo!</div>' : ''}
        </div>
    `;
}

// âœ… v3.7.0.9: Abrir modal de novo movimento
function openNovoMovimentoModal() {
    const modal = document.getElementById('movimentoModal');
    if (!modal) return;
    
    // Limpar formulÃ¡rio
    document.getElementById('movimentoForm')?.reset();
    document.getElementById('artigoSelectedInfo').style.display = 'none';
    
    // Popular dropdown de famÃ­lias
    const familiaSelect = document.getElementById('movimentoFamiliaSelect');
    if (familiaSelect) {
        const familias = [...new Set(AppState.artigos.map(a => a.familia))].sort();
        familiaSelect.innerHTML = '<option value="">Todas as famÃ­lias</option>';
        familias.forEach(familia => {
            const option = document.createElement('option');
            option.value = familia;
            option.textContent = familia;
            familiaSelect.appendChild(option);
        });
    }
    
    // Popular dropdown de artigos (todos)
    filtrarArtigosPorFamilia();
    
    // Preencher responsÃ¡vel com utilizador logado
    const responsavelInput = document.getElementById('movimentoResponsavel');
    if (responsavelInput && AppState.currentUser) {
        responsavelInput.value = AppState.currentUser.nomeCompleto;
    }
    
    // Abrir modal
    modal.classList.add('active');
}

// âœ… v3.7.0.9: Fechar modal de movimento
function closeMovimentoModal() {
    const modal = document.getElementById('movimentoModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

// âœ… v3.7.0.9: Ajustar quantidade com botÃµes +/-
function adjustQuantidade(delta) {
    const input = document.getElementById('movimentoQuantidade');
    if (!input) return;
    
    const currentValue = parseInt(input.value) || 1;
    const newValue = Math.max(1, currentValue + delta);
    input.value = newValue;
}

// Pesquisa de artigos
function searchArtigos(term) {
    const resultsDiv = document.getElementById('stockSearchResults');
    const resultsBody = document.getElementById('stockSearchResultsBody');
    const emptyDiv = document.getElementById('stockEmptySearch');
    
    if (!term || term.trim().length < 2) {
        resultsDiv.style.display = 'none';
        emptyDiv.style.display = 'block';
        return;
    }
    
    const searchTerm = term.toLowerCase();
    const artigos = AppState.artigos.filter(a => 
        a.designacao && a.designacao.toLowerCase().includes(searchTerm) ||
        a.referencia && a.referencia.toLowerCase().includes(searchTerm) ||
        a.id && a.id.toLowerCase().includes(searchTerm) ||
        a.fornecedor && a.fornecedor.toLowerCase().includes(searchTerm) ||
        a.familia && a.familia.toLowerCase().includes(searchTerm)
    );
    
    if (artigos.length === 0) {
        emptyDiv.style.display = 'block';
        emptyDiv.innerHTML = '<p>âŒ Nenhum artigo encontrado</p>';
        resultsDiv.style.display = 'none';
        return;
    }
    
    emptyDiv.style.display = 'none';
    resultsDiv.style.display = 'block';
    
    resultsBody.innerHTML = artigos.map(artigo => {
        const stockAtual = calcularStockAtual(artigo.id);
        const stockBaixo = stockAtual <= artigo.stockMinimo;
        const stockClass = stockBaixo ? 'baixo' : 'ok';
        const stockIcon = stockBaixo ? 'âš ï¸' : 'âœ…';
        
        return `
            <div class="stock-card">
                <div class="stock-card-header">
                    <div class="stock-card-title">${artigo.designacao}</div>
                    <div class="stock-card-ref">${artigo.referencia}</div>
                </div>
                
                <div class="stock-card-body">
                    <div class="stock-card-info">
                        <div class="stock-card-info-row">
                            <span class="stock-card-info-label">ğŸ“¦ FamÃ­lia:</span>
                            <span class="stock-card-info-value">${artigo.familia}</span>
                        </div>
                        <div class="stock-card-info-row">
                            <span class="stock-card-info-label">ğŸ¢ Fornecedor:</span>
                            <span class="stock-card-info-value">${artigo.fornecedor}</span>
                        </div>
                        <div class="stock-card-info-row">
                            <span class="stock-card-info-label">ğŸ’¶ PreÃ§o:</span>
                            <span class="stock-card-info-value">â‚¬${artigo.preco.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div class="stock-card-stock">
                        <div class="stock-card-stock-label">${stockIcon} Stock Atual</div>
                        <div class="stock-card-stock-value ${stockClass}">
                            ${stockAtual} ${artigo.unidade || 'un'}
                        </div>
                        <small style="color: var(--color-text-secondary);">MÃ­nimo: ${artigo.stockMinimo} ${artigo.unidade || 'un'}</small>
                    </div>
                </div>
                
                <div class="stock-card-footer">
                    <button class="btn btn-secondary btn-sm" onclick="darBaixaRapida('${artigo.id}')">
                        ğŸ“¤ Dar Baixa
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="openMovimentoModal('${artigo.id}')">
                        ğŸ“ Movimento
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function clearStockSearch() {
    document.getElementById('stockSearchInput').value = '';
    document.getElementById('stockSearchResults').style.display = 'none';
    document.getElementById('stockEmptySearch').style.display = 'block';
    document.getElementById('stockEmptySearch').innerHTML = '<p>ğŸ” Digite acima para procurar artigos</p>';
}

// ğŸ†• HISTÃ“RICO DE MOVIMENTOS - Pesquisar artigo
let selectedArtigoHistorico = null;

function searchArtigoHistorico(term) {
    const historicoFilters = document.getElementById('historicoFilters');
    const historicoTableContainer = document.getElementById('historicoTableContainer');
    const historicoEmptyState = document.getElementById('historicoEmptyState');
    const historicoNoMovimentos = document.getElementById('historicoNoMovimentos');
    
    // Resetar seleÃ§Ã£o
    selectedArtigoHistorico = null;
    historicoFilters.style.display = 'none';
    historicoTableContainer.style.display = 'none';
    historicoNoMovimentos.style.display = 'none';
    
    if (!term || term.trim().length < 2) {
        historicoEmptyState.style.display = 'block';
        historicoEmptyState.innerHTML = '<p>ğŸ” Digite acima para procurar um artigo e ver seu histÃ³rico</p>';
        return;
    }
    
    const searchTerm = term.toLowerCase();
    const artigos = AppState.artigos.filter(a => 
        a.designacao && a.designacao.toLowerCase().includes(searchTerm) ||
        a.referencia && a.referencia.toLowerCase().includes(searchTerm) ||
        a.id && a.id.toLowerCase().includes(searchTerm) ||
        a.fornecedor && a.fornecedor.toLowerCase().includes(searchTerm) ||
        a.familia && a.familia.toLowerCase().includes(searchTerm)
    );
    
    if (artigos.length === 0) {
        historicoEmptyState.style.display = 'block';
        historicoEmptyState.innerHTML = '<p>âŒ Nenhum artigo encontrado</p>';
        return;
    }
    
    // Se encontrou exatamente 1 artigo, selecionar automaticamente
    if (artigos.length === 1) {
        selectArtigoHistorico(artigos[0].id);
        historicoEmptyState.style.display = 'none';
        return;
    }
    
    // Se encontrou mÃºltiplos, mostrar lista para seleÃ§Ã£o
    historicoEmptyState.style.display = 'block';
    historicoEmptyState.innerHTML = `
        <div style="text-align: left;">
            <strong>ğŸ“¦ ${artigos.length} artigos encontrados - Selecione um:</strong>
            <div style="margin-top: 12px; display: flex; flex-direction: column; gap: 8px;">
                ${artigos.map(a => `
                    <button class="btn btn-secondary" onclick="selectArtigoHistorico('${a.id}')" style="text-align: left; padding: 12px;">
                        <strong>${a.designacao}</strong><br>
                        <small style="color: var(--color-text-secondary);">${a.referencia} | ${a.familia}</small>
                    </button>
                `).join('')}
            </div>
        </div>
    `;
}

// ğŸ†• Selecionar artigo e mostrar histÃ³rico
function selectArtigoHistorico(artigoId) {
    selectedArtigoHistorico = artigoId;
    const artigo = AppState.artigos.find(a => a.id === artigoId);
    
    if (!artigo) return;
    
    const historicoEmptyState = document.getElementById('historicoEmptyState');
    const historicoFilters = document.getElementById('historicoFilters');
    
    // Atualizar input com nome do artigo
    document.getElementById('historicoSearchInput').value = artigo.designacao;
    
    // Ocultar estado vazio e mostrar filtros
    historicoEmptyState.style.display = 'none';
    historicoFilters.style.display = 'block';
    
    // Renderizar movimentos
    renderMovimentosByArtigo();
}

// ğŸ†• Renderizar movimentos de um artigo especÃ­fico
function renderMovimentosByArtigo() {
    if (!selectedArtigoHistorico) return;
    
    const tbody = document.getElementById('movimentosTableBody');
    const tableContainer = document.getElementById('historicoTableContainer');
    const noMovimentos = document.getElementById('historicoNoMovimentos');
    
    const tipoFilter = document.getElementById('movimentoTipoFilter')?.value || 'TODOS';
    const limit = parseInt(document.getElementById('movimentoLimitFilter')?.value || 20);
    
    // Filtrar movimentos do artigo selecionado
    let movimentos = AppState.movimentos.filter(m => m.artigoId === selectedArtigoHistorico);
    
    // Filtrar por tipo
    if (tipoFilter !== 'TODOS') {
        movimentos = movimentos.filter(m => m.tipo === tipoFilter);
    }
    
    // Ordenar por data (mais recente primeiro)
    movimentos.sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora));
    
    // Limitar quantidade
    movimentos = movimentos.slice(0, limit);
    
    if (movimentos.length === 0) {
        tableContainer.style.display = 'none';
        noMovimentos.style.display = 'block';
        return;
    }
    
    noMovimentos.style.display = 'none';
    tableContainer.style.display = 'block';
    
    const artigo = AppState.artigos.find(a => a.id === selectedArtigoHistorico);
    
    tbody.innerHTML = movimentos.map(mov => {
        const dataFormatada = formatDateTime(mov.dataHora);
        const qtdClass = mov.quantidade > 0 ? 'positivo' : 'negativo';
        const badgeClass = mov.tipo === 'Entrada' ? 'badge-entrada' : mov.tipo === 'SaÃ­da' ? 'badge-saida' : 'badge-ajuste';
        
        return `
            <tr>
                <td><small>${dataFormatada}</small></td>
                <td><span class="badge ${badgeClass}">${mov.tipo}</span></td>
                <td>
                    <span class="quantidade-badge ${qtdClass}">
                        ${mov.quantidade > 0 ? '+' : ''}${mov.quantidade} ${artigo?.unidade || 'un'}
                    </span>
                </td>
                <td>${mov.responsavel}</td>
                <td><small>${mov.observacoes || '-'}</small></td>
                <td>
                    <div class="stock-actions">
                        <button class="btn btn-secondary btn-sm" onclick="editarMovimento('${mov.id}')" title="Editar">
                            âœï¸
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="eliminarMovimento('${mov.id}')" title="Eliminar">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// ğŸ†• Limpar pesquisa de histÃ³rico
function clearHistoricoSearch() {
    selectedArtigoHistorico = null;
    document.getElementById('historicoSearchInput').value = '';
    document.getElementById('historicoFilters').style.display = 'none';
    document.getElementById('historicoTableContainer').style.display = 'none';
    document.getElementById('historicoNoMovimentos').style.display = 'none';
    document.getElementById('historicoEmptyState').style.display = 'block';
    document.getElementById('historicoEmptyState').innerHTML = '<p>ğŸ” Digite acima para procurar um artigo e ver seu histÃ³rico</p>';
}

// ============================================
// ğŸ’° BAIXA MÃšLTIPLA DE STOCK
// ============================================

let baixaMultiplaOTSelecionada = null;
let baixaMultiplaLinhasCount = 0;

// Abrir modal de baixa mÃºltipla
function openBaixaMultiplaModal(otId = null) {
    baixaMultiplaOTSelecionada = otId;
    baixaMultiplaLinhasCount = 0;
    
    const modal = document.getElementById('baixaMultiplaModal');
    const otSearch = document.getElementById('baixaMultiplaOTSearch');
    const otInfo = document.getElementById('baixaMultiplaOTInfo');
    const linhasContainer = document.getElementById('baixaMultiplaLinhas');
    const responsavelInput = document.getElementById('baixaMultiplaResponsavel');
    
    // Resetar
    linhasContainer.innerHTML = '';
    otSearch.value = '';
    otInfo.style.display = 'none';
    document.getElementById('baixaMultiplaResumo').style.display = 'none';
    
    // Se veio de uma OT, prÃ©-preencher
    if (otId) {
        const ot = AppState.requests.find(r => r.id === otId);
        if (ot) {
            otSearch.value = otId;
            otInfo.style.display = 'block';
            const descricaoPreview = ot.descricao && ot.descricao.length > 60 
                ? ot.descricao.substring(0, 60) + '...' 
                : ot.descricao || '';
            otInfo.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
                    <div style="flex: 1;">
                        <div style="margin-bottom: 4px;">
                            <strong style="font-size: 15px;">${otId}</strong> 
                            <span class="badge badge-tipo" style="font-size: 11px; margin-left: 8px;">${ot.tipo}</span>
                            <span class="badge badge-estado ${ot.estado.toLowerCase()}" style="font-size: 11px; margin-left: 4px;">${ot.estado}</span>
                        </div>
                        <div style="color: #6c757d; font-size: 13px; margin-bottom: 4px;">
                            ${ot.areaEquipamento || ''} ${ot.componente ? 'â†’ ' + ot.componente : ''}
                        </div>
                        ${descricaoPreview ? `<div style="color: #495057; font-size: 12px; font-style: italic;">"${descricaoPreview}"</div>` : ''}
                    </div>
                </div>
            `;
            otSearch.disabled = true;
        }
    }
    
    // PrÃ©-preencher responsÃ¡vel
    if (AppState.currentUser) {
        responsavelInput.value = AppState.currentUser.nomeCompleto;
    }
    
    // Adicionar primeira linha
    adicionarLinhaBaixa();
    
    modal.classList.add('active');
}

// Fechar modal
function closeBaixaMultiplaModal() {
    document.getElementById('baixaMultiplaModal').classList.remove('active');
    baixaMultiplaOTSelecionada = null;
    baixaMultiplaLinhasCount = 0;
}

// Adicionar linha de artigo
function adicionarLinhaBaixa() {
    const container = document.getElementById('baixaMultiplaLinhas');
    const linhaId = `baixa-linha-${baixaMultiplaLinhasCount++}`;
    
    const linha = document.createElement('div');
    linha.id = linhaId;
    linha.style.cssText = 'display: grid; grid-template-columns: 1fr 2fr 1fr auto; gap: 8px; padding: 12px; background: #f8f9fa; border-radius: 8px; align-items: end;';
    
    // Obter famÃ­lias Ãºnicas
    const familias = [...new Set(AppState.artigos.filter(a => a.visivel !== false).map(a => a.familia))].sort();
    
    linha.innerHTML = `
        <div class="form-group" style="margin: 0;">
            <label class="form-label" style="font-size: 12px; margin-bottom: 4px;">ğŸ“¦ FamÃ­lia</label>
            <select class="form-input baixa-familia-select" data-linha="${linhaId}" onchange="filtrarArtigosBaixaLinha('${linhaId}')" required>
                <option value="">Escolher famÃ­lia...</option>
                ${familias.map(f => `<option value="${f}">${f}</option>`).join('')}
            </select>
        </div>
        <div class="form-group" style="margin: 0;">
            <label class="form-label" style="font-size: 12px; margin-bottom: 4px;">Artigo</label>
            <select class="form-input baixa-artigo-select" data-linha="${linhaId}" onchange="updateLinhaBaixaInfo('${linhaId}')" required disabled>
                <option value="">Escolha famÃ­lia primeiro...</option>
            </select>
            <small class="baixa-linha-info" style="display: none; margin-top: 4px; color: #6c757d;"></small>
        </div>
        <div class="form-group" style="margin: 0;">
            <label class="form-label" style="font-size: 12px; margin-bottom: 4px;">Quantidade</label>
            <input type="number" 
                   class="form-input baixa-quantidade-input" 
                   data-linha="${linhaId}"
                   min="0.01" 
                   step="0.01" 
                   value="1" 
                   onchange="calcularResumoBaixa()"
                   required>
        </div>
        <button type="button" 
                class="btn btn-secondary btn-sm" 
                onclick="removerLinhaBaixa('${linhaId}')" 
                style="height: 38px; padding: 0 12px;"
                title="Remover">
            ğŸ—‘ï¸
        </button>
    `;
    
    container.appendChild(linha);
    calcularResumoBaixa();
}

// Remover linha
function removerLinhaBaixa(linhaId) {
    const linha = document.getElementById(linhaId);
    if (linha) {
        linha.remove();
        calcularResumoBaixa();
    }
}

// Filtrar artigos por famÃ­lia na linha
function filtrarArtigosBaixaLinha(linhaId) {
    const linha = document.getElementById(linhaId);
    if (!linha) return;
    
    const familiaSelect = linha.querySelector('.baixa-familia-select');
    const artigoSelect = linha.querySelector('.baixa-artigo-select');
    const familiaSelecionada = familiaSelect.value;
    
    // Resetar artigo
    artigoSelect.innerHTML = '<option value="">Selecione um artigo...</option>';
    artigoSelect.disabled = !familiaSelecionada;
    
    if (familiaSelecionada) {
        // Filtrar artigos da famÃ­lia
        const artigosFiltrados = AppState.artigos.filter(a => 
            a.visivel !== false && a.familia === familiaSelecionada
        );
        
        artigosFiltrados.forEach(a => {
            const stock = calcularStockAtual(a.id);
            const option = document.createElement('option');
            option.value = a.id;
            option.dataset.stock = stock;
            option.dataset.preco = a.preco;
            option.dataset.unidade = a.unidade || 'un';
            option.textContent = `${a.designacao} (Stock: ${stock} ${a.unidade || 'un'})`;
            artigoSelect.appendChild(option);
        });
        
        console.log(`âœ… ${artigosFiltrados.length} artigos da famÃ­lia "${familiaSelecionada}" carregados`);
    }
    
    // Resetar info e resumo
    const info = linha.querySelector('.baixa-linha-info');
    if (info) info.style.display = 'none';
    calcularResumoBaixa();
}

// Atualizar info da linha
function updateLinhaBaixaInfo(linhaId) {
    const linha = document.getElementById(linhaId);
    if (!linha) return;
    
    const select = linha.querySelector('.baixa-artigo-select');
    const info = linha.querySelector('.baixa-linha-info');
    
    if (select.value) {
        const option = select.options[select.selectedIndex];
        const stock = option.dataset.stock;
        const preco = parseFloat(option.dataset.preco);
        const unidade = option.dataset.unidade;
        
        info.style.display = 'block';
        info.innerHTML = `Stock atual: ${stock} ${unidade} | PreÃ§o: â‚¬${preco.toFixed(2)}/${unidade}`;
        
        // Verificar stock baixo
        const artigo = AppState.artigos.find(a => a.id === select.value);
        if (artigo && parseFloat(stock) <= artigo.stockMinimo) {
            info.style.color = '#dc3545';
            info.innerHTML += ' âš ï¸ Stock baixo!';
        }
    } else {
        info.style.display = 'none';
    }
    
    calcularResumoBaixa();
}

// Calcular resumo
function calcularResumoBaixa() {
    const linhas = document.querySelectorAll('#baixaMultiplaLinhas > div');
    const resumoDiv = document.getElementById('baixaMultiplaResumo');
    const resumoConteudo = document.getElementById('baixaMultiplaResumoConteudo');
    
    let totalItens = 0;
    let custoTotal = 0;
    const artigos = [];
    
    linhas.forEach(linha => {
        const select = linha.querySelector('.baixa-artigo-select');
        const qtdInput = linha.querySelector('.baixa-quantidade-input');
        
        if (select.value && qtdInput.value) {
            const option = select.options[select.selectedIndex];
            const quantidade = parseFloat(qtdInput.value);
            const preco = parseFloat(option.dataset.preco);
            const unidade = option.dataset.unidade;
            const artigoNome = option.text.split(' (Stock:')[0];
            
            const custo = quantidade * preco;
            custoTotal += custo;
            totalItens++;
            
            artigos.push({ nome: artigoNome, quantidade, unidade, preco, custo });
        }
    });
    
    if (totalItens > 0) {
        resumoDiv.style.display = 'block';
        resumoConteudo.innerHTML = `
            <div style="display: flex; flex-direction: column; gap: 4px; margin-bottom: 8px;">
                ${artigos.map(a => `
                    <div style="display: flex; justify-content: space-between;">
                        <span>${a.nome} (${a.quantidade} ${a.unidade})</span>
                        <strong>â‚¬${a.custo.toFixed(2)}</strong>
                    </div>
                `).join('')}
            </div>
            <div style="padding-top: 8px; border-top: 2px solid #28a745; display: flex; justify-content: space-between; font-size: 16px;">
                <strong>${totalItens} ${totalItens === 1 ? 'artigo' : 'artigos'}</strong>
                <strong style="color: #dc3545;">Total: â‚¬${custoTotal.toFixed(2)}</strong>
            </div>
        `;
    } else {
        resumoDiv.style.display = 'none';
    }
}

// Confirmar baixa mÃºltipla
async function confirmarBaixaMultipla() {
    const linhas = document.querySelectorAll('#baixaMultiplaLinhas > div');
    const empresa = document.getElementById('baixaMultiplaEmpresa').value;
    const responsavel = document.getElementById('baixaMultiplaResponsavel').value;
    const observacoesGerais = document.getElementById('baixaMultiplaObservacoes').value;
    const otSearch = document.getElementById('baixaMultiplaOTSearch');
    
    // Validar
    if (!responsavel.trim()) {
        showToast('âŒ Por favor, preencha o responsÃ¡vel!', 'error');
        return;
    }
    
    const movimentos = [];
    let erro = false;
    
    linhas.forEach((linha, index) => {
        const select = linha.querySelector('.baixa-artigo-select');
        const qtdInput = linha.querySelector('.baixa-quantidade-input');
        
        if (!select.value) {
            showToast(`âŒ Linha ${index + 1}: Selecione um artigo!`, 'error');
            erro = true;
            return;
        }
        
        if (!qtdInput.value || parseFloat(qtdInput.value) <= 0) {
            showToast(`âŒ Linha ${index + 1}: Quantidade invÃ¡lida!`, 'error');
            erro = true;
            return;
        }
        
        const artigo = AppState.artigos.find(a => a.id === select.value);
        const quantidade = parseFloat(qtdInput.value);
        
        movimentos.push({
            id: 'MOV' + Date.now() + '_' + index,
            dataHora: new Date().toISOString(),
            artigoId: artigo.id,
            tipo: 'SaÃ­da',
            quantidade: -quantidade,  // Negativo para saÃ­da
            empresa: empresa,
            pedidoId: otSearch.value.trim() || '',  // ğŸ”¥ ID da OT (ou vazio)
            responsavel: responsavel,
            observacoes: observacoesGerais || `Baixa mÃºltipla - ${artigo.designacao}`
        });
    });
    
    if (erro || movimentos.length === 0) {
        return;
    }
    
    // Confirmar
    const totalMovimentos = movimentos.length;
    if (!confirm(`Confirmar baixa de ${totalMovimentos} ${totalMovimentos === 1 ? 'artigo' : 'artigos'}?`)) {
        return;
    }
    
    try {
        // Processar todos os movimentos
        for (const movimento of movimentos) {
            AppState.movimentos.unshift(movimento);
            
            // Sincronizar com Supabase
            const syncedId = await syncMovimentoToGoogleSheets(movimento);
            if (syncedId) {
                movimento.id = syncedId;
            }
        }
        
        saveToLocalStorage();
        showToast(`âœ… ${totalMovimentos} ${totalMovimentos === 1 ? 'artigo dado' : 'artigos dados'} baixa com sucesso!`, 'success');
        
        // Atualizar histÃ³rico se necessÃ¡rio
        if (selectedArtigoHistorico) {
            renderMovimentosByArtigo();
        }
        
        // Recarregar OT se estava aberta
        if (baixaMultiplaOTSelecionada) {
            closeModal();
            setTimeout(() => openRequestDetails(baixaMultiplaOTSelecionada), 300);
        }
        
        closeBaixaMultiplaModal();
        
    } catch (error) {
        console.error('âŒ Erro ao processar baixas:', error);
        showToast('âŒ Erro ao processar baixas!', 'error');
    }
}

// Dar baixa rÃ¡pida
async function darBaixaRapida(artigoId) {
    const artigo = AppState.artigos.find(a => a.id === artigoId);
    if (!artigo) return;
    
    const stockAtual = calcularStockAtual(artigoId);
    const quantidade = prompt(`Dar baixa de ${artigo.designacao}\n\nStock atual: ${stockAtual} ${artigo.unidade || 'un'}\n\nQuantidade a dar baixa:`, '1');
    
    if (!quantidade || isNaN(quantidade) || parseInt(quantidade) <= 0) {
        return;
    }
    
    const qtd = parseInt(quantidade);
    
    if (qtd > artigo.stockAtual) {
        alert(`âŒ Quantidade invÃ¡lida!\n\nStock disponÃ­vel: ${artigo.stockAtual} ${artigo.unidade}\nQuantidade solicitada: ${qtd} ${artigo.unidade}`);
        return;
    }
    
    const responsavel = prompt('ResponsÃ¡vel:', '');
    const observacoes = prompt('ObservaÃ§Ãµes (opcional):', '');
    
    // Registar movimento
    const movimento = {
        id: 'MOV' + Date.now(),
        dataHora: new Date(),
        artigoId: artigo.id,
        tipo: 'SaÃ­da',
        quantidade: -qtd,
        empresa: 'MCF',
        pedidoId: '',
        responsavel: responsavel || '-',
        observacoes: observacoes || 'Baixa rÃ¡pida'
    };
    
    AppState.movimentos.unshift(movimento);
    artigo.stockAtual -= qtd;
    
    // âœ… SINCRONIZAR COM GOOGLE SHEETS
    const syncedId = await syncMovimentoToGoogleSheets(movimento);
    if (syncedId) {
        movimento.id = syncedId;
    }
    
    showToast(`âœ… Baixa registada: ${qtd} ${artigo.unidade} de ${artigo.designacao}`, 'success');
    
    // Atualizar visualizaÃ§Ãµes
    searchArtigos(document.getElementById('stockSearchInput').value);
    if (selectedArtigoHistorico) {
        renderMovimentosByArtigo(); // Atualizar histÃ³rico se tiver artigo selecionado
    }
    saveToLocalStorage();
}

// Renderizar movimentos
// ğŸ†• FunÃ§Ã£o antiga removida - agora usa renderMovimentosByArtigo()

// âœ… v3.6.16: Renderizar alertas de stock mÃ­nimo (CORRIGIDO)
function renderStockMinimo() {
    const container = document.getElementById('stockMinimoContent');
    if (!container) return;
    
    // ğŸ†• v3.8.3.10.1: Debug logs
    console.log('ğŸ” [STOCK ALERTS] Calculando alertas de stock...');
    console.log('ğŸ“¦ Total de artigos:', AppState.artigos.length);
    
    // Filtrar artigos abaixo do mÃ­nimo (calcular stock em tempo real)
    const alertas = AppState.artigos.filter(a => {
        const stockAtual = calcularStockAtual(a.id);
        const temAlerta = a.stockMinimo > 0 && stockAtual < a.stockMinimo;
        if (temAlerta) {
            console.log(`âš ï¸ Alerta: ${a.designacao} - Atual: ${stockAtual}, MÃ­nimo: ${a.stockMinimo}`);
        }
        return temAlerta;
    });
    
    console.log(`ğŸ“Š Total de alertas: ${alertas.length}`);
    
    // Atualizar badge no botÃ£o da tab Stock
    const badge = document.getElementById('stockAlertBadge');
    if (badge) {
        if (alertas.length > 0) {
            console.log(`âœ… Badge atualizado: ${alertas.length}`);
            badge.textContent = alertas.length;
            badge.style.display = 'inline-block';
        } else {
            console.log('âœ… Badge escondido (sem alertas)');
            badge.style.display = 'none';
        }
    } else {
        console.error('âŒ Elemento #stockAlertBadge nÃ£o encontrado!');
    }
    
    // Se nÃ£o hÃ¡ alertas, mostrar mensagem positiva
    if (alertas.length === 0) {
        container.innerHTML = `
            <div class="empty-state-small" style="color: var(--color-success); background: #e8f5e9; padding: var(--spacing-lg); border-radius: 8px; text-align: center;">
                <div style="font-size: 2rem; margin-bottom: 8px;">âœ…</div>
                <strong>Todos os stocks estÃ£o acima do mÃ­nimo!</strong>
                <p style="margin-top: 8px; color: var(--color-text-secondary);">Nenhum artigo requer atenÃ§Ã£o imediata.</p>
            </div>
        `;
        return;
    }
    
    // Ordenar por criticidade: stock=0 primeiro, depois por % de falta
    alertas.sort((a, b) => {
        const stockAtualA = calcularStockAtual(a.id);
        const stockAtualB = calcularStockAtual(b.id);
        if (stockAtualA === 0 && stockAtualB !== 0) return -1;
        if (stockAtualA !== 0 && stockAtualB === 0) return 1;
        const faltaA = (a.stockMinimo - stockAtualA) / a.stockMinimo;
        const faltaB = (b.stockMinimo - stockAtualB) / b.stockMinimo;
        return faltaB - faltaA;
    });
    
    // Renderizar tabela
    let html = `
        <div style="margin-bottom: var(--spacing-md); padding: var(--spacing-sm); background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
            <strong>âš ï¸ ${alertas.length} artigo(s) abaixo do stock mÃ­nimo</strong>
        </div>
        <div class="stock-table-container" style="max-height: 500px; overflow-y: auto;">
            <table class="stock-table">
                <thead>
                    <tr>
                        <th style="min-width: 200px;">Artigo</th>
                        <th style="min-width: 120px;">FamÃ­lia</th>
                        <th style="text-align: center; min-width: 100px;">Stock Atual</th>
                        <th style="text-align: center; min-width: 100px;">Stock MÃ­nimo</th>
                        <th style="text-align: center; min-width: 80px;">Falta</th>
                        <th style="text-align: center; min-width: 100px;">Status</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    alertas.forEach(artigo => {
        const stockAtual = calcularStockAtual(artigo.id);
        const falta = artigo.stockMinimo - stockAtual;
        const isCritico = stockAtual === 0;
        const statusClass = isCritico ? 'badge-critico' : 'badge-alerta';
        const statusIcon = isCritico ? 'ğŸ”´' : 'âš ï¸';
        const statusText = isCritico ? 'CrÃ­tico' : 'Baixo';
        
        html += `
            <tr style="${isCritico ? 'background: #ffebee;' : ''}">
                <td>
                    <strong>${artigo.designacao}</strong><br>
                    <small style="color: var(--color-text-secondary);">Ref: ${artigo.referencia}</small>
                </td>
                <td>${artigo.familia}</td>
                <td style="text-align: center;">
                    <strong style="color: ${isCritico ? '#d32f2f' : '#f57c00'}; font-size: 1.1rem;">
                        ${stockAtual}
                    </strong>
                </td>
                <td style="text-align: center;">${artigo.stockMinimo}</td>
                <td style="text-align: center;">
                    <strong style="color: #d32f2f;">-${falta}</strong>
                </td>
                <td style="text-align: center;">
                    <span class="badge ${statusClass}">${statusIcon} ${statusText}</span>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

function formatDateTime(date) {
    const d = new Date(date);
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = d.getFullYear();
    const hours = String(d.getHours()).padStart(2, '0');
    const minutes = String(d.getMinutes()).padStart(2, '0');
    return `${day}/${month}/${year} ${hours}:${minutes}`;
}

// Editar movimento
async function editarMovimento(movId) {
    const mov = AppState.movimentos.find(m => m.id === movId);
    if (!mov) return;
    
    const artigo = AppState.artigos.find(a => a.id === mov.artigoId);
    
    const novaQtd = prompt(`Editar Movimento\n\nArtigo: ${artigo ? artigo.designacao : mov.artigoId}\nTipo: ${mov.tipo}\nQuantidade atual: ${mov.quantidade}\n\nNova quantidade:`, Math.abs(mov.quantidade));
    
    if (!novaQtd || isNaN(novaQtd)) return;
    
    const qtd = parseInt(novaQtd);
    const novasObs = prompt('ObservaÃ§Ãµes:', mov.observacoes);
    
    // Reverter movimento antigo
    if (artigo) {
        artigo.stockAtual -= mov.quantidade;
    }
    
    // Aplicar novo movimento
    const diferencaQtd = (mov.tipo === 'SAÃDA' ? -Math.abs(qtd) : Math.abs(qtd)) - mov.quantidade;
    mov.quantidade = mov.tipo === 'SAÃDA' ? -Math.abs(qtd) : Math.abs(qtd);
    mov.observacoes = novasObs || mov.observacoes;
    
    if (artigo) {
        artigo.stockAtual += mov.quantidade;
    }
    
    // âš ï¸ NOTA: Google Sheets nÃ£o suporta ediÃ§Ã£o direta de movimentos
    // SoluÃ§Ã£o: Criar novo movimento de ajuste com a diferenÃ§a
    if (AppState.isOnline && diferencaQtd !== 0) {
        const movimentoAjuste = {
            artigoId: mov.artigoId,
            tipo: 'AJUSTE',
            quantidade: diferencaQtd,
            responsavel: 'Sistema',
            observacoes: `Ajuste por ediÃ§Ã£o do movimento ${movId}`
        };
        await syncMovimentoToGoogleSheets(movimentoAjuste);
    }
    
    showToast('âœ… Movimento atualizado!', 'success');
    if (selectedArtigoHistorico) {
        renderMovimentosByArtigo(); // Atualizar histÃ³rico se tiver artigo selecionado
    }
    searchArtigos(document.getElementById('stockSearchInput').value);
    saveToLocalStorage();
}

// Eliminar movimento
async function eliminarMovimento(movId) {
    if (!confirm('Tem a certeza que deseja eliminar este movimento?')) return;
    
    const mov = AppState.movimentos.find(m => m.id === movId);
    if (!mov) return;
    
    const artigo = AppState.artigos.find(a => a.id === mov.artigoId);
    
    // Reverter o movimento no stock
    if (artigo) {
        artigo.stockAtual -= mov.quantidade;
    }
    
    // âš ï¸ NOTA: Google Sheets nÃ£o suporta eliminaÃ§Ã£o direta de movimentos
    // SoluÃ§Ã£o: Criar movimento de ajuste inverso
    if (AppState.isOnline) {
        const movimentoInverso = {
            artigoId: mov.artigoId,
            tipo: 'AJUSTE',
            quantidade: -mov.quantidade, // Inverso
            responsavel: 'Sistema',
            observacoes: `ReversÃ£o por eliminaÃ§Ã£o do movimento ${movId}`
        };
        await syncMovimentoToGoogleSheets(movimentoInverso);
    }
    
    // Remover movimento localmente
    AppState.movimentos = AppState.movimentos.filter(m => m.id !== movId);
    
    showToast('âœ… Movimento eliminado!', 'success');
    if (selectedArtigoHistorico) {
        renderMovimentosByArtigo(); // Atualizar histÃ³rico se tiver artigo selecionado
    }
    searchArtigos(document.getElementById('stockSearchInput').value);
    saveToLocalStorage();
}

async function handleMovimentoSubmit(e) {
    e.preventDefault();
    
    if (!AppState.artigoSelecionado) return;
    
    const tipo = document.getElementById('movimentoTipo').value;
    let quantidade = parseInt(document.getElementById('movimentoQuantidade').value);
    const empresa = document.getElementById('movimentoEmpresa').value;
    const responsavel = document.getElementById('movimentoResponsavel').value || '-';
    const observacoes = document.getElementById('movimentoObservacoes').value || '';
    
    // âœ… v3.6.17: Normalizar tipo para formato do Supabase
    let tipoNormalizado = tipo;
    if (tipo === 'SAÃDA') tipoNormalizado = 'SaÃ­da';
    else if (tipo === 'ENTRADA') tipoNormalizado = 'Entrada';
    else if (tipo === 'BAIXA') tipoNormalizado = 'Baixa';
    
    // Quantidade sempre positiva (o tipo define entrada/saÃ­da)
    quantidade = Math.abs(quantidade);
    
    const artigo = AppState.artigos.find(a => a.id === AppState.artigoSelecionado.id);
    if (!artigo) {
        showToast('âŒ Artigo nÃ£o encontrado', 'error');
        return;
    }
    
    // âœ… Verificar stock atual ANTES de permitir saÃ­da
    const stockAtual = calcularStockAtual(artigo.id);
    
    // âš ï¸ PERMITIR STOCK NEGATIVO (para identificar erros de inventÃ¡rio)
    if (tipoNormalizado === 'SaÃ­da' || tipoNormalizado === 'Baixa') {
        const novoStock = stockAtual - quantidade;
        if (novoStock < 0) {
            console.warn(`âš ï¸ Stock ficarÃ¡ negativo: ${stockAtual} - ${quantidade} = ${novoStock}`);
            // NÃƒO bloquear - permitir para identificar erros
        }
    }
    
    // Registar movimento
    const movimento = {
        id: 'MOV' + Date.now(),
        dataHora: new Date().toISOString(),
        artigoId: artigo.id,
        tipo: tipoNormalizado,  // âœ… Usar tipo normalizado
        quantidade: quantidade,  // âœ… Sempre positivo
        empresa: empresa,
        pedidoId: '',
        responsavel: responsavel,
        observacoes: observacoes
    };
    
    AppState.movimentos.unshift(movimento);
    
    // âœ… SINCRONIZAR COM SUPABASE
    try {
        const syncedId = await syncMovimentoToGoogleSheets(movimento);
        if (syncedId) {
            movimento.id = syncedId;
        }
        
        // Mostrar notificaÃ§Ã£o
        const novoStock = calcularStockAtual(artigo.id);
        showToast(`âœ… Movimento registado: ${tipoNormalizado} de ${quantidade} ${artigo.unidade || 'un'}. Stock atual: ${novoStock}`, 'success');
        
        // Fechar modal
        closeMovimentoModal();
        
        // Re-renderizar
        if (selectedArtigoHistorico) {
            renderMovimentosByArtigo(); // Atualizar histÃ³rico se tiver artigo selecionado
        }
        searchArtigos(document.getElementById('stockSearchInput').value);
        saveToLocalStorage();
        
    } catch (error) {
        console.error('âŒ Erro ao registar movimento:', error);
        showToast('âŒ Erro ao guardar movimento', 'error');
    }
}

// EXPOSIÃ‡ÃƒO GLOBAL
window.openRequestDetails = openRequestDetails;
window.closeModal = closeModal;
window.changeRequestState = changeRequestState;
window.deleteRequest = deleteRequest;
window.clearImagePreview = clearImagePreview;
window.toggleAllocation = toggleAllocation;
window.updateTaskHours = updateTaskHours;
// âŒ REMOVIDO - FunÃ§Ã£o nÃ£o existe
// window.openMovimentoModal = openMovimentoModal;
// window.closeMovimentoModal = closeMovimentoModal;
window.adjustQuantidade = adjustQuantidade;
window.updateArtigoInfo = updateArtigoInfo;
window.filtrarArtigosPorFamilia = filtrarArtigosPorFamilia;
window.searchArtigos = searchArtigos;
window.clearStockSearch = clearStockSearch;
window.darBaixaRapida = darBaixaRapida;
// âŒ REMOVIDO - FunÃ§Ã£o foi substituÃ­da por renderMovimentosByArtigo()
// window.renderMovimentos = renderMovimentos;
window.editarMovimento = editarMovimento;
window.eliminarMovimento = eliminarMovimento;
window.openNovoMovimentoModal = openNovoMovimentoModal;

// ================================================
// ğŸ“Š TAB ANÃLISE - v3.7.0
// ================================================

// VariÃ¡veis globais dos grÃ¡ficos
let chartPedidosPorSemana = null;
let chartEvolucaoBacklog = null;
let chartPedidosPorUtilizador = null;  // âœ… v3.7.0.9: NOVO grÃ¡fico
let chartTiposIntervencao = null;  // ğŸ†• v3.7.6.9: Pie chart tipos de intervenÃ§Ã£o

// âœ… PerÃ­odo selecionado para grÃ¡fico por utilizador (em dias)
let periodoUtilizadorSelecionado = 7; // Default: Ãºltima semana

// ===================================
// FUNÃ‡Ã•ES DE PROCESSAMENTO DE DADOS
// ===================================

/**
 * Obter nÃºmero da semana do ano (ISO 8601)
 */
function getWeekNumber(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

/**
 * Formatar data da semana (ex: "Sem 47 (18-24 Nov)")
 */
function formatWeekLabel(year, week) {
    // Calcular o primeiro dia da semana
    const simple = new Date(year, 0, 1 + (week - 1) * 7);
    const dow = simple.getDay();
    const ISOweekStart = simple;
    if (dow <= 4)
        ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
    else
        ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
    
    const endWeek = new Date(ISOweekStart);
    endWeek.setDate(endWeek.getDate() + 6);
    
    const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
    
    return `Sem ${week} (${ISOweekStart.getDate()} ${months[ISOweekStart.getMonth()]})`;
}

/**
 * Processar dados de ordens de trabalho por semana
 */
function processarDadosPorSemana(numSemanas = 12, empresaFiltro = '') {
    const hoje = new Date();
    const anoAtual = hoje.getFullYear();
    const semanaAtual = getWeekNumber(hoje);
    
    // Criar array de semanas
    const semanas = [];
    for (let i = numSemanas - 1; i >= 0; i--) {
        let ano = anoAtual;
        let semana = semanaAtual - i;
        
        if (semana <= 0) {
            ano--;
            semana += 52; // AproximaÃ§Ã£o (52 semanas por ano)
        }
        
        semanas.push({
            ano,
            semana,
            label: formatWeekLabel(ano, semana),
            abertos: 0,
            fechados: 0
        });
    }
    
    // Filtrar pedidos
    const pedidosFiltrados = empresaFiltro 
        ? AppState.requests.filter(r => r.empresa === empresaFiltro)
        : AppState.requests;
    
    // Contar pedidos por semana
    pedidosFiltrados.forEach(pedido => {
        const data = new Date(pedido.dataHora);
        const ano = data.getFullYear();
        const semana = getWeekNumber(data);
        
        const semanaData = semanas.find(s => s.ano === ano && s.semana === semana);
        if (semanaData) {
            semanaData.abertos++;
            if (pedido.estado === 'Resolvido') {
                semanaData.fechados++;
            }
        }
    });
    
    return semanas;
}

/**
 * Processar evoluÃ§Ã£o do backlog
 */
function processarEvolucaoBacklog(numSemanas = 12, empresaFiltro = '') {
    const hoje = new Date();
    const anoAtual = hoje.getFullYear();
    const semanaAtual = getWeekNumber(hoje);
    
    // Criar array de semanas
    const semanas = [];
    for (let i = numSemanas - 1; i >= 0; i--) {
        let ano = anoAtual;
        let semana = semanaAtual - i;
        
        if (semana <= 0) {
            ano--;
            semana += 52;
        }
        
        semanas.push({
            ano,
            semana,
            label: formatWeekLabel(ano, semana),
            backlog: 0
        });
    }
    
    // Filtrar pedidos
    const pedidosFiltrados = empresaFiltro 
        ? AppState.requests.filter(r => r.empresa === empresaFiltro)
        : AppState.requests;
    
    // Calcular backlog acumulado por semana
    semanas.forEach((semanaData, index) => {
        // Contar pedidos abertos atÃ© esta semana que ainda nÃ£o foram resolvidos
        const backlog = pedidosFiltrados.filter(pedido => {
            const dataPedido = new Date(pedido.dataHora);
            const anoPedido = dataPedido.getFullYear();
            const semanaPedido = getWeekNumber(dataPedido);
            
            // Pedido foi criado antes ou na semana atual?
            const criadoAntes = (anoPedido < semanaData.ano) || 
                               (anoPedido === semanaData.ano && semanaPedido <= semanaData.semana);
            
            // Pedido ainda nÃ£o estÃ¡ resolvido OU foi resolvido depois desta semana?
            const naoResolvido = pedido.estado !== 'Resolvido';
            
            return criadoAntes && naoResolvido;
        }).length;
        
        semanaData.backlog = backlog;
    });
    
    return semanas;
}

/**
 * Calcular mÃ©tricas da semana atual
 */
function calcularMetricasSemana(empresaFiltro = '') {
    const hoje = new Date();
    const anoAtual = hoje.getFullYear();
    const semanaAtual = getWeekNumber(hoje);
    
    // Filtrar pedidos
    const pedidosFiltrados = empresaFiltro 
        ? AppState.requests.filter(r => r.empresa === empresaFiltro)
        : AppState.requests;
    
    // Contar ordens de trabalho desta semana
    const pedidosEstaSemana = pedidosFiltrados.filter(p => {
        const data = new Date(p.dataHora);
        return data.getFullYear() === anoAtual && getWeekNumber(data) === semanaAtual;
    });
    
    // âœ… v3.8.3.10.27.9: Abertos = TODAS as OTs criadas esta semana (independente do estado)
    const abertos = pedidosEstaSemana.length;
    // Fechados = OTs que foram FECHADAS esta semana (estado mudou para Resolvido)
    const fechados = pedidosEstaSemana.filter(p => p.estado === 'Resolvido').length;
    
    // Calcular backlog total atual (todos os pedidos nÃ£o resolvidos)
    const backlogTotal = pedidosFiltrados.filter(p => p.estado !== 'Resolvido').length;
    
    // TendÃªncia do backlog (comparar com semana anterior)
    const semanaAnterior = processarEvolucaoBacklog(2, empresaFiltro);
    const backlogAnterior = semanaAnterior.length >= 2 ? semanaAnterior[0].backlog : backlogTotal;
    const tendencia = backlogTotal - backlogAnterior;
    
    return {
        abertos,
        fechados,
        backlogTotal,
        tendencia
    };
}

/**
 * âœ… v3.7.0.9: Processar pedidos fechados por utilizador
 * @param {string} empresaFiltro - Filtro por empresa
 * @param {number} dias - NÃºmero de dias a considerar (7, 30, 180, 365)
 */
function processarPedidosPorUtilizador(empresaFiltro = '', dias = 7) {
    const hoje = new Date();
    const dataLimite = new Date(hoje);
    dataLimite.setDate(dataLimite.getDate() - dias);
    
    // Filtrar pedidos
    const pedidosFiltrados = empresaFiltro 
        ? AppState.requests.filter(r => r.empresa === empresaFiltro)
        : AppState.requests;
    
    // Pedidos fechados no perÃ­odo
    const pedidosFechados = pedidosFiltrados.filter(p => {
        const data = new Date(p.dataHora);
        return p.estado === 'Resolvido' && data >= dataLimite;
    });
    
    // ğŸ†• v3.7.6.9: Contar por quem FECHOU (nÃ£o por quem foi alocado)
    const porUtilizador = {};
    pedidosFechados.forEach(p => {
        // Prioridade 1: Fechado Por | Fallback: ResponsÃ¡vel (OTs antigas)
        const quemFechou = p.fechadoPor || p.responsavel || 'Sem responsÃ¡vel';
        porUtilizador[quemFechou] = (porUtilizador[quemFechou] || 0) + 1;
    });
    
    // Converter para array e ordenar
    const dados = Object.entries(porUtilizador)
        .map(([nome, count]) => ({ nome, count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 10); // Top 10
    
    return dados;
}

// ===================================
// FUNÃ‡Ã•ES DE RENDERIZAÃ‡ÃƒO DE GRÃFICOS
// ===================================

/**
 * Criar/atualizar grÃ¡fico de ordens de trabalho por semana
 */
function renderizarGraficoPedidosPorSemana(dados) {
    try {
        const ctx = document.getElementById('chartPedidosPorSemana');
        if (!ctx) {
            console.error('âŒ Canvas chartPedidosPorSemana nÃ£o encontrado!');
            return;
        }
        
        // Destruir grÃ¡fico anterior se existir
        if (chartPedidosPorSemana) {
            chartPedidosPorSemana.destroy();
        }
        
        if (typeof Chart === 'undefined') {
            console.error('âŒ Chart.js nÃ£o estÃ¡ carregado!');
            return;
        }
        
        chartPedidosPorSemana = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: dados.map(d => d.label),
            datasets: [
                {
                    label: 'Ordens Abertas',
                    data: dados.map(d => d.abertos),
                    backgroundColor: 'rgba(255, 152, 0, 0.7)',
                    borderColor: 'rgba(255, 152, 0, 1)',
                    borderWidth: 2,
                    borderRadius: 6
                },
                {
                    label: 'Ordens Fechadas',
                    data: dados.map(d => d.fechados),
                    backgroundColor: 'rgba(76, 175, 80, 0.7)',
                    borderColor: 'rgba(76, 175, 80, 1)',
                    borderWidth: 2,
                    borderRadius: 6
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: {
                            family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto',
                            size: 12
                        },
                        padding: 15,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: {
                        size: 14
                    },
                    bodyFont: {
                        size: 13
                    },
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y + ' pedidos';
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 11
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    });
    } catch (error) {
        console.error('âŒ Erro ao renderizar grÃ¡fico por semana:', error);
    }
}

/**
 * Criar/atualizar grÃ¡fico de evoluÃ§Ã£o do backlog
 */
function renderizarGraficoEvolucaoBacklog(dados) {
    try {
        const ctx = document.getElementById('chartEvolucaoBacklog');
        if (!ctx) {
            console.error('âŒ Canvas chartEvolucaoBacklog nÃ£o encontrado!');
            return;
        }
    
    // Destruir grÃ¡fico anterior se existir
    if (chartEvolucaoBacklog) {
        chartEvolucaoBacklog.destroy();
    }
    
    chartEvolucaoBacklog = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dados.map(d => d.label),
            datasets: [
                {
                    label: 'Backlog (Ordens Pendentes)',
                    data: dados.map(d => d.backlog),
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    borderColor: 'rgba(33, 150, 243, 1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: 'rgba(33, 150, 243, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: {
                            family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto',
                            size: 12
                        },
                        padding: 15,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: {
                        size: 14
                    },
                    bodyFont: {
                        size: 13
                    },
                    callbacks: {
                        label: function(context) {
                            return 'Backlog: ' + context.parsed.y + ' pedidos';
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 11
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    });
    } catch (error) {
        console.error('âŒ Erro ao renderizar grÃ¡fico backlog:', error);
    }
}

/**
 * âœ… v3.7.0.9: Criar/atualizar grÃ¡fico de ordens de trabalho fechadas por utilizador
 */
function renderizarGraficoPedidosPorUtilizador(dados) {
    try {
        const ctx = document.getElementById('chartPedidosPorUtilizador');
        if (!ctx) {
            console.error('âŒ Canvas chartPedidosPorUtilizador nÃ£o encontrado!');
            return;
        }
    
    // Destruir grÃ¡fico anterior se existir
    if (chartPedidosPorUtilizador) {
        chartPedidosPorUtilizador.destroy();
    }
    
    if (dados.length === 0) {
        // Mostrar mensagem se nÃ£o hÃ¡ dados
        ctx.parentElement.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Nenhuma ordem de trabalho fechada esta semana</p>';
        return;
    }
    
    chartPedidosPorUtilizador = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: dados.map(d => d.nome),
            datasets: [
                {
                    label: 'Ordens Fechadas',
                    data: dados.map(d => d.count),
                    backgroundColor: 'rgba(76, 175, 80, 0.7)',
                    borderColor: 'rgba(76, 175, 80, 1)',
                    borderWidth: 2,
                    borderRadius: 6
                }
            ]
        },
        options: {
            indexAxis: 'y',  // Horizontal bar
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: {
                        size: 14
                    },
                    bodyFont: {
                        size: 13
                    },
                    callbacks: {
                        label: function(context) {
                            return context.parsed.x + ' pedidos fechados';
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 11
                        }
                    }
                }
            }
        }
    });
    } catch (error) {
        console.error('âŒ Erro ao renderizar grÃ¡fico por utilizador:', error);
    }
}

/**
 * ğŸ†• v3.7.6.9: Renderizar Pie Chart de Tipos de IntervenÃ§Ã£o
 */
function renderizarGraficoTiposIntervencao() {
    try {
        const ctx = document.getElementById('chartTiposIntervencao');
        if (!ctx) {
            console.error('âŒ Canvas chartTiposIntervencao nÃ£o encontrado!');
            return;
        }
        
        // Destruir grÃ¡fico anterior se existir
        if (chartTiposIntervencao) {
            chartTiposIntervencao.destroy();
        }
        
        // Contar tipos de intervenÃ§Ã£o em TODOS os pedidos
        const tiposCount = {};
        let totalPedidos = 0;
        
        AppState.requests.forEach(pedido => {
            const tipo = pedido.tipoIntervencao || 'NÃ£o especificado';
            tiposCount[tipo] = (tiposCount[tipo] || 0) + 1;
            totalPedidos++;
        });
        
        // Ordenar por quantidade (decrescente)
        const tiposOrdenados = Object.entries(tiposCount)
            .sort((a, b) => b[1] - a[1]);
        
        if (tiposOrdenados.length === 0) {
            ctx.parentElement.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Nenhum pedido com tipo de intervenÃ§Ã£o definido</p>';
            return;
        }
        
        // Cores para o pie chart
        const cores = [
            'rgba(255, 99, 132, 0.8)',   // Vermelho
            'rgba(54, 162, 235, 0.8)',   // Azul
            'rgba(255, 206, 86, 0.8)',   // Amarelo
            'rgba(75, 192, 192, 0.8)',   // Verde-Ã¡gua
            'rgba(153, 102, 255, 0.8)',  // Roxo
            'rgba(255, 159, 64, 0.8)',   // Laranja
            'rgba(201, 203, 207, 0.8)'   // Cinza
        ];
        
        chartTiposIntervencao = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: tiposOrdenados.map(([tipo, count]) => {
                    const percentagem = ((count / totalPedidos) * 100).toFixed(1);
                    return `${tipo} (${percentagem}%)`;
                }),
                datasets: [{
                    data: tiposOrdenados.map(([_, count]) => count),
                    backgroundColor: tiposOrdenados.map((_, index) => cores[index % cores.length]),
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: {
                                size: 12
                            },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        const percentagem = ((value / totalPedidos) * 100).toFixed(1);
                                        return {
                                            text: `${label.split(' (')[0]}: ${value} (${percentagem}%)`,
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: {
                            size: 14
                        },
                        bodyFont: {
                            size: 13
                        },
                        callbacks: {
                            label: function(context) {
                                const tipo = tiposOrdenados[context.dataIndex][0];
                                const count = context.parsed;
                                const percentagem = ((count / totalPedidos) * 100).toFixed(1);
                                return `${tipo}: ${count} pedidos (${percentagem}%)`;
                            }
                        }
                    }
                }
            }
        });
        
        console.log('âœ… GrÃ¡fico de tipos de intervenÃ§Ã£o renderizado:', tiposOrdenados);
        
    } catch (error) {
        console.error('âŒ Erro ao renderizar grÃ¡fico de tipos de intervenÃ§Ã£o:', error);
    }
}

/**
 * Atualizar cards de mÃ©tricas
 */
function atualizarCardsMetricas(metricas) {
    // Abertos esta semana
    const abertosEl = document.getElementById('abertosEstaSemana');
    if (abertosEl) {
        abertosEl.textContent = metricas.abertos || 0;
    }
    
    // Fechados esta semana
    const fechadosEl = document.getElementById('fechadosEstaSemana');
    if (fechadosEl) {
        fechadosEl.textContent = metricas.fechados || 0;
    }
    
    // Backlog total
    const backlogEl = document.getElementById('backlogTotal');
    if (backlogEl) {
        backlogEl.textContent = metricas.backlogTotal || 0;
    }
    
    // TendÃªncia do backlog
    const trendEl = document.getElementById('backlogTrend');
    if (trendEl) {
        if (metricas.tendencia > 0) {
            trendEl.innerHTML = `<span style="color: #FF3B30;">â†‘ +${metricas.tendencia} vs semana anterior</span>`;
        } else if (metricas.tendencia < 0) {
            trendEl.innerHTML = `<span style="color: #34C759;">â†“ ${metricas.tendencia} vs semana anterior</span>`;
        } else {
            trendEl.innerHTML = `<span style="color: var(--color-text-secondary);">â†’ Sem alteraÃ§Ã£o</span>`;
        }
    }
}

/**
 * FunÃ§Ã£o principal para atualizar anÃ¡lises
 */
window.atualizarAnalises = function() {
    try {
        // Verificar se hÃ¡ pedidos
        if (!AppState.requests || AppState.requests.length === 0) {
            // Mostrar 0 nos cards se nÃ£o houver dados
            document.getElementById('abertosEstaSemana').textContent = '0';
            document.getElementById('fechadosEstaSemana').textContent = '0';
            document.getElementById('backlogTotal').textContent = '0';
            return;
        }
        
        // Obter filtros
        const empresaFiltro = document.getElementById('analiseEmpresaFilter')?.value || '';
        const numSemanas = 12; // ğŸ†• v3.8.3.8: Fixo (select removido - usam-se os botÃµes de filtro)
        
        // Processar dados
        const dadosPorSemana = processarDadosPorSemana(numSemanas, empresaFiltro);
        const dadosBacklog = processarEvolucaoBacklog(numSemanas, empresaFiltro);
        const dadosPorUtilizador = processarPedidosPorUtilizador(empresaFiltro, periodoUtilizadorSelecionado);
        const metricas = calcularMetricasSemana(empresaFiltro);
        
        console.log('âœ… MÃ©tricas calculadas:', metricas);
        
        // Renderizar grÃ¡ficos
        renderizarGraficoPedidosPorSemana(dadosPorSemana);
        renderizarGraficoEvolucaoBacklog(dadosBacklog);
        renderizarGraficoPedidosPorUtilizador(dadosPorUtilizador);
        renderizarGraficoTiposIntervencao();  // ğŸ†• v3.7.6.9: Pie chart
        
        // Atualizar mÃ©tricas
        atualizarCardsMetricas(metricas);
        
        showToast('âœ… AnÃ¡lises atualizadas!', 'success');
        
    } catch (error) {
        console.error('âŒ Erro em atualizarAnalises():', error);
        showToast('âŒ Erro ao atualizar anÃ¡lises: ' + error.message, 'error');
    }
};

/**
 * âœ… Filtrar grÃ¡fico por utilizador por perÃ­odo
 */
window.filtrarPorUtilizadorPeriodo = function(dias) {
    // Atualizar variÃ¡vel global
    periodoUtilizadorSelecionado = dias;
    
    // Atualizar botÃµes ativos
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (parseInt(btn.getAttribute('data-period')) === dias) {
            btn.classList.add('active');
        }
    });
    
    // Reprocessar dados e atualizar grÃ¡fico
    const empresaFiltro = document.getElementById('analiseEmpresaFilter')?.value || '';
    const dadosPorUtilizador = processarPedidosPorUtilizador(empresaFiltro, dias);
    renderizarGraficoPedidosPorUtilizador(dadosPorUtilizador);
    
    // Atualizar tÃ­tulo do grÃ¡fico com perÃ­odo
    const titulos = {
        1: 'Ãšltimo Dia',
        7: 'Ãšltima Semana',
        30: 'Ãšltimo MÃªs',
        180: 'Ãšltimos 6 Meses',
        365: 'Ãšltimo Ano'
    };
    console.log(`ğŸ“Š GrÃ¡fico atualizado: ${titulos[dias]}`);
};

// ===================================
// CHATBOT COM GEMINI AI
// ===================================

// URL do Cloudflare Worker (serÃ¡ configurado depois)
const CHATBOT_WORKER_URL = 'https://chatbot-manutencao.goncalobarata.workers.dev/chat';

// ============================================
// ğŸ†• v3.7.6.10: CONFIGURAÃ‡ÃƒO OPENAI EMBEDDINGS
// ============================================

/**
 * ğŸ” API Key da OpenAI para gerar embeddings
 * IMPORTANTE: Esta Ã© uma chave de DESENVOLVIMENTO
 * Para PRODUÃ‡ÃƒO, deve estar no Cloudflare Worker (server-side)
 * 
 * ROLLBACK: Comente estas linhas e mude USE_EMBEDDINGS para false
 */
const OPENAI_API_KEY = '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'; // âœ… v3.7.6.10
const OPENAI_EMBEDDINGS_MODEL = 'text-embedding-3-small'; // Modelo mais barato
const USE_EMBEDDINGS = false; // ğŸ”„ v3.7.6.10: DESATIVADO (API key com erro 401)

/**
 * ğŸ†• v3.8.3: Detectar menÃ§Ãµes de tabelas/figuras/diagramas no texto
 * Retorna array de objetos: { match, type, number, page, startIndex, endIndex }
 */
function detectarMencoesTabelas(texto) {
    const mencoes = [];
    
    // PadrÃµes de detecÃ§Ã£o (ordem de prioridade)
    const padroes = [
        // "Tabela 6" ou "Tabela 6:" ou "Tabela 6 (pÃ¡g. 3)"
        /\b(Tabela|tabela)\s+(\d+)(?:\s*(?:\(|:|\s*-\s*)?(?:pÃ¡g?\.?\s*|pÃ¡gina\s*)?(\d+)?)?/gi,
        // "Figura 31" ou "Figura 31:"
        /\b(Figura|figura)\s+(\d+)(?:\s*(?:\(|:|\s*-\s*)?(?:pÃ¡g?\.?\s*|pÃ¡gina\s*)?(\d+)?)?/gi,
        // "diagrama" ou "Diagrama"
        /\b(diagrama|Diagrama)(?:\s+(\d+))?(?:\s*(?:\(|:|\s*-\s*)?(?:pÃ¡g?\.?\s*|pÃ¡gina\s*)?(\d+)?)?/gi,
        // "pÃ¡gina 3" ou "pÃ¡g. 3" (genÃ©rico)
        /(?:pÃ¡gina|pÃ¡g\.?)\s*(\d+)/gi
    ];
    
    padroes.forEach((regex, patternIndex) => {
        let match;
        const regexCopy = new RegExp(regex.source, regex.flags);
        while ((match = regexCopy.exec(texto)) !== null) {
            const type = match[1]?.toLowerCase() || 'page';
            const number = parseInt(match[2]) || null;
            const page = parseInt(match[3]) || null;
            
            mencoes.push({
                match: match[0],
                type: type,
                number: number,
                page: page,
                startIndex: match.index,
                endIndex: match.index + match[0].length,
                priority: patternIndex // Para ordenar por prioridade
            });
        }
    });
    
    // Ordenar por posiÃ§Ã£o no texto (e prioridade se mesma posiÃ§Ã£o)
    mencoes.sort((a, b) => {
        if (a.startIndex !== b.startIndex) return a.startIndex - b.startIndex;
        return a.priority - b.priority;
    });
    
    console.log(`ğŸ” [MENCOES] Detectadas ${mencoes.length} menÃ§Ã£o(Ãµes) de tabelas/figuras:`, mencoes);
    return mencoes;
}

/**
 * ğŸ†• v3.8.3: Fazer matching inteligente entre menÃ§Ãµes e imagens
 * Retorna mapa: { startIndex: imageObject }
 */
function matchMencoesComImagens(mencoes, imagens) {
    const matches = {};
    const imagensUsadas = new Set();
    
    console.log(`ğŸ¯ [MATCHING] Tentando match de ${mencoes.length} menÃ§Ãµes com ${imagens.length} imagens`);
    
    mencoes.forEach((mencao, mencaoIdx) => {
        // Tentar encontrar imagem correspondente
        let melhorMatch = null;
        let melhorScore = -1;
        
        imagens.forEach((img, imgIdx) => {
            if (imagensUsadas.has(imgIdx)) return; // JÃ¡ usada
            
            let score = 0;
            
            // Extrair nÃºmero de pÃ¡gina do URL da imagem
            // Ex: page_003_table_00.png â†’ pÃ¡gina 3
            const pageMatch = img.url.match(/page_(\d+)_/);
            const imgPage = pageMatch ? parseInt(pageMatch[1]) : null;
            
            // Extrair tipo e Ã­ndice do URL
            // Ex: page_003_table_01.png â†’ table, Ã­ndice 1
            const typeMatch = img.url.match(/_(table|diagram)_(\d+)/);
            const imgType = typeMatch ? typeMatch[1] : null;
            const imgIndex = typeMatch ? parseInt(typeMatch[2]) : 0;
            
            // SCORING: quanto maior, melhor o match
            
            // 1. Match de pÃ¡gina (mais importante)
            if (mencao.page && imgPage && mencao.page === imgPage) {
                score += 100; // Match exato de pÃ¡gina!
            }
            
            // 2. Match de tipo (table vs diagram)
            if (mencao.type && imgType) {
                if (mencao.type === 'tabela' && imgType === 'table') score += 50;
                if (mencao.type === 'figura' && imgType === 'table') score += 30;
                if (mencao.type === 'diagrama' && imgType === 'diagram') score += 50;
            }
            
            // 3. Match de nÃºmero (Tabela 6 â†’ Ã­ndice 0 se for a 6Âª tabela mencionada)
            if (mencao.number && imgIndex === mencaoIdx) {
                score += 20;
            }
            
            // 4. Proximidade no array (preferir imagens prÃ³ximas)
            score += (10 - Math.abs(mencaoIdx - imgIdx));
            
            if (score > melhorScore) {
                melhorScore = score;
                melhorMatch = { img, imgIdx, score };
            }
        });
        
        if (melhorMatch && melhorMatch.score > 0) {
            matches[mencao.startIndex] = melhorMatch.img;
            imagensUsadas.add(melhorMatch.imgIdx);
            console.log(`  âœ… Match: "${mencao.match}" â†’ ${melhorMatch.img.url} (score: ${melhorMatch.score})`);
        } else {
            console.log(`  âš ï¸ Sem match para: "${mencao.match}"`);
        }
    });
    
    console.log(`ğŸ¯ [MATCHING] ${Object.keys(matches).length} matches realizados`);
    return matches;
}

/**
 * ğŸ†• v3.8.3: Inserir imagens inline no texto baseado em menÃ§Ãµes
 */
function inserirImagensInline(texto, imagens) {
    if (!imagens || imagens.length === 0) {
        console.log('â„¹ï¸ [INLINE] Sem imagens para inserir');
        return { texto, imagensInseridas: [], imagensRestantes: [] };
    }
    
    // 1. Detectar menÃ§Ãµes de tabelas/figuras
    const mencoes = detectarMencoesTabelas(texto);
    
    if (mencoes.length === 0) {
        console.log('â„¹ï¸ [INLINE] Nenhuma menÃ§Ã£o detectada, imagens vÃ£o para o final');
        return { texto, imagensInseridas: [], imagensRestantes: imagens };
    }
    
    // 2. Fazer matching inteligente
    const matches = matchMencoesComImagens(mencoes, imagens);
    
    // 3. Inserir imagens inline (de trÃ¡s para frente para nÃ£o alterar Ã­ndices)
    const mencoesOrdenadas = mencoes.sort((a, b) => b.startIndex - a.startIndex);
    const imagensInseridas = [];
    
    mencoesOrdenadas.forEach(mencao => {
        const img = matches[mencao.startIndex];
        if (img) {
            // Inserir logo apÃ³s a menÃ§Ã£o
            const insercao = `\n\n${img.emoji} [${img.type.toUpperCase()}]: ${img.url}\n`;
            texto = texto.slice(0, mencao.endIndex) + insercao + texto.slice(mencao.endIndex);
            imagensInseridas.push(img);
        }
    });
    
    // 4. Identificar imagens que sobraram (nÃ£o foram inseridas)
    const imagensRestantes = imagens.filter(img => !imagensInseridas.includes(img));
    
    console.log(`âœ… [INLINE] ${imagensInseridas.length} imagens inseridas inline`);
    console.log(`ğŸ“‹ [INLINE] ${imagensRestantes.length} imagens restantes (vÃ£o para o final)`);
    
    return { texto, imagensInseridas, imagensRestantes };
}

/**
 * Adicionar mensagem ao histÃ³rico do chat
 */
function adicionarMensagemChat(mensagem, tipo = 'user') {
    const history = document.getElementById('chatbotHistory');
    if (!history) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `chatbot-message chatbot-message-${tipo}`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'chatbot-message-content';
    
    // ğŸ†• v3.7.6.0: Detectar e renderizar imagens de tabelas/diagramas
    // Formato: ğŸ“Š [TABLE 1]: https://...url.../page_049_table_00.png
    console.log('ğŸ” [DEBUG-CHAT] Mensagem recebida (primeiros 300 chars):', mensagem.substring(0, 300));
    console.log('ğŸ” [DEBUG-CHAT] Procurando por URLs de imagens...');
    
    // ğŸ†• v3.8.2.15: Remover emojis desnecessÃ¡rios (simplificaÃ§Ã£o)
    
    // ğŸ†• v3.8.2.5: ATIVAR PARSER INLINE (inserir imagens contextualizadas)
    console.log('ğŸ–¼ï¸ [INLINE] Iniciando processamento de imagens inline...');
    
    // ğŸ†• v3.8.3.10.19: FIX - Aceita texto adicional dentro de [] (ex: [ANEXO 3 - Esquema ElÃ©trico 1])
    const imageRegex = /[ğŸ“ŠğŸ–¼ï¸âš¡ğŸ“ï¿½\uFFFD]*\s*\[(TABLE|TABELA|DIAGRAM|FIGURA|ESQUEMA|ANEXO)[^\]]*\]:\s*(https?:\/\/[^\s\)]+?\.(?:png|jpg|jpeg|gif|webp))/gi;
    //                                                                                  ^^^^^^^^^                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    //                                                                                  Aceita QUALQUER texto apÃ³s o tipo   Captura URL COMPLETA atÃ© extensÃ£o
    const imagesFound = [];
    let mensagemProcessada = mensagem;
    
    let match;
    while ((match = imageRegex.exec(mensagem)) !== null) {
        const [fullMatch, type, url] = match;
        console.log('âœ… [DEBUG-CHAT] Imagem encontrada:', { type, url });
        imagesFound.push({ type, url, fullMatch });
    }
    
    console.log('ğŸ“Š [DEBUG-CHAT] Total de imagens encontradas:', imagesFound.length);
    
    // ğŸ†• v3.8.2.12: SUBSTITUIR URLs por <img> INLINE (no lugar dos URLs!)
    let mensagemComImagensInline = mensagemProcessada;
    
    // Remover ï¿½ isolados (sem URL) que Gemini inseriu no meio do texto
    mensagemComImagensInline = mensagemComImagensInline.replace(/ï¿½\s*/g, '');
    mensagemComImagensInline = mensagemComImagensInline.replace(/\uFFFD\s*/g, ''); // Unicode replacement char
    
    // SUBSTITUIR URLs de imagens por <img> tags INLINE!
    if (imagesFound.length > 0 && tipo === 'assistant') {
        console.log(`ğŸ–¼ï¸ [INLINE-v3.8.2.12] Substituindo ${imagesFound.length} URLs por <img> inline...`);
        
        imagesFound.forEach(({ type, url, fullMatch }) => {
            // ğŸ†• v3.8.3.10.13: Limpar URL (remover ) . , no final)
            const cleanUrl = url.replace(/[\)\.,;]+$/, '');
            
            // ğŸ†• v3.8.3.10.17: DEBUG - Ver URL COMPLETA antes de inserir no HTML
            console.log(`   ğŸ” [DEBUG] URL original:`, url);
            console.log(`   ğŸ” [DEBUG] URL limpa:`, cleanUrl);
            console.log(`   ğŸ” [DEBUG] URL.length:`, cleanUrl.length);
            
            // ğŸ†• v3.8.2.15: HTML SIMPLES sem emojis (tÃ­tulo limpo!)
            const imageHtml = `<div style="margin: 15px 0; border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px; background: #f9f9f9;"><div style="font-size: 12px; color: #666; margin-bottom: 5px; font-weight: 500;">${type.charAt(0) + type.slice(1).toLowerCase()}</div><img src="${cleanUrl}" alt="${type}" style="max-width: 100%; height: auto; border-radius: 4px; cursor: pointer;" onclick="window.open('${cleanUrl}', '_blank')" title="Clique para ampliar"></div>`;
            
            // ğŸ†• v3.8.3.10.19: Regex aceita texto adicional dentro de [] (ex: [ANEXO 3 - Esquema ElÃ©trico 1])
            const safeRegex = new RegExp(
                `[ğŸ“ŠğŸ–¼ï¸âš¡ğŸ“ï¿½\\uFFFD]*\\s*\\[${type}[^\\]]*\\]:\\s*` + cleanUrl.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\$&') + '[\\)\\.,;]*',
                'gi'
            );
            
            // Substituir (remove emoji + URL, insere <img> limpa)
            mensagemComImagensInline = mensagemComImagensInline.replace(safeRegex, imageHtml);
            console.log(`   âœ… SubstituÃ­do: ${fullMatch.substring(0, 50)}... â†’ <img>`);
        });
        
        console.log(`âœ… [INLINE-v3.8.2.12] ${imagesFound.length} imagens inseridas inline (no lugar dos URLs)!`);
    }
    
    // Suportar markdown bÃ¡sico (negrito, itÃ¡lico, listas)
    let htmlContent = mensagemComImagensInline
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n- /g, '\nâ€¢ ')
        .replace(/\n/g, '<br>');
    
    contentDiv.innerHTML = htmlContent;
    
    messageDiv.appendChild(contentDiv);
    history.appendChild(messageDiv);
    
    // Scroll para baixo
    history.scrollTop = history.scrollHeight;
}

/**
 * Mostrar/esconder status de loading
 */
function mostrarChatbotStatus(mostrar = true, mensagemCustom = null) {
    const status = document.getElementById('chatbotStatus');
    if (status) {
        status.style.display = mostrar ? 'flex' : 'none';
        
        // ğŸ†• v3.8.2.19: Mensagem customizada para retry
        if (mensagemCustom) {
            const statusText = status.querySelector('.status-text');
            if (statusText) {
                statusText.textContent = mensagemCustom;
            }
        } else {
            const statusText = status.querySelector('.status-text');
            if (statusText) {
                statusText.textContent = 'A processar...';
            }
        }
    }
}

/**
 * Preparar contexto dos dados para o chatbot
 * âœ… v3.7.1.9 - CONTEXTO ADAPTATIVO (envia apenas dados relevantes Ã  pergunta)
 */
async function prepararContextoDados(pergunta = '') {
    const agora = new Date();
    const umMesAtras = new Date(agora.getTime() - 30 * 24 * 60 * 60 * 1000);
    const umaSemanaAtras = new Date(agora.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    // ===================================
    // 1. RESUMO GERAL (sempre enviado)
    // ===================================
    const totalPedidos = AppState.requests.length;
    const pedidosAbertos = AppState.requests.filter(p => p.estado !== 'Resolvido').length;
    const pedidosResolvidos = AppState.requests.filter(p => p.estado === 'Resolvido').length;
    
    // Por empresa
    const pedidosMCF = AppState.requests.filter(p => p.empresa === 'MCF').length;
    const pedidosPSY = AppState.requests.filter(p => p.empresa === 'PSY').length;
    
    // Por tipo
    const tipos = {};
    AppState.requests.forEach(p => {
        tipos[p.tipo] = (tipos[p.tipo] || 0) + 1;
    });
    
    // Top Ã¡reas (Ãºltimos 30 dias)
    const pedidosRecentes = AppState.requests.filter(p => {
        const dataPedido = new Date(p.dataHora);
        return dataPedido >= umMesAtras;
    });
    
    const areas = {};
    pedidosRecentes.forEach(p => {
        if (p.areaEquipamento) {
            areas[p.areaEquipamento] = (areas[p.areaEquipamento] || 0) + 1;
        }
    });
    const topAreas = Object.entries(areas)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(([area, count]) => `${area}: ${count} pedidos`);
    
    // ===================================
    // 2. CONTEXTO ADAPTATIVO (baseado na pergunta)
    // ===================================
    const perguntaLower = pergunta.toLowerCase();
    let pedidosFiltrados = [];
    let filtroAplicado = 'geral';
    
    // ğŸ” Detectar EQUIPAMENTO/ÃREA especÃ­fica
    const equipamentosMencionados = Object.keys(areas).filter(area => 
        perguntaLower.includes(area.toLowerCase())
    );
    
    if (equipamentosMencionados.length > 0) {
        // âœ… Filtrar por equipamento mencionado
        pedidosFiltrados = AppState.requests.filter(p => 
            equipamentosMencionados.some(eq => 
                p.areaEquipamento && p.areaEquipamento.toLowerCase().includes(eq.toLowerCase())
            )
        ).slice(0, 30);  // MÃ¡ximo 30 pedidos do equipamento
        filtroAplicado = `equipamento: ${equipamentosMencionados.join(', ')}`;
    }
    // ğŸ” Detectar EMPRESA (MCF ou PSY)
    else if (perguntaLower.includes('mcf') && !perguntaLower.includes('psy')) {
        pedidosFiltrados = AppState.requests
            .filter(p => p.empresa === 'MCF')
            .slice(0, 20);
        filtroAplicado = 'empresa: MCF';
    }
    else if (perguntaLower.includes('psy') && !perguntaLower.includes('mcf')) {
        pedidosFiltrados = AppState.requests
            .filter(p => p.empresa === 'PSY')
            .slice(0, 20);
        filtroAplicado = 'empresa: PSY';
    }
    // ğŸ” Detectar URGENTES
    else if (perguntaLower.includes('urgente') || perguntaLower.includes('prioridade')) {
        pedidosFiltrados = AppState.requests
            .filter(p => p.urgente === 'Sim' || p.prioridade === 'Alta')
            .slice(0, 20);
        filtroAplicado = 'urgentes/prioridade alta';
    }
    // ğŸ” Detectar PERÃODO (Ãºltima semana, mÃªs, etc.)
    else if (perguntaLower.includes('Ãºltima semana') || perguntaLower.includes('ultima semana')) {
        pedidosFiltrados = AppState.requests
            .filter(p => new Date(p.dataHora) >= umaSemanaAtras)
            .slice(0, 30);
        filtroAplicado = 'Ãºltima semana';
    }
    else if (perguntaLower.includes('Ãºltimo mÃªs') || perguntaLower.includes('ultimo mes')) {
        pedidosFiltrados = pedidosRecentes.slice(0, 30);
        filtroAplicado = 'Ãºltimo mÃªs';
    }
    // ğŸ” Detectar ABERTOS
    else if (perguntaLower.includes('aberto') || perguntaLower.includes('pendente')) {
        pedidosFiltrados = AppState.requests
            .filter(p => p.estado !== 'Resolvido')
            .slice(0, 20);
        filtroAplicado = 'pedidos abertos';
    }
    // ğŸ” Perguntas GERAIS (estatÃ­sticas)
    else if (perguntaLower.includes('quantos') || perguntaLower.includes('total') || 
             perguntaLower.includes('resumo') || perguntaLower.includes('geral')) {
        // âœ… NÃƒO enviar pedidos detalhados, apenas estatÃ­sticas
        pedidosFiltrados = [];
        filtroAplicado = 'estatÃ­sticas apenas';
    }
    // ğŸ” Default: Ãºltimos 10 pedidos (se nenhum filtro)
    else {
        pedidosFiltrados = AppState.requests
            .sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora))
            .slice(0, 10);
        filtroAplicado = 'Ãºltimos 10 pedidos';
    }
    
    // Mapear campos mÃ­nimos
    const pedidosParaEnviar = pedidosFiltrados.map(p => ({
        id: p.id,
        tipo: p.tipo,
        area: p.areaEquipamento,
        empresa: p.empresa,
        estado: p.estado,
        prioridade: p.prioridade,
        urgente: p.urgente,
        data: p.dataHora
    }));
    
    console.log(`ğŸ¤– Contexto adaptativo: ${filtroAplicado} (${pedidosParaEnviar.length} pedidos)`);
    
    // ===================================
    // 3. RETORNAR CONTEXTO
    // ===================================
    return {
        resumo: {
            total: totalPedidos,
            abertos: pedidosAbertos,
            resolvidos: pedidosResolvidos,
            mcf: pedidosMCF,
            psy: pedidosPSY,
            taxaResolucao: totalPedidos > 0 ? Math.round((pedidosResolvidos / totalPedidos) * 100) : 0
        },
        tipos,
        topAreas,
        // âœ… NOVO: Pedidos filtrados baseados na pergunta
        pedidosRelevantes: pedidosParaEnviar,
        filtroAplicado: filtroAplicado,
        // EstatÃ­sticas do Ãºltimo mÃªs
        ultimoMes: {
            total: pedidosRecentes.length,
            abertos: pedidosRecentes.filter(p => p.estado !== 'Resolvido').length,
            fechados: pedidosRecentes.filter(p => p.estado === 'Resolvido').length
        },
        // ğŸ“š MANUAIS: Adicionar se mencionados na pergunta
        // ğŸ†• v3.8.3.9: Detectar equipamentos mencionados dos MANUAIS (nÃ£o sÃ³ de pedidos)
        manuais: await buscarManuaisRelevantes(pergunta, await detectarEquipamentosManuais(pergunta, equipamentosMencionados))
    };
}

/**
 * ğŸ†• v3.8.3.9: Detectar equipamentos mencionados na pergunta (de manuais E pedidos)
 */
async function detectarEquipamentosManuais(pergunta, equipamentosDePedidos = []) {
    const perguntaLower = pergunta.toLowerCase();
    const equipamentosDosManuais = [];
    
    // Verificar se hÃ¡ manuais carregados
    if (AppState.manuais && AppState.manuais.length > 0) {
        AppState.manuais
            .filter(m => m.ativo)
            .forEach(m => {
                // Verificar equipamento_nome (ex: "Alinhadeira")
                if (m.equipamento_nome && perguntaLower.includes(m.equipamento_nome.toLowerCase())) {
                    equipamentosDosManuais.push(m.equipamento_nome);
                }
                // Verificar equipamento_area (ex: "L04")
                if (m.equipamento_area && perguntaLower.includes(m.equipamento_area.toLowerCase())) {
                    equipamentosDosManuais.push(m.equipamento_area);
                }
            });
    }
    
    console.log('ğŸ” [CONTEXTO] Equipamentos de pedidos:', equipamentosDePedidos);
    console.log('ğŸ” [CONTEXTO] Equipamentos de manuais:', equipamentosDosManuais);
    
    // Combinar e remover duplicados
    const todosEquipamentos = [...new Set([...equipamentosDePedidos, ...equipamentosDosManuais])];
    console.log('ğŸ” [CONTEXTO] Todos equipamentos detectados:', todosEquipamentos);
    
    return todosEquipamentos;
}

/**
 * ğŸ†• v3.7.6.13: Cache de keywords do Supabase
 */
let cachedKeywords = null;

/**
 * ğŸ†• v3.8.0: Cache de padrÃµes de auto-tagging
 */
let cachedAutoTagPatterns = null;

/**
 * ğŸ†• v3.7.6.13: Carregar keywords do Supabase
 */
async function carregarKeywords() {
    if (cachedKeywords) {
        return cachedKeywords; // Usar cache se disponÃ­vel
    }
    
    try {
        // ğŸ†• v3.8.2: Usar supabaseFetch em vez de window.supabase.rpc
        const data = await supabaseFetch('rpc/get_chatbot_keywords', {
            method: 'POST',
            body: JSON.stringify({})
        });
        
        if (!data || Object.keys(data).length === 0) {
            console.warn('âš ï¸ [KEYWORDS] Nenhuma keyword retornada, usando padrÃ£o');
            return getKeywordsPadrao();
        }
        
        cachedKeywords = data;
        console.log('âœ… [KEYWORDS] Carregadas do Supabase:', Object.keys(data));
        return data;
        
    } catch (err) {
        console.error('âŒ [KEYWORDS] Erro ao buscar keywords:', err);
        console.warn('â„¹ï¸ [KEYWORDS] Usando keywords padrÃ£o (fallback)');
        return getKeywordsPadrao();
    }
}

/**
 * ğŸ†• v3.7.6.13: Keywords padrÃ£o (fallback)
 */
function getKeywordsPadrao() {
    console.log('â„¹ï¸ [KEYWORDS] Usando keywords padrÃ£o (fallback) - AVISAR ADMIN para configurar no Supabase!');
    return {
        'lubrificacao': ['lubrific', 'Ã³leo', 'graxa', 'lubrificaÃ§Ã£o', 'chumaceira', 'engrenagem', 'Ã³leo hidrÃ¡ulico'],
        'manutencao': ['manutenÃ§Ã£o', 'preventiva', 'corretiva', 'inspeÃ§Ã£o', 'verificaÃ§Ã£o', 'limpeza', 'correia', 'correias', 'esticamento', 'tensÃ£o', 'tensao', 'ajuste', 'substituiÃ§Ã£o', 'troca', 'tracÃ§Ã£o', 'traccao'],
        'operacao': ['operaÃ§Ã£o', 'funcionamento', 'ligar', 'desligar', 'arranque', 'paragem', 'instalaÃ§Ã£o', 'instalacao'],
        'seguranca': ['seguranÃ§a', 'perigo', 'aviso', 'proteÃ§Ã£o', 'epi', 'risco'],
        'especificacoes': ['especificaÃ§Ãµes', 'tÃ©cnica', 'dimensÃµes', 'capacidade', 'potÃªncia', 'voltagem', 'frequÃªncia', 'frequencia'],
        'problemas': ['problema', 'avaria', 'defeito', 'resoluÃ§Ã£o', 'troubleshooting', 'diagnÃ³stico', 'dimensional']
    };
}

/**
 * ğŸ†• v3.8.0: Carregar padrÃµes de auto-tagging do Supabase
 */
async function carregarAutoTagPatterns() {
    if (cachedAutoTagPatterns) {
        return cachedAutoTagPatterns;
    }
    
    try {
        // ğŸ†• v3.8.2: Usar supabaseFetch em vez de window.supabase.rpc
        const data = await supabaseFetch('rpc/get_auto_tag_patterns', {
            method: 'POST',
            body: JSON.stringify({})
        });
        
        if (!data || data.length === 0) {
            console.warn('âš ï¸ [AUTO-TAG] Nenhum padrÃ£o retornado, usando padrÃ£o');
            return getAutoTagPatternsDefault();
        }
        
        // Converter strings para RegExp
        const patterns = {};
        for (const row of data) {
            patterns[row.tag] = row.patterns.map(p => {
                try {
                    return new RegExp(p, 'gi');
                } catch (err) {
                    console.error(`âŒ [AUTO-TAG] Regex invÃ¡lido para tag "${row.tag}": ${p}`, err);
                    return null;
                }
            }).filter(r => r !== null);
        }
        
        // Auto-tag patterns carregados
        cachedAutoTagPatterns = patterns;
        return patterns;
        
    } catch (err) {
        console.error('âŒ [AUTO-TAG] Erro ao buscar padrÃµes:', err);
        console.warn('â„¹ï¸ [AUTO-TAG] Usando padrÃµes padrÃ£o (fallback)');
        return getAutoTagPatternsDefault();
    }
}

/**
 * ğŸ†• v3.8.0: PadrÃµes de auto-tagging padrÃ£o (fallback)
 */
function getAutoTagPatternsDefault() {
    console.warn('âš ï¸ [AUTO-TAG] Usando padrÃµes hard-coded (fallback)');
    return {
        'manutencao_preventiva': [
            /frequÃªncia|periodicidade/gi,
            /mensal|semanal|diÃ¡ria|diario|quinzenal|trimestral|semestral|anual/gi,
            /cada\s+\d+\s+(dia|dias|semana|semanas|mÃªs|meses|ano|anos)/gi,
            /a\s+cada/gi,
            /verificar.{0,20}mente/gi,
            /inspecionar.{0,20}mente/gi,
            /manutenÃ§Ã£o\s+preventiva/gi,
            /plano\s+de\s+manutenÃ§Ã£o/gi
        ],
        'lubrificacao': [/lubrific|Ã³leo|graxa/gi],
        'correias': [/correia|esticamento|tensÃ£o|tensao/gi],
        'periodicidade_mensal': [/mensal|mensalmente/gi],
        'periodicidade_semanal': [/semanal|semanalmente/gi],
        'periodicidade_anual': [/anual|anualmente/gi]
    };
}

/**
 * ğŸ†• v3.8.0: Detectar tags automaticamente baseado em padrÃµes
 */
async function detectarTagsAutomaticas(texto) {
    if (!texto || texto.trim().length === 0) {
        return [];
    }
    
    // Carregar padrÃµes (do Supabase ou fallback)
    const autoTagPatterns = await carregarAutoTagPatterns();
    
    const tags = new Set();
    let score = 0;
    
    // Verificar cada tag e seus padrÃµes
    for (const [tag, patterns] of Object.entries(autoTagPatterns)) {
        for (const regex of patterns) {
            if (regex.test(texto)) {
                tags.add(tag);
                score++;
            }
        }
    }
    
    if (tags.size > 0) {
        console.log(`ğŸ·ï¸ [AUTO-TAG] ${tags.size} tag(s) detectadas (score: ${score}):`, Array.from(tags).join(', '));
    }
    
    return Array.from(tags);
}

/**
 * ğŸ†• v3.7.6.11: Filtrar secÃ§Ãµes de manual por relevÃ¢ncia
 * Analisa a pergunta e retorna apenas secÃ§Ãµes que contenham keywords relevantes
 */
async function filtrarSecoesRelevantes(secoes, pergunta) {
    if (!secoes || secoes.length === 0) return [];
    
    const perguntaLower = pergunta.toLowerCase();
    
    // ğŸ†• v3.7.6.13: Buscar keywords do Supabase
    const topicosKeywords = await carregarKeywords();
    
    // Detectar tÃ³pico da pergunta
    let topicosDetectados = [];
    for (const [topico, keywords] of Object.entries(topicosKeywords)) {
        if (keywords.some(kw => perguntaLower.includes(kw))) {
            topicosDetectados.push(topico);
        }
    }
    
    console.log(`ğŸ” [FILTRO] TÃ³picos detectados na pergunta:`, topicosDetectados);
    
    // Se nÃ£o detectou nenhum tÃ³pico especÃ­fico, retornar tudo (sem filtro)
    if (topicosDetectados.length === 0) {
        console.log(`â„¹ï¸ [FILTRO] Nenhum tÃ³pico especÃ­fico detectado, enviando todas as secÃ§Ãµes (${secoes.length})`);
        return secoes.map(s => ({
            titulo: s.secao,
            paginas: `${s.pagina_inicio}-${s.pagina_fim}`,
            texto: s.conteudo,
            imagens_urls: s.imagens_urls || [],  // ğŸ†• v3.8.1: URLs de tabelas/imagens
            tags: s.tags || []                    // ğŸ†• v3.8.1: Tags da secÃ§Ã£o
        }));
    }
    
    // ğŸ†• v3.8.0: Detectar tags na pergunta
    const tagsPergunta = await detectarTagsAutomaticas(pergunta);
    console.log(`ğŸ·ï¸ [FILTRO] Tags detectadas na pergunta:`, tagsPergunta);
    
    // Filtrar secÃ§Ãµes que contenham keywords OU tags dos tÃ³picos detectados
    const secoesRelevantes = secoes.filter(s => {
        const secaoLower = (s.secao + ' ' + s.conteudo).toLowerCase();
        
        // 1. Verificar se a secÃ§Ã£o contÃ©m keywords de algum tÃ³pico detectado
        const temKeyword = topicosDetectados.some(topico => {
            const keywords = topicosKeywords[topico];
            return keywords.some(kw => secaoLower.includes(kw));
        });
        
        // 2. ğŸ†• v3.8.0: Verificar se a secÃ§Ã£o tem tags que matcham com a pergunta
        const temTag = s.tags && tagsPergunta.length > 0 && 
                       s.tags.some(tag => tagsPergunta.includes(tag));
        
        return temKeyword || temTag;
    });
    
    console.log(`âœ… [FILTRO] SecÃ§Ãµes filtradas: ${secoesRelevantes.length}/${secoes.length} (tÃ³picos: ${topicosDetectados.join(', ')})`);
    
    // Se o filtro for muito restritivo (menos de 1 secÃ§Ã£o), retornar tudo
    if (secoesRelevantes.length === 0) {
        console.log(`âš ï¸ [FILTRO] Filtro muito restritivo, retornando todas as secÃ§Ãµes`);
        return secoes.map(s => ({
            titulo: s.secao,
            paginas: `${s.pagina_inicio}-${s.pagina_fim}`,
            texto: s.conteudo,
            imagens_urls: s.imagens_urls || [],  // ğŸ†• v3.8.1: URLs de tabelas/imagens
            tags: s.tags || []                    // ğŸ†• v3.8.1: Tags da secÃ§Ã£o
        }));
    }
    
    // Mostrar quais secÃ§Ãµes foram selecionadas
    secoesRelevantes.forEach((s, idx) => {
        console.log(`   ${idx + 1}. ${s.secao} (pÃ¡ginas ${s.pagina_inicio}-${s.pagina_fim})`);
        if (s.imagens_urls && s.imagens_urls.length > 0) {
            console.log(`      ğŸ“Š ${s.imagens_urls.length} imagem(ns) incluÃ­da(s)`);
        }
    });
    
    return secoesRelevantes.map(s => {
        // ğŸ†• v3.8.3.10.4: Enriquecer texto com metadata GPT-4 Vision
        let textoEnriquecido = s.conteudo;
        
        // Se tem metadata GPT-4, adicionar descriÃ§Ãµes das figuras ao texto
        if (s.imagens_metadata && s.imagens_metadata.length > 0) {
            console.log(`   ğŸ” Enriquecendo com ${s.imagens_metadata.length} metadata(s) GPT-4`);
            
            s.imagens_metadata.forEach(meta => {
                // ğŸ†• v3.8.3.10.27.9: Incluir TODOS os metadados (com ou sem nÃºmero)
                // Importante para Ã­ndices, anexos sem nÃºmero, etc.
                const tipoCapitalizado = (meta.tipo || 'imagem').charAt(0).toUpperCase() + (meta.tipo || 'imagem').slice(1);
                
                if (meta.numero) {
                    // Com nÃºmero: "Figura 25: TÃ­tulo"
                    const descricao = `\n\n${tipoCapitalizado} ${meta.numero}${meta.titulo ? ': ' + meta.titulo : ''}\n${meta.descricao || ''}\nğŸ“Š [${tipoCapitalizado.toUpperCase()} ${meta.numero}]: ${meta.url}`;
                    textoEnriquecido += descricao;
                } else {
                    // Sem nÃºmero: "Ãndice: TÃ­tulo" ou "Esquema ElÃ©trico: TÃ­tulo"
                    const descricao = `\n\n${tipoCapitalizado}${meta.titulo ? ': ' + meta.titulo : ''}\n${meta.descricao || ''}\nğŸ“Š [${tipoCapitalizado.toUpperCase()}]: ${meta.url}`;
                    textoEnriquecido += descricao;
                }
            });
        }
        
        return {
            titulo: s.secao,
            paginas: `${s.pagina_inicio}-${s.pagina_fim}`,
            texto: textoEnriquecido,  // ğŸ†• v3.8.3.10.4: Texto enriquecido com metadata
            imagens_urls: s.imagens_urls || [],
            tags: s.tags || []
        };
    });
}

/**
 * ğŸ†• v3.8.3.9: Buscar no conteÃºdo dos manuais usando full-text search
 * Esta funÃ§Ã£o complementa as keywords existentes
 */
async function buscarManuaisFullText(pergunta, maxResultados = 5) {
    console.log('ğŸ” [FULLTEXT] Iniciando busca full-text...', pergunta);
    
    try {
        // Chamar funÃ§Ã£o SQL do Supabase
        const resultados = await supabaseFetch('rpc/buscar_manual_fulltext', {
            method: 'POST',
            body: JSON.stringify({
                query_text: pergunta,
                match_count: maxResultados
            })
        });
        
        console.log(`âœ… [FULLTEXT] ${resultados?.length || 0} seÃ§Ãµes encontradas via full-text`);
        
        if (!resultados || resultados.length === 0) {
            return [];
        }
        
        // Transformar resultados no formato esperado
        return resultados.map(r => ({
            manual_id: r.manual_id,
            manual_titulo: r.manual_titulo,
            equipamento_area: r.equipamento_area,
            equipamento_nome: r.equipamento_nome,
            secao: r.secao,
            conteudo: r.conteudo,
            pagina_inicio: r.pagina_inicio,
            pagina_fim: r.pagina_fim,
            relevancia: r.relevancia,
            fonte: 'fulltext'  // Identificar que veio do full-text
        }));
        
    } catch (error) {
        console.error('âŒ [FULLTEXT] Erro na busca full-text:', error);
        return [];  // Retornar vazio em caso de erro (nÃ£o quebra o sistema)
    }
}

/**
 * Buscar manuais relevantes baseados na pergunta
 */
async function buscarManuaisRelevantes(pergunta, equipamentosMencionados = []) {
    // ğŸ†• v3.7.7.4: Usar keywords do Supabase em vez de lista hardcoded!
    const perguntaLower = pergunta.toLowerCase();
    
    // Carregar keywords do Supabase (ou fallback)
    const topicosKeywords = await carregarKeywords();
    
    // Juntar TODAS as keywords de TODOS os tÃ³picos numa Ãºnica lista
    const todasKeywords = Object.values(topicosKeywords).flat();
    
    console.log('ğŸ” [MANUAIS] Keywords carregadas:', todasKeywords.length, 'palavras');
    console.log('ğŸ” [MANUAIS] Pergunta:', pergunta);
    
    // Verificar se a pergunta contÃ©m QUALQUER keyword
    const mencionaManual = todasKeywords.some(palavra => perguntaLower.includes(palavra.toLowerCase()));
    
    console.log('ğŸ” [MANUAIS] Menciona manual/keyword?', mencionaManual);
    
    // ğŸ†• v3.8.3.9: BUSCA HÃBRIDA - Tentar full-text MESMO SEM keywords
    let resultadosFullText = [];
    if (!mencionaManual && equipamentosMencionados.length === 0) {
        console.log('âš ï¸ [MANUAIS] Nenhuma keyword detectada, tentando busca full-text...');
        
        // Tentar busca full-text como fallback
        resultadosFullText = await buscarManuaisFullText(pergunta, 3);
        
        if (resultadosFullText.length === 0) {
            console.log('âŒ [MANUAIS] Full-text tambÃ©m nÃ£o encontrou resultados');
            return null;  // NÃ£o incluir manuais se nÃ£o forem relevantes
        }
        
        console.log(`âœ… [MANUAIS] Full-text encontrou ${resultadosFullText.length} resultados!`);
        
        // Retornar resultados do full-text diretamente
        return {
            disponivel: true,
            fonte: 'fulltext',
            manuais: resultadosFullText.map(r => ({
                manual: {
                    id: r.manual_id,
                    titulo: r.manual_titulo,
                    equipamento_area: r.equipamento_area,
                    equipamento_nome: r.equipamento_nome
                },
                secoes: [{
                    titulo: r.secao,
                    paginas: `${r.pagina_inicio}-${r.pagina_fim}`,
                    texto: r.conteudo,
                    relevancia: r.relevancia,
                    imagens_urls: [],
                    tags: []
                }]
            }))
        };
    }
    
    console.log('âœ… [MANUAIS] Keywords detectadas! Buscando manuais...');
    
    // Se houver manuais carregados no AppState (carregados quando tab Ã© aberta)
    if (!AppState.manuais || AppState.manuais.length === 0) {
        return {
            disponivel: false,
            mensagem: 'Nenhum manual carregado no sistema ainda.'
        };
    }
    
    // Filtrar manuais relevantes
    let manuaisRelevantes = AppState.manuais;
    
    // ğŸ†• v3.7.6.9: Detectar equipamentos mencionados na pergunta (nÃ£o sÃ³ em pedidos)
    // ğŸ†• v3.8.3.10.16: Procurar em equipamento_nome E equipamento_area
    const equipamentosNaPergunta = AppState.manuais
        .filter(m => m.ativo)
        .filter(m => {
            const nome = (m.equipamento_nome || '').toLowerCase();
            const area = (m.equipamento_area || '').toLowerCase();
            return perguntaLower.includes(nome) || perguntaLower.includes(area);
        })
        .map(m => m.equipamento_nome || m.equipamento_area);
    
    if (equipamentosMencionados.length > 0 || equipamentosNaPergunta.length > 0) {
        // Filtrar por equipamento mencionado (de pedidos OU de manuais)
        const todosEquipamentos = [...equipamentosMencionados, ...equipamentosNaPergunta];
        // ğŸ†• v3.8.3.10.16: Procurar em equipamento_nome E equipamento_area
        manuaisRelevantes = AppState.manuais.filter(m => 
            todosEquipamentos.some(eq => {
                const eqLower = eq.toLowerCase();
                const nome = (m.equipamento_nome || '').toLowerCase();
                const area = (m.equipamento_area || '').toLowerCase();
                return nome.includes(eqLower) || area.includes(eqLower);
            })
        );
    }
    
    // Se encontrou manuais relevantes, incluir secÃ§Ãµes de conteÃºdo
    if (manuaisRelevantes.length > 0) {
        console.log(`ğŸ” [DEBUG-CHATBOT] Manuais relevantes encontrados:`, manuaisRelevantes.length);
        console.log(`ğŸ” [DEBUG-CHATBOT] AppState.manuaisConteudo keys:`, Object.keys(AppState.manuaisConteudo || {}));
        
        // ğŸ†• v3.7.6.13: Processar manuais com async (Promise.all)
        const manuaisProcessados = await Promise.all(
            manuaisRelevantes.map(async (m) => {
                const temConteudo = AppState.manuaisConteudo && AppState.manuaisConteudo[m.id];
                console.log(`ğŸ” [DEBUG-CHATBOT] Manual ${m.titulo} (${m.id}): tem conteÃºdo? ${!!temConteudo}, secÃ§Ãµes: ${temConteudo?.length || 0}`);
                
                return {
                    id: m.id,
                    equipamento: m.equipamento_nome,
                    titulo: m.titulo,
                    descricao: m.descricao,
                    num_paginas: m.num_paginas,
                    // ğŸ†• v3.7.6.13: Filtrar secÃ§Ãµes por relevÃ¢ncia baseado em keywords (async)
                    conteudo: temConteudo
                        ? await filtrarSecoesRelevantes(AppState.manuaisConteudo[m.id], pergunta)
                        : []
                };
            })
        );
        
        return {
            disponivel: true,
            quantidade: manuaisRelevantes.length,
            manuais: manuaisProcessados
        };
    }
    
    return null;
}

/**
 * Enviar pergunta para o chatbot
 */
window.enviarPerguntaChatbot = async function() {
    const input = document.getElementById('chatbotInput');
    const sendBtn = document.getElementById('chatbotSendBtn');
    
    if (!input || !sendBtn) return;
    
    const pergunta = input.value.trim();
    if (!pergunta) return;
    
    // Adicionar pergunta do usuÃ¡rio
    adicionarMensagemChat(pergunta, 'user');
    
    // Limpar input
    input.value = '';
    input.style.height = 'auto';
    
    // Desabilitar botÃ£o e mostrar loading
    sendBtn.disabled = true;
    mostrarChatbotStatus(true);
    
    try {
        // âœ… v3.7.1.9 - Preparar contexto ADAPTATIVO baseado na pergunta
        const contexto = await prepararContextoDados(pergunta);
        
        // ğŸ†• v3.8.2.19: Retry com feedback ao utilizador
        const maxTentativas = 3;
        const delayEntreRetries = 2000; // 2 segundos
        let ultimoErro = null;
        
        for (let tentativa = 1; tentativa <= maxTentativas; tentativa++) {
            try {
                // Mostrar feedback de retry
                if (tentativa > 1) {
                    mostrarChatbotStatus(true, `ComunicaÃ§Ã£o mais lenta que o habitual... Tentativa ${tentativa}/${maxTentativas}`);
                }
                
                // ğŸš€ MODO PRODUÃ‡ÃƒO: IA Real com Gemini via Cloudflare Worker
                const response = await fetch(CHATBOT_WORKER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pergunta,
                        contexto
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Erro na resposta do servidor: ${response.status}`);
                }
                
                const data = await response.json();
                
                // âœ… SUCESSO! Sair do loop de retry
                ultimoErro = null;
                
                // ğŸ†• v3.7.6.10: Debug - ver o que veio do Worker
                console.log('ğŸ” [DEBUG] Resposta do Worker:', data);
                
                // ğŸ†• v3.7.6.10: Mostrar logs de debug do Worker
                if (data.debug_logs) {
                    console.log('ğŸ” [WORKER DEBUG LOGS]:');
                    data.debug_logs.forEach(log => console.log('   ', log));
                }
                
                if (data.erro) {
                    throw new Error(data.erro);
                }
                
                if (!data.resposta) {
                    console.error('âŒ Resposta do Worker nÃ£o contÃ©m "resposta":', data);
                    throw new Error('Resposta invÃ¡lida do servidor: campo "resposta" ausente');
                }
                
                // Processar resposta normalmente
                let respostaFinal = data.resposta;
                adicionarMensagemChat(respostaFinal, 'assistant');
                
                // âœ… SUCESSO! Sair do try-catch principal
                break;
                
            } catch (erro) {
                ultimoErro = erro;
                console.error(`âŒ Tentativa ${tentativa}/${maxTentativas} falhou:`, erro);
                
                // Se nÃ£o for a Ãºltima tentativa, aguardar antes de retry
                if (tentativa < maxTentativas) {
                    await new Promise(resolve => setTimeout(resolve, delayEntreRetries));
                }
            }
        }
        
        // Se todas as tentativas falharam, lanÃ§ar erro
        if (ultimoErro) {
            throw ultimoErro;
        }
        
    } catch (error) {
        console.error('âŒ Erro no chatbot:', error);
        console.error('âŒ URL:', CHATBOT_WORKER_URL);
        adicionarMensagemChat(
            `Desculpa, ocorreu um erro ao comunicar com o servidor de IA.\n\n**Erro:** ${error.message}\n\nPor favor, verifica se o Cloudflare Worker estÃ¡ a funcionar ou contacta o administrador.`,
            'assistant'
        );
    } finally {
        sendBtn.disabled = false;
        mostrarChatbotStatus(false);
    }
};

/**
 * Gerar resposta simulada (enquanto o Worker nÃ£o estÃ¡ configurado)
 */
function gerarRespostaSimulada(pergunta, contexto) {
    const p = pergunta.toLowerCase();
    
    // Detectar palavras-chave e gerar resposta
    if (p.includes('quantos') || p.includes('total')) {
        if (p.includes('aberto') || p.includes('pendente')) {
            return `Atualmente existem **${contexto.resumo.abertos} pedidos abertos** (nÃ£o resolvidos).\n\n` +
                   `Do total de ${contexto.resumo.total} pedidos:\n` +
                   `â€¢ ${contexto.resumo.abertos} abertos\n` +
                   `â€¢ ${contexto.resumo.resolvidos} resolvidos`;
        }
        return `AtÃ© agora foram registados **${contexto.resumo.total} pedidos** no sistema:\n\n` +
               `â€¢ MCF: ${contexto.resumo.mcf} pedidos\n` +
               `â€¢ PSY: ${contexto.resumo.psy} pedidos\n\n` +
               `Estado atual:\n` +
               `â€¢ Abertos: ${contexto.resumo.abertos}\n` +
               `â€¢ Resolvidos: ${contexto.resumo.resolvidos}`;
    }
    
    if (p.includes('mcf') && (p.includes('psy') || p.includes('compar'))) {
        return `**ComparaÃ§Ã£o MCF vs PSY:**\n\n` +
               `â€¢ MCF: ${contexto.resumo.mcf} pedidos (${Math.round(contexto.resumo.mcf/contexto.resumo.total*100)}%)\n` +
               `â€¢ PSY: ${contexto.resumo.psy} pedidos (${Math.round(contexto.resumo.psy/contexto.resumo.total*100)}%)\n\n` +
               `A empresa com mais pedidos Ã©: **${contexto.resumo.mcf > contexto.resumo.psy ? 'MCF' : 'PSY'}**`;
    }
    
    if (p.includes('mÃ¡quina') || p.includes('equipamento') || p.includes('Ã¡rea')) {
        if (contexto.topAreas.length > 0) {
            return `**Top equipamentos/Ã¡reas com mais pedidos:**\n\n` +
                   contexto.topAreas.map((a, i) => `${i+1}. ${a}`).join('\n');
        }
        return 'NÃ£o foram encontrados dados de equipamentos/Ã¡reas nos pedidos registados.';
    }
    
    if (p.includes('tipo')) {
        const tiposList = Object.entries(contexto.tipos)
            .sort((a, b) => b[1] - a[1])
            .map(([tipo, count]) => `â€¢ ${tipo}: ${count} pedidos`)
            .join('\n');
        return `**Ordens de trabalho por tipo:**\n\n${tiposList}`;
    }
    
    if (p.includes('tendÃªncia') || p.includes('evoluÃ§Ã£o') || p.includes('backlog')) {
        const metricas = calcularMetricasSemana();
        const sinal = metricas.tendencia > 0 ? 'â†‘' : metricas.tendencia < 0 ? 'â†“' : 'â†’';
        const variacao = metricas.tendencia !== 0 ? `${Math.abs(metricas.tendencia)} pedidos` : 'sem alteraÃ§Ã£o';
        
        return `**AnÃ¡lise de TendÃªncia:**\n\n` +
               `â€¢ Backlog atual: ${metricas.backlogTotal} pedidos abertos\n` +
               `â€¢ TendÃªncia: ${sinal} ${variacao} vs semana anterior\n\n` +
               `Esta semana:\n` +
               `â€¢ Novos pedidos: ${metricas.abertos}\n` +
               `â€¢ Pedidos fechados: ${metricas.fechados}`;
    }
    
    // Resposta padrÃ£o
    return `Analisei a tua pergunta. No momento, tenho dados sobre **${contexto.resumo.total} pedidos** no sistema.\n\n` +
           `Podes perguntar-me sobre:\n` +
           `â€¢ NÃºmero de ordens de trabalho abertas ou fechadas\n` +
           `â€¢ ComparaÃ§Ã£o entre MCF e PSY\n` +
           `â€¢ MÃ¡quinas/equipamentos com mais avarias\n` +
           `â€¢ Tipos de pedidos mais comuns\n` +
           `â€¢ TendÃªncias e evoluÃ§Ã£o do backlog\n\n` +
           `**Nota:** Este Ã© um modo de demonstraÃ§Ã£o. Para anÃ¡lises mais avanÃ§adas com IA, serÃ¡ necessÃ¡rio configurar o backend com Gemini AI.`;
}

// ===================================
// INICIALIZAÃ‡ÃƒO
// ===================================

// Adicionar listener para Enter no input do chatbot
document.addEventListener('DOMContentLoaded', () => {
    const chatInput = document.getElementById('chatbotInput');
    if (chatInput) {
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                enviarPerguntaChatbot();
            }
        });
        
        // Auto-resize do textarea
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    }
    
    // Listeners para filtros de anÃ¡lise
    const empresaFilter = document.getElementById('analiseEmpresaFilter');
    
    if (empresaFilter) {
        empresaFilter.addEventListener('change', () => window.atualizarAnalises());
    }
});

// ============================================
// ğŸ†• v3.8.3.0: MELHORIAS OT
// ============================================

/**
 * Mostra alerta customizado estÃ©tico
 */
function showCustomAlert(options) {
    const { title, message, icon, buttonText, secondaryButtonText, onConfirm } = options;
    
    console.log('ğŸ¨ showCustomAlert chamado:', { title, hasOnConfirm: !!onConfirm });
    
    // Criar overlay
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); z-index: 10000;
        display: flex; align-items: center; justify-content: center;
        animation: fadeIn 0.2s ease;
    `;
    
    // Criar modal
    const modal = document.createElement('div');
    modal.style.cssText = `
        background: white; border-radius: 16px; padding: 32px;
        max-width: 400px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        text-align: center; animation: slideUp 0.3s ease;
    `;
    
    // ğŸ†• v3.8.3.8: Suporte para dois botÃµes (primÃ¡rio + secundÃ¡rio)
    const buttonsHTML = secondaryButtonText ? `
        <div style="display: flex; gap: 12px; justify-content: center;">
            <button 
                class="secondary-btn"
                style="
                    background: #ecf0f1; color: #7f8c8d; border: none;
                    padding: 12px 24px; border-radius: 8px; font-size: 16px;
                    font-weight: 600; cursor: pointer; transition: all 0.2s;
                "
                onmouseover="this.style.background='#d5dbdb'"
                onmouseout="this.style.background='#ecf0f1'">
                ${secondaryButtonText}
            </button>
            <button 
                class="primary-btn"
                style="
                    background: #3498db; color: white; border: none;
                    padding: 12px 24px; border-radius: 8px; font-size: 16px;
                    font-weight: 600; cursor: pointer; transition: all 0.2s;
                "
                onmouseover="this.style.background='#2980b9'"
                onmouseout="this.style.background='#3498db'">
                ${buttonText}
            </button>
        </div>
    ` : `
        <button 
            class="primary-btn"
            style="
                background: #3498db; color: white; border: none;
                padding: 12px 32px; border-radius: 8px; font-size: 16px;
                font-weight: 600; cursor: pointer; transition: all 0.2s;
            "
            onmouseover="this.style.background='#2980b9'"
            onmouseout="this.style.background='#3498db'">
            ${buttonText}
        </button>
    `;
    
    modal.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 16px;">${icon}</div>
        <h3 style="margin: 0 0 12px 0; font-size: 20px; color: #2c3e50;">${title}</h3>
        <p style="margin: 0 0 24px 0; font-size: 16px; color: #7f8c8d; line-height: 1.5;">${message}</p>
        ${buttonsHTML}
    `;
    
    overlay.className = 'custom-alert-overlay';
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    
    console.log('âœ… Modal adicionado ao DOM. Elementos:', {
        execucaoObservacoes: !!document.getElementById('execucaoObservacoes'),
        execucaoHoras: !!document.getElementById('execucaoHoras'),
        overlay: !!document.querySelector('.custom-alert-overlay')
    });
    
    // Event listeners para botÃµes
    const primaryBtn = modal.querySelector('.primary-btn');
    const secondaryBtn = modal.querySelector('.secondary-btn');
    
    if (primaryBtn) {
        primaryBtn.addEventListener('click', async () => {
            console.log('ğŸ–±ï¸ BotÃ£o primÃ¡rio clicado. Verificando elementos antes de onConfirm:', {
                execucaoObservacoes: !!document.getElementById('execucaoObservacoes'),
                execucaoHoras: !!document.getElementById('execucaoHoras'),
                hasOnConfirm: !!onConfirm
            });
            
            // ğŸ†• v3.8.3.10.27: Executar onConfirm ANTES de remover o modal
            // para que os inputs ainda existam no DOM
            if (onConfirm) {
                const result = await onConfirm();
                console.log('âœ… onConfirm executado. Resultado:', result);
                // Se onConfirm retornar false, nÃ£o fecha o modal
                if (result === false) return;
            }
            console.log('ğŸ—‘ï¸ Removendo modal...');
            overlay.remove();
        });
    }
    
    if (secondaryBtn) {
        secondaryBtn.addEventListener('click', () => {
            overlay.remove();
        });
    }
    
    // Fechar ao clicar fora
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) overlay.remove();
    });
}

/**
 * Guardar observaÃ§Ãµes de fecho
 */
async function guardarObservacoesFecho(id) {
    const request = AppState.requests.find(r => r.id === id);
    if (!request) return;
    
    const textarea = document.getElementById('observacoesFecho');
    const observacoes = textarea.value.trim();
    
    // Atualizar localmente
    request.observacoesFecho = observacoes;
    
    // Atualizar no Supabase
    try {
        await window.SupabaseAPI.updatePedido(id, { observacoes_fecho: observacoes });
        showToast('âœ… ObservaÃ§Ãµes guardadas com sucesso!', 'success');
        
        // ğŸ”¥ v3.8.3.5-FIX: Recarregar modal para manter texto visÃ­vel
        openRequestDetails(id);
    } catch (error) {
        console.error('âŒ Erro ao guardar observaÃ§Ãµes:', error);
        showToast('âŒ Erro ao guardar observaÃ§Ãµes', 'error');
    }
}

/**
 * Upload foto de fecho
 */
async function uploadFotoFecho(id, file) {
    if (!file) return;
    
    const request = AppState.requests.find(r => r.id === id);
    if (!request) return;
    
    try {
        showToast('ğŸ“¤ A enviar foto...', 'info');
        

        
        const ext = file.type.split('/')[1] || 'jpg';
        // âœ… v3.8.3.10.27.9: Foto de fecho em subpasta separada
        const fileName = `ot-fecho/${id}.${ext}`;
        const uploadUrl = `${SUPABASE_CONFIG.URL}/storage/v1/object/pedidos-fotos/${fileName}`;
        

        
        const uploadResponse = await fetch(uploadUrl, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_CONFIG.ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_CONFIG.ANON_KEY}`,
                'Content-Type': file.type,
                'x-upsert': 'true'  // Substituir se jÃ¡ existir
            },
            body: file  // ğŸ”¥ Enviar File diretamente (nÃ£o FormData!)
        });
        

        
        if (!uploadResponse.ok) {
            const errorText = await uploadResponse.text();
            console.error('âŒ [FOTO-FECHO] Erro upload:', uploadResponse.status, errorText);
            

            
            throw new Error(`Upload falhou: ${uploadResponse.status} ${errorText}`);
        }
        
        const fotoUrl = `${SUPABASE_CONFIG.URL}/storage/v1/object/public/pedidos-fotos/${fileName}`;  // URL inclui ot-fecho/
        
        request.fotoFecho = fotoUrl;
        await window.SupabaseAPI.updatePedido(id, { foto_fecho: fotoUrl });
        
        showToast('âœ… Foto adicionada com sucesso!', 'success');
        
        // Recarregar modal
        openRequestDetails(id);
        
    } catch (error) {
        console.error('âŒ [FOTO-FECHO] Erro completo:', error);
        showToast('âŒ Erro ao enviar foto: ' + error.message, 'error');
    }
}

/**
 * Remover foto de fecho
 */
async function removerFotoFecho(id) {
    if (!confirm('Tem certeza que deseja remover a foto de fecho?')) return;
    
    const request = AppState.requests.find(r => r.id === id);
    if (!request) return;
    
    try {
        // Atualizar localmente
        request.fotoFecho = null;
        
        // Atualizar no Supabase
        await window.SupabaseAPI.updatePedido(id, { foto_fecho: null });
        
        showToast('âœ… Foto removida com sucesso!', 'success');
        
        // Recarregar modal
        openRequestDetails(id);
        
    } catch (error) {
        console.error('âŒ Erro ao remover foto:', error);
        showToast('âŒ Erro ao remover foto', 'error');
    }
}

// Adicionar animaÃ§Ãµes CSS
const styleAnimations = document.createElement('style');
styleAnimations.textContent = `
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
`;
document.head.appendChild(styleAnimations);

    </script>
</body>
</html>
