<!DOCTYPE html>
<!-- 
    üè≠ APP MANUTEN√á√ÉO MCF + PSY
    üì¶ Vers√£o: v3.6.5
    üìÖ Data: 2025-01-23
    ‚ú® Novo: Dropdown respons√°vel no planeamento
    ‚ö° Performance: Cache inteligente 1min + invalida√ß√£o autom√°tica
    üêõ Bug Fix v3.6.3: "Resolvido" agora atualiza linha existente (n√£o cria duplicados)
    ‚ö° Performance v3.6.2: 35x mais r√°pido
-->
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Manuten√ß√£o MCF+PSY">
    <title>Gest√£o de manuten√ß√£o MCF + PSY</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/appmanutencao/manifest.json">
    
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/appmanutencao/icons/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/appmanutencao/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/appmanutencao/icons/favicon-16x16.png">
    <link rel="shortcut icon" href="/appmanutencao/icons/favicon.ico">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/appmanutencao/icons/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/appmanutencao/icons/apple-touch-icon-180x180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/appmanutencao/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/appmanutencao/icons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/appmanutencao/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/appmanutencao/icons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/appmanutencao/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/appmanutencao/icons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/appmanutencao/icons/apple-touch-icon-60x60.png">
    
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileImage" content="/appmanutencao/icons/mstile-150x150.png">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="browserconfig" href="/appmanutencao/browserconfig.xml">
    
    <!-- Preload logo for faster loading -->
    <link rel="preload" href="./icons/android-chrome-192x192.png" as="image" type="image/png">
    <style>
        /* ===================================
           App de Manuten√ß√£o - Estilo Apple (INLINE)
           =================================== */
        
        /* Reset e Vari√°veis */
        :root {
            /* Cores Apple */
            --color-white: #FFFFFF;
            --color-background: #F5F5F7;
            --color-text-primary: #1D1D1F;
            --color-text-secondary: #86868B;
            --color-blue: #007AFF;
            --color-blue-dark: #0051D5;
            --color-border: #D2D2D7;
            --color-shadow: rgba(0, 0, 0, 0.1);
            
            /* Cores de Prioridade */
            --color-alta: #FF3B30;
            --color-media: #FF9500;
            --color-baixa: #34C759;
            
            /* Cores de Estado */
            --color-novo: #007AFF;
            --color-emcurso: #FF9500;
            --color-resolvido: #34C759;
            
            /* Tipografia - System Fonts */
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-weight-regular: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            
            /* Espa√ßamento */
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-full: 999px;
            
            /* Sombras */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            
            /* Transi√ß√µes */
            --transition-fast: 0.15s ease;
            --transition-base: 0.3s ease;
            --transition-slow: 0.5s ease;
        }
        
        /* Reset Global */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            max-width: 100%;
        }
        
        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            max-width: 100vw;
            overflow-x: hidden;
        }
        
        body {
            font-family: var(--font-family);
            font-weight: var(--font-weight-regular);
            color: var(--color-text-primary);
            background-color: var(--color-background);
            line-height: 1.5;
            min-height: 100vh;
            overflow-x: hidden;
            width: 100%;
        }
        
        /* Header */
        .app-header {
            background: var(--color-white);
            border-bottom: 1px solid var(--color-border);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.8);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-header h1 {
            font-size: 1.5rem;
            font-weight: var(--font-weight-semibold);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .header-icon {
            width: 28px;
            height: 28px;
            color: var(--color-blue);
            flex-shrink: 0;
            /* Remover fundo branco */
            border-radius: 50%;
            background: transparent;
        }
        
        /* Espec√≠fico para IMG (n√£o SVG) */
        img.header-icon {
            width: 32px !important;
            height: 32px !important;
            object-fit: contain;
        }
        
        @media (max-width: 768px) {
            .header-icon {
                width: 20px !important;
                height: 20px !important;
            }
            
            img.header-icon {
                width: 24px !important;
                height: 24px !important;
            }
        }
        
        /* Main Content */
        .app-main {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-lg);
            width: 100%;
            overflow-x: hidden;
        }
        
        .container {
            width: 100%;
        }
        
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            background: var(--color-white);
            padding: 4px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
        }
        
        .tab-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            background: transparent;
            color: var(--color-text-secondary);
            font-size: 0.9375rem;
            font-weight: var(--font-weight-medium);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .tab-btn svg {
            width: 20px;
            height: 20px;
        }
        
        .tab-btn.active {
            background: var(--color-blue);
            color: var(--color-white);
        }
        
        .tab-btn:hover:not(.active) {
            background: var(--color-background);
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn var(--transition-base);
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Card */
        .card {
            background: var(--color-white);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-lg);
        }
        
        .card-title {
            font-size: 1.5rem;
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-lg);
            color: var(--color-text-primary);
        }
        
        /* Form */
        .maintenance-form {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }
        
        .form-label {
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
        }
        
        .form-input {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-family: var(--font-family);
            color: var(--color-text-primary);
            background: var(--color-white);
            transition: all var(--transition-fast);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--color-blue);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }
        
        textarea.form-input {
            resize: vertical;
            min-height: 100px;
        }
        
        select.form-input {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2386868B' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }
        
        /* Priority Selector */
        .priority-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
        }
        
        .priority-option {
            position: relative;
            cursor: pointer;
        }
        
        .priority-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }
        
        .priority-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-md);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
            transition: all var(--transition-fast);
        }
        
        .priority-label svg {
            width: 24px;
            height: 24px;
        }
        
        .priority-alta .priority-label {
            color: var(--color-alta);
        }
        
        .priority-media .priority-label {
            color: var(--color-media);
        }
        
        .priority-baixa .priority-label {
            color: var(--color-baixa);
        }
        
        .priority-option input[type="radio"]:checked + .priority-label {
            border-width: 2px;
        }
        
        .priority-alta input[type="radio"]:checked + .priority-label {
            border-color: var(--color-alta);
            background: rgba(255, 59, 48, 0.05);
        }
        
        .priority-media input[type="radio"]:checked + .priority-label {
            border-color: var(--color-media);
            background: rgba(255, 149, 0, 0.05);
        }
        
        .priority-baixa input[type="radio"]:checked + .priority-label {
            border-color: var(--color-baixa);
            background: rgba(52, 199, 89, 0.05);
        }
        
        /* File Upload */
        .file-upload {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--color-text-secondary);
            font-size: 0.9375rem;
        }
        
        .file-label svg {
            width: 24px;
            height: 24px;
            color: var(--color-blue);
        }
        
        .file-label:hover {
            border-color: var(--color-blue);
            background: rgba(0, 122, 255, 0.03);
        }
        
        .image-preview {
            display: none;
            position: relative;
        }
        
        .image-preview.active {
            display: block;
        }
        
        .image-preview img {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: var(--radius-md);
        }
        
        .image-preview .remove-image {
            position: absolute;
            top: var(--spacing-sm);
            right: var(--spacing-sm);
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            background: rgba(0, 0, 0, 0.6);
            border: none;
            color: var(--color-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            backdrop-filter: blur(10px);
        }
        
        .image-preview .remove-image svg {
            width: 16px;
            height: 16px;
        }
        
        .image-preview .remove-image:hover {
            background: rgba(0, 0, 0, 0.8);
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-full);
            font-size: 1rem;
            font-weight: var(--font-weight-medium);
            font-family: var(--font-family);
            cursor: pointer;
            transition: all var(--transition-fast);
            text-decoration: none;
        }
        
        .btn svg {
            width: 20px;
            height: 20px;
        }
        
        .btn-primary {
            background: var(--color-blue);
            color: var(--color-white);
        }
        
        .btn-primary:hover {
            background: var(--color-blue-dark);
        }
        
        .btn-primary:active {
            transform: scale(0.98);
        }
        
        .btn-secondary {
            background: var(--color-background);
            color: var(--color-text-primary);
        }
        
        .btn-secondary:hover {
            background: var(--color-border);
        }
        
        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            border-radius: var(--radius-full);
            background: transparent;
            color: var(--color-blue);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .btn-icon svg {
            width: 24px;
            height: 24px;
            stroke: currentColor;
        }
        
        .btn-icon:hover {
            background: var(--color-background);
        }
        
        .btn-text {
            padding: var(--spacing-xs) var(--spacing-md);
            border: none;
            background: transparent;
            color: var(--color-blue);
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .btn-text:hover {
            opacity: 0.7;
        }
        
        .form-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
            margin-top: var(--spacing-md);
        }
        
        /* Filters */
        .filters-card {
            margin-bottom: var(--spacing-lg);
        }
        
        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }
        
        .filters-header h3 {
            font-size: 1.125rem;
            font-weight: var(--font-weight-semibold);
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-lg);
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        
        .filter-label {
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            cursor: pointer;
            font-size: 0.9375rem;
            color: var(--color-text-primary);
        }
        
        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--color-blue);
        }
        
        /* List Header */
        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }
        
        .list-info {
            font-size: 0.9375rem;
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
        }
        
        /* Requests List */
        .requests-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        .request-card {
            background: var(--color-white);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
            border: 1px solid transparent;
        }
        
        .request-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--color-border);
            transform: translateY(-2px);
        }
        
        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-sm);
        }
        
        .request-badges {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .badge {
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: var(--font-weight-medium);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-tipo {
            background: var(--color-background);
            color: var(--color-text-primary);
        }
        
        .badge-prioridade {
            color: var(--color-white);
        }
        
        .badge-prioridade.alta {
            background: var(--color-alta);
        }
        
        .badge-prioridade.media {
            background: var(--color-media);
        }
        
        .badge-prioridade.baixa {
            background: var(--color-baixa);
        }
        
        .badge-estado {
            color: var(--color-white);
        }
        
        .badge-estado.novo {
            background: var(--color-novo);
        }
        
        .badge-estado.emcurso {
            background: var(--color-emcurso);
        }
        
        .badge-estado.resolvido {
            background: var(--color-resolvido);
        }
        
        .request-date {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
        }
        
        .request-body {
            margin-bottom: var(--spacing-sm);
        }
        
        .request-body h4 {
            font-size: 1rem;
            font-weight: var(--font-weight-semibold);
            margin-bottom: 4px;
        }
        
        .request-body p {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .request-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: var(--spacing-sm);
            border-top: 1px solid var(--color-background);
        }
        
        .request-meta {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            font-size: 0.875rem;
            color: var(--color-text-secondary);
        }
        
        .request-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .request-meta svg {
            width: 16px;
            height: 16px;
        }
        
        .request-actions {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .request-actions .btn-icon {
            width: 32px;
            height: 32px;
        }
        
        .request-actions .btn-icon svg {
            width: 18px;
            height: 18px;
        }
        
        /* Empty State */
        .empty-state {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-xl);
            text-align: center;
        }
        
        .empty-state.active {
            display: flex;
        }
        
        .empty-state svg {
            width: 64px;
            height: 64px;
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-md);
        }
        
        .empty-state h3 {
            font-size: 1.25rem;
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-xs);
        }
        
        .empty-state p {
            font-size: 0.9375rem;
            color: var(--color-text-secondary);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-lg);
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            animation: fadeIn var(--transition-base);
        }
        
        .modal-content {
            position: relative;
            background: var(--color-white);
            border-radius: var(--radius-lg);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            animation: slideUp var(--transition-base);
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--color-background);
        }
        
        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: var(--font-weight-semibold);
        }
        
        .btn-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--color-background);
            border-radius: var(--radius-full);
            color: var(--color-text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }
        
        .btn-close svg {
            width: 16px;
            height: 16px;
        }
        
        .btn-close:hover {
            background: var(--color-border);
        }
        
        .modal-body {
            padding: var(--spacing-lg);
            overflow-y: auto;
        }
        
        .detail-group {
            margin-bottom: var(--spacing-lg);
        }
        
        .detail-label {
            font-size: 0.75rem;
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .detail-value {
            font-size: 1rem;
            color: var(--color-text-primary);
        }
        
        .detail-badges {
            display: flex;
            gap: var(--spacing-xs);
            flex-wrap: wrap;
        }
        
        .detail-image {
            width: 100%;
            border-radius: var(--radius-md);
            margin-top: var(--spacing-xs);
        }
        
        .modal-actions {
            display: flex;
            gap: var(--spacing-sm);
            padding: var(--spacing-lg);
            border-top: 1px solid var(--color-background);
            background: var(--color-background);
        }
        
        .modal-actions .btn {
            flex: 1;
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            pointer-events: none;
        }
        
        .toast {
            background: var(--color-white);
            color: var(--color-text-primary);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            min-width: 300px;
            pointer-events: auto;
            animation: slideInRight var(--transition-base);
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .toast.success {
            border-left: 4px solid var(--color-resolvido);
        }
        
        .toast.error {
            border-left: 4px solid var(--color-alta);
        }
        
        .toast.info {
            border-left: 4px solid var(--color-blue);
        }
        
        .toast svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        
        .toast.success svg {
            color: var(--color-resolvido);
        }
        
        .toast.error svg {
            color: var(--color-alta);
        }
        
        .toast.info svg {
            color: var(--color-blue);
        }
        
        .toast-message {
            flex: 1;
            font-size: 0.9375rem;
        }
        
        /* Loading State */
        .btn.loading {
            pointer-events: none;
            opacity: 0.7;
            position: relative;
        }
        
        .btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* ===================================
           Manuten√ß√µes Aut√≥nomas Tab
           =================================== */
        
        .card-description {
            color: var(--color-text-secondary);
            font-size: 0.9375rem;
            line-height: 1.6;
            margin-bottom: var(--spacing-lg);
        }
        
        /* PDF Actions */
        .pdf-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-lg);
            flex-wrap: wrap;
        }
        
        .pdf-actions .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .pdf-actions .btn svg {
            width: 18px;
            height: 18px;
        }
        
        /* PDF Viewer Container */
        .pdf-viewer-container {
            margin-top: var(--spacing-lg);
            padding: 0;
            overflow: hidden;
        }
        
        .pdf-viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--color-border);
            background-color: var(--color-background);
        }
        
        .pdf-viewer-header h3 {
            font-size: 1.125rem;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin: 0;
        }
        
        .pdf-viewer {
            width: 100%;
            height: 80vh;
            min-height: 600px;
            background-color: #525659;
            position: relative;
        }
        
        .pdf-viewer iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* Loading State for PDF */
        .pdf-viewer.loading::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 3px solid var(--color-border);
            border-top-color: var(--color-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .pdf-viewer.loading::after {
            content: 'Carregando PDF...';
            position: absolute;
            top: calc(50% + 40px);
            left: 50%;
            transform: translateX(-50%);
            color: var(--color-white);
            font-size: 0.875rem;
            white-space: nowrap;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            html {
                font-size: 14px;
            }
            
            body {
                overflow-x: hidden;
            }
            
            .app-main {
                padding: 12px;
            }
            
            .header-content {
                padding: 10px 12px;
            }
            
            .app-header h1 {
                font-size: 1rem !important;
                gap: 6px !important;
            }
            
            .app-header h1 svg,
            .header-icon {
                width: 18px !important;
                height: 18px !important;
            }
            
            img.header-icon {
                width: 20px !important;
                height: 20px !important;
            }
            
            .btn-icon {
                width: 32px !important;
                height: 32px !important;
                padding: 6px !important;
            }
            
            .btn-icon svg {
                width: 18px !important;
                height: 18px !important;
            }
            
            .tab-nav {
                padding: 4px;
                gap: 4px;
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab-btn {
                flex: 0 0 auto !important;
                font-size: 0.7rem !important;
                padding: 8px 12px !important;
                min-width: 80px;
                flex-direction: column !important;
                gap: 4px !important;
            }
            
            .tab-btn svg {
                width: 20px !important;
                height: 20px !important;
                margin: 0 !important;
            }
            
            .card {
                padding: var(--spacing-md);
            }
            
            .card-title {
                font-size: 1.25rem;
            }
            
            .priority-selector {
                grid-template-columns: 1fr;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .form-actions .btn {
                width: 100%;
            }
            
            .modal {
                padding: 0;
            }
            
            .modal-content {
                max-height: 100vh;
                border-radius: 0;
            }
            
            .toast-container {
                left: var(--spacing-sm);
                right: var(--spacing-sm);
                top: var(--spacing-sm);
            }
            
            .toast {
                min-width: auto;
            }
        }
        
        /* Planeamento / Planning Grid */
        .planning-controls {
            margin-bottom: var(--spacing-lg);
        }
        
        .planning-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }
        
        .planning-header h2 {
            margin: 0;
        }
        
        .planning-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .planning-range {
            font-size: 0.9375rem;
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            padding: 0 var(--spacing-sm);
        }
        
        .planning-filters {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }
        
        .planning-grid-container {
            overflow-x: auto;
            padding: 0;
            -webkit-overflow-scrolling: touch;
            width: 100%;
        }
        
        .planning-scroll {
            overflow-x: auto;
            overflow-y: visible;
            -webkit-overflow-scrolling: touch;
            width: 100%;
        }
        
        .planning-grid {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .planning-grid th,
        .planning-grid td {
            padding: var(--spacing-sm);
            text-align: center;
            border: 1px solid var(--color-border);
        }
        
        .planning-grid th {
            background: var(--color-background);
            font-weight: var(--font-weight-semibold);
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.875rem;
        }
        
        .planning-grid th.task-header {
            text-align: left;
            min-width: 250px;
            max-width: 350px;
        }
        
        .planning-grid th.responsible-header {
            text-align: left;
            min-width: 120px;
            width: 150px;
        }
        
        .planning-grid th.hours-header {
            text-align: center;
            min-width: 80px;
            width: 80px;
        }
        
        .planning-grid th.date-header {
            min-width: 70px;
            writing-mode: horizontal-tb;
        }
        
        .planning-grid th.weekend {
            background: #f0f0f0;
            color: var(--color-text-secondary);
        }
        
        .planning-grid td.task-cell {
            text-align: left;
            font-size: 0.875rem;
            background: var(--color-white);
        }
        
        .planning-grid td.responsible-cell {
            text-align: left;
            font-size: 0.875rem;
            background: var(--color-white);
            color: var(--color-text-primary);
            font-weight: var(--font-weight-medium);
            padding: var(--spacing-xs);
        }
        
        /* ‚úÖ NOVO: Estilo para select de respons√°vel */
        .planning-grid .responsible-select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-size: 0.875rem;
            background-color: var(--color-white);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: border-color 0.2s ease;
        }
        
        .planning-grid .responsible-select:hover {
            border-color: var(--color-primary);
        }
        
        .planning-grid .responsible-select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        .planning-grid td.hours-cell {
            text-align: center;
            background: var(--color-white);
            padding: var(--spacing-xs);
        }
        
        .hours-input {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            text-align: center;
            font-family: var(--font-family);
            transition: all var(--transition-fast);
        }
        
        .hours-input:focus {
            outline: none;
            border-color: var(--color-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .hours-input::-webkit-inner-spin-button,
        .hours-input::-webkit-outer-spin-button {
            opacity: 1;
        }
        
        .planning-grid td.date-cell {
            cursor: pointer;
            transition: all var(--transition-fast);
            background: var(--color-white);
            position: relative;
        }
        
        .planning-grid td.date-cell:hover {
            background: var(--color-background);
        }
        
        .planning-grid td.date-cell.allocated {
            background: var(--color-blue);
            color: var(--color-white);
            font-weight: var(--font-weight-bold);
        }
        
        .planning-grid td.date-cell.allocated::after {
            content: 'X';
            font-size: 1.125rem;
        }
        
        .planning-grid td.date-cell.weekend {
            background: #f9f9f9;
        }
        
        .planning-grid td.date-cell.weekend:hover {
            background: #f0f0f0;
        }
        
        .planning-grid td.date-cell.weekend.allocated {
            background: var(--color-blue);
            opacity: 0.8;
        }
        
        .task-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .task-title {
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .task-meta {
            display: flex;
            gap: var(--spacing-xs);
            flex-wrap: wrap;
        }
        
        .task-responsible {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .task-responsible svg {
            width: 12px;
            height: 12px;
        }
        
        .planning-legend {
            margin-top: var(--spacing-lg);
        }
        
        .planning-legend h3 {
            font-size: 1rem;
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-md);
        }
        
        .legend-items {
            display: flex;
            gap: var(--spacing-lg);
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.875rem;
        }
        
        .legend-box {
            width: 40px;
            height: 30px;
            border: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-weight: var(--font-weight-bold);
        }
        
        .legend-box.allocated {
            background: var(--color-blue);
            color: var(--color-white);
        }
        
        .legend-box.weekend {
            background: #f9f9f9;
        }
        
        /* Responsivo - Planeamento */
        @media (max-width: 768px) {
            .planning-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .planning-actions {
                justify-content: space-between;
            }
            
            .planning-filters {
                flex-direction: column;
            }
            
            .planning-filters .btn {
                width: 100%;
            }
            
            .planning-grid {
                min-width: 600px;
            }
            
            .planning-grid th.task-header {
                min-width: 150px;
                max-width: 150px;
                font-size: 0.75rem;
            }
            
            .planning-grid th.responsible-header {
                min-width: 80px;
                font-size: 0.7rem;
            }
            
            .planning-grid th.hours-header {
                min-width: 50px;
                font-size: 0.7rem;
            }
            
            .planning-grid th.date-header {
                min-width: 50px;
                font-size: 0.7rem;
                padding: 4px;
            }
            
            .planning-grid td {
                padding: 6px;
                font-size: 0.75rem;
            }
            
            .hours-input {
                width: 45px;
                font-size: 0.75rem;
                padding: 2px 4px;
            }
            
            .legend-items {
                flex-direction: column;
            }
            
            /* PDF Viewer Mobile */
            .pdf-actions {
                flex-direction: column;
                gap: var(--spacing-xs);
            }
            
            .pdf-actions .btn {
                width: 100%;
                justify-content: center;
            }
            
            .pdf-viewer {
                height: 70vh;
                min-height: 400px;
            }
            
            .pdf-viewer-header {
                padding: var(--spacing-sm) var(--spacing-md);
            }
            
            .pdf-viewer-header h3 {
                font-size: 1rem;
            }
        }
        
        /* Mobile Pequeno (iPhone SE, etc) */
        @media (max-width: 480px) {
            .app-header h1 {
                font-size: 0.9rem !important;
            }
            
            .tab-btn {
                font-size: 0.65rem !important;
                padding: 6px 10px !important;
                min-width: 70px;
            }
            
            .tab-btn svg {
                width: 18px !important;
                height: 18px !important;
            }
            
            .app-main {
                padding: var(--spacing-sm);
            }
            
            .card {
                padding: var(--spacing-sm);
            }
            
            .card-title {
                font-size: 1.1rem;
            }
            
            .form-group label {
                font-size: 0.875rem;
            }
            
            .form-input,
            .form-select,
            .form-textarea {
                font-size: 0.875rem;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 0.875rem;
            }
            
            .planning-grid {
                min-width: 500px;
            }
            
            .planning-grid th.task-header {
                min-width: 120px;
                max-width: 120px;
            }
            
            .planning-grid th.responsible-header {
                min-width: 70px;
            }
            
            .planning-grid th.hours-header {
                min-width: 45px;
            }
            
            .planning-grid th.date-header {
                min-width: 45px;
                font-size: 0.65rem;
                padding: 2px;
            }
            
            .hours-input {
                width: 40px;
                font-size: 0.7rem;
            }
            
            .request-card {
                padding: var(--spacing-sm);
            }
            
            .request-header h3 {
                font-size: 1rem;
            }
            
            .badge {
                font-size: 0.7rem;
                padding: 2px 8px;
            }
            
            .pdf-viewer {
                height: 60vh;
                min-height: 300px;
            }
        }
        
        /* Mobile Extra Pequeno (iPhone 12/13/14 width) */
        @media (max-width: 400px) {
            .app-header h1 {
                font-size: 0.85rem !important;
            }
            
            .tab-btn {
                font-size: 0.6rem !important;
                padding: 6px 8px !important;
                min-width: 65px;
            }
            
            .tab-btn svg {
                width: 16px !important;
                height: 16px !important;
            }
        }
        
        /* Fix espec√≠fico Chrome iOS */
        @supports (-webkit-touch-callout: none) {
            @media (max-width: 768px) {
                .tab-btn {
                    -webkit-tap-highlight-color: transparent;
                    touch-action: manipulation;
                }
                
                .app-main {
                    padding: 10px !important;
                }
            }
        }
        
        /* Print Styles */
        @media print {
            .app-header,
            .tab-nav,
            .filters-card,
            .list-header,
            .request-actions,
            .btn,
            .modal {
                display: none !important;
            }
            
            body {
                background: white;
            }
            
            .request-card {
                page-break-inside: avoid;
                border: 1px solid #000;
                margin-bottom: 10px;
            }
        }
        
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        /* ===================================
           STOCK MODULE - ESTILOS
           =================================== */
        
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }
        
        .stock-search {
            flex: 1;
            min-width: 250px;
            max-width: 500px;
        }
        
        .stock-filters {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }
        
        .familia-selector {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            background: var(--color-white);
            font-family: var(--font-family);
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .familia-selector:focus {
            outline: none;
            border-color: var(--color-blue);
        }
        
        .stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }
        
        .stock-card {
            background: var(--color-white);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-fast);
            border: 1px solid var(--color-border);
        }
        
        .stock-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .stock-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-sm);
        }
        
        .stock-familia-badge {
            font-size: 0.75rem;
            font-weight: var(--font-weight-semibold);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            background: rgba(0, 122, 255, 0.1);
            color: var(--color-blue);
            white-space: nowrap;
        }
        
        .stock-card-title {
            font-size: 1rem;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin: var(--spacing-xs) 0;
            line-height: 1.3;
        }
        
        .stock-card-ref {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            font-family: 'Courier New', monospace;
        }
        
        .stock-info {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            margin: var(--spacing-md) 0;
            padding: var(--spacing-sm);
            background: var(--color-background);
            border-radius: var(--radius-sm);
        }
        
        .stock-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
        }
        
        .stock-info-label {
            color: var(--color-text-secondary);
            font-weight: var(--font-weight-medium);
        }
        
        .stock-info-value {
            color: var(--color-text-primary);
            font-weight: var(--font-weight-semibold);
        }
        
        .stock-level {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .stock-level.baixo {
            color: var(--color-alta);
        }
        
        .stock-level.ok {
            color: var(--color-baixa);
        }
        
        .stock-level-icon {
            font-size: 1.2rem;
        }
        
        .stock-card-actions {
            display: flex;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-md);
        }
        
        .stock-btn {
            flex: 1;
            padding: var(--spacing-sm);
            border: none;
            border-radius: var(--radius-sm);
            font-family: var(--font-family);
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
        }
        
        .stock-btn-primary {
            background: var(--color-blue);
            color: var(--color-white);
        }
        
        .stock-btn-primary:hover {
            background: var(--color-blue-dark);
        }
        
        .stock-btn-secondary {
            background: var(--color-background);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
        }
        
        .stock-btn-secondary:hover {
            background: var(--color-border);
        }
        
        .stock-alerts {
            margin-bottom: var(--spacing-lg);
        }
        
        .alert-card {
            background: #FFF3CD;
            border: 1px solid #FFC107;
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .alert-card.critical {
            background: #F8D7DA;
            border-color: #F5C6CB;
        }
        
        .alert-title {
            font-size: 1rem;
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .alert-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }
        
        .alert-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-xs);
            background: rgba(255, 255, 255, 0.5);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
        }
        
        .movimento-form {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        .artigo-selected-info {
            background: var(--color-background);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
        }
        
        .artigo-selected-info h4 {
            margin-bottom: var(--spacing-xs);
            color: var(--color-text-primary);
        }
        
        .artigo-selected-info p {
            color: var(--color-text-secondary);
            font-size: 0.875rem;
            margin: 4px 0;
        }
        
        .quantidade-input-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .quantidade-btn {
            width: 40px;
            height: 40px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            background: var(--color-white);
            color: var(--color-text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }
        
        .quantidade-btn:hover {
            background: var(--color-background);
            border-color: var(--color-blue);
        }
        
        .quantidade-input {
            flex: 1;
            text-align: center;
            font-size: 1.2rem;
            font-weight: var(--font-weight-semibold);
        }
        
        .artigos-list {
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            background: var(--color-background);
            margin-top: var(--spacing-md);
        }
        
        .artigos-list-title {
            font-size: 0.875rem;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-sm);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .artigo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm);
            background: var(--color-white);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-xs);
        }
        
        .artigo-item-info {
            flex: 1;
        }
        
        .artigo-item-name {
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            font-size: 0.875rem;
        }
        
        .artigo-item-details {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            margin-top: 2px;
        }
        
        .artigo-item-remove {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--color-alta);
            color: var(--color-alta);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.75rem;
            transition: all var(--transition-fast);
        }
        
        .artigo-item-remove:hover {
            background: var(--color-alta);
            color: var(--color-white);
        }
        
        .artigos-total {
            margin-top: var(--spacing-sm);
            padding-top: var(--spacing-sm);
            border-top: 2px solid var(--color-border);
            font-weight: var(--font-weight-semibold);
            text-align: right;
            color: var(--color-text-primary);
        }
        
        @media (max-width: 768px) {
            .stock-grid {
                grid-template-columns: 1fr;
            }
            
            .stock-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stock-search {
                max-width: none;
            }
        }
        
        /* ===================================
           STOCK MODULE - NOVOS ESTILOS
           =================================== */
        
        .card-header-flex {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }
        
        .stock-table-container {
            overflow-x: auto;
            margin-top: var(--spacing-md);
        }
        
        .stock-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--color-white);
            font-size: 0.875rem;
        }
        
        .stock-table thead {
            background: var(--color-background);
            position: sticky;
            top: 0;
        }
        
        .stock-table th {
            padding: var(--spacing-sm) var(--spacing-md);
            text-align: left;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-secondary);
            border-bottom: 2px solid var(--color-border);
            white-space: nowrap;
        }
        
        .stock-table td {
            padding: var(--spacing-sm) var(--spacing-md);
            border-bottom: 1px solid var(--color-border);
            vertical-align: middle;
        }
        
        .stock-table tbody tr:hover {
            background: var(--color-background);
        }
        
        .stock-value {
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
        }
        
        .stock-value.baixo {
            color: var(--color-alta);
        }
        
        .stock-value.ok {
            color: var(--color-baixa);
        }
        
        .stock-actions {
            display: flex;
            gap: var(--spacing-xs);
            flex-wrap: nowrap;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.75rem;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: var(--font-weight-semibold);
            white-space: nowrap;
        }
        
        .badge-entrada {
            background: rgba(52, 199, 89, 0.1);
            color: var(--color-baixa);
        }
        
        .badge-saida {
            background: rgba(255, 59, 48, 0.1);
            color: var(--color-alta);
        }
        
        .badge-ajuste {
            background: rgba(255, 149, 0, 0.1);
            color: var(--color-media);
        }
        
        .empty-state-small {
            text-align: center;
            padding: var(--spacing-lg);
            color: var(--color-text-secondary);
            font-size: 0.875rem;
        }
        
        .stock-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: var(--spacing-md) 0 var(--spacing-sm) 0;
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--color-border);
        }
        
        .movimento-filters {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
            flex-wrap: wrap;
        }
        
        .movimento-filters .form-input {
            flex: 1;
            min-width: 150px;
        }
        
        .quantidade-badge {
            font-weight: var(--font-weight-bold);
            color: var(--color-text-primary);
        }
        
        .quantidade-badge.negativo {
            color: var(--color-alta);
        }
        
        .quantidade-badge.positivo {
            color: var(--color-baixa);
        }
        
        .badge-entrada {
            background: rgba(52, 199, 89, 0.1);
            color: var(--color-baixa);
        }
        
        .badge-saida {
            background: rgba(255, 59, 48, 0.1);
            color: var(--color-alta);
        }
        
        .badge-ajuste {
            background: rgba(255, 149, 0, 0.1);
            color: var(--color-media);
        }
        
        .stock-actions {
            display: flex;
            gap: var(--spacing-xs);
            flex-wrap: wrap;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 0.75rem;
        }
        
        .stock-value {
            font-weight: var(--font-weight-semibold);
        }
        
        .stock-value.baixo {
            color: var(--color-alta);
        }
        
        .stock-value.ok {
            color: var(--color-baixa);
        }
        
        .artigo-selected-info {
            padding: var(--spacing-md);
            background: var(--color-background);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
        }
        
        .artigo-selected-info h4 {
            margin-bottom: var(--spacing-xs);
            color: var(--color-text-primary);
        }
        
        .artigo-selected-info p {
            margin: var(--spacing-xs) 0;
            font-size: 0.875rem;
            color: var(--color-text-secondary);
        }
        
        /* Sec√ß√£o de Novo Movimento - Destacada */
        .card .btn-primary svg {
            display: inline-block;
            vertical-align: middle;
        }
        
        /* Stock Cards Grid */
        .stock-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }
        
        .stock-card {
            background: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }
        
        .stock-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .stock-card-header {
            margin-bottom: var(--spacing-sm);
        }
        
        .stock-card-title {
            font-size: 1rem;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin-bottom: var(--spacing-xs);
        }
        
        .stock-card-ref {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            font-family: 'Courier New', monospace;
        }
        
        .stock-card-body {
            margin-bottom: var(--spacing-md);
        }
        
        .stock-card-info {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            font-size: 0.875rem;
        }
        
        .stock-card-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stock-card-info-label {
            color: var(--color-text-secondary);
        }
        
        .stock-card-info-value {
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
        }
        
        .stock-card-stock {
            background: var(--color-background);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm);
            margin: var(--spacing-sm) 0;
            text-align: center;
        }
        
        .stock-card-stock-label {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .stock-card-stock-value {
            font-size: 1.5rem;
            font-weight: var(--font-weight-bold);
        }
        
        .stock-card-stock-value.baixo {
            color: var(--color-alta);
        }
        
        .stock-card-stock-value.ok {
            color: var(--color-baixa);
        }
        
        .stock-card-footer {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .stock-card-footer .btn {
            flex: 1;
        }
        
        @media (max-width: 768px) {
            .stock-cards-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .stock-table {
                font-size: 0.75rem;
            }
            
            .stock-table th,
            .stock-table td {
                padding: var(--spacing-xs) var(--spacing-sm);
            }
            
            .stock-actions {
                flex-direction: column;
            }
            
            .card-header-flex {
                flex-direction: column;
                align-items: stretch;
            }
        }
        
        /* ===================================
           TOAST NOTIFICATIONS
           =================================== */
        
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            pointer-events: none;
        }
        
        .toast {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background: var(--color-white);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 300px;
            max-width: 400px;
            pointer-events: auto;
            animation: slideInRight 0.3s ease;
        }
        
        .toast svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        
        .toast.success {
            border-left: 4px solid var(--color-baixa);
        }
        
        .toast.success svg {
            color: var(--color-baixa);
        }
        
        .toast.error {
            border-left: 4px solid var(--color-alta);
        }
        
        .toast.error svg {
            color: var(--color-alta);
        }
        
        .toast.info {
            border-left: 4px solid var(--color-blue);
        }
        
        .toast.info svg {
            color: var(--color-blue);
        }
        
        .toast-message {
            flex: 1;
            font-size: 0.875rem;
            color: var(--color-text-primary);
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        @media (max-width: 768px) {
            .toast-container {
                top: 60px;
                right: 10px;
                left: 10px;
            }
            
            .toast {
                min-width: auto;
                max-width: none;
            }
        }
        
        /* ============================================
           LOADING SPINNER - Feedback visual durante carregamento
           ============================================ */
        
        .loading-spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .loading-spinner-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-spinner-content {
            background: white;
            padding: 40px 60px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .spinner-circle {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner-message {
            margin: 0;
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }
        
        @media (max-width: 768px) {
            .loading-spinner-content {
                padding: 30px 40px;
            }
            
            .spinner-circle {
                width: 50px;
                height: 50px;
                border-width: 4px;
            }
            
            .spinner-message {
                font-size: 14px;
            }
        }
        
        /* ============================================
           LOGIN SCREEN - APPLE CLEAN STYLE
           ============================================ */
        
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #FFFFFF;
            display: none; /* Escondido por padr√£o - JS mostra se necess√°rio */
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .login-screen.show {
            display: flex; /* Mostrar quando JS adicionar classe .show */
        }
        
        .login-card-wrapper {
            width: 100%;
            max-width: 420px;
            padding: 20px;
        }
        
        .login-card-apple {
            background: #FFFFFF;
            border-radius: 20px;
            padding: 48px 40px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
            border: 1px solid #E5E5E7;
            text-align: center;
            animation: fadeInUp 0.4s ease;
        }
        
        .login-logo-container {
            margin-bottom: 32px;
        }
        
        .login-logo {
            width: 120px;
            height: 120px;
            margin: 0 auto;
            display: block;
            /* Remover fundo branco da imagem */
            border-radius: 50%;
            padding: 10px;
            background: transparent;
            /* Adicionar sombra suave para destacar */
            filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.1));
        }
        
        img.login-logo {
            width: 140px !important;
            height: 140px !important;
            object-fit: contain;
            border-radius: 0;
            padding: 0;
        }
        
        .login-title-apple {
            font-size: 28px;
            font-weight: 600;
            color: #1D1D1F;
            margin: 0 0 8px 0;
            letter-spacing: -0.5px;
        }
        
        .login-subtitle-apple {
            font-size: 15px;
            color: #86868B;
            margin: 0 0 32px 0;
            font-weight: 400;
        }
        
        .login-form-apple {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .login-input-wrapper {
            position: relative;
        }
        
        .login-input-apple {
            width: 100%;
            padding: 16px 20px;
            border: 1px solid #D2D2D7;
            border-radius: 12px;
            font-size: 17px;
            font-family: var(--font-family);
            background: #FAFAFA;
            color: #1D1D1F;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }
        
        .login-input-apple::placeholder {
            color: #86868B;
        }
        
        .login-input-apple:focus {
            outline: none;
            border-color: #1D1D1F;
            background: #FFFFFF;
            box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.03);
        }
        
        .login-button-apple {
            width: 100%;
            padding: 16px 24px;
            background: #1D1D1F;
            color: #FFFFFF;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.2s ease;
            font-family: var(--font-family);
        }
        
        .login-button-apple:hover {
            background: #000000;
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }
        
        .login-button-apple:active {
            transform: translateY(0);
        }
        
        .login-button-apple:disabled {
            background: #D2D2D7;
            cursor: not-allowed;
            transform: none;
        }
        
        .login-error-apple {
            background: #FFEBEE;
            border: 1px solid #FFCDD2;
            color: #C62828;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 14px;
            text-align: center;
            margin: 8px 0;
            animation: shake 0.3s;
        }
        
        .login-hint-apple {
            margin-top: 24px;
            padding: 16px;
            background: #F5F5F7;
            border-radius: 12px;
            text-align: left;
        }
        
        .hint-title {
            font-size: 13px;
            font-weight: 600;
            color: #1D1D1F;
            margin-bottom: 8px;
        }
        
        .hint-credentials {
            font-size: 13px;
            color: #86868B;
            line-height: 1.6;
        }
        
        .hint-label {
            color: #1D1D1F;
            font-weight: 500;
        }
        
        .hint-credentials code {
            background: #FFFFFF;
            padding: 3px 8px;
            border-radius: 6px;
            color: #1D1D1F;
            font-size: 13px;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            border: 1px solid #E5E5E7;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        @media (max-width: 768px) {
            .login-card-apple {
                padding: 36px 28px;
            }
            
            .login-title-apple {
                font-size: 24px;
            }
            
            .login-logo {
                width: 80px;
                height: 80px;
            }
            
            img.login-logo {
                width: 100px !important;
                height: 100px !important;
                object-fit: contain;
            }
        }
        
        /* Estilos antigos mantidos para compatibilidade */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #FFFFFF;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .login-overlay.hidden { display: none; }
        
        .login-btn {
            background: #1D1D1F;
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s;
        }
        
        .login-btn:hover { transform: translateY(-2px); }
        .login-btn:active { transform: translateY(0); }
        .login-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .login-error {
            background: #ffebee;
            border: 1px solid #ef5350;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            animation: shake 0.3s;
        }
        
        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
            margin-right: 12px;
        }
        
        .user-info .user-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text-primary);
        }
        
        .user-info .user-dept {
            font-size: 12px;
            color: var(--color-text-secondary);
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 14px;
        }
        
        .logout-btn {
            background: transparent !important;
            border: 1px solid var(--color-border) !important;
            color: var(--color-text-primary) !important;
            width: 40px !important;
            height: 40px !important;
            padding: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .logout-btn:hover {
            background: var(--color-background);
            border-color: var(--color-blue);
            color: var(--color-blue);
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="header-content">
            <h1>
                <img src="/appmanutencao/icons/android-chrome-192x192.png" alt="Logo" class="header-icon" id="headerLogo">
                Manuten√ß√£o
            </h1>
            <div class="header-actions">
                <div id="userInfo" class="user-info" style="display: none;">
                    <span class="user-name"></span>
                    <span class="user-dept"></span>
                </div>

                <button class="btn-icon logout-btn" id="logoutBtn" title="Terminar Sess√£o" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="app-main">
        
        <!-- Tab Navigation -->
        <nav class="tab-nav">
            <button class="tab-btn active" data-tab="novo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
                Novo Pedido
            </button>
            <button class="tab-btn" data-tab="lista">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/>
                </svg>
                Lista de Pedidos
            </button>
            <button class="tab-btn" data-tab="planeamento">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                Planeamento
            </button>
            <button class="tab-btn" data-tab="autonomas">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10 9 9 9 8 9"/>
                </svg>
                Standard manuten√ß√µes MCF
            </button>
            <button class="tab-btn" data-tab="stock">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                    <line x1="12" y1="22.08" x2="12" y2="12"/>
                </svg>
                Stock
            </button>
        </nav>

        <!-- Novo Pedido Tab -->
        <section class="tab-content active" id="tab-novo">
            <div class="container">
                <div class="card form-card">
                    <h2 class="card-title">Criar Novo Pedido</h2>
                    
                    <form id="maintenanceForm" class="maintenance-form">
                        <!-- Tipo de Manuten√ß√£o -->
                        <div class="form-group">
                            <label class="form-label" for="tipo">Tipo de Manuten√ß√£o *</label>
                            <select class="form-input" id="tipo" name="tipo" required>
                                <option value="">Selecione o tipo</option>
                                <option value="Preventiva">Preventiva</option>
                                <option value="Corretiva">Corretiva</option>
                                <option value="Melhoria">Melhoria</option>
                            </select>
                        </div>

                        <!-- Prioridade -->
                        <div class="form-group">
                            <label class="form-label">Prioridade *</label>
                            <div class="priority-selector">
                                <label class="priority-option priority-alta">
                                    <input type="radio" name="prioridade" value="Alta" required>
                                    <span class="priority-label">
                                        <svg viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12 2L2 12h3v8h14v-8h3L12 2z"/>
                                        </svg>
                                        Alta
                                    </span>
                                </label>
                                <label class="priority-option priority-media">
                                    <input type="radio" name="prioridade" value="M√©dia" required>
                                    <span class="priority-label">
                                        <svg viewBox="0 0 24 24" fill="currentColor">
                                            <circle cx="12" cy="12" r="10"/>
                                        </svg>
                                        M√©dia
                                    </span>
                                </label>
                                <label class="priority-option priority-baixa">
                                    <input type="radio" name="prioridade" value="Baixa" required>
                                    <span class="priority-label">
                                        <svg viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12 22L22 12h-3V4H5v8H2l10 10z"/>
                                        </svg>
                                        Baixa
                                    </span>
                                </label>
                            </div>
                        </div>

                        <!-- Empresa -->
                        <div class="form-group">
                            <label class="form-label" for="empresa">Empresa *</label>
                            <select class="form-input" id="empresa" name="empresa" required>
                                <option value="">Selecione a empresa</option>
                                <option value="MCF">MCF</option>
                                <option value="PSY">PSY</option>
                            </select>
                        </div>

                        <!-- Tipo de Interven√ß√£o -->
                        <div class="form-group">
                            <label class="form-label" for="tipoIntervencao">Tipo de Interven√ß√£o</label>
                            <select class="form-input" id="tipoIntervencao" name="tipoIntervencao">
                                <option value="">Selecione o tipo (opcional)</option>
                                <option value="Eletricidade">Eletricidade</option>
                                <option value="Mec√¢nica">Mec√¢nica</option>
                                <option value="Hidr√°ulica">Hidr√°ulica</option>
                                <option value="Serralharia">Serralharia</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>

                        <!-- ‚ö° NOVO: √Årea/Equipamento -->
                        <div class="form-group">
                            <label class="form-label" for="areaEquipamento">√Årea/Equipamento *</label>
                            <select class="form-input" id="areaEquipamento" name="areaEquipamento" required>
                                <option value="">Selecione a √°rea/equipamento</option>
                                <!-- Preenchido dinamicamente via JavaScript -->
                            </select>
                        </div>

                        <!-- ‚ö° NOVO: Componente (desabilitado at√© escolher √Årea) -->
                        <div class="form-group">
                            <label class="form-label" for="componente">Componente *</label>
                            <select class="form-input" id="componente" name="componente" required disabled>
                                <option value="">Escolha primeiro a √°rea/equipamento</option>
                                <!-- Preenchido dinamicamente via JavaScript -->
                            </select>
                        </div>

                        <!-- Checkboxes: Urgente e Paragem Produ√ß√£o -->
                        <div class="form-group">
                            <div class="checkbox-group" style="display: flex; flex-direction: column; gap: 12px;">
                                <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="urgente" name="urgente" value="true" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-size: 14px; color: #333;">üî¥ Urgente</span>
                                </label>
                                <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="paragemProducao" name="paragemProducao" value="true" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-size: 14px; color: #333;">‚ö†Ô∏è Implica paragem de produ√ß√£o</span>
                                </label>
                            </div>
                        </div>

                        <!-- Departamento -->
                        <div class="form-group">
                            <label class="form-label" for="departamento">Departamento</label>
                            <input type="text" class="form-input" id="departamento" name="departamento" placeholder="Ex: Produ√ß√£o, Log√≠stica...">
                        </div>

                        <!-- Descri√ß√£o -->
                        <div class="form-group">
                            <label class="form-label" for="descricao">Descri√ß√£o *</label>
                            <textarea class="form-input" id="descricao" name="descricao" rows="4" placeholder="Descreva o problema ou melhoria necess√°ria..." required></textarea>
                        </div>

                        <!-- Upload de Foto -->
                        <div class="form-group">
                            <label class="form-label" for="foto">Fotografia (opcional, m√°x. 2MB)</label>
                            <div class="file-upload">
                                <input type="file" id="foto" name="foto" accept="image/*" class="file-input">
                                <label for="foto" class="file-label">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <path d="M21 15l-5-5L5 21"/>
                                    </svg>
                                    <span id="fileName">Escolher imagem</span>
                                </label>
                                <div id="imagePreview" class="image-preview"></div>
                            </div>
                        </div>

                        <!-- Nome -->
                        <div class="form-group">
                            <label class="form-label" for="nome">Nome de quem regista *</label>
                            <input type="text" class="form-input" id="nome" name="nome" placeholder="Seu nome completo" required>
                        </div>

                        <!-- Bot√µes -->
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="clearBtn">Limpar</button>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                                    <polyline points="17 21 17 13 7 13 7 21"/>
                                    <polyline points="7 3 7 8 15 8"/>
                                </svg>
                                Criar Pedido
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- Lista de Pedidos Tab -->
        <section class="tab-content" id="tab-lista">
            <div class="container">
                <!-- Filtros -->
                <div class="card filters-card">
                    <div class="filters-header">
                        <h3>Filtros</h3>
                        <button class="btn-text" id="clearFilters">Limpar</button>
                    </div>
                    
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">Tipo</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Preventiva" class="filter-tipo">
                                    <span>Preventiva</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Corretiva" class="filter-tipo">
                                    <span>Corretiva</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Melhoria" class="filter-tipo">
                                    <span>Melhoria</span>
                                </label>
                            </div>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Prioridade</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Alta" class="filter-prioridade">
                                    <span>Alta</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="M√©dia" class="filter-prioridade">
                                    <span>M√©dia</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Baixa" class="filter-prioridade">
                                    <span>Baixa</span>
                                </label>
                            </div>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Estado</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Novo" class="filter-estado" checked>
                                    <span>Novo</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Em curso" class="filter-estado" checked>
                                    <span>Em curso</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Resolvido" class="filter-estado">
                                    <span>Resolvido</span>
                                </label>
                            </div>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Empresa</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="MCF" class="filter-empresa">
                                    <span>MCF</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="PSY" class="filter-empresa">
                                    <span>PSY</span>
                                </label>
                            </div>
                        </div>

                        <!-- ‚ö° NOVO: Filtro de Equipamento -->
                        <div class="filter-group">
                            <label class="filter-label">üîß √Årea/Equipamento</label>
                            <select id="filterEquipamento" class="form-input" style="width: 100%; margin-top: 8px;">
                                <option value="">Todos os equipamentos</option>
                                <!-- Populado dinamicamente via JavaScript -->
                            </select>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Tipo de Interven√ß√£o</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Eletricidade" class="filter-tipoIntervencao">
                                    <span>Eletricidade</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Mec√¢nica" class="filter-tipoIntervencao">
                                    <span>Mec√¢nica</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Hidr√°ulica" class="filter-tipoIntervencao">
                                    <span>Hidr√°ulica</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Serralharia" class="filter-tipoIntervencao">
                                    <span>Serralharia</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Outros" class="filter-tipoIntervencao">
                                    <span>Outros</span>
                                </label>
                            </div>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Especiais</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="true" class="filter-urgente">
                                    <span>üî¥ Urgente</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="true" class="filter-paragemProducao">
                                    <span>‚ö†Ô∏è Paragem Produ√ß√£o</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lista Header -->
                <div class="list-header">
                    <div class="list-info">
                        <span id="listCount">0 pedidos</span>
                    </div>
                    <button class="btn-icon" id="sortBtn" title="Ordenar por data">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 5h10M11 9h7M11 13h4M3 17l3 3 3-3M6 18V4"/>
                        </svg>
                    </button>
                </div>

                <!-- Lista de Pedidos -->
                <div id="requestsList" class="requests-list">
                    <!-- Pedidos ser√£o inseridos aqui dinamicamente -->
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"/>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                    </svg>
                    <h3>Nenhum pedido encontrado</h3>
                    <p>Crie o primeiro pedido ou ajuste os filtros</p>
                </div>
            </div>
        </section>

        <!-- Planeamento Tab -->
        <section class="tab-content" id="tab-planeamento">
            <div class="container">
                <!-- Controlos do Planeamento -->
                <div class="card planning-controls">
                    <div class="planning-header">
                        <h2 class="card-title">Planeamento de Manuten√ß√£o</h2>
                        <div class="planning-actions">
                            <button class="btn-icon" id="prevWeekBtn" title="Semana anterior">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M15 18l-6-6 6-6"/>
                                </svg>
                            </button>
                            <span class="planning-range" id="planningRange">Carregando...</span>
                            <button class="btn-icon" id="nextWeekBtn" title="Pr√≥xima semana">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 18l6-6-6-6"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="planning-filters">
                        <button class="btn btn-secondary" id="todayBtn">Hoje</button>
                        <button class="btn btn-secondary" id="savePlanningBtn">Salvar Planeamento</button>
                        <button class="btn btn-primary" id="exportPlanningBtn">Exportar Excel</button>
                    </div>
                </div>

                <!-- Grid de Planeamento -->
                <div class="card planning-grid-container">
                    <div class="planning-scroll">
                        <table class="planning-grid" id="planningGrid">
                            <!-- Ser√° preenchido dinamicamente -->
                        </table>
                    </div>
                </div>

                <!-- Legenda -->
                <div class="card planning-legend">
                    <h3>Legenda</h3>
                    <div class="legend-items">
                        <div class="legend-item">
                            <span class="legend-box allocated">X</span>
                            <span>Dia alocado</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-box weekend"></span>
                            <span>Fim de semana</span>
                        </div>
                        <div class="legend-item">
                            <span class="badge badge-prioridade alta">Alta</span>
                            <span class="badge badge-prioridade media">M√©dia</span>
                            <span class="badge badge-prioridade baixa">Baixa</span>
                            <span>Prioridades</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Standard manuten√ß√µes MCF Tab -->
        <section class="tab-content" id="tab-autonomas">
            <div class="container">
                <div class="card">
                    <h2 class="card-title">Standard manuten√ß√µes MCF</h2>
                    <p class="card-description">Selecione uma m√°quina para visualizar os standards de manuten√ß√£o MCF.</p>
                    
                    <!-- Seletor de M√°quina -->
                    <div class="form-group">
                        <label class="form-label" for="machineSelect">M√°quina</label>
                        <select class="form-input" id="machineSelect">
                            <option value="">Selecione uma m√°quina</option>
                            <option value="crivo">Crivo de exc√™ntrico</option>
                            <option value="destrocador">Destro√ßador</option>
                            <option value="l01-dupla">L01 - Dupla</option>
                            <option value="l01-multiserra">L01 - Multiserra</option>
                            <option value="l01-paletizadora">L01 - Paletizadora</option>
                            <option value="l01-retestadeira">L01 - Retestadeira</option>
                            <option value="l01-tracador">L01 - Tra√ßador</option>
                            <option value="l02-charriot">L02 - Charriot</option>
                            <option value="l02-retestadeira">L02 - Retestadeira</option>
                            <option value="l03-alinhadeira">L03 - Alinhadeira</option>
                            <option value="l03-paletizadora">L03 - Paletizadora</option>
                            <option value="l03-retestadeira">L03 - Retestadeira</option>
                            <option value="tinas">Tinas impregnante</option>
                        </select>
                    </div>

                    <!-- A√ß√µes PDF -->
                    <div class="pdf-actions" id="pdfActions" style="display: none;">
                        <button class="btn btn-secondary" id="downloadPdfBtn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                            </svg>
                            Download
                        </button>
                        <button class="btn btn-secondary" id="printPdfBtn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 9V2h12v7M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                                <rect x="6" y="14" width="12" height="8"/>
                            </svg>
                            Imprimir
                        </button>
                        <button class="btn btn-primary" id="openOneDriveBtn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                <polyline points="15 3 21 3 21 9"/>
                                <line x1="10" y1="14" x2="21" y2="3"/>
                            </svg>
                            Abrir no Google Drive
                        </button>
                    </div>
                </div>

                <!-- Visualizador PDF -->
                <div class="card pdf-viewer-container" id="pdfViewerContainer" style="display: none;">
                    <div class="pdf-viewer-header">
                        <h3 id="pdfTitle">Procedimento de Manuten√ß√£o</h3>
                        <button class="btn-icon" id="closePdfBtn" title="Fechar">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                    <div class="pdf-viewer">
                        <iframe id="pdfIframe" frameborder="0" allowfullscreen></iframe>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="pdfEmptyState" class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                    </svg>
                    <h3>Selecione uma M√°quina</h3>
                    <p>Escolha uma m√°quina acima para visualizar os standards de manuten√ß√£o MCF</p>
                </div>
            </div>
        </section>

        <!-- Tab Stock -->
        <section class="tab-content" id="tab-stock">
            <div class="container">
                
                <!-- SEC√á√ÉO 1: CONSULTA E BAIXA R√ÅPIDA -->
                <div class="card">
                    <h2 class="card-title">üì¶ Consulta de Stock e Baixas</h2>
                    
                    <!-- Pesquisa de Artigo -->
                    <div class="form-group">
                        <label class="form-label">Procurar Artigo</label>
                        <input type="text" 
                               class="form-input" 
                               id="stockSearchInput" 
                               placeholder="Digite nome, fam√≠lia, refer√™ncia, fornecedor ou c√≥digo...">
                    </div>
                    
                    <!-- Resultados da Pesquisa em CARDS -->
                    <div id="stockSearchResults" style="display: none;">
                        <div class="stock-results-header">
                            <strong>Resultados:</strong>
                            <button class="btn btn-secondary btn-sm" onclick="clearStockSearch()">‚úï Limpar</button>
                        </div>
                        <div class="stock-cards-grid" id="stockSearchResultsBody">
                            <!-- Preenchido dinamicamente com cards -->
                        </div>
                    </div>
                    
                    <!-- Estado Vazio -->
                    <div id="stockEmptySearch" class="empty-state-small">
                        <p>üîç Digite acima para procurar artigos</p>
                    </div>
                </div>
                
                <!-- SEC√á√ÉO 2: REGISTAR NOVO MOVIMENTO -->
                <div class="card" style="margin-top: var(--spacing-lg);">
                    <h2 class="card-title">‚ûï Registar Novo Movimento</h2>
                    <p class="card-description">Criar entrada, sa√≠da ou ajuste de stock manualmente</p>
                    
                    <button class="btn btn-primary" onclick="openNovoMovimentoModal()" style="width: 100%; padding: var(--spacing-md);">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; margin-right: 8px;">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        Novo Movimento de Stock
                    </button>
                </div>
                
                <!-- SEC√á√ÉO 3: HIST√ìRICO DE MOVIMENTOS -->
                <div class="card" style="margin-top: var(--spacing-lg);">
                    <h2 class="card-title">üìã Hist√≥rico de Movimentos</h2>
                    
                    <!-- Filtros de Movimentos -->
                    <div class="movimento-filters">
                        <select class="form-input" id="movimentoTipoFilter" onchange="renderMovimentos()">
                            <option value="TODOS">Todos os Tipos</option>
                            <option value="ENTRADA">üì• Entradas</option>
                            <option value="SA√çDA">üì§ Sa√≠das</option>
                            <option value="AJUSTE">‚öôÔ∏è Ajustes</option>
                        </select>
                        <input type="number" 
                               class="form-input" 
                               id="movimentoLimitFilter" 
                               value="20" 
                               min="10" 
                               max="100" 
                               step="10"
                               onchange="renderMovimentos()"
                               placeholder="Limite">
                    </div>
                    
                    <!-- Tabela de Movimentos -->
                    <div class="stock-table-container">
                        <table class="stock-table">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Artigo</th>
                                    <th>Tipo</th>
                                    <th>Quantidade</th>
                                    <th>Respons√°vel</th>
                                    <th>Observa√ß√µes</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="movimentosTableBody">
                                <!-- Preenchido dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="movimentosEmptyState" class="empty-state-small" style="display: none;">
                        <p>üì≠ Nenhum movimento registado</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal de Detalhes -->
    <div class="modal" id="detailsModal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Detalhes do Pedido</h2>
                <button class="btn-close" id="closeModal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Conte√∫do ser√° inserido dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal: Movimento de Stock -->
    <div class="modal" id="movimentoModal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="movimentoModalTitle">Movimento de Stock</h2>
                <button class="btn-close" onclick="closeMovimentoModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="movimentoForm" class="movimento-form">
                    <!-- Filtro de Fam√≠lia -->
                    <div class="form-group">
                        <label class="form-label">üì¶ Fam√≠lia</label>
                        <select class="form-input" id="movimentoFamiliaSelect" onchange="filtrarArtigosPorFamilia()">
                            <option value="">Todas as fam√≠lias</option>
                        </select>
                    </div>
                    
                    <!-- Sele√ß√£o de Artigo -->
                    <div class="form-group" id="artigoSelectGroup">
                        <label class="form-label">Artigo *</label>
                        <select class="form-input" id="movimentoArtigoSelect" required onchange="updateArtigoInfo()">
                            <option value="">Selecione um artigo...</option>
                        </select>
                    </div>
                    
                    <!-- Info do Artigo Selecionado -->
                    <div class="artigo-selected-info" id="artigoSelectedInfo" style="display: none;"></div>
                    
                    <div class="form-group">
                        <label class="form-label">Tipo de Movimento *</label>
                        <select class="form-input" id="movimentoTipo" required>
                            <option value="ENTRADA">üì• Entrada (Compra/Devolu√ß√£o)</option>
                            <option value="SA√çDA">üì§ Sa√≠da (Consumo)</option>
                            <option value="AJUSTE">‚öôÔ∏è Ajuste (Corre√ß√£o)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Quantidade *</label>
                        <div class="quantidade-input-group">
                            <button type="button" class="quantidade-btn" onclick="adjustQuantidade(-1)">‚àí</button>
                            <input type="number" 
                                   class="form-input quantidade-input" 
                                   id="movimentoQuantidade" 
                                   min="1" 
                                   value="1" 
                                   required>
                            <button type="button" class="quantidade-btn" onclick="adjustQuantidade(1)">+</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Empresa *</label>
                        <select class="form-input" id="movimentoEmpresa" required>
                            <option value="">Selecione a empresa</option>
                            <option value="MCF" selected>MCF</option>
                            <option value="PSY">PSY</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Respons√°vel</label>
                        <input type="text" 
                               class="form-input" 
                               id="movimentoResponsavel" 
                               list="responsaveisList">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Observa√ß√µes</label>
                        <textarea class="form-input" 
                                  id="movimentoObservacoes" 
                                  rows="3" 
                                  placeholder="Motivo do movimento, notas adicionais..."></textarea>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeMovimentoModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">üíæ Registar Movimento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Login - Apple Style Clean -->
    <div class="login-screen" id="loginModal" style="display: none;">
        <div class="login-card-wrapper">
            <div class="login-card-apple">
                <!-- Logo -->
                <div class="login-logo-container">
                    <img src="/appmanutencao/icons/android-chrome-192x192.png" alt="Logo Manuten√ß√£o" class="login-logo" id="loginLogo">
                </div>
                
                <!-- T√≠tulo -->
                <h1 class="login-title-apple">Gest√£o de manuten√ß√£o MCF + PSY</h1>
                <p class="login-subtitle-apple">Fa√ßa login para continuar</p>
                
                <!-- Formul√°rio -->
                <form id="loginForm" class="login-form-apple">
                    <div class="login-input-wrapper">
                        <input type="text" 
                               class="login-input-apple" 
                               id="loginUsername" 
                               placeholder="Username"
                               required 
                               autocomplete="username">
                    </div>
                    
                    <div class="login-input-wrapper">
                        <input type="password" 
                               class="login-input-apple" 
                               id="loginPassword" 
                               placeholder="Password"
                               required 
                               autocomplete="current-password">
                    </div>
                    
                    <div id="loginError" class="login-error-apple" style="display: none;"></div>
                    
                    <button type="submit" class="login-button-apple">
                        Entrar
                    </button>
                    

                </form>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- JavaScript Principal (INLINE para garantir funcionamento) -->
    <script>
// ================================================
// App de Manuten√ß√£o - JavaScript Principal  
// VERS√ÉO INLINE PARA MOBILE PWA
// ================================================

// CONFIGURA√á√ÉO
const CONFIG = {
    GOOGLE_SHEETS_URL: 'https://script.google.com/macros/s/AKfycbxsgLa1qTwDRg13sItlTHg5cqhFaxrvjj_Oq-7f7VCBUcMNog_qPvRDrYm1vgAkoB-w-g/exec',
    MAX_IMAGE_SIZE: 2 * 1024 * 1024,
    IMAGE_QUALITY: 0.8,
    MAX_IMAGE_WIDTH: 1920,
    MAX_IMAGE_HEIGHT: 1920,
    LOGO_PATHS: [
        'icons/android-chrome-192x192.png',
        './icons/android-chrome-192x192.png',
        '/icons/android-chrome-192x192.png'
    ],
    STORAGE_KEYS: {
        REQUESTS: 'maintenance_requests',
        OFFLINE_QUEUE: 'maintenance_offline_queue',
        USER_NAME: 'maintenance_user_name',
        PLANNING: 'maintenance_planning',
        USER_SESSION: 'maintenance_user_session',
        USER_TOKEN: 'maintenance_user_token'
    },
    PLANNING_WEEKS: 2,
    INCLUDE_WEEKENDS: true,
    MACHINES: {
        'crivo': { name: 'Crivo de exc√™ntrico', url: 'https://drive.google.com/file/d/1cONotpIDkqzWx7vuKp7nj1xc2qON2uTT/view', embedUrl: 'https://drive.google.com/file/d/1cONotpIDkqzWx7vuKp7nj1xc2qON2uTT/preview' },
        'destrocador': { name: 'Destro√ßador', url: 'https://drive.google.com/file/d/17CrN8UxtaD5bmDknHSl7GyhnT5kDxEln/view', embedUrl: 'https://drive.google.com/file/d/17CrN8UxtaD5bmDknHSl7GyhnT5kDxEln/preview' },
        'l01-dupla': { name: 'L01 - Dupla', url: 'https://drive.google.com/file/d/1ekrMpI3U0928ZPP0bemW18bL0rm0PwdT/view', embedUrl: 'https://drive.google.com/file/d/1ekrMpI3U0928ZPP0bemW18bL0rm0PwdT/preview' },
        'l01-multiserra': { name: 'L01 - Multiserra', url: 'https://drive.google.com/file/d/1Fm3KuVQA1DW17NeAMpMiX6biJRoxE5Yv/view', embedUrl: 'https://drive.google.com/file/d/1Fm3KuVQA1DW17NeAMpMiX6biJRoxE5Yv/preview' },
        'l01-paletizadora': { name: 'L01 - Paletizadora', url: 'https://drive.google.com/file/d/1XGzzWrVY7y2N7Qjc9pTfjcCbtZoIrpFJ/view', embedUrl: 'https://drive.google.com/file/d/1XGzzWrVY7y2N7Qjc9pTfjcCbtZoIrpFJ/preview' },
        'l01-retestadeira': { name: 'L01 - Retestadeira', url: 'https://drive.google.com/file/d/1yhMPDhdVLbnNyipXW4YcurPuYApd1kzv/view', embedUrl: 'https://drive.google.com/file/d/1yhMPDhdVLbnNyipXW4YcurPuYApd1kzv/preview' },
        'l01-tracador': { name: 'L01 - Tra√ßador', url: 'https://drive.google.com/file/d/1_z76x5wlAed80dL2cnoiiaN0EaOqK87J/view', embedUrl: 'https://drive.google.com/file/d/1_z76x5wlAed80dL2cnoiiaN0EaOqK87J/preview' },
        'l02-charriot': { name: 'L02 - Charriot', url: 'https://drive.google.com/file/d/1ms0jVeOePed49KqniSLDlUPEmrPdbYgr/view', embedUrl: 'https://drive.google.com/file/d/1ms0jVeOePed49KqniSLDlUPEmrPdbYgr/preview' },
        'l02-retestadeira': { name: 'L02 - Retestadeira', url: 'https://drive.google.com/file/d/1NvggjN6HKYpo1wF4qZfZcXnlPD-uaWUm/view', embedUrl: 'https://drive.google.com/file/d/1NvggjN6HKYpo1wF4qZfZcXnlPD-uaWUm/preview' },
        'l03-alinhadeira': { name: 'L03 - Alinhadeira', url: 'https://drive.google.com/file/d/1M0tepr43OZ1AGhtLDBqh2Q9cK3W01lmh/view', embedUrl: 'https://drive.google.com/file/d/1M0tepr43OZ1AGhtLDBqh2Q9cK3W01lmh/preview' },
        'l03-paletizadora': { name: 'L03 - Paletizadora', url: 'https://drive.google.com/file/d/14BuEGLBx_JXMWVCeUGKbr_t_L-6fe6mY/view', embedUrl: 'https://drive.google.com/file/d/14BuEGLBx_JXMWVCeUGKbr_t_L-6fe6mY/preview' },
        'l03-retestadeira': { name: 'L03 - Retestadeira', url: 'https://drive.google.com/file/d/1X4L2M8KInJMRUaGheGjLcRKHV0vbqUuv/view', embedUrl: 'https://drive.google.com/file/d/1X4L2M8KInJMRUaGheGjLcRKHV0vbqUuv/preview' },
        'tinas': { name: 'Tinas impregnante', url: 'https://drive.google.com/file/d/16dwf9DGaiGrNI2xF1LfoRw1wVA1nZQP-/view', embedUrl: 'https://drive.google.com/file/d/16dwf9DGaiGrNI2xF1LfoRw1wVA1nZQP-/preview' }
    },
    
    // ‚ö° EQUIPAMENTOS - Estrutura HARDCODED para performance m√°xima (INSTANT√ÇNEO - 0ms)
    // Total: 146 linhas organizadas em 22 √°reas/equipamentos
    EQUIPAMENTOS: {
        'Triagem': [
            'Redler superior Silo Casca',
            'Redler transporte para Silo Casca',
            'Rampa Entrada principal Triagem',
            'Descascadeira',
            'Corrente Sa√≠da Descascadeira',
            'Rampa Entrada P√≥s-Descascadeira',
            'Raixo X',
            'Corrente Sa√≠da Raio X',
            'Redler Principal Triagem',
            'Redler Cascas Descascador Charriot',
            'Corrente Transporte Triagem',
            'Box 1',
            'Box 2',
            'Box 3',
            'Box 4',
            'Box 5',
            'Box 6',
            'Box 7',
            'Box 8 - Rampa Linha Principal',
            'Triagem Outros'
        ],
        'L01 - Linha Principal': [
            'Tapete desperdicio L01',
            'Quadro El√©ctrico/Aut√≥mato L01',
            'Tapete Costaneiros L01-L03',
            'Tapete Superior de Escolha L01',
            'Tapete Escolha L01',
            'Progrow',
            'Estrutura L01',
            'Separador do Tra√ßador L01',
            'Rampa Entrada Exterior Tra√ßador L01',
            'Redler Entrada Tra√ßador L01',
            'Tra√ßador L01',
            'Tapete Sa√≠da Tra√ßador L01',
            'Rampa sa√≠da Tra√ßador L01',
            'Comandos Controlo Dupla L01',
            'Separador Dupla L1',
            'Rolos rota√ß√£o Dupla L01',
            'Calcador Dupla L01',
            'Serra Esquerda Dupla L01',
            'Serra Direita Dupla L01',
            'Corrente de tra√ß√£o Dupla L01',
            'Tapete Sa√≠da Dupla L01',
            'Rolos Tra√ß√£o Centrador L01',
            'Centrador L01',
            'Tapete Entrada 3/4 Face L01',
            '3/4 Face L01',
            'Rolos tra√ß√£o 3/4 Face L01',
            'Rolos tra√ß√£o Retestadeira L01',
            'Retestadeira L01',
            'Rolos tra√ß√£o Multiserra L01',
            'Multiserra L01',
            'Tapete saida Multiserra L01',
            'Tapete entrada Paletizador L01',
            'Paletizador L01',
            'Descarga Paletizador L01',
            'L01 - Linha Principal - Outros'
        ],
        'L03 - Linha Aproveitamentos': [
            'Tapete desperdicio L03.01',
            'Tapete desperdicio L03.02',
            'Tapete inferior da Escolha L03.01',
            'Tapete Escolha L03.02',
            'Plataforma elevatoria L03',
            'Estrutura L03',
            'Tapete Entrada Alinhadeira L03',
            'Alinhadeira L03',
            'Tapete Entrada Retestadeira L03',
            'Retestadeira L03',
            'Corrente de sa√≠da Retestadeira L03',
            'Tapete Transporte Retest. L03-Multiserra',
            'Corrente entrada Multis.L03.01',
            'Multiserra L03.01',
            'Corrente entrada Multis.L03.02',
            'Multiserra L03.02',
            'Tapete entrada-Mesa de Escolha L03.01',
            'Paletizador L03',
            'L03 - Linha Aproveitamentos - Outros'
        ],
        'L02 - Charriot': [
            'Rampa Entrada Descascadeira Charriot L02',
            'Descascadeira Charriot L02',
            'Corrente Transporte Desc. - Charriot L02',
            'Redler Charriot L02',
            'Rampa Entrada Charriot L02',
            'Charriot L02',
            'Cabine Comando Charriot L02',
            'Tapete Desperdicio Charriot L02',
            'Rampa Descarga Charriot L02',
            'Rampa Carga-Descarga Charriot L02',
            'Rolos tra√ß√£o Charriot - Multiserra L02',
            'Mesa entrada Multiserra L02',
            'Cabine Comando Multiserra L02',
            'Tapete Saida Multiserra L02',
            'Mesa Escolha do Paletizador L02',
            'Tapete inferior Escolha Paletizador L02',
            'Retestadeira L02',
            'Rolos Entrada Retestadeira L02',
            'L02 - Charriot - Outros'
        ],
        'Destro√ßador': [
            'Quadro El√©ctrico/Automato',
            'Tapete  Desperdicio',
            'Tapete Entrada',
            'Destro√ßador',
            'Tapete Saida Destro√ßador',
            'Crivos',
            'Tapete Finos',
            'Tapete Estilha',
            'Destro√ßador - Outros'
        ],
        'Aspira√ß√£o': [
            'Tubagem Aspira√ß√£o',
            'Ventilador',
            'Ciclones',
            'Aspira√ß√£o - Outros'
        ],
        'Redlers Interiores': [
            'Redler Dupla L01',
            'Redler 3/4 Face',
            'Redler Dupla-3/4 Face',
            'Redler Retestadeira L01-Alinh. L03',
            'Redler Multiserra L01',
            'Redler Retest. L01-Multis.L01',
            'Redler Linha Principal - Silo',
            'Redler L03',
            'Redler Destro√ßador - Charriot',
            'Redler Charriot-Silo'
        ],
        'Empilhadores': [
            'Nissan',
            'Linde',
            'Caterpillar'
        ],
        'P√°s Carregadoras': [
            'Caterpillar 1',
            'Caterpillar 2',
            'Case'
        ],
        'High-Liflts': [
            'Volvo C',
            'Volvo D',
            'Volvo E'
        ],
        'Tinas Tratamento': [
            'Tina 1',
            'Tina 2',
            'Tina 3'
        ],
        'Bomba Gas√≥leo': [
            'Bomba Gas√≥leo'
        ],
        'Estufa': [
            'Estufa Secagem'
        ],
        'Caldeiras': [
            'Caldeira 1',
            'Caldeira 2'
        ],
        'Rede Ar comprimido': [
            'Compressor 1',
            'Compressor 2',
            'Compressor 3',
            'Secador 1',
            'Secador 2',
            'Rede Distribui√ß√£o Ar Comprimido'
        ],
        'Edificio': [
            'Electricidade',
            'Canaliza√ß√£o √Ågua',
            'Saneamento',
            'Rede Inform√°tica',
            'Estrutura',
            'Edificio - Outros'
        ],
        'MCF': [
            'MCF - Outros'
        ]
    }
};

// ================================================
// FUN√á√ÉO DE FALLBACK PARA LOGOS
// ================================================
let logoAttempts = 0;

function handleLogoError(imgElement) {
    console.error('üö® ERRO ao carregar logo:', imgElement.src);
    logoAttempts++;
    
    // Tentar pr√≥ximo path da lista
    if (logoAttempts < CONFIG.LOGO_PATHS.length) {
        const nextPath = CONFIG.LOGO_PATHS[logoAttempts];
        console.log(`üîÑ Tentando path alternativo (${logoAttempts + 1}/${CONFIG.LOGO_PATHS.length}):`, nextPath);
        imgElement.src = nextPath;
        return;
    }
    
    // Se todos os paths falharam, usar SVG como fallback
    console.warn('‚ö†Ô∏è Todos os paths de imagem falharam. Usando SVG fallback.');
    
    const svgLogo = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: ${imgElement.classList.contains('login-logo') ? '140px' : '32px'}; height: ${imgElement.classList.contains('login-logo') ? '140px' : '32px'}; color: #667eea;">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v12M6 12h12"/>
            <circle cx="12" cy="12" r="3"/>
        </svg>
    `;
    
    imgElement.outerHTML = svgLogo;
}

// Testar caminhos dos logos ao carregar
function testLogoPaths() {
    console.log('üîç Testando paths dos logos...');
    console.log('üìÅ Base URL:', window.location.href);
    console.log('üìÅ Paths configurados:', CONFIG.LOGO_PATHS);
    
    CONFIG.LOGO_PATHS.forEach((path, index) => {
        const testImg = new Image();
        testImg.onload = () => {
            console.log(`‚úÖ Path ${index + 1} FUNCIONA:`, path, `(${testImg.naturalWidth}x${testImg.naturalHeight}px)`);
        };
        testImg.onerror = () => {
            console.error(`‚ùå Path ${index + 1} FALHOU:`, path);
        };
        testImg.src = path;
    });
}

// Executar teste ao carregar
window.addEventListener('DOMContentLoaded', testLogoPaths);

// ESTADO DA APLICA√á√ÉO
const AppState = {
    requests: [],
    filteredRequests: [],
    sortOrder: 'desc',
    currentFilters: { tipo: [], prioridade: [], estado: ['Novo', 'Em curso'], empresa: [], tipoIntervencao: [], urgente: [], paragemProducao: [] },
    isOnline: navigator.onLine,
    planning: { allocations: {}, startDate: null, endDate: null },
    artigos: [],
    movimentos: [],
    utilizadores: [],  // ‚úÖ NOVO: Lista de utilizadores para dropdown
    artigoSelecionado: null,
    currentUser: null  // { username, nomeCompleto, departamento, role, podeEditarPlaneamento, token }
};

// ‚ö†Ô∏è DADOS DEMO REMOVIDOS - App usa APENAS Google Sheets
// Artigos e movimentos devem ser criados no Google Sheets
// Se n√£o houver dados, app mostra erro (n√£o usa dados falsos)

let currentMachine = null;

// ============================================
// SISTEMA DE AUTENTICA√á√ÉO
// ============================================

async function checkAuthentication() {
    console.log('üîê checkAuthentication() chamado');
    
    if (AppState.currentUser) {
        console.log('‚úÖ User j√° em mem√≥ria:', AppState.currentUser.username);
        showUserInterface();
        return true;
    }
    
    let savedSession = localStorage.getItem(CONFIG.STORAGE_KEYS.USER_SESSION);
    let savedToken = localStorage.getItem(CONFIG.STORAGE_KEYS.USER_TOKEN);
    
    console.log('üì¶ localStorage:', {
        session: savedSession ? 'EXISTE' : 'VAZIO',
        token: savedToken ? 'EXISTE' : 'VAZIO'
    });
    
    // Se localStorage vazio, tentar restaurar dos cookies
    if (!savedSession || !savedToken) {
        const cookieSession = getCookie('maintenance_user_session');
        const cookieToken = getCookie('maintenance_user_token');
        
        if (cookieSession && cookieToken) {
            localStorage.setItem(CONFIG.STORAGE_KEYS.USER_SESSION, cookieSession);
            localStorage.setItem(CONFIG.STORAGE_KEYS.USER_TOKEN, cookieToken);
            savedSession = cookieSession;
            savedToken = cookieToken;
        }
    }
    
    if (savedSession && savedToken) {
        try {
            const userData = JSON.parse(savedSession);
            console.log('‚úÖ Sess√£o restaurada:', userData.username);
            AppState.currentUser = userData;
            showUserInterface();
            return true;
        } catch (e) {
            console.error('‚ùå Erro ao parsear sess√£o:', e);
            clearSession();
        }
    } else {
        console.log('‚ùå Sem sess√£o guardada - mostrar login');
    }
    
    showLoginModal();
    return false;
}

function showLoginModal() {
    const modal = document.getElementById('loginModal');
    const mainContent = document.querySelector('.app-main');
    const header = document.querySelector('.app-header');
    
    if (modal) {
        modal.style.display = 'flex'; // Inline sobrescreve tudo
        modal.classList.add('show');
    }
    if (mainContent) mainContent.style.display = 'none';
    if (header) header.style.opacity = '0.5';
    
    console.log('üîì Modal de login mostrado');
}

function hideLoginModal() {
    const modal = document.getElementById('loginModal');
    const mainContent = document.querySelector('.app-main');
    const header = document.querySelector('.app-header');
    
    if (modal) {
        modal.style.display = 'none'; // Inline garante esconder
        modal.classList.remove('show');
    }
    if (mainContent) mainContent.style.display = 'block';
    if (header) header.style.opacity = '1';
    
    console.log('üîí Modal de login escondido');
}

async function handleLogin(event) {
    event.preventDefault();
    
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    const errorDiv = document.getElementById('loginError');
    const submitBtn = event.target.querySelector('button[type="submit"]');
    
    if (!username || !password) {
        showLoginError('Por favor, preencha todos os campos');
        return;
    }
    
    try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'A validar...';
        errorDiv.style.display = 'none';
        
        console.log('üîê A tentar login:', username);
        
        // Fazer pedido de login ao Google Apps Script
        // Usar JSONP para contornar CORS
        const response = await fetch(CONFIG.GOOGLE_SHEETS_URL + '?action=login&username=' + encodeURIComponent(username) + '&password=' + encodeURIComponent(password), {
            method: 'GET',
            mode: 'cors',
            credentials: 'omit'
        });
        
        const result = await response.json();
        
        if (result.success && result.data) {
            AppState.currentUser = result.data;
            localStorage.setItem(CONFIG.STORAGE_KEYS.USER_SESSION, JSON.stringify(result.data));
            localStorage.setItem(CONFIG.STORAGE_KEYS.USER_TOKEN, result.data.token);
            setCookie('maintenance_user_session', JSON.stringify(result.data), 30);
            setCookie('maintenance_user_token', result.data.token, 30);
            
            showToast(`Bem-vindo, ${result.data.nomeCompleto}!`, 'success');
            
            hideLoginModal();
            showUserInterface();
            
            setTimeout(() => {
                applyUserAutoFill();
                applyPermissions();
            }, 200);
            
            if (AppState.isOnline) await syncWithGoogleSheets();
            renderRequestsList();
            
        } else {
            showLoginError(result.message || 'Username ou password incorretos');
        }
        
    } catch (e) {
        console.error('‚ùå Erro ao fazer login:', e);
        showLoginError('Erro ao conectar ao servidor. Verifique a liga√ß√£o √† internet.');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<svg style="width: 20px; height: 20px; margin-right: 8px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M13.8 12H3"/></svg>Entrar';
    }
}

async function validateSession(username, token) {
    try {
        console.log('üîê validateSession() - Validando sess√£o para:', username);
        console.log('üîê validateSession() - Token existe?', token ? 'SIM' : 'N√ÉO');
        
        // Valida√ß√£o de sess√£o via GET tamb√©m
        const url = CONFIG.GOOGLE_SHEETS_URL + '?action=validateSession&username=' + encodeURIComponent(username) + '&token=' + encodeURIComponent(token);
        console.log('üì° validateSession() - URL:', url);
        
        const response = await fetch(url, {
            method: 'GET',
            mode: 'cors',
            credentials: 'omit'
        });
        
        console.log('üì° validateSession() - Response status:', response.status);
        
        const result = await response.json();
        console.log('üì¶ validateSession() - Resposta completa:', JSON.stringify(result));
        
        if (result.success && result.data) {
            console.log('‚úÖ validateSession() - Sess√£o V√ÅLIDA!');
            console.log('üë§ validateSession() - Dados do utilizador:', result.data);
            
            // Atualizar dados do utilizador (pode ter sido alterado)
            AppState.currentUser = result.data;
            localStorage.setItem(CONFIG.STORAGE_KEYS.USER_SESSION, JSON.stringify(result.data));
            
            // üç™ ATUALIZAR TAMB√âM OS COOKIES
            setCookie('maintenance_user_session', JSON.stringify(result.data), 30);
            setCookie('maintenance_user_token', result.data.token, 30);
            
            return true;
        }
        
        console.warn('‚ö†Ô∏è validateSession() - Sess√£o INV√ÅLIDA ou dados em falta');
        console.warn('‚ö†Ô∏è validateSession() - result.success:', result.success);
        console.warn('‚ö†Ô∏è validateSession() - result.data:', result.data);
        console.warn('‚ö†Ô∏è validateSession() - result.message:', result.message);
        
        return false;
    } catch (e) {
        console.error('‚ùå validateSession() - ERRO:', e);
        console.error('‚ùå validateSession() - Stack:', e.stack);
        return false;
    }
}

function showLoginError(message) {
    const errorDiv = document.getElementById('loginError');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
}

function showUserInterface() {
    if (!AppState.currentUser) return;
    
    hideLoginModal();
    
    const userInfo = document.getElementById('userInfo');
    const logoutBtn = document.getElementById('logoutBtn');
    
    if (userInfo) {
        userInfo.querySelector('.user-name').textContent = AppState.currentUser.nomeCompleto;
        userInfo.querySelector('.user-dept').textContent = AppState.currentUser.departamento;
        userInfo.style.display = 'flex';
    }
    
    if (logoutBtn) {
        logoutBtn.style.display = 'flex';
    }
    
    applyUserAutoFill();
    applyPermissions();
    
    // üìä Mostrar info de armazenamento (s√≥ para admins)
    if (AppState.currentUser.role === 'admin' || AppState.currentUser.role === 'Administrador') {
        showStorageInfo();
    }
}

// Mostrar informa√ß√£o de armazenamento (para admins)
function showStorageInfo() {
    setTimeout(() => {
        const storageInfo = getLocalStorageInfo();
        if (parseFloat(storageInfo.usagePercent) > 50) {
            console.warn(`‚ö†Ô∏è [ADMIN] LocalStorage: ${storageInfo.totalMB} MB (${storageInfo.usagePercent}% usado)`);
            
            if (storageInfo.isNearLimit) {
                showToast(`‚ö†Ô∏è Cache pr√≥ximo do limite (${storageInfo.usagePercent}%). Auto-limpeza ativa.`, 'warning');
            }
        }
    }, 2000);
}

function applyUserAutoFill() {
    if (!AppState.currentUser) return;
    
    const nomeInput = document.getElementById('nome');
    if (nomeInput) {
        nomeInput.value = AppState.currentUser.nomeCompleto;
        nomeInput.readOnly = true;
        nomeInput.style.background = '#F5F5F7';
        nomeInput.style.cursor = 'not-allowed';
    }
    
    const departamentoInput = document.getElementById('departamento');
    if (departamentoInput) {
        departamentoInput.value = AppState.currentUser.departamento;
        departamentoInput.readOnly = true;
        departamentoInput.style.background = '#F5F5F7';
        departamentoInput.style.cursor = 'not-allowed';
    }
    
    const movimentoResponsavel = document.getElementById('movimentoResponsavel');
    if (movimentoResponsavel) {
        movimentoResponsavel.value = AppState.currentUser.nomeCompleto;
    }
}

function applyPermissions() {
    if (!AppState.currentUser) return;
    
    const role = AppState.currentUser.role;
    const podeEditarPlaneamento = AppState.currentUser.podeEditarPlaneamento;
    
    // Controlo de acesso ao Planeamento
    if (!podeEditarPlaneamento && role !== 'admin') {
        const planningTab = document.querySelector('.tab-content[data-tab="planeamento"]');
        if (planningTab) {
            const allInputs = planningTab.querySelectorAll('input, select, button, textarea');
            allInputs.forEach(input => {
                input.disabled = true;
                input.style.opacity = '0.6';
                input.title = 'Sem permiss√£o para editar o planeamento';
            });
            
            // Adicionar aviso
            const warningDiv = document.createElement('div');
            warningDiv.className = 'permission-warning';
            warningDiv.style.cssText = 'background: #FFF4E5; border: 1px solid #FF9500; padding: 12px; border-radius: 8px; margin-bottom: 16px; color: #1D1D1F; font-size: 14px;';
            warningDiv.innerHTML = '<strong>‚ö†Ô∏è Visualiza√ß√£o apenas:</strong> N√£o tem permiss√£o para editar o planeamento.';
            planningTab.insertBefore(warningDiv, planningTab.firstChild);
        }
    }
    
    // Outras permiss√µes (visualizador)
    if (role === 'visualizador') {
        // Desativar bot√µes de criar/editar
        document.querySelectorAll('.btn-primary, button[type="submit"]').forEach(btn => {
            if (!btn.id.includes('login')) {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.title = 'Sem permiss√£o para criar/editar';
            }
        });
    }
    
    console.log('üîí Permiss√µes aplicadas - Role:', role, '| Editar Planeamento:', podeEditarPlaneamento);
}

// ============================================
// FUN√á√ïES DE COOKIES (BACKUP PERSISTENTE)
// ============================================

function setCookie(name, value, days = 30) {
    try {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        const expires = "expires=" + date.toUTCString();
        
        // Tentar com SameSite=None para PWA (precisa Secure em HTTPS)
        if (window.location.protocol === 'https:') {
            document.cookie = name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/;SameSite=None;Secure";
        } else {
            // HTTP ou file:// - usar Lax (mais compat√≠vel)
            document.cookie = name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/;SameSite=Lax";
        }
        
        // BACKUP: Sempre salvar no localStorage tamb√©m (iOS pode bloquear cookies)
        try {
            localStorage.setItem('cookie_' + name, value);
            localStorage.setItem('cookie_' + name + '_expires', date.getTime().toString());
        } catch (e) {
            console.warn('localStorage backup falhou:', e);
        }
    } catch (e) {
        console.error('Erro ao definir cookie:', e);
    }
}

function getCookie(name) {
    // Tentar ler do cookie primeiro
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for(let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) {
            return decodeURIComponent(c.substring(nameEQ.length, c.length));
        }
    }
    
    // BACKUP: Se cookie n√£o existe, tentar localStorage (iOS pode bloquear cookies)
    try {
        const backupValue = localStorage.getItem('cookie_' + name);
        const backupExpires = localStorage.getItem('cookie_' + name + '_expires');
        
        if (backupValue && backupExpires) {
            const expiresTime = parseInt(backupExpires);
            if (Date.now() < expiresTime) {
                return backupValue;
            } else {
                // Expirado - limpar
                localStorage.removeItem('cookie_' + name);
                localStorage.removeItem('cookie_' + name + '_expires');
            }
        }
    } catch (e) {
        console.warn('localStorage backup read falhou:', e);
    }
    
    return null;
}

function deleteCookie(name) {
    document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;";
}

function logout() {
    clearSession();
    AppState.currentUser = null;
    
    const userInfo = document.getElementById('userInfo');
    const logoutBtn = document.getElementById('logoutBtn');
    
    if (userInfo) userInfo.style.display = 'none';
    if (logoutBtn) logoutBtn.style.display = 'none';
    
    showToast('Sess√£o terminada', 'info');
    showLoginModal();
    
    document.getElementById('loginForm').reset();
    document.getElementById('loginError').style.display = 'none';
}

function clearSession() {
    localStorage.removeItem(CONFIG.STORAGE_KEYS.USER_SESSION);
    localStorage.removeItem(CONFIG.STORAGE_KEYS.USER_TOKEN);
    deleteCookie('maintenance_user_session');
    deleteCookie('maintenance_user_token');
    APP_INITIALIZED = false;
}

// ============================================
// PROTE√á√ÉO CONTRA REINICIALIZA√á√ïES
// ============================================

// Flag global para evitar m√∫ltiplas inicializa√ß√µes
let APP_INITIALIZED = false;

// Verificar se j√° existe sess√£o ativa ANTES do DOMContentLoaded
(function checkExistingSession() {
    const savedSession = localStorage.getItem('maintenance_user_session');
    const savedToken = localStorage.getItem('maintenance_user_token');
    const cookieSession = getCookie('maintenance_user_session');
    const cookieToken = getCookie('maintenance_user_token');
    
    if ((savedSession && savedToken) || (cookieSession && cookieToken)) {
        APP_INITIALIZED = true;
        console.log('üîê Sess√£o detectada ANTES do DOM - modal permanecer√° escondido');
        
        // ESCONDER MODAL IMEDIATAMENTE ao carregar DOM
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('loginModal');
            if (modal) {
                modal.style.display = 'none';
                console.log('‚úÖ Modal escondido imediatamente');
            }
        }, { once: true, capture: true });
    }
})();

// INICIALIZA√á√ÉO
document.addEventListener('DOMContentLoaded', () => { initializeApp(); });

// iOS Safari: pageshow √© mais confi√°vel para PWA
window.addEventListener('pageshow', (event) => {
    // SEMPRE re-verifica sess√£o no iOS (mesmo que n√£o seja do cache)
    // iOS Safari limpa estado em certas condi√ß√µes
    console.log('üîÑ pageshow event - verificando sess√£o...');
    
    // Pequeno delay para garantir que DOM est√° pronto
    setTimeout(() => {
        if (!AppState.currentUser) {
            checkAuthentication();
        }
    }, 100);
});

async function initializeApp() {
    // Se j√° est√° inicializado e tem sess√£o v√°lida, apenas restaurar UI
    if (APP_INITIALIZED && AppState.currentUser) {
        showUserInterface();
        renderRequestsList();
        return;
    }
    
    // üßπ LIMPEZA AUTOM√ÅTICA DI√ÅRIA (primeiro que tudo!)
    cleanOldDataFromLocalStorage();
    
    await unregisterServiceWorkers();
    setupEventListeners();
    setupOnlineOfflineListeners();
    
    const isAuthenticated = await checkAuthentication();
    
    if (!isAuthenticated) {
        APP_INITIALIZED = false;
        return;
    }
    
    APP_INITIALIZED = true;
    
    loadFromLocalStorage();
    loadSavedUserName();
    if (AppState.isOnline) await syncWithGoogleSheets();
    renderRequestsList();
    initializePlanning();
    initializeAutonomousMaintenance();
    initializeStockModule();
}

// EVENT LISTENERS
function setupEventListeners() {
    // Login e Logout
    document.getElementById('loginForm')?.addEventListener('submit', handleLogin);
    document.getElementById('logoutBtn')?.addEventListener('click', logout);
    
    // Tab navega√ß√£o e formul√°rios principais
    document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', handleTabChange));
    document.getElementById('maintenanceForm').addEventListener('submit', handleFormSubmit);
    document.getElementById('clearBtn').addEventListener('click', clearForm);
    document.getElementById('foto').addEventListener('change', handlePhotoUpload);
    document.querySelectorAll('.filter-tipo, .filter-prioridade, .filter-estado, .filter-empresa, .filter-tipoIntervencao, .filter-urgente, .filter-paragemProducao').forEach(checkbox => checkbox.addEventListener('change', handleFilterChange));
    
    // ‚ö° NOVO: Event listener para filtro de equipamento
    const filterEquipamento = document.getElementById('filterEquipamento');
    if (filterEquipamento) {
        filterEquipamento.addEventListener('change', handleFilterChange);
        populateEquipamentoFilter(); // Popular dropdown ao carregar
    }
    
    document.getElementById('clearFilters').addEventListener('click', clearFilters);
    document.getElementById('sortBtn').addEventListener('click', toggleSortOrder);
    document.getElementById('closeModal').addEventListener('click', closeModal);
    document.querySelector('.modal-overlay').addEventListener('click', closeModal);
    document.getElementById('prevWeekBtn').addEventListener('click', () => movePlanningWeek(-1));
    document.getElementById('nextWeekBtn').addEventListener('click', () => movePlanningWeek(1));
    document.getElementById('todayBtn').addEventListener('click', resetPlanningToToday);
    document.getElementById('savePlanningBtn').addEventListener('click', savePlanning);
    document.getElementById('exportPlanningBtn').addEventListener('click', exportPlanningToExcel);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
    
    // ‚ö° Event listeners para Equipamentos/Componentes
    const areaSelect = document.getElementById('areaEquipamento');
    const componenteSelect = document.getElementById('componente');
    
    if (areaSelect) {
        areaSelect.addEventListener('change', handleAreaEquipamentoChange);
        // Popular dropdown de √°reas ao carregar
        populateAreaEquipamento();
    }
}

// ‚ö° EQUIPAMENTOS - Popular dropdown de √Åreas/Equipamentos
function populateAreaEquipamento() {
    const areaSelect = document.getElementById('areaEquipamento');
    if (!areaSelect) return;
    
    // Limpar op√ß√µes existentes (exceto a primeira)
    areaSelect.innerHTML = '<option value="">Selecione a √°rea/equipamento</option>';
    
    // Adicionar todas as √°reas do CONFIG.EQUIPAMENTOS
    const areas = Object.keys(CONFIG.EQUIPAMENTOS).sort(); // Ordenar alfabeticamente
    
    areas.forEach(area => {
        const option = document.createElement('option');
        option.value = area;
        option.textContent = area;
        areaSelect.appendChild(option);
    });
    
    console.log('‚ö° √Åreas/Equipamentos populadas:', areas.length);
}

// ‚ö° EQUIPAMENTOS - Filtrar componentes ao escolher √°rea
function handleAreaEquipamentoChange(e) {
    const areaSelected = e.target.value;
    const componenteSelect = document.getElementById('componente');
    
    if (!componenteSelect) return;
    
    // Limpar e desabilitar se n√£o houver √°rea selecionada
    if (!areaSelected) {
        componenteSelect.innerHTML = '<option value="">Escolha primeiro a √°rea/equipamento</option>';
        componenteSelect.disabled = true;
        return;
    }
    
    // Obter componentes da √°rea selecionada
    const componentes = CONFIG.EQUIPAMENTOS[areaSelected] || [];
    
    // Limpar e popular dropdown de componentes
    componenteSelect.innerHTML = '<option value="">Selecione o componente</option>';
    
    componentes.forEach(componente => {
        const option = document.createElement('option');
        option.value = componente;
        option.textContent = componente;
        componenteSelect.appendChild(option);
    });
    
    // Habilitar dropdown
    componenteSelect.disabled = false;
    
    console.log('‚ö° Componentes filtrados para "' + areaSelected + '":', componentes.length);
}

function handleTabChange(e) {
    const tab = e.currentTarget.dataset.tab;
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    e.currentTarget.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
    if (tab === 'planeamento') renderPlanningGrid();
    
    // Re-aplicar auto-preenchimento quando mudar de tab
    if (tab === 'novo') {
        setTimeout(() => applyUserAutoFill(), 100);
    }
}

// FORMUL√ÅRIO
async function handleFormSubmit(e) {
    e.preventDefault();
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.classList.add('loading');
    submitBtn.disabled = true;
    try {
        const formData = {
            id: generateUUID(),
            tipo: document.getElementById('tipo').value,
            prioridade: document.querySelector('input[name="prioridade"]:checked').value,
            empresa: document.getElementById('empresa').value,
            tipoIntervencao: document.getElementById('tipoIntervencao').value || '-',
            areaEquipamento: document.getElementById('areaEquipamento').value,
            componente: document.getElementById('componente').value,
            urgente: document.getElementById('urgente').checked,
            paragemProducao: document.getElementById('paragemProducao').checked,
            departamento: document.getElementById('departamento').value || '-',
            descricao: document.getElementById('descricao').value,
            foto: await getImageData(),
            nome: document.getElementById('nome').value,
            dataHora: new Date().toISOString(),
            estado: 'Novo'
        };
        localStorage.setItem(CONFIG.STORAGE_KEYS.USER_NAME, formData.nome);
        AppState.requests.unshift(formData);
        saveToLocalStorage();
        if (AppState.isOnline) {
            await sendToGoogleSheets(formData);
        } else {
            addToOfflineQueue(formData);
            showToast('Pedido salvo offline. Ser√° sincronizado quando estiver online.', 'info');
        }
        clearForm();
        showToast('Pedido criado com sucesso!', 'success');
        document.querySelector('.tab-btn[data-tab="lista"]').click();
        renderRequestsList();
    } catch (error) {
        console.error('Erro ao criar pedido:', error);
        showToast('Erro ao criar pedido. Tente novamente.', 'error');
    } finally {
        submitBtn.classList.remove('loading');
        submitBtn.disabled = false;
    }
}

function clearForm() {
    document.getElementById('maintenanceForm').reset();
    clearImagePreview();
    
    // ‚ö° Resetar campos de Equipamento/Componente
    const componenteSelect = document.getElementById('componente');
    if (componenteSelect) {
        componenteSelect.innerHTML = '<option value="">Escolha primeiro a √°rea/equipamento</option>';
        componenteSelect.disabled = true;
    }
}

function loadSavedUserName() {
    const savedName = localStorage.getItem(CONFIG.STORAGE_KEYS.USER_NAME);
    if (savedName) document.getElementById('nome').value = savedName;
}

// UPLOAD DE IMAGENS
async function handlePhotoUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    if (file.size > CONFIG.MAX_IMAGE_SIZE) {
        showToast('A imagem deve ter no m√°ximo 2MB.', 'error');
        e.target.value = '';
        return;
    }
    if (!file.type.startsWith('image/')) {
        showToast('Por favor, selecione uma imagem v√°lida.', 'error');
        e.target.value = '';
        return;
    }
    try {
        const compressedImage = await compressImage(file);
        showImagePreview(compressedImage);
        document.getElementById('fileName').textContent = file.name;
    } catch (error) {
        console.error('Erro ao processar imagem:', error);
        showToast('Erro ao processar imagem.', 'error');
        e.target.value = '';
    }
}

function compressImage(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width, height = img.height;
                if (width > CONFIG.MAX_IMAGE_WIDTH || height > CONFIG.MAX_IMAGE_HEIGHT) {
                    if (width > height) {
                        height = (height / width) * CONFIG.MAX_IMAGE_WIDTH;
                        width = CONFIG.MAX_IMAGE_WIDTH;
                    } else {
                        width = (width / height) * CONFIG.MAX_IMAGE_HEIGHT;
                        height = CONFIG.MAX_IMAGE_HEIGHT;
                    }
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                const compressedDataUrl = canvas.toDataURL('image/jpeg', CONFIG.IMAGE_QUALITY);
                resolve(compressedDataUrl);
            };
            img.onerror = reject;
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

function showImagePreview(dataUrl) {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = `<img src="${dataUrl}" alt="Preview"><button type="button" class="remove-image" onclick="clearImagePreview()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>`;
    preview.classList.add('active');
}

function clearImagePreview() {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    preview.classList.remove('active');
    document.getElementById('foto').value = '';
    document.getElementById('fileName').textContent = 'Escolher imagem';
}

async function getImageData() {
    const preview = document.getElementById('imagePreview');
    if (!preview.classList.contains('active')) return null;
    const img = preview.querySelector('img');
    return img ? img.src : null;
}

// LISTAGEM
function renderRequestsList() {
    applyFilters();
    applySorting();
    const container = document.getElementById('requestsList');
    const emptyState = document.getElementById('emptyState');
    const listCount = document.getElementById('listCount');
    const count = AppState.filteredRequests.length;
    listCount.textContent = `${count} ${count === 1 ? 'pedido' : 'pedidos'}`;
    if (AppState.filteredRequests.length === 0) {
        container.innerHTML = '';
        emptyState.classList.add('active');
        return;
    }
    emptyState.classList.remove('active');
    container.innerHTML = AppState.filteredRequests.map(request => `<div class="request-card" onclick="openRequestDetails('${request.id}')"><div class="request-header"><div class="request-badges"><span class="badge badge-tipo">${request.tipo}</span><span class="badge badge-prioridade ${request.prioridade.toLowerCase()}">${request.prioridade}</span><span class="badge badge-estado ${request.estado.toLowerCase().replace(' ', '')}">${request.estado}</span>${request.areaEquipamento && request.areaEquipamento !== '-' ? `<span class="badge" style="background: #667eea; color: white; font-size: 11px;" title="${request.componente || ''}">üîß ${request.areaEquipamento}</span>` : ''}</div><span class="request-date">${formatDate(request.dataHora)}</span></div><div class="request-body"><h4>${request.tipo} - ${request.prioridade}</h4><p>${request.descricao}</p></div><div class="request-footer"><div class="request-meta"><span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>${request.nome}</span>${request.departamento !== '-' ? `<span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>${request.departamento}</span>` : ''}</div><div class="request-actions" onclick="event.stopPropagation()">${request.estado !== 'Resolvido' ? `<button class="btn-icon" onclick="changeRequestState('${request.id}')" title="Mudar estado"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg></button>` : ''}<button class="btn-icon" onclick="deleteRequest('${request.id}')" title="Eliminar"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button></div></div></div>`).join('');
}

function applyFilters() {
    AppState.filteredRequests = AppState.requests.filter(request => {
        // ‚ö° NORMALIZAR valores para evitar problemas com espa√ßos/mai√∫sculas
        const estadoPedido = (request.estado || '').trim();
        const tipoPedido = (request.tipo || '').trim();
        const prioridadePedido = (request.prioridade || '').trim();
        
        // Filtros
        const passaTipo = AppState.currentFilters.tipo.length === 0 || AppState.currentFilters.tipo.includes(tipoPedido);
        const passaPrioridade = AppState.currentFilters.prioridade.length === 0 || AppState.currentFilters.prioridade.includes(prioridadePedido);
        const passaEstado = AppState.currentFilters.estado.length === 0 || AppState.currentFilters.estado.includes(estadoPedido);
        
        const empresaPedido = request.empresa || 'MCF';
        const passaEmpresa = AppState.currentFilters.empresa.length === 0 || AppState.currentFilters.empresa.includes(empresaPedido);
        
        // ‚ö° NOVO: Filtro de Equipamento
        const filterEquipamento = document.getElementById('filterEquipamento')?.value || '';
        const passaEquipamento = !filterEquipamento || 
                                (request.areaEquipamento && request.areaEquipamento === filterEquipamento);
        
        // Novos filtros
        const tipoIntervencaoPedido = request.tipoIntervencao || '-';
        const passaTipoIntervencao = AppState.currentFilters.tipoIntervencao.length === 0 || 
                                     (tipoIntervencaoPedido !== '-' && AppState.currentFilters.tipoIntervencao.includes(tipoIntervencaoPedido));
        
        const passaUrgente = AppState.currentFilters.urgente.length === 0 || 
                            (AppState.currentFilters.urgente.includes('true') && request.urgente === true);
        
        const passaParagem = AppState.currentFilters.paragemProducao.length === 0 || 
                            (AppState.currentFilters.paragemProducao.includes('true') && request.paragemProducao === true);
        
        return passaTipo && passaPrioridade && passaEstado && passaEmpresa && passaEquipamento && passaTipoIntervencao && passaUrgente && passaParagem;
    });
    
    console.log(`‚úÖ Filtros aplicados: ${AppState.filteredRequests.length} de ${AppState.requests.length} pedidos`);
}

function applySorting() {
    AppState.filteredRequests.sort((a, b) => {
        const dateA = new Date(a.dataHora), dateB = new Date(b.dataHora);
        return AppState.sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
    });
}

function handleFilterChange(e) {
    const filterType = e.target.classList[0].replace('filter-', '');
    const value = e.target.value;
    if (e.target.checked) {
        AppState.currentFilters[filterType].push(value);
    } else {
        const index = AppState.currentFilters[filterType].indexOf(value);
        if (index > -1) AppState.currentFilters[filterType].splice(index, 1);
    }
    renderRequestsList();
}

// ‚ö° EQUIPAMENTOS - Popular filtro de equipamento
function populateEquipamentoFilter() {
    const select = document.getElementById('filterEquipamento');
    if (!select) return;
    
    // Limpar op√ß√µes existentes (exceto a primeira "Todos")
    select.innerHTML = '<option value="">Todos os equipamentos</option>';
    
    // Adicionar todas as √°reas do CONFIG.EQUIPAMENTOS (ordenadas alfabeticamente)
    const areas = Object.keys(CONFIG.EQUIPAMENTOS).sort();
    
    areas.forEach(area => {
        const componentesCount = CONFIG.EQUIPAMENTOS[area].length;
        const option = document.createElement('option');
        option.value = area;
        option.textContent = `${area} (${componentesCount})`;
        select.appendChild(option);
    });
    
    console.log('‚ö° Filtro de Equipamento populado com', areas.length, '√°reas');
}

function clearFilters() {
    AppState.currentFilters = { tipo: [], prioridade: [], estado: ['Novo', 'Em curso'], empresa: [], tipoIntervencao: [], urgente: [], paragemProducao: [] };
    document.querySelectorAll('.filter-tipo, .filter-prioridade, .filter-estado, .filter-empresa, .filter-tipoIntervencao, .filter-urgente, .filter-paragemProducao').forEach(checkbox => checkbox.checked = false);
    document.querySelectorAll('.filter-estado').forEach(checkbox => {
        if (checkbox.value === 'Novo' || checkbox.value === 'Em curso') checkbox.checked = true;
    });
    
    // ‚ö° NOVO: Limpar filtro de equipamento
    const filterEquipamento = document.getElementById('filterEquipamento');
    if (filterEquipamento) {
        filterEquipamento.value = '';
    }
    
    renderRequestsList();
}

function toggleSortOrder() {
    AppState.sortOrder = AppState.sortOrder === 'desc' ? 'asc' : 'desc';
    renderRequestsList();
    showToast(`Ordena√ß√£o: ${AppState.sortOrder === 'desc' ? 'Mais recentes primeiro' : 'Mais antigos primeiro'}`, 'info');
}

// DETALHES
function openRequestDetails(id) {
    const request = AppState.requests.find(r => r.id === id);
    if (!request) return;
    const modal = document.getElementById('detailsModal');
    const modalBody = document.getElementById('modalBody');
    
    let html = `
        <div class="detail-group">
            <div class="detail-label">ID do Pedido</div>
            <div class="detail-value">${request.id}</div>
        </div>
        <div class="detail-group">
            <div class="detail-label">Data e Hora</div>
            <div class="detail-value">${formatDateLong(request.dataHora)}</div>
        </div>
        <div class="detail-group">
            <div class="detail-label">Tipo</div>
            <div class="detail-badges"><span class="badge badge-tipo">${request.tipo}</span></div>
        </div>
        <div class="detail-group">
            <div class="detail-label">Prioridade</div>
            <div class="detail-badges"><span class="badge badge-prioridade ${request.prioridade.toLowerCase()}">${request.prioridade}</span></div>
        </div>
        <div class="detail-group">
            <div class="detail-label">Estado</div>
            <div class="detail-badges"><span class="badge badge-estado ${request.estado.toLowerCase().replace(' ', '')}">${request.estado}</span></div>
        </div>
        <div class="detail-group">
            <div class="detail-label">Empresa</div>
            <div class="detail-value">${request.empresa || 'MCF'}</div>
        </div>`;
    
    // Tipo de Interven√ß√£o
    if (request.tipoIntervencao && request.tipoIntervencao !== '-') {
        html += `
        <div class="detail-group">
            <div class="detail-label">Tipo de Interven√ß√£o</div>
            <div class="detail-value">${request.tipoIntervencao}</div>
        </div>`;
    }
    
    // ‚ö° NOVO: √Årea/Equipamento
    if (request.areaEquipamento && request.areaEquipamento !== '-') {
        html += `
        <div class="detail-group">
            <div class="detail-label">√Årea/Equipamento</div>
            <div class="detail-value"><strong>${request.areaEquipamento}</strong></div>
        </div>`;
    }
    
    // ‚ö° NOVO: Componente
    if (request.componente && request.componente !== '-') {
        html += `
        <div class="detail-group">
            <div class="detail-label">Componente</div>
            <div class="detail-value">${request.componente}</div>
        </div>`;
    }
    
    // Urgente e Paragem Produ√ß√£o
    if (request.urgente || request.paragemProducao) {
        html += `<div class="detail-group"><div class="detail-label">Especiais</div><div class="detail-badges">`;
        if (request.urgente) html += `<span class="badge" style="background: #ff4757; color: white;">üî¥ Urgente</span>`;
        if (request.paragemProducao) html += `<span class="badge" style="background: #ffa502; color: white;">‚ö†Ô∏è Paragem Produ√ß√£o</span>`;
        html += `</div></div>`;
    }
    
    if (request.departamento !== '-') {
        html += `
        <div class="detail-group">
            <div class="detail-label">Departamento</div>
            <div class="detail-value">${request.departamento}</div>
        </div>`;
    }
    
    html += `
        <div class="detail-group">
            <div class="detail-label">Descri√ß√£o</div>
            <div class="detail-value">${request.descricao}</div>
        </div>
        <div class="detail-group">
            <div class="detail-label">Registado por</div>
            <div class="detail-value">${request.nome}</div>
        </div>`;
    
    if (request.foto) {
        html += `
        <div class="detail-group">
            <div class="detail-label">Fotografia</div>
            <img src="${request.foto}" alt="Foto do pedido" class="detail-image">
        </div>`;
    }
    
    html += `<div class="modal-actions">`;
    if (request.estado !== 'Resolvido') {
        html += `
        <button class="btn btn-primary" onclick="changeRequestState('${request.id}'); closeModal();">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
            </svg>
            ${request.estado === 'Novo' ? 'Iniciar' : 'Marcar como Resolvido'}
        </button>`;
    }
    html += `
        <button class="btn btn-secondary" onclick="deleteRequest('${request.id}'); closeModal();">Eliminar</button>
    </div>`;
    
    modalBody.innerHTML = html;
    modal.classList.add('active');
}

function closeModal() {
    document.getElementById('detailsModal').classList.remove('active');
}

// A√á√ïES
async function changeRequestState(id) {
    const request = AppState.requests.find(r => r.id === id);
    if (!request) return;
    const stateTransitions = { 'Novo': 'Em curso', 'Em curso': 'Resolvido', 'Resolvido': 'Resolvido' };
    request.estado = stateTransitions[request.estado];
    saveToLocalStorage();
    if (AppState.isOnline) await updateInGoogleSheets(request);
    renderRequestsList();
    showToast(`Estado alterado para: ${request.estado}`, 'success');
}

async function deleteRequest(id) {
    if (!confirm('Tem a certeza que deseja eliminar este pedido?')) return;
    const index = AppState.requests.findIndex(r => r.id === id);
    if (index === -1) return;
    AppState.requests.splice(index, 1);
    saveToLocalStorage();
    if (AppState.isOnline) await deleteFromGoogleSheets(id);
    renderRequestsList();
    showToast('Pedido eliminado com sucesso.', 'success');
}

// GOOGLE SHEETS
async function sendToGoogleSheets(data) {
    if (!CONFIG.GOOGLE_SHEETS_URL || CONFIG.GOOGLE_SHEETS_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
        console.warn('Google Sheets URL n√£o configurada');
        return;
    }
    try {
        await fetch(CONFIG.GOOGLE_SHEETS_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'create', data: data })
        });
        console.log('‚úÖ Pedido enviado para Google Sheets');
    } catch (error) {
        console.error('‚ùå Erro ao enviar para Google Sheets:', error);
        addToOfflineQueue(data);
    }
}

async function updateInGoogleSheets(data) {
    if (!CONFIG.GOOGLE_SHEETS_URL || CONFIG.GOOGLE_SHEETS_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') return;
    try {
        await fetch(CONFIG.GOOGLE_SHEETS_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'update', data: data })
        });
        console.log('‚úÖ Pedido atualizado no Google Sheets');
    } catch (error) {
        console.error('‚ùå Erro ao atualizar Google Sheets:', error);
        addToOfflineQueue({ action: 'update', data: data });
    }
}

async function deleteFromGoogleSheets(id) {
    if (!CONFIG.GOOGLE_SHEETS_URL || CONFIG.GOOGLE_SHEETS_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') return;
    try {
        await fetch(CONFIG.GOOGLE_SHEETS_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'delete', id: id })
        });
        console.log('‚úÖ Pedido eliminado do Google Sheets');
    } catch (error) {
        console.error('‚ùå Erro ao eliminar do Google Sheets:', error);
    }
}

async function syncWithGoogleSheets() {
    if (!CONFIG.GOOGLE_SHEETS_URL || CONFIG.GOOGLE_SHEETS_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
        console.warn('‚ö†Ô∏è Google Sheets URL n√£o configurada - usando apenas localStorage');
        return;
    }
    try {
        console.log('üîÑ Sincronizando com Google Sheets...');
        
        const response = await fetch(`${CONFIG.GOOGLE_SHEETS_URL}?timestamp=${Date.now()}`, {
            method: 'GET',
            mode: 'cors',
            credentials: 'omit'
        });
        
        const data = await response.json();
        
        if (data && data.success) {
            // ‚ö° OTIMIZA√á√ÉO: Limitar a √∫ltimos 200 pedidos (ordenados por data)
            if (data.requests) {
                // Ordenar por data (mais recentes primeiro)
                const sortedRequests = data.requests.sort((a, b) => {
                    return new Date(b.dataHora) - new Date(a.dataHora);
                });
                
                // Limitar a 200 pedidos
                const MAX_REQUESTS = 200;
                AppState.requests = sortedRequests.slice(0, MAX_REQUESTS);
                
                console.log(`‚úÖ ${data.requests.length} pedidos recebidos, mostrando √∫ltimos ${AppState.requests.length}`);
                
                // Avisar se houver muitos pedidos
                if (data.requests.length > MAX_REQUESTS) {
                    console.log(`‚ÑπÔ∏è Total de ${data.requests.length} pedidos. Mostrando apenas os ${MAX_REQUESTS} mais recentes para melhor performance.`);
                }
            } else {
                console.warn('‚ö†Ô∏è Nenhum pedido recebido!');
            }
            
            // Artigos
            if (data.artigos) {
                AppState.artigos = data.artigos;
                console.log('‚úÖ Artigos sincronizados:', data.artigos.length);
                
                // üõ°Ô∏è N√ÉO guardar artigos no localStorage (ocupam muito espa√ßo)
                // Artigos s√£o sempre carregados do servidor
            } else {
                console.warn('‚ö†Ô∏è Nenhum artigo recebido');
                // üî• FOR√áAR chamada direta a loadArtigosFromGoogleSheets
                console.warn('üîÑ Tentando loadArtigosFromGoogleSheets() como fallback...');
                await loadArtigosFromGoogleSheets();
            }
            
            // Movimentos (N√ÉO guardar no localStorage - sempre do servidor)
            if (data.movimentos) {
                console.log('üì¶ Movimentos recebidos:', data.movimentos.length);
                AppState.movimentos = data.movimentos;
                console.log('‚úÖ Movimentos sincronizados:', data.movimentos.length);
                // üõ°Ô∏è Movimentos N√ÉO s√£o guardados no localStorage
            } else {
                console.warn('‚ö†Ô∏è Nenhum movimento recebido!');
            }
            
            // ‚úÖ Utilizadores (para dropdown de respons√°vel no planeamento)
            if (data.utilizadores) {
                AppState.utilizadores = data.utilizadores.filter(u => u.ativo !== false);
                console.log('‚úÖ Utilizadores carregados:', AppState.utilizadores.length);
            } else {
                console.warn('‚ö†Ô∏è Nenhum utilizador recebido!');
            }
            
            // üíæ Guardar APENAS pedidos (sem fotos, limitados a 30)
            saveToLocalStorage();
            console.log('‚úÖ Sincronizado com Google Sheets - TUDO OK!');
        } else {
            console.error('‚ùå data.success √© FALSE ou data √© null!');
            console.error('üìã Data:', data);
        }
    } catch (error) {
        console.error('‚ùå Erro ao sincronizar:', error);
        console.error('üîß Stack:', error.stack);
        console.error('üîß Message:', error.message);
        console.warn('‚ö†Ô∏è N√£o foi poss√≠vel sincronizar com Google Sheets, usando dados locais');
    }
}

// OFFLINE SUPPORT
function setupOnlineOfflineListeners() {
    window.addEventListener('online', async () => {
        AppState.isOnline = true;
        showToast('Conex√£o restaurada. Sincronizando...', 'info');
        await processOfflineQueue();
        await syncWithGoogleSheets();
        renderRequestsList();
    });
    window.addEventListener('offline', () => {
        AppState.isOnline = false;
        showToast('Sem conex√£o. Os dados ser√£o sincronizados quando a conex√£o for restaurada.', 'info');
    });
}

function addToOfflineQueue(item) {
    const queue = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.OFFLINE_QUEUE) || '[]');
    // Se item j√° tem action, usa-a; sen√£o default √© 'create'
    const queueItem = item.action ? item : { action: 'create', data: item, timestamp: Date.now() };
    if (!queueItem.timestamp) queueItem.timestamp = Date.now();
    queue.push(queueItem);
    localStorage.setItem(CONFIG.STORAGE_KEYS.OFFLINE_QUEUE, JSON.stringify(queue));
    console.log(`üì• Item adicionado √† fila offline: ${queueItem.action}`);
}

async function processOfflineQueue() {
    const queue = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.OFFLINE_QUEUE) || '[]');
    if (queue.length === 0) return;
    console.log(`üì§ Processando ${queue.length} itens da fila offline...`);
    for (const item of queue) {
        try {
            if (item.action === 'create') {
                await sendToGoogleSheets(item.data);
            } else if (item.action === 'update') {
                await updateInGoogleSheets(item.data);
            } else if (item.action === 'delete') {
                await deleteFromGoogleSheets(item.id || item.data.id);
            }
        } catch (error) {
            console.error('Erro ao processar item da fila:', error);
        }
    }
    localStorage.setItem(CONFIG.STORAGE_KEYS.OFFLINE_QUEUE, '[]');
    showToast('Dados sincronizados com sucesso!', 'success');
}

// ============================================
// LOCAL STORAGE - GEST√ÉO SUSTENT√ÅVEL
// ============================================

// Auto-limpeza di√°ria de dados antigos
function cleanOldDataFromLocalStorage() {
    try {
        const lastCleanup = localStorage.getItem('last_cleanup');
        const now = Date.now();
        const oneDayMs = 24 * 60 * 60 * 1000;
        
        // S√≥ limpar se passou mais de 1 dia
        if (!lastCleanup || (now - parseInt(lastCleanup)) > oneDayMs) {
            console.log('üß∫ Limpeza autom√°tica de dados antigos...');
            
            // Remover pedidos com mais de 7 dias
            const saved = localStorage.getItem(CONFIG.STORAGE_KEYS.REQUESTS);
            if (saved) {
                const requests = JSON.parse(saved);
                const sevenDaysAgo = now - (7 * oneDayMs);
                const recentRequests = requests.filter(req => {
                    const reqDate = new Date(req.dataHora).getTime();
                    return reqDate > sevenDaysAgo;
                });
                
                if (recentRequests.length < requests.length) {
                    console.log(`‚úÖ Removidos ${requests.length - recentRequests.length} pedidos antigos (>7 dias)`);
                    localStorage.setItem(CONFIG.STORAGE_KEYS.REQUESTS, JSON.stringify(recentRequests));
                }
            }
            
            // Limpar fila offline antiga
            localStorage.removeItem('maintenance_offline_queue');
            
            // Marcar √∫ltima limpeza
            localStorage.setItem('last_cleanup', now.toString());
            console.log('‚úÖ Limpeza conclu√≠da!');
        }
    } catch (error) {
        console.error('‚ùå Erro na limpeza autom√°tica:', error);
    }
}

// Verificar espa√ßo dispon√≠vel no localStorage
function getLocalStorageInfo() {
    try {
        const total = JSON.stringify(localStorage).length;
        const totalMB = (total / 1024 / 1024).toFixed(2);
        const limitMB = 5; // Limite aproximado
        const usagePercent = ((total / (limitMB * 1024 * 1024)) * 100).toFixed(1);
        
        return {
            totalBytes: total,
            totalMB: totalMB,
            usagePercent: usagePercent,
            isNearLimit: usagePercent > 70
        };
    } catch (error) {
        return { totalMB: '?', usagePercent: '?', isNearLimit: true };
    }
}

function saveToLocalStorage() {
    try {
        // üß∫ Auto-limpeza di√°ria
        cleanOldDataFromLocalStorage();
        
        // üìä Verificar espa√ßo
        const storageInfo = getLocalStorageInfo();
        console.log(`üìä LocalStorage: ${storageInfo.totalMB} MB (${storageInfo.usagePercent}% usado)`);
        
        if (storageInfo.isNearLimit) {
            console.warn('‚ö†Ô∏è LocalStorage pr√≥ximo do limite! For√ßando limpeza...');
            cleanOldDataFromLocalStorage();
        }
        
        // üõ°Ô∏è NUNCA guardar fotos base64!
        // üõ°Ô∏è Limitar a 30 pedidos mais recentes (7 dias de trabalho t√≠pico)
        let requestsToSave = AppState.requests
            .sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora))
            .slice(0, 30);
        
        // Remover TODAS as fotos (apenas URLs do Drive s√£o mantidas no Google Sheets)
        const requestsWithoutPhotos = requestsToSave.map(req => ({
            id: req.id,
            dataHora: req.dataHora,
            tipo: req.tipo,
            prioridade: req.prioridade,
            departamento: req.departamento,
            descricao: req.descricao,
            nome: req.nome,
            estado: req.estado,
            empresa: req.empresa,
            urgente: req.urgente,
            tipoIntervencao: req.tipoIntervencao,
            paragemProducao: req.paragemProducao
            // foto: REMOVIDO - Fotos s√≥ no Google Sheets!
            // artigos: REMOVIDO - Dados de stock sempre do servidor
        }));
        
        const dataToSave = JSON.stringify(requestsWithoutPhotos);
        const sizeKB = (dataToSave.length / 1024).toFixed(2);
        
        console.log(`üíæ Guardando ${requestsWithoutPhotos.length} pedidos (${sizeKB} KB - SEM fotos)`);
        
        // Verificar espa√ßo dispon√≠vel
        const testKey = 'test_quota_' + Date.now();
        try {
            localStorage.setItem(testKey, dataToSave);
            localStorage.removeItem(testKey);
            
            // Se chegou aqui, h√° espa√ßo suficiente
            localStorage.setItem(CONFIG.STORAGE_KEYS.REQUESTS, dataToSave);
            console.log('‚úÖ Dados guardados com sucesso!');
            
        } catch (quotaError) {
            console.error('‚ùå LocalStorage cheio! Limpeza de emerg√™ncia...');
            
            // LIMPEZA DE EMERG√äNCIA TOTAL
            localStorage.removeItem('maintenance_offline_queue');
            localStorage.removeItem('maintenance_planning');
            localStorage.removeItem('maintenance_user_session'); // For√ßar novo login (seguran√ßa)
            
            // Tentar novamente com apenas 10 pedidos
            const minimalRequests = requestsWithoutPhotos.slice(0, 10);
            try {
                localStorage.setItem(CONFIG.STORAGE_KEYS.REQUESTS, JSON.stringify(minimalRequests));
                console.log('‚úÖ Limpeza de emerg√™ncia conclu√≠da. Guardados 10 pedidos.');
            } catch (finalError) {
                // Se ainda assim falhar, limpar TUDO
                console.error('‚ùå Limpeza de emerg√™ncia falhou. Limpando TUDO...');
                localStorage.clear();
                showToast('‚ö†Ô∏è Cache limpo por falta de espa√ßo. Fa√ßa login novamente.', 'warning');
                setTimeout(() => location.reload(), 2000);
            }
        }
        
    } catch (error) {
        console.error('‚ùå Erro cr√≠tico ao guardar no localStorage:', error);
        // N√ÉO mostrar toast - modo silencioso para n√£o incomodar utilizador
        // App continua a funcionar s√≥ com dados do servidor
    }
}

function loadFromLocalStorage() {
    const saved = localStorage.getItem(CONFIG.STORAGE_KEYS.REQUESTS);
    if (saved) AppState.requests = JSON.parse(saved);
}

// EXPORTAR EXCEL
function exportToExcel() {
    if (AppState.requests.length === 0) {
        showToast('N√£o h√° pedidos para exportar.', 'info');
        return;
    }
    try {
        // Preparar dados para exporta√ß√£o
        const exportData = AppState.requests.map(request => ({
            'ID': request.id, 
            'Data/Hora': formatDateLong(request.dataHora), 
            'Tipo': request.tipo,
            'Prioridade': request.prioridade, 
            'Estado': request.estado, 
            'Departamento': request.departamento,
            'Descri√ß√£o': request.descricao,
            'Registado por': request.nome, 
            'Foto': request.foto ? 'Ver Foto' : 'Sem foto'
        }));
        
        // Criar worksheet
        const ws = XLSX.utils.json_to_sheet(exportData);
        
        // üì∏ ADICIONAR HIPERLINKS PARA FOTOS!
        // Percorrer cada linha e adicionar hiperlink se tiver foto
        AppState.requests.forEach((request, index) => {
            if (request.foto) {
                const cellAddress = XLSX.utils.encode_cell({ r: index + 1, c: 8 }); // Coluna I (Foto)
                
                // Criar hiperlink clic√°vel
                ws[cellAddress].l = { 
                    Target: request.foto, 
                    Tooltip: "Clique para ver a foto" 
                };
                
                // Estilo azul e sublinhado (como link)
                if (!ws[cellAddress].s) ws[cellAddress].s = {};
                ws[cellAddress].s = {
                    font: { color: { rgb: "0563C1" }, underline: true }
                };
            }
        });
        
        // Criar workbook e adicionar sheet
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Pedidos de Manuten√ß√£o");
        
        // Configurar largura das colunas
        ws['!cols'] = [
            { wch: 36 }, // ID
            { wch: 20 }, // Data/Hora
            { wch: 12 }, // Tipo
            { wch: 12 }, // Prioridade
            { wch: 12 }, // Estado
            { wch: 15 }, // Departamento
            { wch: 50 }, // Descri√ß√£o
            { wch: 20 }, // Registado por
            { wch: 15 }  // Foto (hiperlink)
        ];
        
        const fileName = `Manutencao_${formatDateForFilename()}.xlsx`;
        XLSX.writeFile(wb, fileName, { bookType: 'xlsx', type: 'binary' });
        
        showToast('‚úÖ Excel exportado com fotos clic√°veis!', 'success');
    } catch (error) {
        console.error('Erro ao exportar Excel:', error);
        showToast('Erro ao exportar ficheiro Excel.', 'error');
    }
}

// SERVICE WORKER - DESATIVADO (causa conflitos com login)
// async function registerServiceWorker() {
//     try {
//         const registration = await navigator.serviceWorker.register('./sw.js');
//         console.log('‚úÖ Service Worker registado:', registration);
//     } catch (error) {
//         console.error('‚ùå Erro ao registar Service Worker:', error);
//     }
// }

// DESATIVAR Service Workers existentes
async function unregisterServiceWorkers() {
    if ('serviceWorker' in navigator) {
        const registrations = await navigator.serviceWorker.getRegistrations();
        for (let registration of registrations) {
            await registration.unregister();
            console.log('üóëÔ∏è Service Worker removido');
        }
    }
}

// TOAST
function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    const icons = {
        success: '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>',
        error: '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>',
        info: '<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>'
    };
    toast.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${icons[type]}</svg><div class="toast-message">${message}</div>`;
    container.appendChild(toast);
    setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

// ‚ö° LOADING SPINNER - Feedback visual durante carregamento do Google Sheets
function showLoadingSpinner(message = 'Carregando...') {
    let spinner = document.getElementById('loadingSpinner');
    
    // Se n√£o existe, criar
    if (!spinner) {
        spinner = document.createElement('div');
        spinner.id = 'loadingSpinner';
        spinner.className = 'loading-spinner-overlay';
        spinner.innerHTML = `
            <div class="loading-spinner-content">
                <div class="spinner-circle"></div>
                <p class="spinner-message">${message}</p>
            </div>
        `;
        document.body.appendChild(spinner);
    } else {
        // Atualizar mensagem
        const messageEl = spinner.querySelector('.spinner-message');
        if (messageEl) messageEl.textContent = message;
    }
    
    // Mostrar com anima√ß√£o
    setTimeout(() => spinner.classList.add('active'), 10);
    console.log('‚ö° Loading spinner MOSTRADO:', message);
}

function hideLoadingSpinner() {
    const spinner = document.getElementById('loadingSpinner');
    if (spinner) {
        spinner.classList.remove('active');
        setTimeout(() => {
            if (spinner.parentNode) {
                spinner.parentNode.removeChild(spinner);
            }
        }, 300); // Aguarda anima√ß√£o
        console.log('‚ö° Loading spinner ESCONDIDO');
    }
}

// UTILS
function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

function formatDate(isoString) {
    const date = new Date(isoString), now = new Date(), diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000), diffHours = Math.floor(diffMs / 3600000), diffDays = Math.floor(diffMs / 86400000);
    if (diffMins < 1) return 'Agora';
    if (diffMins < 60) return `H√° ${diffMins}m`;
    if (diffHours < 24) return `H√° ${diffHours}h`;
    if (diffDays < 7) return `H√° ${diffDays}d`;
    return date.toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function formatDateLong(isoString) {
    const date = new Date(isoString);
    return date.toLocaleString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function formatDateForFilename() {
    return new Date().toISOString().split('T')[0];
}

// PLANEAMENTO
function initializePlanning() { loadPlanningFromStorage(); resetPlanningToToday(); renderPlanningGrid(); }
function resetPlanningToToday() {
    const today = new Date(); today.setHours(0,0,0,0);
    AppState.planning.startDate = new Date(today);
    AppState.planning.endDate = new Date(today);
    AppState.planning.endDate.setDate(today.getDate() + (CONFIG.PLANNING_WEEKS * 7) - 1);
    renderPlanningGrid();
}
function movePlanningWeek(direction) {
    const daysToMove = 7 * direction;
    AppState.planning.startDate.setDate(AppState.planning.startDate.getDate() + daysToMove);
    AppState.planning.endDate.setDate(AppState.planning.endDate.getDate() + daysToMove);
    renderPlanningGrid();
}
function generateDateRange() {
    const dates = [], current = new Date(AppState.planning.startDate);
    while (current <= AppState.planning.endDate) {
        if (CONFIG.INCLUDE_WEEKENDS || (current.getDay() !== 0 && current.getDay() !== 6)) dates.push(new Date(current));
        else if (!CONFIG.INCLUDE_WEEKENDS && current.getDay() === 6) dates.push(new Date(current));
        current.setDate(current.getDate() + 1);
    }
    return dates;
}
function renderPlanningGrid() {
    const grid = document.getElementById('planningGrid'), dates = generateDateRange();
    const rangeText = `${formatDateShort(AppState.planning.startDate)} - ${formatDateShort(AppState.planning.endDate)}`;
    document.getElementById('planningRange').textContent = rangeText;
    const activeTasks = AppState.requests.filter(r => r.estado !== 'Resolvido');
    if (activeTasks.length === 0) {
        grid.innerHTML = `<tr><td colspan="${dates.length + 1}" style="text-align: center; padding: var(--spacing-xl);"><p>N√£o h√° pedidos ativos para planear.</p><p style="color: var(--color-text-secondary); font-size: 0.875rem;">Crie novos pedidos na tab "Novo Pedido"</p></td></tr>`;
        return;
    }
    let html = '<thead><tr><th class="task-header">Pedido / Tarefa</th><th class="responsible-header">Respons√°vel</th><th class="hours-header">Horas</th>';
    dates.forEach(date => {
        const isWeekend = date.getDay() === 0 || date.getDay() === 6, weekendClass = isWeekend ? 'weekend' : '';
        const dayName = date.toLocaleDateString('pt-PT', { weekday: 'short' }), dayNum = date.getDate();
        const monthName = date.toLocaleDateString('pt-PT', { month: 'short' });
        html += `<th class="date-header ${weekendClass}" title="${formatDateLong2(date)}"><div>${dayName}</div><div>${dayNum} ${monthName}</div></th>`;
    });
    html += '</tr></thead><tbody>';
    activeTasks.forEach(task => {
        html += '<tr>';
        html += `<td class="task-cell"><div class="task-info"><div class="task-title">${task.descricao}</div><div class="task-meta"><span class="badge badge-tipo">${task.tipo}</span><span class="badge badge-prioridade ${task.prioridade.toLowerCase()}">${task.prioridade}</span>`;
        if (task.responsavel && task.responsavel !== '-') html += `<span class="task-responsible"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>${task.responsavel}</span>`;
        html += `</div></div></td>`;
        
        // ‚úÖ NOVO: Select dropdown para Respons√°vel (em vez de texto est√°tico)
        html += `<td class="responsible-cell">`;
        html += `<select class="responsible-select" data-task-id="${task.id}" onchange="updateTaskResponsible('${task.id}', this.value)">`;
        html += `<option value="">-</option>`;
        AppState.utilizadores.forEach(user => {
            const selected = task.responsavel === user.nomeCompleto ? 'selected' : '';
            html += `<option value="${user.nomeCompleto}" ${selected}>${user.nomeCompleto}</option>`;
        });
        html += `</select></td>`;
        const taskHours = task.horasEstimadas || '';
        html += `<td class="hours-cell"><input type="number" class="hours-input" value="${taskHours}" min="0" step="0.5" placeholder="0" data-task-id="${task.id}" onchange="updateTaskHours('${task.id}', this.value)"></td>`;
        dates.forEach(date => {
            const dateKey = formatDateKey(date), allocationKey = `${task.id}-${dateKey}`;
            const isAllocated = AppState.planning.allocations[allocationKey] === true, isWeekend = date.getDay() === 0 || date.getDay() === 6;
            const classes = ['date-cell'];
            if (isAllocated) classes.push('allocated');
            if (isWeekend) classes.push('weekend');
            html += `<td class="${classes.join(' ')}" data-task="${task.id}" data-date="${dateKey}" onclick="toggleAllocation('${task.id}', '${dateKey}')" title="Clique para alocar/desalocar"></td>`;
        });
        html += '</tr>';
    });
    html += '</tbody>';
    grid.innerHTML = html;
}
function toggleAllocation(taskId, dateKey) {
    const allocationKey = `${taskId}-${dateKey}`;
    if (AppState.planning.allocations[allocationKey]) delete AppState.planning.allocations[allocationKey];
    else AppState.planning.allocations[allocationKey] = true;
    renderPlanningGrid();
    savePlanningToStorage();
}
function updateTaskHours(taskId, hours) {
    const task = AppState.requests.find(r => r.id === taskId);
    if (task) {
        task.horasEstimadas = hours ? parseFloat(hours) : 0;
        saveToLocalStorage();
        showToast(`Horas atualizadas: ${hours || 0}h`, 'success');
    }
}

// ‚úÖ NOVO: Atualizar respons√°vel da tarefa no planeamento
function updateTaskResponsible(taskId, responsavel) {
    const task = AppState.requests.find(r => r.id === taskId);
    if (task) {
        task.responsavel = responsavel || '';
        saveToLocalStorage();
        renderPlanningGrid();  // Re-render para atualizar badge de respons√°vel
        showToast(`Respons√°vel atualizado: ${responsavel || 'Nenhum'}`, 'success');
    }
}
function savePlanning() {
    savePlanningToStorage();
    if (AppState.isOnline) syncPlanningWithGoogleSheets();
    showToast('Planeamento salvo com sucesso!', 'success');
}
function savePlanningToStorage() { localStorage.setItem(CONFIG.STORAGE_KEYS.PLANNING, JSON.stringify(AppState.planning)); }
function loadPlanningFromStorage() {
    const saved = localStorage.getItem(CONFIG.STORAGE_KEYS.PLANNING);
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            AppState.planning.allocations = parsed.allocations || {};
            if (parsed.startDate) {
                AppState.planning.startDate = new Date(parsed.startDate);
                AppState.planning.endDate = new Date(parsed.endDate);
            }
        } catch (error) { console.error('Erro ao carregar planeamento:', error); }
    }
}
async function syncPlanningWithGoogleSheets() {
    if (!CONFIG.GOOGLE_SHEETS_URL || CONFIG.GOOGLE_SHEETS_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') return;
    try {
        const allocations = [];
        Object.keys(AppState.planning.allocations).forEach(key => {
            const [taskId, dateKey] = key.split('-'), task = AppState.requests.find(r => r.id === taskId);
            if (task) allocations.push({ pedidoId: taskId, descricao: task.descricao, tipo: task.tipo, prioridade: task.prioridade, responsavel: task.responsavel || '-', data: dateKey });
        });
        await fetch(CONFIG.GOOGLE_SHEETS_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'updatePlanning', planning: allocations }) });
        console.log('‚úÖ Planeamento sincronizado com Google Sheets');
    } catch (error) { console.error('‚ùå Erro ao sincronizar planeamento:', error); }
}
function exportPlanningToExcel() {
    if (AppState.requests.length === 0) { showToast('N√£o h√° dados para exportar.', 'info'); return; }
    try {
        const dates = generateDateRange(), activeTasks = AppState.requests.filter(r => r.estado !== 'Resolvido');
        const requestsData = AppState.requests.map(request => ({ 'ID': request.id, 'Data/Hora': formatDateLong(request.dataHora), 'Tipo': request.tipo, 'Prioridade': request.prioridade, 'Estado': request.estado, 'Departamento': request.departamento, 'Respons√°vel': request.responsavel || '-', 'Descri√ß√£o': request.descricao, 'Registado por': request.nome, 'Tem Foto': request.foto ? 'Sim' : 'N√£o' }));
        const planningData = [];
        activeTasks.forEach(task => {
            const row = { 'Pedido ID': task.id, 'Descri√ß√£o': task.descricao, 'Tipo': task.tipo, 'Prioridade': task.prioridade, 'Respons√°vel': task.responsavel || '-', 'Horas Estimadas': task.horasEstimadas || 0 };
            dates.forEach(date => {
                const dateKey = formatDateKey(date), allocationKey = `${task.id}-${dateKey}`, dayLabel = `${date.getDate()}/${date.getMonth() + 1}`;
                row[dayLabel] = AppState.planning.allocations[allocationKey] ? 'X' : '';
            });
            planningData.push(row);
        });
        const wb = XLSX.utils.book_new();
        const ws1 = XLSX.utils.json_to_sheet(requestsData);
        ws1['!cols'] = [{ wch: 36 }, { wch: 20 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 15 }, { wch: 20 }, { wch: 50 }, { wch: 20 }, { wch: 10 }];
        XLSX.utils.book_append_sheet(wb, ws1, "Pedidos de Manuten√ß√£o");
        if (planningData.length > 0) {
            const ws2 = XLSX.utils.json_to_sheet(planningData);
            const cols = [{ wch: 36 }, { wch: 50 }, { wch: 12 }, { wch: 12 }, { wch: 20 }, { wch: 12 }];
            dates.forEach(() => cols.push({ wch: 8 }));
            ws2['!cols'] = cols;
            XLSX.utils.book_append_sheet(wb, ws2, "Planeamento");
        }
        const fileName = `Manutencao_Completo_${formatDateForFilename()}.xlsx`;
        XLSX.writeFile(wb, fileName, { bookType: 'xlsx' });
        showToast('Excel exportado com sucesso!', 'success');
    } catch (error) { console.error('Erro ao exportar:', error); showToast('Erro ao exportar Excel.', 'error'); }
}
function formatDateKey(date) {
    const year = date.getFullYear(), month = String(date.getMonth() + 1).padStart(2, '0'), day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}
function formatDateShort(date) { return date.toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric' }); }
function formatDateLong2(date) { return date.toLocaleDateString('pt-PT', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' }); }

// MANUTEN√á√ïES AUT√ìNOMAS
function initializeAutonomousMaintenance() {
    const machineSelect = document.getElementById('machineSelect');
    const closePdfBtn = document.getElementById('closePdfBtn');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const printPdfBtn = document.getElementById('printPdfBtn');
    const openOneDriveBtn = document.getElementById('openOneDriveBtn');
    
    machineSelect.addEventListener('change', function() {
        const machineKey = this.value;
        if (!machineKey) { hidePdfViewer(); return; }
        const machine = CONFIG.MACHINES[machineKey];
        if (!machine) { showToast('M√°quina n√£o encontrada.', 'error'); return; }
        loadPdfForMachine(machineKey, machine);
    });
    
    closePdfBtn.addEventListener('click', function() { hidePdfViewer(); machineSelect.value = ''; });
    downloadPdfBtn.addEventListener('click', function() { if (currentMachine) { window.open(currentMachine.url, '_blank'); showToast('Abrindo download...', 'info'); } });
    printPdfBtn.addEventListener('click', function() {
        if (currentMachine) {
            try {
                const iframe = document.getElementById('pdfIframe');
                iframe.contentWindow.print();
            } catch (error) {
                const printWindow = window.open(currentMachine.embedUrl, '_blank');
                if (printWindow) printWindow.onload = function() { printWindow.print(); };
            }
        }
    });
    openOneDriveBtn.addEventListener('click', function() { if (currentMachine) { window.open(currentMachine.url, '_blank'); showToast('Abrindo no OneDrive...', 'info'); } });
}

function loadPdfForMachine(machineKey, machine) {
    const pdfActions = document.getElementById('pdfActions');
    const pdfViewerContainer = document.getElementById('pdfViewerContainer');
    const pdfEmptyState = document.getElementById('pdfEmptyState');
    const pdfIframe = document.getElementById('pdfIframe');
    const pdfTitle = document.getElementById('pdfTitle');
    const pdfViewer = document.querySelector('.pdf-viewer');
    currentMachine = machine;
    pdfViewer.classList.add('loading');
    pdfEmptyState.style.display = 'none';
    pdfActions.style.display = 'flex';
    pdfViewerContainer.style.display = 'block';
    pdfTitle.textContent = `Procedimento: ${machine.name}`;
    pdfIframe.src = machine.embedUrl;
    setTimeout(() => { pdfViewer.classList.remove('loading'); }, 2000);
    setTimeout(() => { pdfViewerContainer.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 300);
    showToast(`Carregando: ${machine.name}`, 'info');
}

function hidePdfViewer() {
    const pdfActions = document.getElementById('pdfActions');
    const pdfViewerContainer = document.getElementById('pdfViewerContainer');
    const pdfEmptyState = document.getElementById('pdfEmptyState');
    const pdfIframe = document.getElementById('pdfIframe');
    const pdfViewer = document.querySelector('.pdf-viewer');
    currentMachine = null;
    pdfIframe.src = '';
    pdfViewer.classList.remove('loading');
    pdfActions.style.display = 'none';
    pdfViewerContainer.style.display = 'none';
    pdfEmptyState.style.display = 'flex';
}

// ============================================
// ============================================
// M√ìDULO DE GEST√ÉO DE STOCK
// ============================================

// ============================================
// SINCRONIZA√á√ÉO COM GOOGLE SHEETS
// ============================================

// ‚ö° CACHE DE ARTIGOS (24h)
function getCachedArtigos() {
    try {
        const cached = localStorage.getItem('artigos_cache');
        const cacheTime = localStorage.getItem('artigos_cache_time');
        
        if (cached && cacheTime) {
            const age = Date.now() - parseInt(cacheTime);
            const maxAge = 24 * 60 * 60 * 1000; // 24 horas
            
            if (age < maxAge) {
                console.log('‚ö° Usando artigos do cache (idade: ' + (age / 1000 / 60).toFixed(0) + ' min)');
                return JSON.parse(cached);
            }
        }
    } catch (error) {
        console.warn('‚ö†Ô∏è Erro ao ler cache:', error);
    }
    return null;
}

function setCachedArtigos(artigos) {
    try {
        localStorage.setItem('artigos_cache', JSON.stringify(artigos));
        localStorage.setItem('artigos_cache_time', Date.now().toString());
        console.log('üíæ Artigos guardados em cache para 24h');
    } catch (error) {
        console.warn('‚ö†Ô∏è N√£o foi poss√≠vel guardar cache:', error);
    }
}

// Carregar artigos do Google Sheets (com cache e retry)
async function loadArtigosFromGoogleSheets(retryCount = 0, forceReload = false) {
    if (!AppState.isOnline) {
        console.log('‚ö†Ô∏è Offline - usando dados locais');
        return;
    }
    
    // ‚ö° TENTAR CACHE PRIMEIRO (se n√£o for reload for√ßado)
    if (!forceReload) {
        const cached = getCachedArtigos();
        if (cached && cached.length > 0) {
            AppState.artigos = cached;
            console.log('‚ö° Artigos carregados do cache:', cached.length);
            hideLoadingSpinner(); // ‚ö° Esconder spinner se veio do cache
            return;
        }
    }
    
    // ‚ö° MOSTRAR LOADING SPINNER
    if (retryCount === 0) {
        showLoadingSpinner('Carregando artigos do Google Sheets...');
    }
    
    try {
        console.log('üîÑ Carregando artigos do Google Sheets... (tentativa ' + (retryCount + 1) + ')');
        console.log('üåê URL:', CONFIG.GOOGLE_SHEETS_URL);
        
        const response = await fetch(CONFIG.GOOGLE_SHEETS_URL + '?timestamp=' + Date.now(), {
            method: 'GET',
            mode: 'cors',
            credentials: 'omit',
            cache: 'no-cache'
        });
        
        console.log('üì° Response status:', response.status);
        console.log('üì° Response ok:', response.ok);
        
        const data = await response.json();
        
        console.log('üì¶ Resposta recebida completa:', JSON.stringify(data, null, 2));
        console.log('üì¶ data.success:', data.success);
        console.log('üì¶ data.artigos:', data.artigos);
        console.log('üì¶ N√∫mero de artigos:', data.artigos ? data.artigos.length : 0);
        
        if (data.success && data.artigos) {
            AppState.artigos = data.artigos;
            setCachedArtigos(data.artigos); // ‚ö° Guardar em cache
            console.log('‚úÖ Artigos carregados do Google Sheets:', data.artigos.length);
            console.log('üìã Artigos detalhados:', JSON.stringify(data.artigos, null, 2));
            
            // ‚ö° ESCONDER LOADING SPINNER
            hideLoadingSpinner();
            showToast(`‚úÖ ${data.artigos.length} artigos carregados com sucesso!`, 'success');
            
            // Atualizar interface se j√° estiver no tab stock
            const stockTab = document.getElementById('tab-stock');
            if (stockTab && stockTab.classList.contains('active')) {
                const searchInput = document.getElementById('stockSearchInput');
                if (searchInput && searchInput.value.length >= 2) {
                    searchArtigos(searchInput.value);
                }
            }
        } else {
            console.error('‚ùå ERRO: Nenhum artigo no Google Sheets!');
            console.error('üìã Data.success:', data.success);
            console.error('üìã Data.artigos:', data.artigos);
            console.error('üìã Data completa:', JSON.stringify(data, null, 2));
            
            // Retry autom√°tico (m√°ximo 2 tentativas)
            if (retryCount < 2) {
                console.warn('‚ö†Ô∏è Tentando novamente em 2 segundos...');
                setTimeout(() => loadArtigosFromGoogleSheets(retryCount + 1), 2000);
            } else {
                AppState.artigos = [];
                hideLoadingSpinner(); // ‚ö° Esconder spinner
                showToast('‚ùå Nenhum artigo encontrado no Google Sheets. Adicione artigos na sheet "Artigos".', 'error');
            }
        }
    } catch (error) {
        console.error('‚ùå Erro ao carregar artigos do Google Sheets:', error);
        console.error('üîß Stack:', error.stack);
        console.error('üîß Message:', error.message);
        
        // Retry autom√°tico em caso de erro de rede (m√°ximo 2 tentativas)
        if (retryCount < 2) {
            console.warn('‚ö†Ô∏è Tentando novamente em 2 segundos...');
            setTimeout(() => loadArtigosFromGoogleSheets(retryCount + 1), 2000);
        } else {
            AppState.artigos = [];
            hideLoadingSpinner(); // ‚ö° Esconder spinner
            showToast('‚ùå Erro ao conectar com Google Sheets. Verifique a configura√ß√£o.', 'error');
        }
    }
}

// Carregar movimentos do Google Sheets
async function loadMovimentosFromGoogleSheets() {
    if (!AppState.isOnline) {
        console.log('‚ö†Ô∏è Offline - usando dados locais');
        return;
    }
    
    try {
        console.log('üîÑ Carregando movimentos do Google Sheets...');
        const response = await fetch(CONFIG.GOOGLE_SHEETS_URL);
        const data = await response.json();
        
        if (data.success && data.movimentos) {
            AppState.movimentos = data.movimentos.map(mov => ({
                ...mov,
                dataHora: new Date(mov.dataHora)
            }));
            console.log('‚úÖ Movimentos carregados:', AppState.movimentos.length);
            renderMovimentos();
        } else {
            console.warn('‚ö†Ô∏è Nenhum movimento no Google Sheets');
        }
    } catch (error) {
        console.error('‚ùå Erro ao carregar movimentos:', error);
    }
}

// Sincronizar movimento com Google Sheets
async function syncMovimentoToGoogleSheets(movimento) {
    if (!AppState.isOnline) {
        console.log('‚ö†Ô∏è Offline - movimento ser√° sincronizado depois');
        addToOfflineQueue({action: 'createMovimento', movimento: movimento});
        return null;
    }
    
    try {
        console.log('üîÑ Sincronizando movimento com Google Sheets...');
        await fetch(CONFIG.GOOGLE_SHEETS_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                action: 'createMovimento',
                movimento: {
                    artigoId: movimento.artigoId,
                    tipo: movimento.tipo,
                    quantidade: movimento.quantidade,
                    pedidoId: movimento.pedidoId || '',
                    responsavel: movimento.responsavel || '',
                    observacoes: movimento.observacoes || '',
                    empresa: movimento.empresa || 'MCF'
                }
            })
        });
        
        // ‚ö†Ô∏è Com mode: 'no-cors' n√£o conseguimos ler a resposta
        // Assumimos sucesso se n√£o deu erro
        console.log('‚úÖ Movimento enviado para Google Sheets (modo no-cors)');
        
        // Recarregar movimentos depois de 2 segundos para confirmar
        setTimeout(() => {
            loadMovimentosFromGoogleSheets();
        }, 2000);
        
        return movimento.id;
    } catch (error) {
        console.error('‚ùå Erro ao sincronizar movimento:', error);
        addToOfflineQueue({action: 'createMovimento', movimento: movimento});
        return null;
    }
}

// ============================================
// INICIALIZA√á√ÉO DO M√ìDULO
// ============================================

function initializeStockModule() {
    // Carregar dados do Google Sheets
    loadArtigosFromGoogleSheets();
    loadMovimentosFromGoogleSheets();
    
    // Setup event listeners
    const stockTab = document.querySelector('.tab-btn[data-tab="stock"]');
    if (stockTab) {
        stockTab.addEventListener('click', () => {
            renderMovimentos();
        });
    }
    
    const searchInput = document.getElementById('stockSearchInput');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchArtigos(e.target.value);
            }, 300); // Debounce de 300ms
        });
    }
    
    const movimentoForm = document.getElementById('movimentoForm');
    if (movimentoForm) {
        movimentoForm.addEventListener('submit', handleMovimentoSubmit);
    }
}

// Pesquisa de artigos
function searchArtigos(term) {
    const resultsDiv = document.getElementById('stockSearchResults');
    const resultsBody = document.getElementById('stockSearchResultsBody');
    const emptyDiv = document.getElementById('stockEmptySearch');
    
    if (!term || term.trim().length < 2) {
        resultsDiv.style.display = 'none';
        emptyDiv.style.display = 'block';
        return;
    }
    
    const searchTerm = term.toLowerCase();
    const artigos = AppState.artigos.filter(a => 
        a.designacao.toLowerCase().includes(searchTerm) ||
        a.referencia.toLowerCase().includes(searchTerm) ||
        a.id.toLowerCase().includes(searchTerm) ||
        a.fornecedor.toLowerCase().includes(searchTerm) ||
        a.familia.toLowerCase().includes(searchTerm)
    );
    
    if (artigos.length === 0) {
        emptyDiv.style.display = 'block';
        emptyDiv.innerHTML = '<p>‚ùå Nenhum artigo encontrado</p>';
        resultsDiv.style.display = 'none';
        return;
    }
    
    emptyDiv.style.display = 'none';
    resultsDiv.style.display = 'block';
    
    resultsBody.innerHTML = artigos.map(artigo => {
        const stockBaixo = artigo.stockAtual <= artigo.stockMinimo;
        const stockClass = stockBaixo ? 'baixo' : 'ok';
        const stockIcon = stockBaixo ? '‚ö†Ô∏è' : '‚úÖ';
        
        return `
            <div class="stock-card">
                <div class="stock-card-header">
                    <div class="stock-card-title">${artigo.designacao}</div>
                    <div class="stock-card-ref">${artigo.referencia}</div>
                </div>
                
                <div class="stock-card-body">
                    <div class="stock-card-info">
                        <div class="stock-card-info-row">
                            <span class="stock-card-info-label">üì¶ Fam√≠lia:</span>
                            <span class="stock-card-info-value">${artigo.familia}</span>
                        </div>
                        <div class="stock-card-info-row">
                            <span class="stock-card-info-label">üè¢ Fornecedor:</span>
                            <span class="stock-card-info-value">${artigo.fornecedor}</span>
                        </div>
                        <div class="stock-card-info-row">
                            <span class="stock-card-info-label">üí∂ Pre√ßo:</span>
                            <span class="stock-card-info-value">‚Ç¨${artigo.preco.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div class="stock-card-stock">
                        <div class="stock-card-stock-label">${stockIcon} Stock Atual</div>
                        <div class="stock-card-stock-value ${stockClass}">
                            ${artigo.stockAtual} ${artigo.unidade}
                        </div>
                        <small style="color: var(--color-text-secondary);">M√≠nimo: ${artigo.stockMinimo} ${artigo.unidade}</small>
                    </div>
                </div>
                
                <div class="stock-card-footer">
                    <button class="btn btn-secondary btn-sm" onclick="darBaixaRapida('${artigo.id}')">
                        üì§ Dar Baixa
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="openMovimentoModal('${artigo.id}')">
                        üìù Movimento
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function clearStockSearch() {
    document.getElementById('stockSearchInput').value = '';
    document.getElementById('stockSearchResults').style.display = 'none';
    document.getElementById('stockEmptySearch').style.display = 'block';
    document.getElementById('stockEmptySearch').innerHTML = '<p>üîç Digite acima para procurar artigos</p>';
}

// Dar baixa r√°pida
async function darBaixaRapida(artigoId) {
    const artigo = AppState.artigos.find(a => a.id === artigoId);
    if (!artigo) return;
    
    const quantidade = prompt(`Dar baixa de ${artigo.designacao}\n\nStock atual: ${artigo.stockAtual} ${artigo.unidade}\n\nQuantidade a dar baixa:`, '1');
    
    if (!quantidade || isNaN(quantidade) || parseInt(quantidade) <= 0) {
        return;
    }
    
    const qtd = parseInt(quantidade);
    
    if (qtd > artigo.stockAtual) {
        alert(`‚ùå Quantidade inv√°lida!\n\nStock dispon√≠vel: ${artigo.stockAtual} ${artigo.unidade}\nQuantidade solicitada: ${qtd} ${artigo.unidade}`);
        return;
    }
    
    const responsavel = prompt('Respons√°vel:', '');
    const observacoes = prompt('Observa√ß√µes (opcional):', '');
    
    // Registar movimento
    const movimento = {
        id: 'MOV' + Date.now(),
        dataHora: new Date(),
        artigoId: artigo.id,
        tipo: 'SA√çDA',
        quantidade: -qtd,
        responsavel: responsavel || '-',
        observacoes: observacoes || 'Baixa r√°pida'
    };
    
    AppState.movimentos.unshift(movimento);
    artigo.stockAtual -= qtd;
    
    // ‚úÖ SINCRONIZAR COM GOOGLE SHEETS
    const syncedId = await syncMovimentoToGoogleSheets(movimento);
    if (syncedId) {
        movimento.id = syncedId;
    }
    
    showToast(`‚úÖ Baixa registada: ${qtd} ${artigo.unidade} de ${artigo.designacao}`, 'success');
    
    // Atualizar visualiza√ß√µes
    searchArtigos(document.getElementById('stockSearchInput').value);
    renderMovimentos();
    saveToLocalStorage();
}

// Renderizar movimentos
function renderMovimentos() {
    const tbody = document.getElementById('movimentosTableBody');
    const emptyState = document.getElementById('movimentosEmptyState');
    
    if (!tbody) return;
    
    const tipoFilter = document.getElementById('movimentoTipoFilter')?.value || 'TODOS';
    const limit = parseInt(document.getElementById('movimentoLimitFilter')?.value || 20);
    
    let movimentos = [...AppState.movimentos];
    
    // Filtrar por tipo
    if (tipoFilter !== 'TODOS') {
        movimentos = movimentos.filter(m => m.tipo === tipoFilter);
    }
    
    // Ordenar por data (mais recente primeiro)
    movimentos.sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora));
    
    // Limitar quantidade
    movimentos = movimentos.slice(0, limit);
    
    if (movimentos.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    
    tbody.innerHTML = movimentos.map(mov => {
        const artigo = AppState.artigos.find(a => a.id === mov.artigoId);
        const artigoNome = artigo ? artigo.designacao : mov.artigoId;
        const dataFormatada = formatDateTime(mov.dataHora);
        const qtdClass = mov.quantidade > 0 ? 'positivo' : 'negativo';
        const badgeClass = mov.tipo === 'ENTRADA' ? 'badge-entrada' : mov.tipo === 'SA√çDA' ? 'badge-saida' : 'badge-ajuste';
        
        return `
            <tr>
                <td><small>${dataFormatada}</small></td>
                <td>
                    <strong>${artigoNome}</strong><br>
                    <small><code>${mov.artigoId}</code></small>
                </td>
                <td><span class="badge ${badgeClass}">${mov.tipo}</span></td>
                <td>
                    <span class="quantidade-badge ${qtdClass}">
                        ${mov.quantidade > 0 ? '+' : ''}${mov.quantidade}
                    </span>
                </td>
                <td>${mov.responsavel}</td>
                <td><small>${mov.observacoes || '-'}</small></td>
                <td>
                    <div class="stock-actions">
                        <button class="btn btn-secondary btn-sm" onclick="editarMovimento('${mov.id}')" title="Editar">
                            ‚úèÔ∏è
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="eliminarMovimento('${mov.id}')" title="Eliminar">
                            üóëÔ∏è
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function formatDateTime(date) {
    const d = new Date(date);
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = d.getFullYear();
    const hours = String(d.getHours()).padStart(2, '0');
    const minutes = String(d.getMinutes()).padStart(2, '0');
    return `${day}/${month}/${year} ${hours}:${minutes}`;
}

// Editar movimento
async function editarMovimento(movId) {
    const mov = AppState.movimentos.find(m => m.id === movId);
    if (!mov) return;
    
    const artigo = AppState.artigos.find(a => a.id === mov.artigoId);
    
    const novaQtd = prompt(`Editar Movimento\n\nArtigo: ${artigo ? artigo.designacao : mov.artigoId}\nTipo: ${mov.tipo}\nQuantidade atual: ${mov.quantidade}\n\nNova quantidade:`, Math.abs(mov.quantidade));
    
    if (!novaQtd || isNaN(novaQtd)) return;
    
    const qtd = parseInt(novaQtd);
    const novasObs = prompt('Observa√ß√µes:', mov.observacoes);
    
    // Reverter movimento antigo
    if (artigo) {
        artigo.stockAtual -= mov.quantidade;
    }
    
    // Aplicar novo movimento
    const diferencaQtd = (mov.tipo === 'SA√çDA' ? -Math.abs(qtd) : Math.abs(qtd)) - mov.quantidade;
    mov.quantidade = mov.tipo === 'SA√çDA' ? -Math.abs(qtd) : Math.abs(qtd);
    mov.observacoes = novasObs || mov.observacoes;
    
    if (artigo) {
        artigo.stockAtual += mov.quantidade;
    }
    
    // ‚ö†Ô∏è NOTA: Google Sheets n√£o suporta edi√ß√£o direta de movimentos
    // Solu√ß√£o: Criar novo movimento de ajuste com a diferen√ßa
    if (AppState.isOnline && diferencaQtd !== 0) {
        const movimentoAjuste = {
            artigoId: mov.artigoId,
            tipo: 'AJUSTE',
            quantidade: diferencaQtd,
            responsavel: 'Sistema',
            observacoes: `Ajuste por edi√ß√£o do movimento ${movId}`
        };
        await syncMovimentoToGoogleSheets(movimentoAjuste);
    }
    
    showToast('‚úÖ Movimento atualizado!', 'success');
    renderMovimentos();
    searchArtigos(document.getElementById('stockSearchInput').value);
    saveToLocalStorage();
}

// Eliminar movimento
async function eliminarMovimento(movId) {
    if (!confirm('Tem a certeza que deseja eliminar este movimento?')) return;
    
    const mov = AppState.movimentos.find(m => m.id === movId);
    if (!mov) return;
    
    const artigo = AppState.artigos.find(a => a.id === mov.artigoId);
    
    // Reverter o movimento no stock
    if (artigo) {
        artigo.stockAtual -= mov.quantidade;
    }
    
    // ‚ö†Ô∏è NOTA: Google Sheets n√£o suporta elimina√ß√£o direta de movimentos
    // Solu√ß√£o: Criar movimento de ajuste inverso
    if (AppState.isOnline) {
        const movimentoInverso = {
            artigoId: mov.artigoId,
            tipo: 'AJUSTE',
            quantidade: -mov.quantidade, // Inverso
            responsavel: 'Sistema',
            observacoes: `Revers√£o por elimina√ß√£o do movimento ${movId}`
        };
        await syncMovimentoToGoogleSheets(movimentoInverso);
    }
    
    // Remover movimento localmente
    AppState.movimentos = AppState.movimentos.filter(m => m.id !== movId);
    
    showToast('‚úÖ Movimento eliminado!', 'success');
    renderMovimentos();
    searchArtigos(document.getElementById('stockSearchInput').value);
    saveToLocalStorage();
}

async function openNovoMovimentoModal() {
    console.log('üöÄ openNovoMovimentoModal() INICIADO');
    console.log('üìä Total de artigos em AppState:', AppState.artigos.length);
    console.log('üì¶ Artigos completos:', JSON.stringify(AppState.artigos, null, 2));
    
    // üî• SE VAZIO ‚Üí FOR√áAR RELOAD DO SERVIDOR!
    if (AppState.artigos.length === 0) {
        console.warn('‚ö†Ô∏è Artigos vazios! For√ßando reload do Google Sheets...');
        
        // üé® Mostrar loading spinner
        const loadingToast = showToast('‚è≥ Carregando artigos... Pode demorar alguns segundos.', 'info');
        
        try {
            const startTime = Date.now();
            await loadArtigosFromGoogleSheets(0, true); // forceReload = true
            const loadTime = ((Date.now() - startTime) / 1000).toFixed(1);
            
            // Verificar novamente ap√≥s reload
            if (AppState.artigos.length === 0) {
                console.error('‚ùå ERRO CR√çTICO: Artigos continuam vazios ap√≥s reload!');
                showToast('‚ùå Nenhum artigo encontrado no Google Sheets. Verifique a sheet "Artigos".', 'error');
                return;
            }
            
            console.log('‚úÖ Artigos carregados com sucesso ap√≥s reload:', AppState.artigos.length, '(tempo:', loadTime + 's)');
            showToast('‚úÖ ' + AppState.artigos.length + ' artigos carregados! (' + loadTime + 's)', 'success');
        } catch (error) {
            console.error('‚ùå Erro ao carregar artigos:', error);
            showToast('‚ùå Erro ao carregar artigos. Tente novamente.', 'error');
            return;
        }
    }
    
    // Preencher dropdown de fam√≠lias
    const familiaSelect = document.getElementById('movimentoFamiliaSelect');
    console.log('üîç familiaSelect existe?', !!familiaSelect);
    if (familiaSelect) {
        const familias = [...new Set(AppState.artigos.map(a => a.familia))].sort();
        console.log('üìã Fam√≠lias √∫nicas encontradas:', familias);
        familiaSelect.innerHTML = '<option value="">Todas as fam√≠lias</option>';
        familias.forEach(familia => {
            const option = document.createElement('option');
            option.value = familia;
            option.textContent = familia;
            familiaSelect.appendChild(option);
            console.log('‚úÖ Fam√≠lia adicionada ao dropdown:', familia);
        });
        console.log('‚úÖ Total de fam√≠lias no dropdown:', familiaSelect.options.length);
    }
    
    // Preencher dropdown com TODOS os artigos inicialmente
    const select = document.getElementById('movimentoArtigoSelect');
    console.log('üîç artigoSelect existe?', !!select);
    if (select) {
        select.innerHTML = '<option value="">Selecione um artigo...</option>';
        AppState.artigos.forEach((artigo, index) => {
            const option = document.createElement('option');
            option.value = artigo.id;
            option.textContent = `${artigo.designacao} (${artigo.referencia}) - Stock: ${artigo.stockAtual} ${artigo.unidade}`;
            select.appendChild(option);
            console.log(`‚úÖ Artigo ${index + 1} adicionado:`, artigo.id, artigo.designacao);
        });
        console.log('‚úÖ Total de artigos no dropdown:', select.options.length);
    }
    
    // Mostrar dropdown, esconder info
    const selectGroup = document.getElementById('artigoSelectGroup');
    const info = document.getElementById('artigoSelectedInfo');
    if (selectGroup) selectGroup.style.display = 'block';
    if (info) info.style.display = 'none';
    
    // Resetar form
    document.getElementById('movimentoTipo').value = 'ENTRADA';
    document.getElementById('movimentoQuantidade').value = '1';
    document.getElementById('movimentoObservacoes').value = '';
    
    // Auto-preencher respons√°vel com utilizador logado
    const responsavelInput = document.getElementById('movimentoResponsavel');
    if (responsavelInput && AppState.currentUser) {
        responsavelInput.value = AppState.currentUser.nomeCompleto;
        console.log('‚úÖ Respons√°vel preenchido automaticamente:', AppState.currentUser.nomeCompleto);
    }
    
    // Abrir modal
    const modal = document.getElementById('movimentoModal');
    if (modal) {
        modal.classList.add('active');
        modal.querySelector('.modal-overlay')?.addEventListener('click', closeMovimentoModal);
    }
}

function filtrarArtigosPorFamilia() {
    const familiaSelect = document.getElementById('movimentoFamiliaSelect');
    const artigoSelect = document.getElementById('movimentoArtigoSelect');
    
    if (!familiaSelect || !artigoSelect) return;
    
    const familiaSelecionada = familiaSelect.value;
    
    // Filtrar artigos
    let artigosFiltrados = AppState.artigos;
    if (familiaSelecionada) {
        artigosFiltrados = AppState.artigos.filter(a => a.familia === familiaSelecionada);
    }
    
    // Recriar dropdown de artigos
    artigoSelect.innerHTML = '<option value="">Selecione um artigo...</option>';
    artigosFiltrados.forEach(artigo => {
        const option = document.createElement('option');
        option.value = artigo.id;
        option.textContent = `${artigo.designacao} (${artigo.referencia}) - Stock: ${artigo.stockAtual} ${artigo.unidade}`;
        artigoSelect.appendChild(option);
    });
    
    // Limpar sele√ß√£o e info
    artigoSelect.value = '';
    const info = document.getElementById('artigoSelectedInfo');
    if (info) info.style.display = 'none';
    AppState.artigoSelecionado = null;
}

function openMovimentoModal(artigoId) {
    // Quando vem de um bot√£o de artigo espec√≠fico (baixa r√°pida)
    const artigo = AppState.artigos.find(a => a.id === artigoId);
    if (!artigo) return;
    
    AppState.artigoSelecionado = artigo;
    
    // Preencher dropdown de fam√≠lias
    const familiaSelect = document.getElementById('movimentoFamiliaSelect');
    if (familiaSelect) {
        const familias = [...new Set(AppState.artigos.map(a => a.familia))].sort();
        familiaSelect.innerHTML = '<option value="">Todas as fam√≠lias</option>';
        familias.forEach(familia => {
            const option = document.createElement('option');
            option.value = familia;
            option.textContent = familia;
            // Pr√©-selecionar a fam√≠lia do artigo
            if (familia === artigo.familia) option.selected = true;
            familiaSelect.appendChild(option);
        });
    }
    
    // Preencher dropdown de artigos (filtrado pela fam√≠lia do artigo selecionado)
    const select = document.getElementById('movimentoArtigoSelect');
    if (select) {
        select.innerHTML = '<option value="">Selecione um artigo...</option>';
        const artigosDaFamilia = AppState.artigos.filter(a => a.familia === artigo.familia);
        artigosDaFamilia.forEach(art => {
            const option = document.createElement('option');
            option.value = art.id;
            option.textContent = `${art.designacao} (${art.referencia}) - Stock: ${art.stockAtual} ${art.unidade}`;
            if (art.id === artigoId) option.selected = true;
            select.appendChild(option);
        });
    }
    
    // Mostrar info do artigo
    updateArtigoInfo();
    
    // Resetar campos
    document.getElementById('movimentoTipo').value = 'ENTRADA';
    document.getElementById('movimentoQuantidade').value = '1';
    document.getElementById('movimentoObservacoes').value = '';
    
    // Auto-preencher respons√°vel com utilizador logado
    const responsavelInput = document.getElementById('movimentoResponsavel');
    if (responsavelInput && AppState.currentUser) {
        responsavelInput.value = AppState.currentUser.nomeCompleto;
        console.log('‚úÖ Respons√°vel preenchido automaticamente:', AppState.currentUser.nomeCompleto);
    }
    
    // Abrir modal
    const modal = document.getElementById('movimentoModal');
    if (modal) {
        modal.classList.add('active');
        modal.querySelector('.modal-overlay')?.addEventListener('click', closeMovimentoModal);
    }
}

function updateArtigoInfo() {
    const select = document.getElementById('movimentoArtigoSelect');
    const info = document.getElementById('artigoSelectedInfo');
    
    if (!select || !info) return;
    
    const artigoId = select.value;
    
    if (!artigoId) {
        info.style.display = 'none';
        AppState.artigoSelecionado = null;
        return;
    }
    
    const artigo = AppState.artigos.find(a => a.id === artigoId);
    if (!artigo) return;
    
    AppState.artigoSelecionado = artigo;
    
    info.style.display = 'block';
    info.innerHTML = `
        <h4>${artigo.designacao}</h4>
        <p><strong>Refer√™ncia:</strong> ${artigo.referencia}</p>
        <p><strong>Stock Atual:</strong> ${artigo.stockAtual} ${artigo.unidade}</p>
        <p><strong>Fornecedor:</strong> ${artigo.fornecedor}</p>
    `;
}

function closeMovimentoModal() {
    const modal = document.getElementById('movimentoModal');
    if (modal) {
        modal.classList.remove('active');
    }
    AppState.artigoSelecionado = null;
}

// üîç FUN√á√ÉO DE DIAGN√ìSTICO DE ARTIGOS
async function diagnosticarArtigos() {
    console.log('üîçüîçüîç === DIAGN√ìSTICO DE ARTIGOS INICIADO === üîçüîçüîç');
    
    // 1. Verificar AppState.artigos
    console.log('üìä AppState.artigos.length:', AppState.artigos.length);
    console.log('üì¶ AppState.artigos:', JSON.stringify(AppState.artigos, null, 2));
    
    // 2. Verificar URL do Google Sheets
    console.log('üåê CONFIG.GOOGLE_SHEETS_URL:', CONFIG.GOOGLE_SHEETS_URL);
    
    // 3. For√ßar reload dos artigos
    console.log('üîÑ For√ßando reload dos artigos do Google Sheets...');
    
    try {
        const url = CONFIG.GOOGLE_SHEETS_URL + '?timestamp=' + Date.now() + '&debug=true';
        console.log('üì° Fazendo fetch para:', url);
        
        const response = await fetch(url, {
            method: 'GET',
            mode: 'cors',
            credentials: 'omit',
            cache: 'no-cache'
        });
        
        console.log('üì° Response status:', response.status);
        console.log('üì° Response ok:', response.ok);
        console.log('üì° Response headers:', response.headers);
        
        const text = await response.text();
        console.log('üìÑ Response texto BRUTO:', text);
        
        try {
            const data = JSON.parse(text);
            console.log('‚úÖ JSON parseado com sucesso!');
            console.log('üì¶ data.success:', data.success);
            console.log('üì¶ data.artigos:', data.artigos);
            console.log('üì¶ data.artigos.length:', data.artigos ? data.artigos.length : 0);
            
            if (data.success && data.artigos && data.artigos.length > 0) {
                AppState.artigos = data.artigos;
                console.log('‚úÖ‚úÖ‚úÖ ARTIGOS RECARREGADOS COM SUCESSO!');
                console.log('üìä Novos artigos em AppState:', AppState.artigos.length);
                showToast('‚úÖ Artigos recarregados: ' + AppState.artigos.length, 'success');
            } else {
                console.error('‚ùå ERRO: Nenhum artigo no response!');
                showToast('‚ùå Nenhum artigo encontrado no Google Sheets', 'error');
            }
        } catch (parseError) {
            console.error('‚ùå ERRO ao fazer parse do JSON:', parseError);
            console.error('üìÑ Texto que falhou:', text.substring(0, 500));
            showToast('‚ùå Erro ao processar resposta do servidor', 'error');
        }
        
    } catch (error) {
        console.error('‚ùå ERRO no fetch:', error);
        console.error('Stack:', error.stack);
        showToast('‚ùå Erro ao conectar com Google Sheets', 'error');
    }
    
    console.log('üîçüîçüîç === DIAGN√ìSTICO FINALIZADO === üîçüîçüîç');
}

function adjustQuantidade(delta) {
    const input = document.getElementById('movimentoQuantidade');
    if (input) {
        const current = parseInt(input.value) || 1;
        const newValue = Math.max(1, current + delta);
        input.value = newValue;
    }
}

async function handleMovimentoSubmit(e) {
    e.preventDefault();
    
    if (!AppState.artigoSelecionado) return;
    
    const tipo = document.getElementById('movimentoTipo').value;
    let quantidade = parseInt(document.getElementById('movimentoQuantidade').value);
    const empresa = document.getElementById('movimentoEmpresa').value;
    const responsavel = document.getElementById('movimentoResponsavel').value || '-';
    const observacoes = document.getElementById('movimentoObservacoes').value || '';
    
    // Sa√≠da √© negativa
    if (tipo === 'SA√çDA') {
        quantidade = -Math.abs(quantidade);
    } else if (tipo === 'ENTRADA') {
        quantidade = Math.abs(quantidade);
    }
    
    // Atualizar stock localmente
    const artigo = AppState.artigos.find(a => a.id === AppState.artigoSelecionado.id);
    if (artigo) {
        artigo.stockAtual += quantidade;
        
        // Registar movimento
        const movimento = {
            id: 'MOV' + Date.now(),
            dataHora: new Date(),
            artigoId: artigo.id,
            tipo: tipo,
            quantidade: quantidade,
            empresa: empresa,
            responsavel: responsavel,
            observacoes: observacoes
        };
        
        AppState.movimentos.unshift(movimento);
        
        // ‚úÖ SINCRONIZAR COM GOOGLE SHEETS
        const syncedId = await syncMovimentoToGoogleSheets(movimento);
        if (syncedId) {
            movimento.id = syncedId; // Usar ID do Google Sheets
        }
        
        // Mostrar notifica√ß√£o
        showToast(`‚úÖ Movimento registado: ${tipo} de ${Math.abs(quantidade)} ${artigo.unidade}`, 'success');
        
        // Fechar modal
        closeMovimentoModal();
        
        // Re-renderizar
        renderMovimentos();
        searchArtigos(document.getElementById('stockSearchInput').value);
        saveToLocalStorage();
    }
}

// EXPOSI√á√ÉO GLOBAL
window.openRequestDetails = openRequestDetails;
window.closeModal = closeModal;
window.changeRequestState = changeRequestState;
window.deleteRequest = deleteRequest;
window.clearImagePreview = clearImagePreview;
window.toggleAllocation = toggleAllocation;
window.updateTaskHours = updateTaskHours;
window.openMovimentoModal = openMovimentoModal;
window.closeMovimentoModal = closeMovimentoModal;
window.adjustQuantidade = adjustQuantidade;
window.updateArtigoInfo = updateArtigoInfo;
window.filtrarArtigosPorFamilia = filtrarArtigosPorFamilia;
window.searchArtigos = searchArtigos;
window.clearStockSearch = clearStockSearch;
window.darBaixaRapida = darBaixaRapida;
window.renderMovimentos = renderMovimentos;
window.editarMovimento = editarMovimento;
window.eliminarMovimento = eliminarMovimento;
window.openNovoMovimentoModal = openNovoMovimentoModal;
    </script>
</body>
</html>
